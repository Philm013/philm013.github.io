<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 NGSS 3D Progression Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added Chart.js and Shepherd.js for new features -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script>
        // Support for Tailwind's dark mode based on user's OS preference
        tailwind.config = {
          darkMode: 'media',
        }
    </script>
    <style>
        /* A few helper styles for sticky table headers and custom scrollbars */
        #planner-table-container, .modal-content, #progression-table-view, #summary-content, #popover-content {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar, .modal-content::-webkit-scrollbar, #progression-table-view::-webkit-scrollbar, #summary-content::-webkit-scrollbar, #popover-content::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #planner-table-container::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track, #progression-table-view::-webkit-scrollbar-track, #summary-content::-webkit-scrollbar-track, #popover-content::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb, #progression-table-view::-webkit-scrollbar-thumb, #summary-content::-webkit-scrollbar-thumb, #popover-content::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }
		#pe-modal-list {
		    overflow-y: auto;
		}
        .dark #planner-table-container, .dark .modal-content, .dark #progression-table-view, .dark #summary-content, .dark #popover-content {
            scrollbar-color: #4a5568 #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-track, .dark .modal-content::-webkit-scrollbar-track, .dark #progression-table-view::-webkit-scrollbar-track, .dark #summary-content::-webkit-scrollbar-track, .dark #popover-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-thumb, .dark .modal-content::-webkit-scrollbar-thumb, .dark #progression-table-view::-webkit-scrollbar-thumb, .dark #summary-content::-webkit-scrollbar-thumb, .dark #popover-content::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-color: #2d3748;
        }
        
        #planner-table-container thead th {
            position: sticky; top: 0; z-index: 20;
            height: 140px; /* Increased height for rotated text */
            vertical-align: bottom;
            padding-bottom: 5px;
        }
        #planner-table-container thead th > div {
            transform-origin: bottom left;
            transform: translateX(10px) rotate(-60deg);
            width: 30px;
            white-space: nowrap;
        }

        .sticky-col-1 { position: sticky; left: 0; z-index: 15; min-width: 94px;}
        .sticky-col-2 { position: sticky; left: 93px; z-index: 14; }
        .sticky-col-3 { 
            position: sticky; 
            left: 154px; 
            z-index: 13; 
            box-shadow: 4px 0 5px -2px rgba(0,0,0,0.05);
        }
        .dark .sticky-col-3 {
            box-shadow: 4px 0 5px -2px rgba(0,0,0,0.25);
        }
		#planner-table-container thead th.sticky-col-1, #planner-table-container thead th.sticky-col-2, #planner-table-container thead th.sticky-col-3 {
			z-index: 21;
            height: auto; /* Reset height for non-rotated sticky headers */
		}
        #planner-table-container thead th.sticky-col-1 > div, #planner-table-container thead th.sticky-col-2 > div, #planner-table-container thead th.sticky-col-3 > div {
            transform: none; /* No rotation for first three headers */
            width: auto;
        }

        #progression-table-view th.sticky {
            box-shadow: 0 4px 5px -2px rgba(0,0,0,0.05);
        }
        .dark #progression-table-view th.sticky {
             box-shadow: 0 4px 5px -2px rgba(0,0,0,0.25);
        }

        body.sidebar-open #sidebar { transform: translateX(0); }
        body.sidebar-open #sidebar-backdrop { opacity: 1; pointer-events: auto; }
        body.modal-open #menu-toggle { display: none; }
        
        .pe-link-indicator { display: inline-block; font-size: 0.7em; padding: 1px 5px; background-color: #e6f4ff; color: #005a9c; border: 1px solid #b3d7ff; border-radius: 4px; font-weight: bold; vertical-align: middle; margin-left: 4px; }
        .dark .pe-link-indicator { background-color: #1e3a8a; color: #93c5fd; border-color: #3b82f6; }
        
        /* Styles for new features */
        tr.filtered-out { display: none; }
        .shepherd-button { background-color: #3b82f6; color: white; border-radius: 0.375rem; padding: 0.5rem 1rem; }
        .shepherd-button:not(.shepherd-button-secondary):hover { background-color: #2563eb; }
        .shepherd-button.shepherd-button-secondary { background-color: #6b7280; }
        .shepherd-header { background-color: #1f2937; padding: 1rem; }
        .shepherd-footer { padding: 0.5rem; }
        .dark .shepherd-text, .dark .shepherd-header, .dark .shepherd-content { background-color: #374151; color: #e5e7eb; }
        .dark .shepherd-arrow::before { background-color: #374151; }
    </style>
</head>
<body id="body-tag" class="bg-gray-100 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-200 antialiased group">
    <div id="loading-indicator" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center text-lg text-gray-500 dark:text-gray-400 z-[2000] transition-opacity duration-500">Loading NGSS Planner...</div>

    <div class="relative flex h-screen overflow-hidden">
        <aside id="sidebar" class="bg-gray-800 text-gray-100 flex flex-col w-80 flex-shrink-0 p-4 transform transition-transform duration-300 ease-in-out z-[1000] -translate-x-full md:relative md:translate-x-0 fixed top-0 left-0 h-full md:shadow-lg">
            <h2 class="text-xl font-bold border-b border-gray-600 pb-3 mb-4">Planner Navigator</h2>
            <div id="navigator-controls" class="grid grid-cols-2 gap-2 mb-4">
                <button id="new-planner-btn" class="w-full px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">+ New Planner</button>
                <button id="view-progression-btn" class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold text-sm">Progression</button>
            </div>
             <div class="grid grid-cols-1 gap-2 mb-4">
                <button id="help-btn" class="w-full px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-semibold text-sm">Help / Tour</button>
            </div>
            <ul id="navigator-list" class="overflow-y-auto space-y-1"></ul>
        </aside>

        <div id="main-wrapper" class="flex-1 flex flex-col overflow-x-hidden">
            <button id="menu-toggle" class="md:hidden absolute top-4 left-4 z-[40] bg-gray-800/80 backdrop-blur-sm text-white p-2 rounded-md text-xl">☰</button>
            <div id="sidebar-backdrop" class="md:hidden fixed inset-0 bg-black/40 z-[999] opacity-0 pointer-events-none transition-opacity duration-300"></div>

            <main id="main-content" class="flex-1 flex flex-col p-3 md:p-5 min-h-0">
                <div id="welcome-view" class="view active">
                    <div class="text-center m-auto text-gray-500 dark:text-gray-400">
                        <h2 class="text-2xl font-semibold mb-2">Welcome to the NGSS 3D Progression Planner</h2>
                        <p>Select a planner from the navigator on the left to begin, or create a new one.</p>
                        <button id="welcome-help-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Show me how it works!</button>
                    </div>
                </div>

                <div id="planner-view" class="view flex-1 flex flex-col">
                    <!-- Compact Header -->
                    <div class="flex flex-wrap justify-between items-start gap-4 mb-4">
                        <div>
                            <h1 id="planner-title" class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100"></h1>
                            <p id="planner-subtitle" class="text-base text-gray-500 dark:text-gray-400 -mt-1"></p>
                        </div>
                        <div class="flex items-center justify-end gap-x-4 gap-y-2 flex-wrap">
                             <label class="flex items-center gap-2 text-sm cursor-pointer font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">
                                <span>PE Bundled Only</span>
                                <input type="checkbox" id="pe-bundle-toggle" class="sr-only peer">
                                <div class="relative w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </label>
                            <span id="save-status" class="text-sm italic text-gray-500 dark:text-gray-400"></span>
                        </div>
                    </div>

                    <div class="mb-4 p-3 border border-dashed border-blue-300 dark:border-blue-700 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <p class="font-bold text-sm text-blue-800 dark:text-blue-200">Anchoring Phenomenon:</p>
                        <p id="planner-phenomenon" class="text-sm text-blue-700 dark:text-blue-300 italic">Not specified.</p>
                        <p class="font-bold text-sm text-blue-800 dark:text-blue-200 mt-2">Unit Driving Question:</p>
                        <p id="planner-question" class="text-sm text-blue-700 dark:text-blue-300 italic">Not specified.</p>
                    </div>
                    
                    <div class="controls flex flex-row flex-wrap gap-2 md:gap-4 mb-4 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm md:items-center">
                         <div class="relative flex-shrink-0">
                            <input type="search" id="search-input" placeholder="Search lessons..." class="w-full md:w-48 pl-8 pr-2 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none text-gray-400">⚲</div>
                        </div>
                        <div class="controls-group flex gap-2">
                            <button id="assign-pe-btn" class="px-3 py-2 bg-cyan-500 text-white rounded-md hover:bg-cyan-600 text-sm font-medium transition-colors">Manage PEs</button>
                            <button id="view-summary-btn" class="px-3 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-sm font-medium transition-colors">Summary</button>
                        </div>
                        <div class="controls-group flex gap-2 group-[.view-mode-active]:hidden">
                            <button id="add-lesson-set-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium transition-colors">Add Set</button>
                            <button id="add-lesson-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium transition-colors">Add Lesson</button>
                        </div>
                         <div class="controls-group flex gap-2">
                            <button id="undo-btn" disabled title="Undo (Ctrl+Z)" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Undo</button>
                            <button id="redo-btn" disabled title="Redo (Ctrl+Y)" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Redo</button>
                        </div>
                        <div class="controls-group flex gap-2">
                            <button id="edit-planner-btn" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm font-medium transition-colors group-[.view-mode-active]:hidden">Settings</button>
                            <button id="view-mode-toggle" class="px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 text-sm font-medium transition-colors">View Mode</button>
                        </div>
                        <div class="controls-group flex gap-2">
                            <button id="import-planner-btn" class="px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm font-medium transition-colors">Import</button>
                            <button id="export-planner-btn" class="px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm font-medium transition-colors">Export</button>
                        </div>
                    </div>

                    <div id="tab-container" class="tabs flex border-b-2 border-gray-300 dark:border-gray-700 -mb-px"></div>
                    <div id="planner-table-container" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-b-lg rounded-tr-lg bg-white dark:bg-gray-800/50"></div>
                </div>
                
                <div id="progression-view" class="view flex-1 flex flex-col">
                     <div class="flex justify-between items-center mb-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Progression Storyline</h1>
                            <p id="progression-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <div class="flex items-center gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                            <button id="progression-view-element" class="px-3 py-1 text-sm font-medium rounded-md">By Element</button>
                            <button id="progression-view-lesson" class="px-3 py-1 text-sm font-medium rounded-md">By Lesson</button>
                        </div>
                     </div>
                     <div id="progression-table-view" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-lg p-4"></div>
                </div>
                 <div id="summary-view" class="view flex-1 flex flex-col">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Planner Summary & Analytics</h1>
                    <p id="summary-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400 mb-4"></p>
                    <div id="summary-content" class="flex-grow overflow-auto p-4 space-y-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="planner-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b dark:border-gray-700">
                 <h3 id="planner-modal-title" class="text-xl font-semibold text-gray-900 dark:text-gray-100">New Planner</h3>
            </div>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="planner-id-input">
                <div>
                    <label for="planner-title-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Planner Title</label>
                    <input type="text" id="planner-title-input" placeholder="e.g., Grade 4 Energy Unit" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div>
                    <label for="planner-course-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Course / Subject</label>
                    <input type="text" id="planner-course-input" placeholder="e.g., 4th Grade Science" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="planner-band-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grade Band</label>
                        <select id="planner-band-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="primary">Grades K-2</option>
                            <option value="elementary">Grades 3-5</option>
                            <option value="middle">Grades 6-8</option>
                            <option value="high">Grades 9-12</option>
                        </select>
                    </div>
                    <div>
                        <label for="planner-standard-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Standard Set</label>
                        <select id="planner-standard-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="NGSS">NGSS</option>
                        </select>
                    </div>
                </div>
                <div id="new-planner-structure-fields" class="grid grid-cols-2 gap-4 border-t pt-4 dark:border-gray-700">
                    <div>
                        <label for="planner-sets-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Number of Lesson Sets</label>
                        <input type="number" id="planner-sets-input" value="4" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="planner-lessons-per-set-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lessons per Set</label>
                        <input type="number" id="planner-lessons-per-set-input" value="2" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                </div>
                 <div>
                    <label for="planner-phenomenon-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Anchoring Phenomenon</label>
                    <textarea id="planner-phenomenon-input" rows="2" placeholder="e.g., A wrecking ball can knock down a building." class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                 <div>
                    <label for="planner-question-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unit Driving Question</label>
                    <textarea id="planner-question-input" rows="2" placeholder="e.g., How can something small cause a big change?" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                <div>
                    <label for="planner-description-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description (Optional)</label>
                    <textarea id="planner-description-input" rows="3" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-between items-center">
                <button id="planner-modal-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold text-sm hidden">Delete</button>
                <div class="flex-grow text-right space-x-2">
                    <button id="planner-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                    <button id="planner-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Planner</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="pe-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100 sticky top-0 bg-white dark:bg-gray-800">Assign Performance Expectations</h3>
            <div class="modal-content p-6 overflow-y-auto" id="pe-modal-list"></div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right space-x-2 sticky bottom-0">
                <button id="pe-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="pe-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="element-detail-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h3 id="element-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Element Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <p id="element-modal-description" class="text-base"></p>
                <div id="element-progression"></div>
                <div id="element-linked-pes"></div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="element-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="export-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Export Planner</h3>
            <div class="modal-content p-6 overflow-y-auto" id="export-options-list">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Select a format to download your planner.</p>
                <div class="space-y-3">
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="json">
                        <strong class="text-blue-600 dark:text-blue-400">JSON File</strong>
                        <small class="text-gray-500 dark:text-gray-400">Best for backing up and re-importing into this tool.</small>
                    </button>
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="html">
                        <strong class="text-blue-600 dark:text-blue-400">HTML File</strong>
                        <small class="text-gray-500 dark:text-gray-400">A self-contained, viewable webpage of your planner.</small>
                    </button>
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="xlsx">
                        <strong class="text-blue-600 dark:text-blue-400">Excel (XLSX) File</strong>
                        <small class="text-gray-500 dark:text-gray-400">For use in spreadsheets like Excel or Google Sheets.</small>
                    </button>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="export-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
            </div>
        </div>
    </div>
     <div id="lesson-details-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 id="lesson-details-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Lesson Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <div>
                    <label for="lesson-notes-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="lesson-notes-input" rows="6" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Links & Resources</label>
                    <div id="lesson-links-container" class="space-y-2"></div>
                    <div class="flex gap-2 mt-2">
                         <input type="url" id="new-link-input" placeholder="https://example.com" class="flex-grow px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                         <button id="add-link-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="lesson-details-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="import-options-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Import Options</h3>
            <div class="modal-content p-6 overflow-y-auto space-y-4">
                <p>You are importing planner: <strong id="import-planner-name" class="text-blue-600 dark:text-blue-400"></strong></p>
                <p class="text-gray-600 dark:text-gray-400">How would you like to import it?</p>
                <div class="space-y-3">
                    <label class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer">
                        <input type="radio" name="import-option" value="create" class="mr-2" checked>
                        <strong>Create New Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Adds the imported planner to your list. If an ID conflict exists, a new one will be created.</small>
                    </label>
                    <label id="import-merge-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="merge" class="mr-2" disabled>
                        <strong>Merge with Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Combines PEs and rows with the currently open planner. This option is only available when a planner is open.</small>
                    </label>
                    <label id="import-replace-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="replace" class="mr-2" disabled>
                        <strong>Replace Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Deletes the currently open planner and replaces it with the imported one. This cannot be undone.</small>
                    </label>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-end space-x-2">
                <button id="import-options-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="import-options-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Confirm Import</button>
            </div>
        </div>
    </div>
    <div id="element-popover" class="hidden absolute z-[1001] bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-300 dark:border-gray-600 w-full max-w-md flex flex-col transition-opacity duration-150">
        <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-lg">
            <h4 id="popover-title" class="font-semibold text-gray-800 dark:text-gray-200 text-sm"></h4>
            <button id="popover-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xl font-bold leading-none">&times;</button>
        </div>
        <div id="popover-content" class="overflow-y-auto max-h-[50vh]"></div>
    </div>


    <div id="tooltip" class="fixed bg-gray-900 text-white px-3 py-1.5 rounded-md z-[1002] pointer-events-none opacity-0 transition-opacity text-sm max-w-md shadow-lg"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

    <script>
	
    /**
     * @file This file contains the complete JavaScript application for the K-12 NGSS 3D Progression Planner.
     * This version includes numerous feature enhancements like Undo/Redo, search, guided tours,
     * lesson notes, analytics dashboards, a storyline view, templates, and phenomenon integration.
     */
    document.addEventListener('DOMContentLoaded', () => {
        
        /** @namespace App */
        const App = {
            state: {
                programData: {},
                currentPlannerId: null,
                currentActiveTab: 'pe',
                saveTimeout: null,
                draggedGroup: null, 
                isViewMode: false,
                isPeBundleMode: false,
                undoStack: [],
                redoStack: [],
                pendingImportData: null,
                allNgssData: [],
                allNgss3dElements: [],
                progressionViewType: 'element', // 'element' or 'lesson'
            },
			dataMaps: {
                peMap: new Map(),
                ngss3dMap: new Map(),
                peTo3dMap: new Map(),
                parentToChildrenMap: new Map(),
                major3DMap: new Map(),
                nameToCodeMap: new Map(),
                textToSpecificCodeMap: new Map(),
                fuzzyMatchCache: new Map(),
                gradeBandMap: { 'K': 'primary', '1': 'primary', '2': 'primary', '3': 'elementary', '4': 'elementary', '5': 'elementary', 'MS': 'middle', 'HS': 'high' }
            },
            dom: {
                sidebar: document.getElementById('sidebar'),
                navigatorList: document.getElementById('navigator-list'),
                mainContent: document.getElementById('main-content'),
                plannerView: document.getElementById('planner-view'),
                plannerTableContainer: document.getElementById('planner-table-container'),
                tabContainer: document.getElementById('tab-container'),
                saveStatus: document.getElementById('save-status'),
                tooltip: document.getElementById('tooltip'),
                loadingIndicator: document.getElementById('loading-indicator'),
                body: document.getElementById('body-tag'),
                undoBtn: document.getElementById('undo-btn'),
                redoBtn: document.getElementById('redo-btn'),
                searchInput: document.getElementById('search-input'),
                plannerPhenomenon: document.getElementById('planner-phenomenon'),
                plannerQuestion: document.getElementById('planner-question'),
            },
            constants: {
                statusClasses: {
                    I: 'bg-yellow-200/50 dark:bg-yellow-700/30 border-yellow-300',
                    D: 'bg-green-200/50 dark:bg-green-700/30 border-green-300',
                    A: 'bg-blue-200/50 dark:bg-blue-700/30 border-blue-300',
                },
                statusBadgeClasses: {
                    I: 'bg-yellow-200 text-yellow-800 dark:bg-yellow-300 dark:text-yellow-900',
                    D: 'bg-green-200 text-green-800 dark:bg-green-300 dark:text-green-900',
                    A: 'bg-blue-200 text-blue-800 dark:bg-blue-300 dark:text-blue-900',
                },
                scopeClasses: {
                    F: 'bg-indigo-200/60 dark:bg-indigo-700/40 border-indigo-300',
                    S: 'bg-rose-200/60 dark:bg-rose-700/40 border-rose-300'
                }
            },

            init() {
                // buildDataMaps is now called in loadDataAndInit after fetching
                this.persistence.loadProgramData();
                this.render.navigator();
                this.attachEventListeners();
                this.tour.init();
                this.popover.init();
                this.utils.showView('welcome-view');

                this.dom.loadingIndicator.style.opacity = '0';
                setTimeout(() => {
                    this.dom.loadingIndicator.style.display = 'none';
                    if (!localStorage.getItem('ngssPlannerTourCompleted')) {
                        if (App.state.programData.planners.length > 0) {
                           this.tour.start();
                        }
                    }
                }, 500);
            },
            
            buildDataMaps() {
                const { ngss3dMap, peMap, peTo3dMap, parentToChildrenMap, major3DMap, nameToCodeMap, textToSpecificCodeMap, fuzzyMatchCache } = this.dataMaps;
                ngss3dMap.clear(); peMap.clear(); peTo3dMap.clear(); parentToChildrenMap.clear(); major3DMap.clear(); nameToCodeMap.clear(); textToSpecificCodeMap.clear(); fuzzyMatchCache.clear();
                
                const processElementForMaps = (element) => {
                    if (!element.name) return;
                    const firstColonIndex = element.name.indexOf(':');
                    if (firstColonIndex > -1) {
                        const code = element.name.substring(0, firstColonIndex).trim();
                        const nameOnly = element.name.substring(firstColonIndex + 1).trim();
                        major3DMap.set(code, nameOnly);
                        nameToCodeMap.set(element.name, code); 
                        nameToCodeMap.set(nameOnly, code);
                    }
                };
                
                this.state.allNgss3dElements.forEach(dim => {
                    let elementsToProcess = [];
                    if (dim.elements) {
                        elementsToProcess = dim.elements;
                    } else if (dim.core_ideas) {
                        elementsToProcess = dim.core_ideas;
                    } else if (dim.understandings) {
                        dim.understandings.forEach(understanding => {
                            if (understanding.elements) {
                                elementsToProcess.push(...understanding.elements);
                            }
                        });
                    }

                    elementsToProcess.forEach(el => {
                         const processProgressions = (item) => {
                             if(item.progressions){
                                 Object.values(item.progressions).forEach(pArr=>(pArr||[]).forEach(i=>{
                                     i.parentName = item.name;
                                     i.parentCode = item.name.split(':')[0].trim();
                                     i.dimension = dim.short_name;
                                     i.allProgressions = item.progressions;
                                     i.relatedPes = new Set();
                                     ngss3dMap.set(i.code,i);
                                     textToSpecificCodeMap.set(i.text.trim(), i.code);
                                 }));
                             }
                         };
                        processElementForMaps(el);
                        processProgressions(el);
                        if (el.components) {
                            el.components.forEach(comp => {
                                processElementForMaps(comp);
                                processProgressions(comp);
                            });
                        }
                    });
                });
                
                this.state.allNgssData.forEach(gradeData => gradeData.topics.forEach(t => t.performanceExpectations.forEach(p => {
                    peMap.set(p.id, p);
                    if (!p.details) return;

                    const componentCodes = new Set();
                    const secondaryComponentCodes = new Set();
                    const specificCodes = new Set();

                    ['sep', 'dci', 'ccc'].forEach(key => (p.details[key] || []).forEach(ref => {
                        let lineMatched = false;
                        const textLines = Array.isArray(ref.text) ? ref.text : (ref.text ? [ref.text] : []);
                        
                        textLines.forEach(line => {
                            if (!line.trim()) return;
                            const specCode = App.utils.findBestMatchingSpecificElement(line, gradeData.gradeLabel);
                            if (specCode) {
                                specificCodes.add(specCode);
                                const el = ngss3dMap.get(specCode);
                                if (el) {
                                    el.relatedPes.add(p.id);
                                    if (el.parentCode) componentCodes.add(el.parentCode);
                                }
                                lineMatched = true;
                            }
                        });
                        
                        if (!lineMatched) {
                            const isSecondary = ref.id.includes('(secondary)');
                            const cleanId = ref.id.replace(' (secondary)', '').trim();
                            const nameOnly = cleanId.includes(':') ? cleanId.split(':').pop().trim() : cleanId;
                            const cCode = nameToCodeMap.get(cleanId) || nameToCodeMap.get(nameOnly);
                            if (cCode) {
                                if(isSecondary) {
                                    secondaryComponentCodes.add(cCode);
                                } else {
                                    componentCodes.add(cCode);
                                }
                            }
                        }
                    }));

                    if (componentCodes.size > 0 || secondaryComponentCodes.size > 0 || specificCodes.size > 0) {
                        peTo3dMap.set(p.id, { componentCodes, secondaryComponentCodes, specificCodes });
                    }
                })));
                
                const processParent = (parent, dimShortName) => {
                    if (!parent.progressions) return;
                    const parentCode = parent.code || parent.name.split(':')[0].trim();
                    const children = [];
                    Object.values(parent.progressions).forEach(bandProg => { if(bandProg) children.push(...bandProg) });
                    const uniqueChildren = Array.from(new Map(children.map(item => [item.code, item])).values());
                    parentToChildrenMap.set(parentCode, {name: parent.name, children: uniqueChildren, dimension: dimShortName});
                };
                this.state.allNgss3dElements.forEach(dim => { (dim.elements || dim.core_ideas).forEach(el => { if (el.progressions) { processParent(el, dim.short_name); } else if (el.components) { el.components.forEach(comp => processParent(comp, dim.short_name)); } }); });
                parentToChildrenMap.set('PE', {name: "Performance Expectations", children: [], dimension: 'PE'});
            },

            attachEventListeners() {
                document.getElementById('new-planner-btn').addEventListener('click', () => this.utils.openPlannerModal());
                document.getElementById('view-progression-btn').addEventListener('click', () => this.render.progressionViewer());
                this.dom.navigatorList.addEventListener('click', e => { if (e.target.type === 'checkbox') return; const item = e.target.closest('.planner-item'); if (item) { this.render.plannerView(item.dataset.plannerId); if (window.innerWidth <= 768) this.dom.body.classList.remove('sidebar-open'); } });
                document.getElementById('assign-pe-btn').addEventListener('click', () => this.utils.openPeAssignmentModal());
                document.getElementById('view-summary-btn').addEventListener('click', () => this.render.summary());
                document.getElementById('add-lesson-set-btn').addEventListener('click', () => this.utils.addRow('lesson-set', 'New Lesson Set...'));
                document.getElementById('add-lesson-btn').addEventListener('click', () => this.utils.addRow('lesson', 'New Lesson...'));
                document.getElementById('edit-planner-btn').addEventListener('click', () => { const p = this.utils.findPlanner(this.state.currentPlannerId); if(p) this.utils.openPlannerModal(p); });
                
                this.dom.undoBtn.addEventListener('click', () => this.history.undo());
                this.dom.redoBtn.addEventListener('click', () => this.history.redo());
                this.dom.searchInput.addEventListener('input', e => this.utils.performSearch(e.target.value));
                document.getElementById('help-btn').addEventListener('click', () => this.tour.start());
                document.getElementById('welcome-help-btn').addEventListener('click', () => this.tour.start());
                document.getElementById('progression-view-element').addEventListener('click', () => { App.state.progressionViewType = 'element'; App.render.progressionViewer(); });
                document.getElementById('progression-view-lesson').addEventListener('click', () => { App.state.progressionViewType = 'lesson'; App.render.progressionViewer(); });

                document.getElementById('view-mode-toggle').addEventListener('click', () => this.utils.toggleViewMode());
                document.getElementById('pe-bundle-toggle').addEventListener('change', e => { App.state.isPeBundleMode = e.target.checked; App.render.setActiveTab(App.state.currentActiveTab); });
                document.getElementById('export-planner-btn').addEventListener('click', () => this.export.showExportOptions());
                document.getElementById('import-planner-btn').addEventListener('click', () => this.import.handleImport());
                document.getElementById('export-options-list').addEventListener('click', e => {
                    const btn = e.target.closest('.export-option-btn');
                    if (btn) {
                        const format = btn.dataset.format;
                        const planner = App.utils.findPlanner(App.state.currentPlannerId);
                        if (!planner) return;

                        switch (format) {
                            case 'json': this.export.asJson(planner); break;
                            case 'html': this.export.asHtml(planner); break;
                            case 'xlsx': this.export.asXlsx(planner); break;
                        }
                        this.utils.closeAllModals();
                    }
                });
                document.getElementById('import-options-confirm').addEventListener('click', () => this.import.processImport());

                this.dom.plannerTableContainer.addEventListener('click', e => this.handlers.mainTableClick(e));
                this.dom.plannerTableContainer.addEventListener('blur', e => { if (e.target.matches('.editable')) this.handlers.titleEdit(e) }, true);
                this.dom.tabContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) this.render.setActiveTab(e.target.dataset.tab); });
                document.body.addEventListener('mouseover', e => this.handlers.tooltipShow(e));
                document.body.addEventListener('mouseout', () => this.handlers.tooltipHide());

                this.dom.plannerTableContainer.addEventListener('dragstart', e => this.handlers.dragStart(e));
                this.dom.plannerTableContainer.addEventListener('dragover', e => this.handlers.dragOver(e));
                this.dom.plannerTableContainer.addEventListener('dragleave', e => this.handlers.dragLeave(e));
                this.dom.plannerTableContainer.addEventListener('drop', e => this.handlers.drop(e));

                document.getElementById('planner-modal-save').addEventListener('click', () => this.utils.savePlanner());
                document.getElementById('pe-modal-save').addEventListener('click', () => this.utils.savePeAssignments());
                document.getElementById('planner-modal-delete').addEventListener('click', () => { if (confirm('Are you sure? This cannot be undone.')) { const id = document.getElementById('planner-id-input').value; this.state.programData.planners = this.state.programData.planners.filter(p => p.id !== id); this.persistence.saveProgramData(); this.history.clear(); this.utils.closeAllModals(); this.utils.showView('welcome-view'); this.state.currentPlannerId = null; this.render.navigator(); } });
                
                document.getElementById('add-link-btn').addEventListener('click', () => this.utils.addLinkToDetailsModal());
                document.getElementById('lesson-links-container').addEventListener('click', (e) => { if(e.target.classList.contains('remove-link-btn')) this.utils.removeLinkFromDetailsModal(e.target); });
                document.getElementById('lesson-details-modal-close').addEventListener('click', () => this.utils.saveLessonDetails());

                document.body.addEventListener('click', e => { if(e.target.matches('.modal-backdrop, [id$="-modal-cancel"], [id$="-modal-close"]')) this.utils.closeAllModals(); });

                document.getElementById('menu-toggle').addEventListener('click', () => this.dom.body.classList.toggle('sidebar-open'));
                document.getElementById('sidebar-backdrop').addEventListener('click', () => this.dom.body.classList.remove('sidebar-open'));

                document.addEventListener('keydown', (e) => {
                    if (document.activeElement.isContentEditable || document.querySelector('.modal-backdrop:not(.hidden)')) return;
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); this.history.undo(); }
                        if (e.key === 'y') { e.preventDefault(); this.history.redo(); }
                    }
                });
            },
        };

        App.popover = {
            dom: {},
            state: { isVisible: false, activeCell: null, activeRowId: null },
            init() {
                this.dom.container = document.getElementById('element-popover');
                this.dom.title = document.getElementById('popover-title');
                this.dom.content = document.getElementById('popover-content');
                document.getElementById('popover-close').addEventListener('click', () => this.hide());
                this.dom.content.addEventListener('change', (e) => {
                    if (e.target.type === 'radio') this.handleSelectionChange(e.target);
                });
            },
            _handleOutsideClick(e) {
                if (this.state.isVisible && !this.dom.container.contains(e.target) && !this.state.activeCell.contains(e.target)) {
                    this.hide();
                }
            },
            show(cell, parentCode, rowId) {
                if (this.state.isVisible) this.hide();
                this.state.activeCell = cell;
                this.state.activeRowId = rowId;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const rowData = App.utils.findRowData(planner, rowId);
                if (!planner || !rowData) return;
                const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                this.dom.title.textContent = parentInfo ? parentInfo.name : 'Select Elements';
                this.dom.content.innerHTML = this.buildContentHTML(parentInfo, planner.gradeBand, rowData);
                this.dom.container.classList.remove('hidden');
                this.state.isVisible = true;
                this.position(cell);
                setTimeout(() => document.addEventListener('click', this._handleOutsideClick.bind(this), { capture: true, once: true }), 0);
            },
            hide() {
                this.dom.container.classList.add('hidden');
                this.state.isVisible = false;
                this.state.activeCell = null;
                this.state.activeRowId = null;
            },
            position(targetCell) {
                const rect = targetCell.getBoundingClientRect();
                const popover = this.dom.container;
                let top = rect.bottom + 8;
                let left = rect.left;
                if (top + popover.offsetHeight > window.innerHeight) top = rect.top - popover.offsetHeight - 8;
                if (left + popover.offsetWidth > window.innerWidth) left = rect.right - popover.offsetWidth;
                if (left < 8) left = 8;
                popover.style.top = `${top}px`;
                popover.style.left = `${left}px`;
            },
            buildContentHTML(parentInfo, gradeBand, rowData) {
                let children = [];
                if (parentInfo) {
                    const parentProgressions = parentInfo.children[0]?.allProgressions || {};
                    const gradeBandProgressions = parentProgressions[gradeBand] || [];
                    const validCodesForBand = new Set(gradeBandProgressions.map(p => p.code));
                    children = parentInfo.children.filter(child => validCodesForBand.has(child.code));
                }
                if (children.length === 0) return '<p class="text-center text-gray-500 dark:text-gray-400 p-8">No elements for this category in the selected grade band.</p>';
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                return children.map(child => {
                    const elData = App.dataMaps.ngss3dMap.get(child.code);
                    let indicatorHTML = '';
                    if (elData) {
                        const linkedPEs = [...elData.relatedPes].filter(peId => (planner.assignedPes || []).some(p => p.id === peId));
                        if (linkedPEs.length > 0) {
                            indicatorHTML = `<span class="pe-link-indicator" title="Linked to assigned PE(s): ${linkedPEs.join(', ')}">PE</span>`;
                        }
                    }
                    const currentStatus = rowData.trackingData[child.code] || '';
                    const u = `status-${child.code}`;
                    return `<div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div>
                                    <strong class="font-semibold">${child.code}</strong>${indicatorHTML}
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${child.text}</p>
                                </div>
                                <div class="flex gap-1.5 flex-shrink-0">
                                    <input type="radio" id="${u}-none" name="${u}" value="" ${!currentStatus&&'checked'} class="hidden peer/none"><label for="${u}-none" title="None" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-gray-300 dark:border-gray-600 font-bold text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 peer-checked/none:ring-2 ring-gray-400">-</label>
                                    <input type="radio" id="${u}-i" name="${u}" value="I" ${currentStatus==='I'&&'checked'} class="hidden peer/i"><label for="${u}-i" title="Introduced" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-yellow-400 font-bold text-sm bg-yellow-200 text-yellow-800 hover:bg-yellow-300 peer-checked/i:ring-2 ring-yellow-500">I</label>
                                    <input type="radio" id="${u}-d" name="${u}" value="D" ${currentStatus==='D'&&'checked'} class="hidden peer/d"><label for="${u}-d" title="Developed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-green-400 font-bold text-sm bg-green-200 text-green-800 hover:bg-green-300 peer-checked/d:ring-2 ring-green-500">D</label>
                                    <input type="radio" id="${u}-a" name="${u}" value="A" ${currentStatus==='A'&&'checked'} class="hidden peer/a"><label for="${u}-a" title="Assessed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-blue-400 font-bold text-sm bg-blue-200 text-blue-800 hover:bg-blue-300 peer-checked/a:ring-2 ring-blue-500">A</label>
                                </div>
                            </div>`;
                }).join('');
            },
            handleSelectionChange(radioInput) {
                const rowId = this.state.activeRowId;
                if (!rowId) return;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const rowData = App.utils.findRowData(planner, rowId);
                if (!rowData) return;
                App.history.saveState(planner);
                const code = radioInput.name.replace('status-', '');
                if (radioInput.value) {
                    rowData.trackingData[code] = radioInput.value;
                } else {
                    delete rowData.trackingData[code];
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            }
        };

        App.db = {
            db: null,
            DB_NAME: 'NGSSDataDB',
            STORE_NAME: 'ngss_data',
            DB_VERSION: 1,
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                    request.onerror = (event) => reject("IndexedDB error: " + request.error);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME);
                        }
                    };
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction([this.STORE_NAME], 'readonly');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            set(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        App.persistence = {
            saveProgramData() { localStorage.setItem('ngssProgramPlannerData', JSON.stringify(App.state.programData)); },
            loadProgramData() { const data = localStorage.getItem('ngssProgramPlannerData'); App.state.programData = data ? JSON.parse(data) : { programName: "My K-12 Science Program", planners: [] }; },
            debouncedSave() { clearTimeout(App.state.saveTimeout); App.dom.saveStatus.textContent = 'Saving...'; App.state.saveTimeout = setTimeout(() => { const planner = App.utils.findPlanner(App.state.currentPlannerId); if (planner) { planner.activeTab = App.state.currentActiveTab; this.saveProgramData(); App.dom.saveStatus.innerHTML = `Saved ✓ <span class="font-normal">${new Date().toLocaleTimeString()}</span>`; } }, 1000); },
            updateStateFromTableOrder() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                if (!tbody) return;
                const newRowsState = [];
                const allRowsMap = new Map();
                planner.rows.forEach(row => {
                    allRowsMap.set(row.id, row.type === 'lesson-set' ? { ...row, children: [] } : { ...row });
                    if (row.children) {
                        row.children.forEach(child => allRowsMap.set(child.id, { ...child }));
                    }
                });
                let currentLessonSet = null;
                Array.from(tbody.children).forEach(rowEl => {
                    const id = rowEl.dataset.id;
                    const rowData = allRowsMap.get(id);
                    if (!rowData) return;
                    if (rowData.type === 'lesson-set') {
                        currentLessonSet = rowData;
                        newRowsState.push(currentLessonSet);
                    } else if (rowData.type === 'lesson') {
                        if (currentLessonSet) {
                            currentLessonSet.children.push(rowData);
                        } else {
                            newRowsState.push(rowData);
                        }
                    }
                });
                planner.rows = newRowsState;
            }
        };

        App.history = {
            saveState(planner) {
                if (!planner) return;
                const stateCopy = JSON.parse(JSON.stringify(planner));
                App.state.undoStack.push(stateCopy);
                App.state.redoStack = []; 
                this.updateUndoRedoButtons();
            },
            
            undo() {
                if (App.state.undoStack.length === 0) return;
                
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const currentState = JSON.parse(JSON.stringify(planner));
                App.state.redoStack.push(currentState);
                
                const previousState = App.state.undoStack.pop();
                Object.assign(planner, previousState);
                
                App.render.plannerView(App.state.currentPlannerId);
                App.persistence.saveProgramData(); 
                this.updateUndoRedoButtons();
            },

            redo() {
                if (App.state.redoStack.length === 0) return;

                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const currentState = JSON.parse(JSON.stringify(planner));
                App.state.undoStack.push(currentState);

                const nextState = App.state.redoStack.pop();
                Object.assign(planner, nextState);
                
                App.render.plannerView(App.state.currentPlannerId);
                App.persistence.saveProgramData();
                this.updateUndoRedoButtons();
            },

            clear() {
                App.state.undoStack = [];
                App.state.redoStack = [];
                this.updateUndoRedoButtons();
            },
            
            updateUndoRedoButtons() {
                App.dom.undoBtn.disabled = App.state.undoStack.length === 0;
                App.dom.redoBtn.disabled = App.state.redoStack.length === 0;
            }
        };

        App.render = {
            navigator() { App.dom.navigatorList.innerHTML = ''; App.state.programData.planners.forEach(planner => { const item = document.createElement('li'); item.className = `planner-item flex items-center gap-2 p-2 rounded-md cursor-pointer transition-colors user-select-none ${planner.id === App.state.currentPlannerId ? 'bg-blue-600 font-bold' : 'hover:bg-gray-700'}`; item.dataset.plannerId = planner.id; item.innerHTML = `<input type="checkbox" class="planner-checkbox" title="Select for progression view"><span class="planner-title flex-grow pointer-events-none">${planner.title}</span><span class="planner-band text-xs bg-gray-600 px-2 py-0.5 rounded-full text-white">${planner.gradeBand}</span>`; App.dom.navigatorList.appendChild(item); }); },
            plannerView(plannerId) {
                const planner = App.utils.findPlanner(plannerId); if (!planner) { App.utils.showView('welcome-view'); return; }
                App.state.currentPlannerId = plannerId;
                App.history.clear(); 

                document.getElementById('planner-title').textContent = planner.title;
                document.getElementById('planner-subtitle').textContent = `${planner.course} (${planner.gradeBand})`;
                App.dom.plannerPhenomenon.textContent = planner.phenomenon || 'Not specified.';
                App.dom.plannerQuestion.textContent = planner.question || 'Not specified.';

                const allColumns = App.utils.gatherColumns(planner.gradeBand);
                
                this.tabs(allColumns);
                this.renderPlannerContent(); 

                this.setActiveTab(planner.activeTab || 'pe');
                App.utils.showView('planner-view');
                this.navigator();
            },
            renderPlannerContent() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                const allColumns = App.utils.gatherColumns(planner.gradeBand);

                this.table(allColumns);
                this.rowsFromState(planner.rows || []);
            },
            table(columnGroups) {
                App.dom.plannerTableContainer.innerHTML = ''; const table = document.createElement('table'); table.className = 'table-view w-full border-collapse'; const thead = document.createElement('thead');
                let headerRowHTML = `<tr>
                    <th class="sticky-col-1"><div class="w-full">Actions</div></th>
                    <th class="sticky-col-2"><div class="w-full">Scope</div></th>
                    <th class="sticky-col-3"><div class="w-full">Instructional Sequence</div></th>`;
                
                const planner = App.utils.findPlanner(App.state.currentPlannerId);

                Object.keys(columnGroups).forEach(key => {
                    if (key === 'pe') {
                        (planner?.assignedPes || []).forEach(peObj => {
                             const peCode = peObj.id;
                             const peData = App.dataMaps.peMap.get(peCode);
                             const tooltip = peData ? `${peCode}: ${peData.description.replace(/"/g, '&quot;')}` : peCode;
                             const secondaryClass = peObj.isSecondary ? 'font-normal italic text-gray-500 dark:text-gray-400' : 'font-semibold';
                             headerRowHTML += `<th class="cursor-pointer ${secondaryClass}" data-tab-group="pe" data-code="${peCode}" data-tooltip="${tooltip}"><div>${peCode}</div></th>`;
                        });
                        if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                            headerRowHTML += `<th class="font-normal" data-tab-group="pe"><div>Assign PEs</div></th>`;
                        }
                    } else {
                        columnGroups[key].cols.forEach(col => {
                            headerRowHTML += `<th class="cursor-pointer" data-tab-group="${key}" data-code="${col.code}" data-tooltip="${col.title}"><div>${col.title}</div></th>`;
                        });
                    }
                });
                headerRowHTML += '</tr>'; thead.innerHTML = headerRowHTML; table.appendChild(thead); table.appendChild(document.createElement('tbody')); App.dom.plannerTableContainer.appendChild(table);
            },
            rowsFromState(rowsData) {
                const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                tbody.innerHTML = '';
                if (!rowsData || rowsData.length === 0) return;
                rowsData.forEach(rowData => {
                    tbody.appendChild(this.createRowElement(rowData));
                    if (rowData.type === 'lesson-set' && rowData.children) {
                        rowData.children.forEach(childRowData => {
                            const childRow = this.createRowElement(childRowData, rowData.id);
                            if (rowData.isCollapsed) childRow.classList.add('hidden');
                            tbody.appendChild(childRow);
                        });
                    }
                });
                this.updateTableHeaderHighlights();
            },
            createRowElement(rowData, parentId = null) {
                const row = document.createElement('tr');
                const searchTerm = App.dom.searchInput.value.toLowerCase();
                if (searchTerm && rowData.type === 'lesson') {
                    const rowText = (rowData.title + ' ' + Object.keys(rowData.trackingData || {}).join(' ')).toLowerCase();
                    if (!rowText.includes(searchTerm)) {
                        row.classList.add('filtered-out');
                    }
                }
                
                row.className += ` ${rowData.type}-row group/row`; row.dataset.rowType = rowData.type; row.dataset.id = rowData.id;
                row.draggable = !App.state.isViewMode;

                const planner = App.utils.findPlanner(App.state.currentPlannerId); const columnGroups = App.utils.gatherColumns(planner.gradeBand);
                if (rowData.type === 'lesson-set') {
                    const isCollapsedClass = rowData.isCollapsed ? 'is-collapsed' : '';
                    const rotateClass = rowData.isCollapsed ? '-rotate-90' : '';
                    const editableSpan = `<span class="editable group-[.view-mode-active]:cursor-default group-[.view-mode-active]:bg-transparent group-[.view-mode-active]:outline-none hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="${!App.state.isViewMode}">${rowData.title}</span>`;
                    
                    let cellsHTML = `
                        <td class="sticky-col-1 p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50 align-middle"><span class="drag-handle cursor-grab group-[.view-mode-active]:hidden">⠿</span> <span class="delete-btn cursor-pointer text-gray-400 font-bold invisible group-hover/row:visible hover:text-red-500 transition-colors group-[.view-mode-active]:hidden" title="Delete Lesson Set">✖</span></td>
                        <td class="sticky-col-2 p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50 align-middle"></td>
                        <td class="sticky-col-3 p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 font-semibold cursor-pointer ${isCollapsedClass}"><span class="collapse-icon inline-block mr-1 transition-transform ${rotateClass}">▼</span> ${editableSpan}</td>`;
                    
                    Object.keys(columnGroups).forEach(key => {
                        if (key === 'pe') {
                            const peCount = planner?.assignedPes?.length || 0;
                            if (peCount > 0) {
                                cellsHTML += `<td data-tab-group="pe" class="p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50" colspan="${peCount}"></td>`;
                            } else {
                                cellsHTML += `<td data-tab-group="pe" class="p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50"></td>`;
                            }
                        } else {
                            columnGroups[key].cols.forEach(() => {
                                cellsHTML += `<td data-tab-group="${key}" class="p-2 border border-gray-200 dark:border-gray-700 bg-blue-100 dark:bg-blue-900/50"></td>`;
                            });
                        }
                    });
                    row.innerHTML = cellsHTML;

                } else {
                    if (parentId) row.dataset.parentId = parentId;
                    const scope = rowData.scope || '';
                    const scopeClass = App.constants.scopeClasses[scope] || '';
                    const scopeCursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer';
                    const editableSpan = `<span class="editable group-[.view-mode-active]:cursor-default group-[.view-mode-active]:bg-transparent group-[.view-mode-active]:outline-none hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="${!App.state.isViewMode}">${rowData.title}</span>`;
                    const notesIcon = `<span class="notes-btn cursor-pointer text-base" title="Edit Notes & Links">📝</span>`;
                    let cellsHTML = `
                        <td class="sticky-col-1 p-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 align-middle">
                            <div class="flex items-center justify-between gap-1.5 text-gray-400">
                                <span class="drag-handle cursor-grab group-[.view-mode-active]:hidden">⠿</span>
                                <div class="flex items-center gap-1.5 invisible group-hover/row:visible">
                                    ${notesIcon}
                                    <span class="delete-btn cursor-pointer font-bold hover:text-red-500 transition-colors group-[.view-mode-active]:hidden" title="Delete Lesson">✖</span>
                                    <span class="add-below-btn cursor-pointer hover:text-green-500 transition-colors group-[.view-mode-active]:hidden" title="Add Lesson Below">+</span>
                                    <span class="copy-row-btn cursor-pointer hover:text-blue-500 transition-colors group-[.view-mode-active]:hidden" title="Duplicate Lesson">❐</span>
                                </div>
                            </div>
                        </td>
                        <td data-scope-cell="true" class="sticky-col-2 p-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 align-middle font-bold text-center ${scopeCursorClass} ${scopeClass}" data-tooltip="Click to cycle Assessment Scope">${scope}</td>
                        <td class="sticky-col-3 p-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-left ${parentId ? 'pl-10' : ''}">${editableSpan}</td>`;

                    Object.keys(columnGroups).forEach(key => {
                         if (key === 'pe') {
                             (planner?.assignedPes || []).forEach(peObj => {
                                 cellsHTML += this.createTrackingCellHTML({ code: peObj.id, type: 'pe' }, rowData);
                             });
                             if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                                cellsHTML += `<td data-tab-group="pe" class="p-2 border border-gray-200 dark:border-gray-700"></td>`;
                             }
                         } else {
                            cellsHTML += columnGroups[key].cols.map(col => this.createTrackingCellHTML({ code: col.code, title: col.title, type: '3d', tabGroup: key }, rowData)).join('');
                         }
                    });
                    row.innerHTML = cellsHTML;
                } return row;
            },
            createTrackingCellHTML(column, rowData) {
                const commonCellClasses = "p-2 border border-gray-200 dark:border-gray-700 align-top";
                if (column.type === 'pe') {
                    const status = rowData.trackingData?.[column.code] || '';
                    const statusClass = App.constants.statusClasses[status] || '';
                    const cursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer hover:bg-yellow-300/50 dark:hover:bg-yellow-500/50';
                    return `<td class="${commonCellClasses} text-center font-bold ${cursorClass} ${statusClass}" data-tab-group="pe" data-pe-code="${column.code}" data-tooltip="Click to change status for ${column.code}">${status}</td>`;
                }
                const parentCode = column.code; 
                const cellTooltip = `${column.title}. Click to edit elements.`;
                const cursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50';
                const cellContent = this.generateCellContent(parentCode, rowData);
                return `<td class="${commonCellClasses} ${cursorClass}" data-tab-group="${column.tabGroup}" data-parent-code="${parentCode}" data-tooltip="${cellTooltip}">${cellContent}</td>`;
            },
            generateCellContent(parentCode, rowData) {
                const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                const childrenCodes = parentInfo ? parentInfo.children.map(c => c.code) : [];
                const trackedChildren = childrenCodes.filter(code => rowData.trackingData?.[code]).map(code => ({ code, status: rowData.trackingData[code] }));
                const badgeHTML = trackedChildren.map(child => {
                    const details = App.dataMaps.ngss3dMap.get(child.code) || {description: 'N/A', text: 'N/A'};
                    const text = (details.text || details.description).replace(/"/g, '&quot;');
                    const badgeTooltip = `<b>${child.code} (${child.status})</b>: ${text}`;
                    const badgeColor = App.constants.statusBadgeClasses[child.status] || 'bg-gray-200 dark:bg-gray-600';
                    return `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${badgeTooltip}">${child.code}</span>`;
                }).join('');
                return `<div class="flex flex-wrap gap-1 items-center min-h-[24px]">${badgeHTML}</div>`;
            },
            tabs(columnGroups) { App.dom.tabContainer.innerHTML = ''; Object.keys(columnGroups).forEach(key => { if(columnGroups[key].cols.length > 0 || key === 'pe') { const btn = document.createElement('button'); btn.className = 'tab-button px-4 py-2 cursor-pointer border border-transparent rounded-t-lg font-medium transition-colors text-sm'; btn.dataset.tab = key; btn.textContent = columnGroups[key].name; App.dom.tabContainer.appendChild(btn); } }); },
            setActiveTab(tabKey) {
                const table = App.dom.plannerTableContainer.querySelector('table');
                if (!table || !App.dom.tabContainer.querySelector(`[data-tab="${tabKey}"]`)) {
                    tabKey = 'pe';
                }
                App.state.currentActiveTab = tabKey;
                App.dom.tabContainer.querySelectorAll('.tab-button').forEach(b => {
                    const isActive = b.dataset.tab === tabKey;
                    b.classList.toggle('bg-white', isActive); b.classList.toggle('dark:bg-gray-800/50', isActive); b.classList.toggle('border-gray-300', isActive); b.classList.toggle('dark:border-gray-700', isActive); b.classList.toggle('border-b-white', isActive); b.classList.toggle('dark:border-b-gray-800/50', isActive); b.classList.toggle('text-blue-600', isActive); b.classList.toggle('dark:text-blue-400', isActive); b.classList.toggle('bg-gray-100', !isActive); b.classList.toggle('dark:bg-transparent', !isActive); b.classList.toggle('text-gray-500', !isActive); b.classList.toggle('dark:text-gray-400', !isActive); b.classList.toggle('hover:text-gray-700', !isActive); b.classList.toggle('dark:hover:text-gray-200', !isActive);
                });
                if (table) {
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    let bundledParentCodes = null;
                    if (App.state.isPeBundleMode && planner) {
                        bundledParentCodes = new Set();
                        const assignedPes = (planner.assignedPes || []).map(p => p.id);
                        assignedPes.forEach(peCode => {
                            const links = App.dataMaps.peTo3dMap.get(peCode);
                            if (links) {
                                links.specificCodes.forEach(specificCode => {
                                    const element = App.dataMaps.ngss3dMap.get(specificCode);
                                    if (element && element.parentCode) {
                                        bundledParentCodes.add(element.parentCode);
                                    }
                                });
                            }
                        });
                    }
                    table.querySelectorAll('th[data-tab-group], td[data-tab-group]').forEach(cell => {
                        const isVisibleForTab = cell.dataset.tabGroup === tabKey;
                        let isVisibleForBundle = true; 
                        if (bundledParentCodes !== null && cell.dataset.tabGroup !== 'pe') {
                            const code = cell.dataset.code || cell.dataset.parentCode;
                            isVisibleForBundle = bundledParentCodes.has(code);
                        }
                        cell.style.display = (isVisibleForTab && isVisibleForBundle) ? '' : 'none';
                    });
                }
                App.persistence.debouncedSave();
            },
            updateTableHeaderHighlights() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId); if (!planner) return;
                const assignedPes = planner.assignedPes || [];
                const primaryLinks = new Set();
                const secondaryLinks = new Set();

                assignedPes.forEach(peObj => {
                    const links = App.dataMaps.peTo3dMap.get(peObj.id);
                    if (!links) return;
                    
                    const targetSet = peObj.isSecondary ? secondaryLinks : primaryLinks;
                    links.componentCodes.forEach(code => targetSet.add(code));
                    links.specificCodes.forEach(code => {
                        const el = App.dataMaps.ngss3dMap.get(code);
                        if(el && el.parentCode) targetSet.add(el.parentCode);
                    });
                    links.secondaryComponentCodes.forEach(code => secondaryLinks.add(code));
                });
            
                App.dom.plannerTableContainer.querySelectorAll('thead th[data-code]').forEach(th => {
                    const code = th.dataset.code;
                    th.classList.remove('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold', 'bg-gray-300', 'dark:bg-gray-700', 'bg-gray-400/50', 'dark:bg-gray-600/50');
                    th.classList.add('bg-gray-200', 'dark:bg-gray-800');

                    const isPrimaryPe = assignedPes.some(p => p.id === code && !p.isSecondary);
                    const isSecondaryPe = assignedPes.some(p => p.id === code && p.isSecondary);

                    if (isPrimaryPe) {
                        th.classList.add('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold');
                    } else if (isSecondaryPe) {
                        th.classList.add('bg-blue-100', 'dark:bg-blue-900/20');
                    } else if (primaryLinks.has(code)) {
                        th.classList.add('bg-gray-300', 'dark:bg-gray-700');
                    } else if (secondaryLinks.has(code)) {
                        th.classList.add('bg-gray-400/50', 'dark:bg-gray-600/50');
                    }
                });
            },
            progressionViewer() { 
                const btnElement = document.getElementById('progression-view-element');
                const btnLesson = document.getElementById('progression-view-lesson');
                
                btnElement.classList.toggle('bg-white', App.state.progressionViewType === 'element');
                btnElement.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'element');
                btnLesson.classList.toggle('bg-white', App.state.progressionViewType === 'lesson');
                btnLesson.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'lesson');
                
                if (App.state.progressionViewType === 'lesson') {
                    this.renderProgressionByLesson();
                } else {
                    this.renderProgressionByElement();
                }
                App.utils.showView('progression-view'); 
            },
            renderProgressionByElement() {
                const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                if (selectedPlannerIds.length === 0) { 
                    alert('Please select at least one planner from the navigator to view its progression.'); 
                    return; 
                } 
                const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id)); 
                const tableContainer = document.getElementById('progression-table-view');
                tableContainer.innerHTML = '';
                document.getElementById('progression-subtitle').textContent = `Comparing: ${selectedPlanners.map(p => p.title).join(', ')}`; 
                
                const allTrackedElements = new Map(); 
                const allUnique3DElements = new Map();

                selectedPlanners.forEach(planner => { 
                    (planner.rows || []).forEach(row => { 
                        const processLesson = (lesson, lessonSetTitle = null) => { 
                            if (!lesson.trackingData) return;
                            Object.entries(lesson.trackingData).forEach(([code, status]) => { 
                                const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                                if (elementData) {
                                    if (!allTrackedElements.has(code)) { 
                                        allTrackedElements.set(code, []);
                                        allUnique3DElements.set(code, elementData);
                                    } 
                                    allTrackedElements.get(code).push({ plannerId: planner.id, lessonTitle: lesson.title, lessonSetTitle: lessonSetTitle, status: status });
                                }
                            }); 
                        }; 
                        if (row.type === 'lesson') processLesson(row); 
                        else if (row.type === 'lesson-set' && row.children) row.children.forEach(lesson => processLesson(lesson, row.title)); 
                    }); 
                }); 

                const groupedElements = { PE: [], SEP: [], DCI: [], CCC: [] };
                const groupNames = { PE: "Performance Expectations", SEP: "Science and Engineering Practices", DCI: "Disciplinary Core Ideas", CCC: "Crosscutting Concepts & Connections" };

                allUnique3DElements.forEach((elementData, code) => {
                    if (App.dataMaps.peMap.has(code)) {
                        groupedElements.PE.push([code, elementData]);
                    } else {
                        const dim = elementData.dimension || '';
                        if (dim.startsWith('SEP')) groupedElements.SEP.push([code, elementData]);
                        else if (dim.startsWith('DCI')) groupedElements.DCI.push([code, elementData]);
                        else groupedElements.CCC.push([code, elementData]);
                    }
                });

                for (const key in groupedElements) {
                    groupedElements[key].sort((a, b) => a[0].localeCompare(b[0]));
                }

                let tableHTML = `<table class="w-full border-collapse"><thead><tr class="bg-gray-200 dark:bg-gray-800"><th class="sticky p-2 border border-gray-300 dark:border-gray-700 text-left top-0 bg-gray-200 dark:bg-gray-800">3D Element / PE</th>`;
                selectedPlanners.forEach(p => { tableHTML += `<th class="p-2 border border-gray-300 dark:border-gray-700 text-left sticky top-0 bg-gray-200 dark:bg-gray-800">${p.title}</th>`; });
                tableHTML += `</tr></thead><tbody>`;

                Object.keys(groupedElements).forEach(groupKey => {
                    const elements = groupedElements[groupKey];
                    if (elements.length > 0) {
                        tableHTML += `<tr><th colspan="${selectedPlanners.length + 1}" class="p-2 text-left bg-gray-100 dark:bg-gray-900/50 font-bold text-lg text-gray-700 dark:text-gray-300 border-t-4 border-b-2 border-gray-300 dark:border-gray-600">${groupNames[groupKey]}</th></tr>`;
                        
                        elements.forEach(([code, elementData]) => {
                            const desc = elementData.text || elementData.description || '';
                            const elementTooltip = desc.replace(/"/g, '&quot;');
                            tableHTML += `<tr class="border-b dark:border-gray-700">
                                <td class="p-2 border border-gray-300 dark:border-gray-700 align-top font-semibold sticky left-0 bg-gray-50 dark:bg-gray-800/50 shadow-[4px_0_5px_-2px_rgba(0,0,0,0.05)] dark:shadow-[4px_0_5px_-2px_rgba(0,0,0,0.2)]">
                                    <strong data-tooltip="${elementTooltip}">${code}</strong><br><small class="font-normal text-gray-600 dark:text-gray-400">${desc}</small>
                                </td>`;
                            selectedPlanners.forEach(planner => {
                                const entriesForPlanner = (allTrackedElements.get(code) || []).filter(e => e.plannerId === planner.id);
                                let cellContent = '<div class="flex flex-col space-y-2">';
                                if (entriesForPlanner.length > 0) {
                                    cellContent += entriesForPlanner.map(e => {
                                       const tooltip = `${e.lessonSetTitle ? `${e.lessonSetTitle} &rarr; ` : ''}${e.lessonTitle}`;
                                       const badgeColor = App.constants.statusBadgeClasses[e.status] || 'bg-gray-200 dark:bg-gray-600';
                                       return `<div class="flex items-center gap-2 text-sm">
                                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 ${badgeColor}" data-tooltip="${tooltip.replace(/"/g, '&quot;')}">${e.status}</span>
                                                <span class="truncate" title="${tooltip}">${tooltip}</span>
                                               </div>`;
                                    }).join('');
                                }
                                cellContent += '</div>';
                                tableHTML += `<td class="p-2 border border-gray-300 dark:border-gray-700 align-top">${cellContent}</td>`;
                            });
                            tableHTML += `</tr>`;
                        });
                    }
                });
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            },
            renderProgressionByLesson() {
                const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                if (selectedPlannerIds.length === 0) { 
                    alert('Please select at least one planner from the navigator to view its progression.'); 
                    return; 
                } 
                // "By Lesson" view only makes sense for one planner at a time.
                const planner = App.utils.findPlanner(selectedPlannerIds[0]);
                if (!planner) return;
                
                const container = document.getElementById('progression-table-view');
                container.innerHTML = '';
                document.getElementById('progression-subtitle').textContent = `Storyline for: ${planner.title}`;

                (planner.rows || []).forEach(row => {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'mb-4';
                    if (row.type === 'lesson-set') {
                        rowEl.innerHTML = `<h3 class="text-lg font-bold p-2 bg-blue-100 dark:bg-blue-900/50 rounded-t-lg text-blue-800 dark:text-blue-200">${row.title}</h3>`;
                        (row.children || []).forEach(lesson => {
                            rowEl.innerHTML += this.createStorylineLessonHTML(lesson);
                        });
                    } else {
                        rowEl.innerHTML = this.createStorylineLessonHTML(row);
                    }
                    container.appendChild(rowEl);
                });
            },
            createStorylineLessonHTML(lesson) {
                 const groupedBadges = { PE: [], SEP: [], DCI: [], CCC: [] };

                 Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                    const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                    const desc = elementData ? (elementData.text || elementData.description) : 'Unknown Element';
                    const tooltip = `<b>${code} (${status})</b>: ${desc.replace(/"/g, '&quot;')}`;
                    const badgeColor = App.constants.statusBadgeClasses[status] || 'bg-gray-200 dark:bg-gray-600';
                    const badgeHTML = `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${tooltip}">${code}</span>`;

                    if (App.dataMaps.peMap.has(code)) {
                        groupedBadges.PE.push(badgeHTML);
                    } else if (elementData) {
                        const dim = elementData.dimension || '';
                        if (dim.startsWith('SEP')) groupedBadges.SEP.push(badgeHTML);
                        else if (dim.startsWith('DCI')) groupedBadges.DCI.push(badgeHTML);
                        else groupedBadges.CCC.push(badgeHTML);
                    }
                });

                let finalHTML = '';
                const groupOrder = ['PE', 'DCI', 'SEP', 'CCC'];
                const groupNames = { PE: 'PEs', DCI: 'DCIs', SEP: 'SEPs', CCC: 'CCCs' };

                groupOrder.forEach(key => {
                    if (groupedBadges[key].length > 0) {
                        finalHTML += `<div class="flex items-start gap-2 mb-1.5">
                                        <strong class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 w-10 flex-shrink-0 pt-0.5">${groupNames[key]}:</strong>
                                        <div class="flex flex-wrap gap-1.5">${groupedBadges[key].join('')}</div>
                                      </div>`;
                    }
                });

                return `
                    <div class="p-3 border dark:border-gray-700 bg-white dark:bg-gray-800/50">
                        <h4 class="font-semibold">${lesson.title}</h4>
                        <div class="mt-2 space-y-2">
                            ${finalHTML || '<p class="text-xs text-gray-500 dark:text-gray-400">No elements tracked.</p>'}
                        </div>
                    </div>
                `;
            },
            summary() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;

                document.getElementById('summary-subtitle').textContent = planner.title;
                const container = document.getElementById('summary-content');
                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><h3 class="font-bold mb-2">3D Element Status Distribution</h3><canvas id="status-chart"></canvas></div>
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><h3 class="font-bold mb-2">Dimension Usage Balance</h3><canvas id="dimension-chart"></canvas></div>
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow"><h3 class="font-bold mb-2">Assessment Scope</h3><canvas id="scope-chart"></canvas></div>
                    </div>
                     <div class="mt-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-4">Element Coverage Report</h3>
                        <div id="element-coverage-report" class="space-y-6"></div>
                    </div>
                `;

                const allLessons = [];
                (planner.rows || []).forEach(row => {
                    if (row.type === 'lesson') allLessons.push(row);
                    else if (row.type === 'lesson-set') allLessons.push(...(row.children || []));
                });

                const statusCounts = { I: 0, D: 0, A: 0 };
                const dimensionCounts = { SEP: 0, DCI: 0, CCC: 0, PE: 0 };
                const scopeCounts = { F: 0, S: 0, None: 0};

                allLessons.forEach(lesson => {
                    scopeCounts[lesson.scope || 'None']++;
                    Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                        statusCounts[status]++;
                        const element = App.dataMaps.ngss3dMap.get(code);
                        if (element) {
                            if (element.dimension.startsWith('SEP')) dimensionCounts.SEP++;
                            else if (element.dimension.startsWith('DCI')) dimensionCounts.DCI++;
                            else if (element.dimension.startsWith('CCC') || element.dimension.startsWith('C-ETAS') || element.dimension.startsWith('CNS')) {
                                dimensionCounts.CCC++; // Grouping connections under CCC for this chart
                            }
                        } else if (App.dataMaps.peMap.has(code)) {
                            dimensionCounts.PE++;
                        }
                    });
                });

                new Chart(document.getElementById('status-chart'), {
                    type: 'bar',
                    data: {
                        labels: ['Introduced (I)', 'Developed (D)', 'Assessed (A)'],
                        datasets: [{ label: 'Element Count', data: [statusCounts.I, statusCounts.D, statusCounts.A], backgroundColor: ['#FBBF24', '#34D399', '#60A5FA'] }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } } }
                });

                 new Chart(document.getElementById('dimension-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SEPs', 'DCIs', 'CCCs & Connections', 'PEs'],
                        datasets: [{ data: [dimensionCounts.SEP, dimensionCounts.DCI, dimensionCounts.CCC, dimensionCounts.PE], backgroundColor: ['#818CF8', '#F87171', '#FB923C', '#60A5FA'] }]
                    },
                    options: { responsive: true }
                });

                new Chart(document.getElementById('scope-chart'), {
                    type: 'pie',
                    data: {
                        labels: ['Formative (F)', 'Summative (S)', 'Not Scoped'],
                        datasets: [{ data: [scopeCounts.F, scopeCounts.S, scopeCounts.None], backgroundColor: ['#6366F1', '#EC4899', '#A1A1AA'] }]
                    },
                    options: { responsive: true }
                });
                
                const coverageReportContainer = document.getElementById('element-coverage-report');
                const allColumns = App.utils.gatherColumns(planner.gradeBand);
                const coverageMap = new Map();

                allLessons.forEach(lesson => {
                    Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                        if (!App.dataMaps.ngss3dMap.has(code)) return;
                        if (!coverageMap.has(code)) {
                            coverageMap.set(code, { I: 0, D: 0, A: 0 });
                        }
                        coverageMap.get(code)[status]++;
                    });
                });

                let reportHTML = '';
                const groupOrder = ['dci', 'sep', 'ccc'];
                groupOrder.forEach(groupKey => {
                    const group = allColumns[groupKey];
                    if (group.cols.length === 0) return;

                    reportHTML += `<div class="mb-4">
                                    <h4 class="text-xl font-semibold border-b-2 pb-2 mb-3 dark:border-gray-600">${group.name}</h4>`;
                    
                    group.cols.forEach(parentCol => {
                        const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCol.code);
                        if (!parentInfo) return;
                        
                        reportHTML += `<div class="mb-4 pl-2">
                                        <h5 class="font-bold text-gray-800 dark:text-gray-200">${parentInfo.name}</h5>
                                        <ul class="list-disc pl-5 mt-1 space-y-2 text-sm">`;
                        
                        const gradeBandProgressions = parentInfo.children[0]?.allProgressions?.[planner.gradeBand] || [];
                        const validCodesForBand = new Set(gradeBandProgressions.map(p => p.code));
                        const childrenForBand = parentInfo.children.filter(child => validCodesForBand.has(child.code));

                        if (childrenForBand.length === 0) {
                            reportHTML += `<li class="text-gray-500">No elements for this grade band.</li>`;
                        } else {
                            childrenForBand.forEach(child => {
                                const coverage = coverageMap.get(child.code);
                                let coverageString = '';
                                if (coverage) {
                                    coverageString = Object.entries(coverage)
                                        .filter(([, count]) => count > 0)
                                        .map(([status, count]) => `<span class="px-2 py-0.5 rounded-full text-xs font-bold ${App.constants.statusBadgeClasses[status]}">${status}: ${count}</span>`)
                                        .join(' ');
                                } else {
                                    coverageString = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300">Not Covered</span>`;
                                }
                                reportHTML += `<li>
                                                <div class="flex justify-between items-center flex-wrap gap-2">
                                                    <span><strong>${child.code}:</strong> ${child.text}</span>
                                                    <span class="flex-shrink-0 ml-4 text-right flex flex-wrap gap-1.5">${coverageString}</span>
                                                </div>
                                               </li>`;
                            });
                        }
                        reportHTML += `</ul></div>`;
                    });
                    reportHTML += `</div>`;
                });
                coverageReportContainer.innerHTML = reportHTML;

                App.utils.showView('summary-view');
            }
        };

        App.handlers = {
            mainTableClick(e) {
                const target = e.target;
                const rowEl = target.closest('[data-id]');
                if (!rowEl || App.state.isViewMode) return;
                
                const rowId = rowEl.dataset.id;
                
                const notesBtn = target.closest('.notes-btn');
                if (notesBtn) { App.utils.openLessonDetailsModal(rowId); return; }
                
                const deleteBtn = target.closest('.delete-btn');
                if (deleteBtn) { if (confirm('Delete this row?')) { App.utils.deleteRow(rowId); } return; }
                
                const addBelowBtn = target.closest('.add-below-btn');
                if (addBelowBtn) { App.utils.addRowAdjacent(rowId, 'below'); return; }

                const copyBtn = target.closest('.copy-row-btn');
                if (copyBtn) { App.utils.copyRow(rowId); return; }

                const peCell = target.closest('[data-pe-code]');
                if (peCell) { App.utils.cyclePeStatus(rowId, peCell.dataset.peCode); return; }

                const scopeCell = target.closest('[data-scope-cell]');
                if(scopeCell) { App.utils.cycleScopeStatus(rowId); return; }

                const trackingCell = target.closest('[data-parent-code]'); 
                if (trackingCell) { App.popover.show(trackingCell, trackingCell.dataset.parentCode, rowId); return; }

                const headerCell = target.closest('th[data-code]'); 
                if (headerCell) { App.utils.openElementDetailModal(headerCell.dataset.code); return; }
                
                const lessonSetRow = target.closest('.lesson-set-row');
                if (lessonSetRow && !target.matches('.editable')) { 
                    App.history.saveState(App.utils.findPlanner(App.state.currentPlannerId));
                    const planner = App.utils.findPlanner(App.state.currentPlannerId); 
                    const rowData = App.utils.findRowData(planner, rowId); 
                    if (rowData) { 
                        rowData.isCollapsed = !rowData.isCollapsed; 
                        App.render.rowsFromState(planner.rows); 
                        App.render.setActiveTab(App.state.currentActiveTab); 
                        App.persistence.debouncedSave(); 
                    } 
                }
            },
            titleEdit(e) {
                clearTimeout(this.titleEditTimeout);
                this.titleEditTimeout = setTimeout(() => {
                    const rowId = e.target.closest('[data-id]').dataset.id;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    App.history.saveState(planner);
                    const rowData = App.utils.findRowData(planner, rowId);
                    if (rowData) {
                        rowData.title = e.target.textContent;
                        App.persistence.debouncedSave();
                    }
                }, 500); 
            },
            tooltipShow(e) { const target = e.target.closest('[data-tooltip]'); if (!target || !target.dataset.tooltip) return; App.dom.tooltip.innerHTML = target.dataset.tooltip; App.dom.tooltip.style.opacity = '1'; const targetRect = target.getBoundingClientRect(); App.dom.tooltip.style.left = `${e.clientX + 10}px`; App.dom.tooltip.style.top = `${e.clientY + 10}px`; },
            tooltipHide() { App.dom.tooltip.style.opacity = '0'; },
            dragStart(e) {
                if (!e.target.matches('tr') || App.state.isViewMode) return;
                const draggedRow = e.target;
                App.state.draggedGroup = [draggedRow];

                if (draggedRow.dataset.rowType === 'lesson-set') {
                    const setId = draggedRow.dataset.id;
                    const childRows = App.dom.plannerTableContainer.querySelectorAll(`tr[data-parent-id="${setId}"]`);
                    childRows.forEach(child => App.state.draggedGroup.push(child));
                }
                
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    App.state.draggedGroup.forEach(row => row.classList.add('opacity-50', 'bg-yellow-200'));
                }, 0);
            },
            dragOver(e) {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (targetRow && App.state.draggedGroup && !App.state.draggedGroup.includes(targetRow)) {
                    targetRow.classList.add('bg-blue-100');
                }
            },
            dragLeave(e) {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (targetRow) {
                    targetRow.classList.remove('bg-blue-100');
                }
            },
            drop(e) {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                App.history.saveState(planner);
                e.preventDefault();
                const dropTarget = e.target.closest('tbody tr');
                if (dropTarget && App.state.draggedGroup && !App.state.draggedGroup.includes(dropTarget)) {
                    const tbody = dropTarget.parentNode;
                    const targetRect = dropTarget.getBoundingClientRect();
                    const targetMidY = targetRect.top + targetRect.height / 2;
                    const referenceNode = (e.clientY < targetMidY) ? dropTarget : dropTarget.nextSibling;
                    App.state.draggedGroup.forEach(draggedRow => { tbody.insertBefore(draggedRow, referenceNode); });
                }
                document.querySelectorAll('.bg-blue-100').forEach(el => el.classList.remove('bg-blue-100'));
                if (App.state.draggedGroup) { App.state.draggedGroup.forEach(row => row.classList.remove('opacity-50', 'bg-yellow-200')); }
                App.state.draggedGroup = null;
                App.persistence.updateStateFromTableOrder();
                App.persistence.debouncedSave();
            }
        };

        App.utils = {
             findPlanner: (id) => App.state.programData.planners.find(p => p.id === id),
             findRowData(planner, rowId) {
                if (!planner || !planner.rows) return null;
                for (const row of planner.rows) {
                    if (row.id === rowId) return row;
                    if (row.type === 'lesson-set' && row.children) {
                        const foundInChildren = row.children.find(child => child.id === rowId);
                        if (foundInChildren) return foundInChildren;
                    }
                }
                return null;
             },
             findRowAndParent(planner, rowId) {
                if (!planner || !planner.rows) return null;
                for (let i = 0; i < planner.rows.length; i++) {
                    const row = planner.rows[i];
                    if (row.id === rowId) {
                        return { row: row, parentArray: planner.rows, index: i };
                    }
                    if (row.type === 'lesson-set' && row.children) {
                        for (let j = 0; j < row.children.length; j++) {
                            const child = row.children[j];
                            if (child.id === rowId) {
                                return { row: child, parentArray: row.children, index: j };
                            }
                        }
                    }
                }
                return null;
             },
             showView: (id) => { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex', 'flex-col');},
             openModal(modalId) { document.getElementById(modalId).classList.replace('hidden', 'flex'); App.dom.body.classList.add('modal-open'); },
             closeAllModals: () => { document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.replace('flex', 'hidden') ); App.dom.body.classList.remove('modal-open'); App.popover.hide(); },
             normalizeText: (t) => t.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim(),
             escapeRegExp: (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
            getGradeBandKey: (l) => {
                if (!l) return null;
                const lc = l.toLowerCase();
                if (['kindergarten', 'first', 'second', 'k-2'].some(k => lc.includes(k))) return 'primary';
                if (['third', 'fourth', 'fifth', '3-5'].some(k => lc.includes(k))) return 'elementary';
                if (lc.includes('middle')) return 'middle';
                if (lc.includes('high')) return 'high';
                return null;
            },
            findBestMatchingSpecificElement(text, grade) {
                const clean = text.trim().replace(/^[\*•]\s*/, '').replace(/\s*\([^)]*\)\s*$/, '').trim();
                if (clean.length < 15) return null;
                const cacheKey = `${grade}|${clean}`;
                if (App.dataMaps.fuzzyMatchCache.has(cacheKey)) return App.dataMaps.fuzzyMatchCache.get(cacheKey);
                const normText = this.normalizeText(clean);
                const words = normText.split(' ').filter(w => w.length > 1);
                if (words.length === 0) return null;
                const threshold = words.length < 10 ? 0.75 : 0.80;
                const gradeKey = this.getGradeBandKey(grade);
                let best = { code: null, score: 0, base: 0, len: Infinity };
                for (const [offText, code] of App.dataMaps.textToSpecificCodeMap.entries()) {
                    const normOffText = this.normalizeText(offText);
                    const found = words.reduce((count, word) => {
                        const rgx = new RegExp(`\\b${this.escapeRegExp(word)}\\b`);
                        if (rgx.test(normOffText)) return count + 1;
                        const singular = word.endsWith('s') ? word.slice(0, -1) : null;
                        if (singular && singular.length > 2 && new RegExp(`\\b${this.escapeRegExp(singular)}\\b`).test(normOffText)) return count + 1;
                        const plural = !word.endsWith('s') ? word + 's' : null;
                        if (plural && new RegExp(`\\b${this.escapeRegExp(plural)}\\b`).test(normOffText)) return count + 1;
                        return count;
                    }, 0);
                    const baseScore = found / words.length;
                    let weightedScore = baseScore;
                    const el = App.dataMaps.ngss3dMap.get(code);
                    if (gradeKey && el && el.allProgressions[gradeKey]) {
                         weightedScore += 0.2;
                    }
                    if (weightedScore > best.score || (weightedScore === best.score && offText.length < best.len)) {
                        best = { code, score: weightedScore, base: baseScore, len: offText.length };
                    }
                }
                const result = best.base >= threshold ? best.code : null;
                App.dataMaps.fuzzyMatchCache.set(cacheKey, result);
                return result;
            },
             gatherColumns(gradeBand) {
                const groups = { 
                    pe: { name: "PEs", key: 'pe', cols: [] }, 
                    dci: { name: "DCIs", key: 'dci', cols: [] }, 
                    sep: { name: "SEPs & Nature of Science", key: 'sep', cols: [] }, 
                    ccc: { name: "CCCs, NOS, & ETAS", key: 'ccc', cols: [] } 
                };

                const nosForSep = new Set(['VOM', 'BEE', 'OTR', 'ENP']);
                const nosForCcc = new Set(['WOK', 'AOC', 'HE', 'AQAW']);

                App.dataMaps.parentToChildrenMap.forEach((parentData, parentCode) => {
                    if (parentCode === 'PE') return;

                    const isRelevant = parentData.children.some(child => child.allProgressions[gradeBand]?.length > 0);
                    if (isRelevant) {
                        const columnInfo = { code: parentCode, title: parentData.name };
                        const dimension = parentData.dimension;

                        if (dimension === 'SEP') {
                            groups.sep.cols.push(columnInfo);
                        } else if (dimension.startsWith('DCI')) {
                            groups.dci.cols.push(columnInfo);
                        } else if (dimension === 'CCC') {
                            groups.ccc.cols.push(columnInfo);
                        } else if (dimension === 'CNS') {
                            if (nosForSep.has(parentCode)) {
                                groups.sep.cols.push(columnInfo);
                            }
                            if (nosForCcc.has(parentCode)) {
                                groups.ccc.cols.push(columnInfo);
                            }
                        } else if (dimension === 'C-ETAS') {
                            groups.ccc.cols.push(columnInfo);
                        }
                    }
                });
                return groups;
            },
            cyclePeStatus(rowId, peCode) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                App.history.saveState(planner);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                const currentStatus = rowData.trackingData[peCode];
                const cycle = { '': 'I', 'I': 'D', 'D': 'A', 'A': '' };
                const newStatus = cycle[currentStatus || ''];
                if (newStatus) { rowData.trackingData[peCode] = newStatus; } 
                else { delete rowData.trackingData[peCode]; }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            cycleScopeStatus(rowId) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                App.history.saveState(planner);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                const currentScope = rowData.scope;
                const cycle = { '': 'F', 'F': 'S', 'S': '' };
                rowData.scope = cycle[currentScope || ''];
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            toggleViewMode() {
                App.state.isViewMode = !App.state.isViewMode;
                App.dom.body.classList.toggle('view-mode-active', App.state.isViewMode);
                document.getElementById('view-mode-toggle').textContent = App.state.isViewMode ? 'Exit View Mode' : 'Enter View Mode';
                if (App.state.currentPlannerId) App.render.plannerView(App.state.currentPlannerId);
            },
            addRow(type, text) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState(planner);
                const newRowData = { id: `row-${Date.now()}`, type, title: text };
                if (type === 'lesson-set') {
                    newRowData.children = [];
                    newRowData.isCollapsed = false;
                    planner.rows.push(newRowData);
                } else {
                    newRowData.trackingData = {};
                    newRowData.scope = '';
                    newRowData.details = { notes: '', links: [] };
                    const lastSet = planner.rows.filter(r => r.type === 'lesson-set').pop();
                    if (lastSet && !lastSet.isCollapsed) {
                        lastSet.children.push(newRowData);
                    } else {
                        planner.rows.push(newRowData);
                    }
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            addRowAdjacent(referenceRowId, position = 'below') {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState(planner);
                const location = this.findRowAndParent(planner, referenceRowId);
                if (!location) return;
                const newLesson = {
                    id: `row-${Date.now()}`,
                    type: 'lesson',
                    title: 'New Lesson...',
                    trackingData: {},
                    scope: '',
                    details: { notes: '', links: [] }
                };
                const insertIndex = position === 'below' ? location.index + 1 : location.index;
                location.parentArray.splice(insertIndex, 0, newLesson);
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            copyRow(sourceRowId) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState(planner);
                const location = this.findRowAndParent(planner, sourceRowId);
                if (!location) return;
                const sourceRowData = location.row;
                const newRowData = JSON.parse(JSON.stringify(sourceRowData));
                newRowData.id = `row-${Date.now()}`;
                newRowData.title = `${sourceRowData.title} (Copy)`;
                location.parentArray.splice(location.index + 1, 0, newRowData);
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            deleteRow(rowId) {
                const planner = this.findPlanner(App.state.currentPlannerId); if (!planner) return;
                App.history.saveState(planner);
                let foundAndRemoved = false;
                planner.rows = planner.rows.filter(row => {
                    if (row.id === rowId) {
                        foundAndRemoved = true;
                        return false;
                    }
                    return true;
                });
                if (!foundAndRemoved) {
                    planner.rows.forEach(row => {
                        if (row.type === 'lesson-set' && row.children) {
                            row.children = row.children.filter(child => child.id !== rowId);
                        }
                    });
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            openPlannerModal(p=null){
                const t=document.getElementById('planner-modal-title');const d=document.getElementById('planner-modal-delete');
                const structureFields = document.getElementById('new-planner-structure-fields');
                document.getElementById('planner-id-input').value=p?p.id:'';
                document.getElementById('planner-title-input').value=p?p.title:'';
                document.getElementById('planner-course-input').value=p?p.course:'';
                document.getElementById('planner-band-select').value=p?p.gradeBand:'elementary';
                document.getElementById('planner-standard-select').value=p?p.standardSet:'NGSS';
                document.getElementById('planner-phenomenon-input').value = p ? p.phenomenon : '';
                document.getElementById('planner-question-input').value = p ? p.question : '';
                document.getElementById('planner-description-input').value=p?p.description:'';
                if(p) {
                    t.textContent='Edit Planner';
                    d.style.display='inline-block';
                    structureFields.style.display = 'none';
                } else {
                    t.textContent='New Planner';
                    d.style.display='none';
                    structureFields.style.display = 'grid';
                }
                this.openModal('planner-modal-backdrop'); 
            },
            savePlanner() { 
                const id = document.getElementById('planner-id-input').value;
                const planner = id ? this.findPlanner(id) : null;
                if(planner) App.history.saveState(planner);

                const data = {
                    title: document.getElementById('planner-title-input').value,
                    course: document.getElementById('planner-course-input').value,
                    gradeBand: document.getElementById('planner-band-select').value,
                    standardSet: document.getElementById('planner-standard-select').value,
                    phenomenon: document.getElementById('planner-phenomenon-input').value,
                    question: document.getElementById('planner-question-input').value,
                    description: document.getElementById('planner-description-input').value
                };

                if (!data.title) { alert('Planner Title is required.'); return; }

                if (id) {
                    Object.assign(App.utils.findPlanner(id), data);
                } else {
                    data.id = `planner-${Date.now()}`;
                    const numSets = parseInt(document.getElementById('planner-sets-input').value) || 1;
                    const lessonsPerSet = parseInt(document.getElementById('planner-lessons-per-set-input').value) || 1;
                    
                    const genId = () => `row-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                    const makeLesson = (lessonNum) => ({ id: genId(), type: 'lesson', title: `Lesson ${lessonNum}`, trackingData: {}, scope: '', details: { notes: '', links: [] } });
                    
                    data.rows = [];
                    let lessonCounter = 1;
                    for(let i=1; i<=numSets; i++) {
                        const children = [];
                        for(let j=1; j<=lessonsPerSet; j++) {
                            children.push(makeLesson(lessonCounter++));
                        }
                        data.rows.push({ id: genId(), type: 'lesson-set', title: `Lesson Set ${i}`, isCollapsed: false, children });
                    }

                    data.activeTab = 'pe';
                    data.assignedPes = [];
                    App.state.programData.planners.push(data);
                }
                App.persistence.saveProgramData();
                App.render.navigator();
                if (!id || id === App.state.currentPlannerId) {
                    App.render.plannerView(id || data.id);
                }
                App.utils.closeAllModals();
            },
            openPeAssignmentModal() { 
                const p = App.utils.findPlanner(App.state.currentPlannerId); if(!p) return;
                const list = document.getElementById('pe-modal-list');
                list.innerHTML = '';
                const r = Object.keys(App.dataMaps.gradeBandMap).filter(g => App.dataMaps.gradeBandMap[g] === p.gradeBand); 
                list.className = 'grid grid-cols-1 md:grid-cols-2 gap-4'; 

                App.state.allNgssData.forEach(g => {
                    if(r.includes(g.gradeId)){
                        g.topics.forEach(t => {
                            t.performanceExpectations.forEach(pe => {
                                const assignedPeObj = p.assignedPes?.find(p_obj => p_obj.id === pe.id);
                                const isChecked = !!assignedPeObj;
                                const isSecondaryChecked = assignedPeObj?.isSecondary || false;

                                const d = document.createElement('div');
                                d.className = 'pe-modal-item relative p-4 border rounded-lg shadow-sm transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:border-gray-700 dark:has-[:checked]:bg-blue-900/20 dark:has-[:checked]:border-blue-700';
                                
                                const links = App.dataMaps.peTo3dMap.get(pe.id) || { componentCodes: new Set(), secondaryComponentCodes: new Set() };
                                let linksHTML = '<dl class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-1">';
                                ['SEP', 'DCI', 'CCC'].forEach(dim => {
                                    const codes = [...links.componentCodes, ...links.secondaryComponentCodes].filter(code => {
                                        const parentInfo = App.dataMaps.parentToChildrenMap.get(code);
                                        return parentInfo && parentInfo.dimension.startsWith(dim);
                                    });
                                    if (codes.length > 0) {
                                        linksHTML += `<div><dt class="font-semibold inline">${dim}: </dt><dd class="inline">${codes.join(', ')}</dd></div>`;
                                    }
                                });
                                linksHTML += '</dl>';
                                
                                d.innerHTML=`
                                    <label class="block">
                                        <div class="flex items-start">
                                            <input type="checkbox" value="${pe.id}" ${isChecked ? 'checked' : ''} class="h-4 w-4 mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                                            <div class="ml-3 text-sm flex-1">
                                                <span class="font-bold text-gray-900 dark:text-gray-100">${pe.id}</span>
                                                <p class="text-gray-600 dark:text-gray-400">${pe.description}</p>
                                            </div>
                                        </div>
                                        ${linksHTML}
                                        <div class="flex items-center mt-2 pl-7">
                                            <input type="checkbox" id="secondary-toggle-${pe.id}" class="secondary-pe-toggle h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer" ${isSecondaryChecked ? 'checked' : ''}>
                                            <label for="secondary-toggle-${pe.id}" class="ml-2 text-xs text-gray-600 dark:text-gray-400 cursor-pointer">Mark as a supporting PE</label>
                                        </div>
                                    </label>`;
                                list.appendChild(d);
                            });
                        });
                    }
                }); 
                this.openModal('pe-modal-backdrop');
            },
            savePeAssignments() { 
                const p = App.utils.findPlanner(App.state.currentPlannerId); if (!p) return;
                App.history.saveState(p);
                p.assignedPes = Array.from(document.querySelectorAll('#pe-modal-list input[type="checkbox"][value]:checked')).map(i => {
                    const container = i.closest('.pe-modal-item');
                    const isSecondary = container.querySelector('.secondary-pe-toggle').checked;
                    return { id: i.value, isSecondary: isSecondary };
                });
                App.persistence.saveProgramData(); App.render.plannerView(p.id); this.closeAllModals(); 
            },
            openElementDetailModal(code) {
                let title, description, progressionHTML = '', linkedPEsHTML = '';
                const planner = this.findPlanner(App.state.currentPlannerId);

                if (App.dataMaps.peMap.has(code)) {
                    const pe = App.dataMaps.peMap.get(code);
                    title = `PE: ${pe.id}`;
                    description = pe.description;
                    const linked3D = App.dataMaps.peTo3dMap.get(code);
                    if (linked3D && linked3D.specificCodes.size > 0) {
                        progressionHTML = '<h4 class="font-bold mt-4">Linked 3D Elements:</h4><ul class="list-disc pl-5 space-y-1">';
                        linked3D.specificCodes.forEach(specCode => {
                            const element = App.dataMaps.ngss3dMap.get(specCode);
                            if (element) {
                                progressionHTML += `<li><strong>${specCode}:</strong> ${element.text}</li>`;
                            }
                        });
                        progressionHTML += '</ul>';
                    }
                } else if (App.dataMaps.parentToChildrenMap.has(code)) {
                    const parentInfo = App.dataMaps.parentToChildrenMap.get(code);
                    title = parentInfo.name;
                    description = `This is a parent element for a set of specific performance expectations across grade bands.`;
                    
                    const bands = ['primary', 'elementary', 'middle', 'high'];
                    progressionHTML = '<h4 class="font-bold mt-4">Grade Band Progression:</h4><div class="space-y-3">';
                    bands.forEach(band => {
                        const elementsInBand = parentInfo.children.filter(c => c.allProgressions[band]?.length > 0);
                        if (elementsInBand.length > 0) {
                            progressionHTML += `
                                <div>
                                    <h5 class="font-semibold capitalize">${band.replace('primary', 'K-2').replace('elementary', '3-5').replace('middle', '6-8').replace('high', '9-12')}</h5>
                                    <ul class="list-disc pl-6 text-sm text-gray-700 dark:text-gray-300">
                                        ${elementsInBand.map(el => `<li><strong>${el.code}:</strong> ${el.text}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                    });
                    progressionHTML += '</div>';

                    if (planner && planner.assignedPes) {
                        const linkedPEs = new Set();
                        planner.assignedPes.forEach(peObj => {
                            const links = App.dataMaps.peTo3dMap.get(peObj.id);
                            if (links) {
                                links.specificCodes.forEach(specificCode => {
                                    const element = App.dataMaps.ngss3dMap.get(specificCode);
                                    if (element && element.parentCode === code) {
                                        linkedPEs.add(peObj.id);
                                    }
                                });
                            }
                        });

                        if (linkedPEs.size > 0) {
                            linkedPEsHTML = `<h4 class="font-bold mt-4">Linked PEs in this planner:</h4><div class="flex flex-wrap gap-2">${Array.from(linkedPEs).map(pe => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full dark:bg-blue-900 dark:text-blue-300">${pe}</span>`).join('')}</div>`;
                        }
                    }
                } else {
                    return; // Code not found
                }

                document.getElementById('element-modal-title').textContent = title;
                document.getElementById('element-modal-description').innerHTML = description;
                document.getElementById('element-progression').innerHTML = progressionHTML;
                document.getElementById('element-linked-pes').innerHTML = linkedPEsHTML;
                this.openModal('element-detail-modal-backdrop');
            },

            openLessonDetailsModal(rowId) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                
                const modal = document.getElementById('lesson-details-modal-backdrop');
                modal.dataset.currentRowId = rowId;

                document.getElementById('lesson-details-modal-title').textContent = `Details for: ${rowData.title}`;
                document.getElementById('lesson-notes-input').value = rowData.details?.notes || '';
                this.renderLinksInModal(rowData.details?.links || []);
                this.openModal('lesson-details-modal-backdrop');
            },

            renderLinksInModal(links) {
                const container = document.getElementById('lesson-links-container');
                container.innerHTML = links.map((link, index) => `
                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 p-2 rounded">
                        <a href="${link}" target="_blank" class="flex-grow text-blue-600 dark:text-blue-400 truncate">${link}</a>
                        <button class="remove-link-btn text-red-500 font-bold" data-index="${index}">✖</button>
                    </div>
                `).join('');
            },

            addLinkToDetailsModal() {
                const input = document.getElementById('new-link-input');
                let url = input.value.trim();
                if (!url) return;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData.details) rowData.details = { notes: '', links: [] };
                if (!rowData.details.links) rowData.details.links = [];
                rowData.details.links.push(url);
                this.renderLinksInModal(rowData.details.links);
                input.value = '';
            },

            removeLinkFromDetailsModal(button) {
                 const index = parseInt(button.dataset.index, 10);
                 const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                rowData.details.links.splice(index, 1);
                this.renderLinksInModal(rowData.details.links);
            },
            
            saveLessonDetails() {
                const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                App.history.saveState(planner);

                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                
                if (!rowData.details) rowData.details = { notes: '', links: [] };
                rowData.details.notes = document.getElementById('lesson-notes-input').value;
                
                App.persistence.debouncedSave();
                this.closeAllModals();
            },

            performSearch(query) {
                this.render.renderPlannerContent(); // Re-render to apply filter
            },
        };

        App.import = {
            handleImport() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,application/json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = e => {
                        try {
                            const importedPlanner = JSON.parse(e.target.result);
                            if (!importedPlanner.id || !importedPlanner.title) {
                                throw new Error('Invalid planner file format.');
                            }
                            App.state.pendingImportData = importedPlanner;
                            this.showImportOptions();
                        } catch (error) {
                            alert(`Error importing file: ${error.message}`);
                        }
                    };
                    reader.readText(file);
                };
                input.click();
            },
            showImportOptions() {
                const modal = document.getElementById('import-options-modal-backdrop');
                document.getElementById('import-planner-name').textContent = App.state.pendingImportData.title;

                const currentPlanner = App.utils.findPlanner(App.state.currentPlannerId);
                const mergeLabel = document.getElementById('import-merge-label');
                const replaceLabel = document.getElementById('import-replace-label');
                const mergeInput = mergeLabel.querySelector('input');
                const replaceInput = replaceLabel.querySelector('input');

                if (currentPlanner) {
                    mergeLabel.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    replaceLabel.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    mergeInput.disabled = false;
                    replaceInput.disabled = false;
                } else {
                    mergeLabel.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    replaceLabel.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
                    mergeInput.disabled = true;
                    replaceInput.disabled = true;
                    document.querySelector('input[name="import-option"][value="create"]').checked = true;
                }
                App.utils.openModal('import-options-modal-backdrop');
            },
            processImport() {
                const importedPlanner = App.state.pendingImportData;
                if (!importedPlanner) return;

                const option = document.querySelector('input[name="import-option"]:checked').value;
                const currentPlanner = App.utils.findPlanner(App.state.currentPlannerId);

                switch (option) {
                    case 'create':
                        if (App.utils.findPlanner(importedPlanner.id)) {
                            importedPlanner.id = `planner-${Date.now()}`;
                            importedPlanner.title = `${importedPlanner.title} (Imported Copy)`;
                        }
                        App.state.programData.planners.push(importedPlanner);
                        alert(`Planner "${importedPlanner.title}" imported successfully!`);
                        break;
                    case 'merge':
                        if (!currentPlanner) { alert("No planner open to merge with."); return; }
                        App.history.saveState(currentPlanner);
                        const currentPes = new Map((currentPlanner.assignedPes || []).map(p => [p.id, p]));
                        (importedPlanner.assignedPes || []).forEach(p => {
                            if (!currentPes.has(p.id)) {
                                currentPes.set(p.id, p);
                            }
                        });
                        currentPlanner.assignedPes = Array.from(currentPes.values());
                        currentPlanner.rows.push(...(importedPlanner.rows || []));
                        alert(`Merged "${importedPlanner.title}" into "${currentPlanner.title}".`);
                        break;
                    case 'replace':
                        if (!currentPlanner) { alert("No planner open to replace."); return; }
                        const index = App.state.programData.planners.findIndex(p => p.id === App.state.currentPlannerId);
                        if (index > -1) {
                            importedPlanner.id = currentPlanner.id; 
                            App.state.programData.planners[index] = importedPlanner;
                            App.history.clear(); // History is invalid after replacement
                        }
                        alert(`Replaced "${currentPlanner.title}" with "${importedPlanner.title}".`);
                        break;
                }
                
                App.persistence.saveProgramData();
                App.render.navigator();
                if (option !== 'create') {
                    App.render.plannerView(App.state.currentPlannerId);
                }
                App.utils.closeAllModals();
                App.state.pendingImportData = null;
            }
        };
        
        App.tour = {
            instance: null,
            init() {
                this.instance = new Shepherd.Tour({
                    useModalOverlay: true,
                    defaultStepOptions: {
                        classes: 'shadow-md bg-gray-100 dark:bg-gray-700',
                        scrollTo: true
                    }
                });

                this.instance.addStep({
                    id: 'step1', text: 'Welcome! This is the Navigator. All your planners are listed here. Let\'s create a new one.',
                    attachTo: { element: '#new-planner-btn', on: 'bottom' }, buttons: [{ action() { this.next(); }, text: 'Next' }]
                });
                this.instance.addStep({
                    id: 'step2', text: 'After creating a planner, assign the Performance Expectations (PEs) you\'ll be targeting.',
                    attachTo: { element: '#assign-pe-btn', on: 'bottom' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                });
                this.instance.addStep({
                    id: 'step3', text: 'Your instructional sequence appears here. You can edit titles, add lessons, and drag-and-drop to reorder.',
                    attachTo: { element: '#planner-table-container', on: 'top' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                });
                 this.instance.addStep({
                    id: 'step4', text: 'Use these tabs to switch between tracking PEs and the three dimensions (DCIs, SEPs, CCCs).',
                    attachTo: { element: '#tab-container', on: 'bottom' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                });
                 this.instance.addStep({
                    id: 'step5', text: 'Click inside a cell to open a popover and track an element\'s status (Introduced, Developed, or Assessed) for that lesson.',
                    attachTo: { element: '#planner-table-container tbody tr:first-child td:last-child', on: 'left' }, isRequired: ['#planner-table-container tbody tr'], buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                });
                this.instance.addStep({
                    id: 'step6', text: 'You can check planner analytics in the Summary view, or compare multiple planners using the Progression view.',
                    attachTo: { element: '#view-summary-btn', on: 'bottom' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.complete(); }, text: 'Finish' }]
                });

                this.instance.on('complete', () => {
                    localStorage.setItem('ngssPlannerTourCompleted', 'true');
                });
            },
            start() {
                if (App.state.currentPlannerId === null && App.state.programData.planners.length > 0) {
                    App.render.plannerView(App.state.programData.planners[0].id);
                } else if (App.state.programData.planners.length === 0) {
                    // Create a default planner for the tour if none exist
                    const newPlanner = {
                        id: `planner-${Date.now()}`, title: 'Sample 4th Grade Unit', course: '4th Grade Science', gradeBand: 'elementary', standardSet: 'NGSS',
                        phenomenon: 'A wrecking ball can knock down a wall.', question: 'How does energy change and move?', description: 'A sample unit.',
                        assignedPes: [{id: "4-PS3-1", isSecondary: false}, {id:"4-PS3-2", isSecondary: false}, {id:"4-PS3-4", isSecondary: false}],
                        rows: [
                            { id: `row-${Date.now()}-1`, type: 'lesson-set', title: 'Lesson Set 1', isCollapsed: false, children: [
                                { id: `row-${Date.now()}-2`, type: 'lesson', title: 'Lesson 1', trackingData: {'4-PS3-1':'I'}, scope:'F', details:{notes:'', links:[]} }
                            ]}
                        ]
                    };
                    App.state.programData.planners.push(newPlanner);
                    App.persistence.saveProgramData();
                    App.render.navigator();
                    App.render.plannerView(newPlanner.id);
                }
                setTimeout(() => this.instance.start(), 200);
            }
        };
        
        async function loadDataAndInit() {
            try {
                await App.db.init();
                const cachedMaps = await App.db.get('processed_maps');

                if (cachedMaps) {
                    console.log("Loading processed data maps from cache.");
                    App.dataMaps.peMap = new Map(cachedMaps.peMap);
                    App.dataMaps.ngss3dMap = new Map(cachedMaps.ngss3dMap);
                    App.dataMaps.peTo3dMap = new Map(cachedMaps.peTo3dMap.map(([key, value]) => [key, { componentCodes: new Set(value.componentCodes), secondaryComponentCodes: new Set(value.secondaryComponentCodes), specificCodes: new Set(value.specificCodes) }]));
                    App.dataMaps.parentToChildrenMap = new Map(cachedMaps.parentToChildrenMap);
                    App.dataMaps.major3DMap = new Map(cachedMaps.major3DMap);
                    App.dataMaps.nameToCodeMap = new Map(cachedMaps.nameToCodeMap);
                    App.dataMaps.textToSpecificCodeMap = new Map(cachedMaps.textToSpecificCodeMap);
                    // We still need the raw data for the PE modal, load it from cache if available
                    App.state.allNgssData = await App.db.get('raw_ngss_data');
                    if (!App.state.allNgssData) throw new Error("Raw data missing from cache.");
                } else {
                    console.log("Data not found in cache. Fetching from server and processing...");
                    const dataPath = 'https://philm013.github.io/JSON/';
                    const [ngss3d, k5, m68, h912] = await Promise.all([
                        fetch(`${dataPath}ngss3DElements.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss3DElements.json`); return res.json(); }),
                        fetch(`${dataPath}ngssK5.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngssK5.json`); return res.json(); }),
                        fetch(`${dataPath}ngss68.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss68.json`); return res.json(); }),
                        fetch(`${dataPath}ngss912.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss912.json`); return res.json(); })
                    ]);
                    
                    App.state.allNgss3dElements = ngss3d;
                    const msData = { gradeId: 'MS', gradeLabel: 'Middle School', topics: m68 };
                    const hsData = { gradeId: 'HS', gradeLabel: 'High School', topics: h912 };
                    App.state.allNgssData = [...k5, msData, ..hsData];
                    
                    App.buildDataMaps();
                    
                    const serializableMaps = {
                        peMap: [...App.dataMaps.peMap],
                        ngss3dMap: [...App.dataMaps.ngss3dMap],
                        peTo3dMap: [...App.dataMaps.peTo3dMap].map(([key, value]) => [key, { componentCodes: [...value.componentCodes], secondaryComponentCodes: [...value.secondaryComponentCodes], specificCodes: [...value.specificCodes] }]),
                        parentToChildrenMap: [...App.dataMaps.parentToChildrenMap],
                        major3DMap: [...App.dataMaps.major3DMap],
                        nameToCodeMap: [...App.dataMaps.nameToCodeMap],
                        textToSpecificCodeMap: [...App.dataMaps.textToSpecificCodeMap],
                    };
                    await App.db.set('processed_maps', serializableMaps);
                    await App.db.set('raw_ngss_data', App.state.allNgssData);
                    console.log("Data processed and cached.");
                }

                App.init();

            } catch (error) {
                console.error("Failed to load NGSS data:", error);
                document.getElementById('loading-indicator').textContent = 'Error loading data. Please check the console and refresh. Make sure you are running this from a web server and the ../JSON/ folder is accessible.';
            }
        }
        
        loadDataAndInit();
    });
    </script>
</body>
</html>
