<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 NGSS 3D Progression Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
        tailwind.config = { darkMode: 'media' }
    </script>
    <style>
        /* --- SCROLLBARS --- */
        #planner-table-container, .modal-content, #progression-table-view, #summary-content, #popover-content {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar, .modal-content::-webkit-scrollbar, #progression-table-view::-webkit-scrollbar, #summary-content::-webkit-scrollbar, #popover-content::-webkit-scrollbar {
            width: 8px; height: 8px;
        }
        #planner-table-container::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track, #progression-table-view::-webkit-scrollbar-track, #summary-content::-webkit-scrollbar-track, #popover-content::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb, #progression-table-view::-webkit-scrollbar-thumb, #summary-content::-webkit-scrollbar-thumb, #popover-content::-webkit-scrollbar-thumb {
            background-color: #a0aec0; border-radius: 10px; border: 2px solid #e2e8f0;
        }
        .dark #planner-table-container, .dark .modal-content, .dark #progression-table-view, .dark #summary-content, .dark #popover-content {
            scrollbar-color: #4a5568 #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-track, .dark .modal-content::-webkit-scrollbar-track, .dark #progression-table-view::-webkit-scrollbar-track, .dark #summary-content::-webkit-scrollbar-track, .dark #popover-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-thumb, .dark .modal-content::-webkit-scrollbar-thumb, .dark #progression-table-view::-webkit-scrollbar-thumb, .dark #summary-content::-webkit-scrollbar-thumb, .dark #popover-content::-webkit-scrollbar-thumb {
            background-color: #4a5568; border-color: #2d3748;
        }
        
        /* --- STRICT FIXED LAYOUT --- */
        table.fixed-layout {
            table-layout: fixed;
            width: max-content; 
            min-width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
        }

        #planner-table-container thead th {
            position: sticky; top: 0; z-index: 20;
            height: 160px;
            vertical-align: bottom;
            padding: 8px 4px;
            border-bottom: 2px solid #cbd5e0;
            background-clip: padding-box;
        }
        .dark #planner-table-container thead th { border-bottom-color: #4a5568; }

        .vertical-header-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            text-align: left;
            max-height: 140px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        /* --- STICKY COLUMNS --- */
        .sticky-col-1 { 
            position: sticky; left: 0; z-index: 25; 
            width: 120px; min-width: 120px; max-width: 120px;
            overflow: hidden;
        }
        .sticky-col-2 { 
            position: sticky; left: 120px; z-index: 24; 
            width: 80px; min-width: 80px; max-width: 80px;
            overflow: hidden;
        }
        .sticky-col-3 { 
            position: sticky; left: 200px; z-index: 23; 
            width: 400px; min-width: 400px; max-width: 400px;
            box-shadow: 4px 0 5px -2px rgba(0,0,0,0.05);
            overflow: hidden; text-overflow: ellipsis;
        }
        .dark .sticky-col-3 { box-shadow: 4px 0 5px -2px rgba(0,0,0,0.25); }

        .data-col-header { width: 50px; min-width: 50px; max-width: 50px; }

        #planner-table-container thead th.sticky-col-1, 
        #planner-table-container thead th.sticky-col-2, 
        #planner-table-container thead th.sticky-col-3 {
			z-index: 30; height: auto; vertical-align: middle; padding-bottom: 10px;
		}

        /* --- MISC --- */
        body.sidebar-open #sidebar { transform: translateX(0); }
        body.sidebar-open #sidebar-backdrop { opacity: 1; pointer-events: auto; }
        body.modal-open #menu-toggle { display: none; }
        .pe-link-indicator { display: inline-block; font-size: 0.7em; padding: 1px 5px; background-color: #e6f4ff; color: #005a9c; border: 1px solid #b3d7ff; border-radius: 4px; font-weight: bold; vertical-align: middle; margin-left: 4px; }
        .dark .pe-link-indicator { background-color: #1e3a8a; color: #93c5fd; border-color: #3b82f6; }
        tr.filtered-out { display: none; }
        .shepherd-button { background-color: #3b82f6; color: white; border-radius: 0.375rem; padding: 0.5rem 1rem; }
        .shepherd-button:not(.shepherd-button-secondary):hover { background-color: #2563eb; }
        .shepherd-button.shepherd-button-secondary { background-color: #6b7280; }
        .shepherd-header { background-color: #1f2937; padding: 1rem; }
        .shepherd-footer { padding: 0.5rem; }
        .dark .shepherd-text, .dark .shepherd-header, .dark .shepherd-content { background-color: #374151; color: #e5e7eb; }
        .dark .shepherd-arrow::before { background-color: #374151; }
        #pe-modal-list { overflow-y: auto; }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body id="body-tag" class="bg-gray-100 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-200 antialiased group">
    <div id="loading-indicator" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center text-lg text-gray-500 dark:text-gray-400 z-[2000] transition-opacity duration-500">Loading NGSS Planner...</div>

    <div class="relative flex h-screen overflow-hidden">
        <aside id="sidebar" class="bg-gray-800 text-gray-100 flex flex-col w-80 flex-shrink-0 p-4 transform transition-transform duration-300 ease-in-out z-[1000] -translate-x-full md:relative md:translate-x-0 fixed top-0 left-0 h-full md:shadow-lg">
            <h2 class="text-xl font-bold border-b border-gray-600 pb-3 mb-4">Planner Navigator</h2>
            
            <div id="navigator-controls" class="grid grid-cols-1 gap-2 mb-4">
                <button id="new-planner-btn" class="w-full px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">+ New Planner</button>
                <div class="grid grid-cols-2 gap-2">
                    <button id="view-summary-btn" class="w-full px-3 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors font-semibold text-sm">Summary</button>
                    <button id="view-progression-btn" class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold text-sm">Progression</button>
                </div>
            </div>
            
             <div class="grid grid-cols-1 gap-2 mb-4">
                <button id="help-btn" class="w-full px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors font-semibold text-sm">Help / Tour</button>
            </div>
            <ul id="navigator-list" class="overflow-y-auto space-y-1"></ul>
        </aside>

        <div id="main-wrapper" class="flex-1 flex flex-col overflow-x-hidden">
            <button id="menu-toggle" class="md:hidden absolute top-4 left-4 z-[40] bg-gray-800/80 backdrop-blur-sm text-white p-2 rounded-md text-xl">‚ò∞</button>
            <div id="sidebar-backdrop" class="md:hidden fixed inset-0 bg-black/40 z-[999] opacity-0 pointer-events-none transition-opacity duration-300"></div>

            <main id="main-content" class="flex-1 flex flex-col p-3 md:p-5 min-h-0">
                <div id="welcome-view" class="view active">
                    <div class="text-center m-auto text-gray-500 dark:text-gray-400">
                        <h2 class="text-2xl font-semibold mb-2">Welcome to the NGSS 3D Progression Planner</h2>
                        <p>Select a planner from the navigator on the left to begin, or create a new one.</p>
                        <button id="welcome-help-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Show me how it works!</button>
                    </div>
                </div>

                <div id="planner-view" class="view flex-1 flex flex-col h-full">
                    <!-- Streamlined Header & Toolbar -->
                    <div class="flex flex-col gap-2 mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <div class="flex flex-wrap justify-between items-end gap-x-4 gap-y-2">
                            <!-- Title Section -->
                            <div class="min-w-[200px]">
                                <h1 id="planner-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100 leading-tight"></h1>
                                <p id="planner-subtitle" class="text-sm text-gray-500 dark:text-gray-400"></p>
                            </div>

                            <!-- Toolbar Section -->
                            <div class="flex flex-wrap items-center gap-2 justify-end flex-1">
                                <!-- Search -->
                                <div class="relative">
                                    <input type="search" id="search-input" placeholder="Search..." class="w-32 focus:w-48 transition-all pl-7 pr-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-blue-500">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none text-gray-400 text-xs">üîç</div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-1">
                                    <button id="assign-pe-btn" class="px-2 py-1 bg-cyan-600 text-white rounded hover:bg-cyan-700 text-xs font-medium">PEs</button>
                                    <button id="add-lesson-set-btn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium group-[.view-mode-active]:hidden">+ Set</button>
                                    <button id="add-lesson-btn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium group-[.view-mode-active]:hidden">+ Lesson</button>
                                </div>

                                <!-- Undo/Redo -->
                                <div class="flex gap-1 border-l border-gray-300 dark:border-gray-600 pl-2">
                                    <button id="undo-btn" disabled class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 disabled:opacity-30 text-xs">‚Ü∂</button>
                                    <button id="redo-btn" disabled class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 disabled:opacity-30 text-xs">‚Ü∑</button>
                                </div>

                                <!-- Settings/View/Export -->
                                <div class="flex gap-1 border-l border-gray-300 dark:border-gray-600 pl-2">
                                    <button id="edit-planner-btn" class="px-2 py-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-xs group-[.view-mode-active]:hidden">‚öôÔ∏è</button>
                                    <button id="view-mode-toggle" class="px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-xs">View</button>
                                    <button id="export-planner-btn" class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs">Export</button>
                                    <button id="import-planner-btn" class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs">Import</button>
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Toggles & Status (Compact) -->
                        <div class="flex justify-between items-center text-xs">
                             <!-- Collapsible Phenomenon Toggle -->
                            <details class="group relative">
                                <summary class="list-none cursor-pointer text-blue-600 dark:text-blue-400 font-medium hover:underline flex items-center gap-1">
                                    <span class="group-open:rotate-90 transition-transform">‚ñ∂</span> Show Phenomenon & Driving Question
                                </summary>
                                <div class="absolute top-full left-0 mt-1 z-50 w-96 p-4 bg-white dark:bg-gray-800 border border-blue-200 dark:border-blue-900 rounded-lg shadow-xl text-sm">
                                    <p class="font-bold text-blue-800 dark:text-blue-200">Anchoring Phenomenon:</p>
                                    <p id="planner-phenomenon" class="mb-2 text-gray-700 dark:text-gray-300 italic"></p>
                                    <p class="font-bold text-blue-800 dark:text-blue-200">Driving Question:</p>
                                    <p id="planner-question" class="text-gray-700 dark:text-gray-300 italic"></p>
                                </div>
                            </details>

                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer text-gray-600 dark:text-gray-400">
                                    <span>Bundled PEs Only</span>
                                    <input type="checkbox" id="pe-bundle-toggle" class="accent-blue-600">
                                </label>
                                <span id="save-status" class="italic text-gray-400"></span>
                            </div>
                        </div>
                    </div>

                    <div id="tab-container" class="tabs flex border-b-2 border-gray-300 dark:border-gray-700 -mb-px"></div>
                    <div id="planner-table-container" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-b-lg rounded-tr-lg bg-white dark:bg-gray-800/50"></div>
                </div>
                
                <div id="progression-view" class="view flex-1 flex flex-col">
                     <div class="flex justify-between items-center mb-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Progression Storyline</h1>
                            <p id="progression-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <div class="flex items-center gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                            <button id="progression-view-element" class="px-3 py-1 text-sm font-medium rounded-md">By Element</button>
                            <button id="progression-view-lesson" class="px-3 py-1 text-sm font-medium rounded-md">By Lesson</button>
                        </div>
                     </div>
                     <div id="progression-table-view" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-lg p-4"></div>
                </div>
                 <div id="summary-view" class="view flex-1 flex flex-col">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Planner Summary & Analytics</h1>
                    <p id="summary-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400 mb-4"></p>
                    <div id="summary-content" class="flex-grow overflow-auto p-4 space-y-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="planner-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b dark:border-gray-700">
                 <h3 id="planner-modal-title" class="text-xl font-semibold text-gray-900 dark:text-gray-100">New Planner</h3>
            </div>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="planner-id-input">
                <div>
                    <label for="planner-title-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Planner Title</label>
                    <input type="text" id="planner-title-input" placeholder="e.g., Grade 4 Energy Unit" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div>
                    <label for="planner-course-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Course / Subject</label>
                    <input type="text" id="planner-course-input" placeholder="e.g., 4th Grade Science" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="planner-band-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grade Band</label>
                        <select id="planner-band-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="primary">Grades K-2</option>
                            <option value="elementary">Grades 3-5</option>
                            <option value="middle">Grades 6-8</option>
                            <option value="high">Grades 9-12</option>
                        </select>
                    </div>
                    <div>
                        <label for="planner-standard-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Standard Set</label>
                        <select id="planner-standard-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="NGSS">NGSS</option>
                        </select>
                    </div>
                </div>
                <div id="new-planner-structure-fields" class="grid grid-cols-2 gap-4 border-t pt-4 dark:border-gray-700">
                    <div>
                        <label for="planner-sets-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Number of Lesson Sets</label>
                        <input type="number" id="planner-sets-input" value="4" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="planner-lessons-per-set-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lessons per Set</label>
                        <input type="number" id="planner-lessons-per-set-input" value="2" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                </div>
                 <div>
                    <label for="planner-phenomenon-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Anchoring Phenomenon</label>
                    <textarea id="planner-phenomenon-input" rows="2" placeholder="e.g., A wrecking ball can knock down a building." class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                 <div>
                    <label for="planner-question-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unit Driving Question</label>
                    <textarea id="planner-question-input" rows="2" placeholder="e.g., How can something small cause a big change?" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                <div>
                    <label for="planner-description-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description (Optional)</label>
                    <textarea id="planner-description-input" rows="3" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-between items-center">
                <button id="planner-modal-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold text-sm hidden">Delete</button>
                <div class="flex-grow text-right space-x-2">
                    <button id="planner-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                    <button id="planner-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Planner</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="pe-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100 sticky top-0 bg-white dark:bg-gray-800">Assign Performance Expectations</h3>
            <div class="modal-content p-6 overflow-y-auto" id="pe-modal-list"></div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right space-x-2 sticky bottom-0">
                <button id="pe-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="pe-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="element-detail-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h3 id="element-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Element Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <p id="element-modal-description" class="text-base"></p>
                <div id="element-progression"></div>
                <div id="element-linked-pes"></div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="element-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="export-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Export Planner</h3>
            <div class="modal-content p-6 overflow-y-auto" id="export-options-list">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Select a format to download your planner.</p>
                <div class="space-y-3">
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="json">
                        <strong class="text-blue-600 dark:text-blue-400">JSON File</strong>
                        <small class="text-gray-500 dark:text-gray-400">Best for backing up and re-importing into this tool.</small>
                    </button>
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="html">
                        <strong class="text-blue-600 dark:text-blue-400">HTML File</strong>
                        <small class="text-gray-500 dark:text-gray-400">A self-contained, viewable webpage of your planner.</small>
                    </button>
                    <button class="export-option-btn w-full text-left p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:shadow-sm transition-all" data-format="xlsx">
                        <strong class="text-blue-600 dark:text-blue-400">Excel (XLSX) File</strong>
                        <small class="text-gray-500 dark:text-gray-400">For use in spreadsheets like Excel or Google Sheets.</small>
                    </button>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="export-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
            </div>
        </div>
    </div>
     <div id="lesson-details-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 id="lesson-details-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Lesson Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <div>
                    <label for="lesson-notes-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="lesson-notes-input" rows="6" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Links & Resources</label>
                    <div id="lesson-links-container" class="space-y-2"></div>
                    <div class="flex gap-2 mt-2">
                         <input type="url" id="new-link-input" placeholder="https://example.com" class="flex-grow px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                         <button id="add-link-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="lesson-details-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="import-options-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Import Options</h3>
            <div class="modal-content p-6 overflow-y-auto space-y-4">
                <p>You are importing planner: <strong id="import-planner-name" class="text-blue-600 dark:text-blue-400"></strong></p>
                <p class="text-gray-600 dark:text-gray-400">How would you like to import it?</p>
                <div class="space-y-3">
                    <label class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer">
                        <input type="radio" name="import-option" value="create" class="mr-2" checked>
                        <strong>Create New Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Adds the imported planner to your list. If an ID conflict exists, a new one will be created.</small>
                    </label>
                    <label id="import-merge-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="merge" class="mr-2" disabled>
                        <strong>Merge with Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Combines PEs and rows with the currently open planner. This option is only available when a planner is open.</small>
                    </label>
                    <label id="import-replace-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="replace" class="mr-2" disabled>
                        <strong>Replace Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Deletes the currently open planner and replaces it with the imported one. This cannot be undone.</small>
                    </label>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-end space-x-2">
                <button id="import-options-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="import-options-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Confirm Import</button>
            </div>
        </div>
    </div>
    <div id="element-popover" class="hidden absolute z-[1001] bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-300 dark:border-gray-600 w-full max-w-md flex flex-col transition-opacity duration-150">
        <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-lg">
            <h4 id="popover-title" class="font-semibold text-gray-800 dark:text-gray-200 text-sm"></h4>
            <button id="popover-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xl font-bold leading-none">&times;</button>
        </div>
        <div id="popover-content" class="overflow-y-auto max-h-[50vh]"></div>
    </div>


    <div id="tooltip" class="fixed bg-gray-900 text-white px-3 py-1.5 rounded-md z-[1002] pointer-events-none opacity-0 transition-opacity text-sm max-w-md shadow-lg"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        /** @namespace App */
        const App = {
            state: {
                programData: {},
                currentPlannerId: null,
                currentActiveTab: 'pe',
                saveTimeout: null,
                draggedGroup: null, 
                isViewMode: false,
                isPeBundleMode: false,
                undoStack: [],
                redoStack: [],
                pendingImportData: null,
                allNgssData: [],
                allNgss3dElements: [],
                progressionViewType: 'element',
                summaryShowCoveredOnly: false,
                summaryChartFilter: null,
            },
			dataMaps: {
                peMap: new Map(),
                ngss3dMap: new Map(),
                peTo3dMap: new Map(),
                parentToChildrenMap: new Map(),
                major3DMap: new Map(),
                nameToCodeMap: new Map(),
                textToSpecificCodeMap: new Map(),
                fuzzyMatchCache: new Map(),
                gradeBandMap: { 
                    'K': 'primary', '1': 'primary', '2': 'primary', 'K-2': 'primary',
                    '3': 'elementary', '4': 'elementary', '5': 'elementary', '3-5': 'elementary',
                    'MS': 'middle', '6-8': 'middle',
                    'HS': 'high', '9-12': 'high'
                }
            },
            dom: {
                sidebar: document.getElementById('sidebar'),
                navigatorList: document.getElementById('navigator-list'),
                mainContent: document.getElementById('main-content'),
                plannerView: document.getElementById('planner-view'),
                plannerTableContainer: document.getElementById('planner-table-container'),
                tabContainer: document.getElementById('tab-container'),
                saveStatus: document.getElementById('save-status'),
                tooltip: document.getElementById('tooltip'),
                loadingIndicator: document.getElementById('loading-indicator'),
                body: document.getElementById('body-tag'),
                undoBtn: document.getElementById('undo-btn'),
                redoBtn: document.getElementById('redo-btn'),
                searchInput: document.getElementById('search-input'),
                plannerPhenomenon: document.getElementById('planner-phenomenon'),
                plannerQuestion: document.getElementById('planner-question'),
            },
            constants: {
                statusClasses: {
                    I: 'bg-yellow-200/50 dark:bg-yellow-700/30 border-yellow-300',
                    D: 'bg-green-200/50 dark:bg-green-700/30 border-green-300',
                    A: 'bg-blue-200/50 dark:bg-blue-700/30 border-blue-300',
                },
                statusBadgeClasses: {
                    I: 'bg-yellow-200 text-yellow-800 dark:bg-yellow-300 dark:text-yellow-900',
                    D: 'bg-green-200 text-green-800 dark:bg-green-300 dark:text-green-900',
                    A: 'bg-blue-200 text-blue-800 dark:bg-blue-300 dark:text-blue-900',
                },
                scopeClasses: {
                    F: 'bg-indigo-200/60 dark:bg-indigo-700/40 border-indigo-300',
                    S: 'bg-rose-200/60 dark:bg-rose-700/40 border-rose-300'
                }
            },

            init() {
                this.persistence.loadProgramData();
                this.render.navigator();
                this.attachEventListeners();
                this.tour.init();
                this.popover.init();
                this.utils.showView('welcome-view');

                this.dom.loadingIndicator.style.opacity = '0';
                setTimeout(() => {
                    this.dom.loadingIndicator.style.display = 'none';
                    if (!localStorage.getItem('ngssPlannerTourCompleted')) {
                        if (App.state.programData.planners.length > 0) {
                           this.tour.start();
                        }
                    }
                }, 500);
            },
            
            buildDataMaps() {
                const { ngss3dMap, peMap, peTo3dMap, parentToChildrenMap, major3DMap, nameToCodeMap, textToSpecificCodeMap, fuzzyMatchCache } = this.dataMaps;
                ngss3dMap.clear(); peMap.clear(); peTo3dMap.clear(); parentToChildrenMap.clear(); major3DMap.clear(); nameToCodeMap.clear(); textToSpecificCodeMap.clear(); fuzzyMatchCache.clear();
                
                const processElementForMaps = (element) => {
                    if (!element.name) return;
                    const firstColonIndex = element.name.indexOf(':');
                    if (firstColonIndex > -1) {
                        const code = element.name.substring(0, firstColonIndex).trim();
                        const nameOnly = element.name.substring(firstColonIndex + 1).trim();
                        major3DMap.set(code, nameOnly);
                        nameToCodeMap.set(element.name, code); 
                        nameToCodeMap.set(nameOnly, code);
                    }
                };
                
                if (!this.state.allNgss3dElements) return;

                this.state.allNgss3dElements.forEach(dim => {
                    const elementsToProcess = dim.elements || dim.core_ideas || [];
                    if (dim.understandings) {
                        dim.understandings.forEach(u => { if(u.elements) elementsToProcess.push(...u.elements); });
                    }

                    elementsToProcess.forEach(el => {
                         const processProgressions = (item) => {
                             if(item.progressions){
                                 Object.values(item.progressions).forEach(pArr=>{
                                     if(Array.isArray(pArr)) {
                                         pArr.forEach(i=>{
                                             if(!i) return;
                                             i.parentName = item.name;
                                             i.parentCode = item.name.split(':')[0].trim();
                                             i.dimension = dim.short_name;
                                             i.allProgressions = item.progressions;
                                             i.relatedPes = new Set();
                                             ngss3dMap.set(i.code,i);
                                             textToSpecificCodeMap.set(i.text.trim(), i.code);
                                         });
                                     }
                                 });
                             }
                         };
                        processElementForMaps(el);
                        processProgressions(el);
                        if (el.components) {
                            el.components.forEach(comp => {
                                processElementForMaps(comp);
                                processProgressions(comp);
                            });
                        }
                    });
                });
                
                if (!this.state.allNgssData) return;

                this.state.allNgssData.forEach(gradeData => {
                    if(!gradeData.topics) return;
                    gradeData.topics.forEach(t => {
                        if(!t.performanceExpectations) return;
                        t.performanceExpectations.forEach(p => {
                            peMap.set(p.id, p);
                            if (!p.details) return;

                            const componentCodes = new Set();
                            const secondaryComponentCodes = new Set();
                            const specificCodes = new Set();

                            ['sep', 'dci', 'ccc'].forEach(key => {
                                const refs = p.details[key] || [];
                                refs.forEach(ref => {
                                    let lineMatched = false;
                                    const textLines = Array.isArray(ref.text) ? ref.text : (ref.text ? [ref.text] : []);
                                    
                                    textLines.forEach(line => {
                                        if (!line || typeof line !== 'string') return;
                                        const cleanLine = line.trim();
                                        if(!cleanLine) return;

                                        const specCode = App.utils.findBestMatchingSpecificElement(cleanLine, gradeData.gradeLabel);
                                        if (specCode) {
                                            specificCodes.add(specCode);
                                            const el = ngss3dMap.get(specCode);
                                            if (el) {
                                                el.relatedPes.add(p.id);
                                                if (el.parentCode) componentCodes.add(el.parentCode);
                                            }
                                            lineMatched = true;
                                        }
                                        
                                        const potentialCode = nameToCodeMap.get(cleanLine);
                                        if (potentialCode) {
                                            componentCodes.add(potentialCode);
                                        }
                                    });
                                    
                                    const isSecondary = ref.id.includes('(secondary)');
                                    const cleanId = ref.id.replace(' (secondary)', '').trim();
                                    const nameOnly = cleanId.includes(':') ? cleanId.split(':').pop().trim() : cleanId;
                                    const cCode = nameToCodeMap.get(cleanId) || nameToCodeMap.get(nameOnly);
                                    if (cCode) {
                                        if(isSecondary) {
                                            secondaryComponentCodes.add(cCode);
                                        } else {
                                            componentCodes.add(cCode);
                                        }
                                    }
                                });
                            });

                            if (componentCodes.size > 0 || secondaryComponentCodes.size > 0 || specificCodes.size > 0) {
                                peTo3dMap.set(p.id, { componentCodes, secondaryComponentCodes, specificCodes });
                            }
                        });
                    });
                });
                
                const processParent = (parent, dimShortName) => {
                    if (!parent.progressions) return;
                    const parentCode = parent.code || parent.name.split(':')[0].trim();
                    const children = [];
                    Object.values(parent.progressions).forEach(bandProg => { if(bandProg) children.push(...bandProg) });
                    const uniqueChildren = Array.from(new Map(children.map(item => [item.code, item])).values());
                    parentToChildrenMap.set(parentCode, {name: parent.name, children: uniqueChildren, dimension: dimShortName});
                };

                this.state.allNgss3dElements.forEach(dim => {
                    (dim.elements || []).forEach(el => processParent(el, dim.short_name));
                    (dim.core_ideas || []).forEach(el => {
                        if (el.progressions) {
                            processParent(el, dim.short_name);
                        } else if (el.components) {
                            el.components.forEach(comp => processParent(comp, dim.short_name));
                        }
                    });
                });
                parentToChildrenMap.set('PE', {name: "Performance Expectations", children: [], dimension: 'PE'});
            },

            attachEventListeners() {
                document.getElementById('new-planner-btn').addEventListener('click', () => this.utils.openPlannerModal());
                document.getElementById('view-progression-btn').addEventListener('click', () => this.render.progressionViewer());
                document.getElementById('view-summary-btn').addEventListener('click', () => this.render.summary());
                
                this.dom.navigatorList.addEventListener('click', e => { if (e.target.type === 'checkbox') return; const item = e.target.closest('.planner-item'); if (item) { this.render.plannerView(item.dataset.plannerId); if (window.innerWidth <= 768) this.dom.body.classList.remove('sidebar-open'); } });
                document.getElementById('assign-pe-btn').addEventListener('click', () => this.utils.openPeAssignmentModal());
                document.getElementById('add-lesson-set-btn').addEventListener('click', () => this.utils.addRow('lesson-set', 'New Lesson Set...'));
                document.getElementById('add-lesson-btn').addEventListener('click', () => this.utils.addRow('lesson', 'New Lesson...'));
                document.getElementById('edit-planner-btn').addEventListener('click', () => { const p = this.utils.findPlanner(this.state.currentPlannerId); if(p) this.utils.openPlannerModal(p); });
                
                this.dom.undoBtn.addEventListener('click', () => this.history.undo());
                this.dom.redoBtn.addEventListener('click', () => this.history.redo());
                this.dom.searchInput.addEventListener('input', e => this.utils.performSearch(e.target.value));
                document.getElementById('help-btn').addEventListener('click', () => this.tour.start());
                document.getElementById('welcome-help-btn').addEventListener('click', () => this.tour.start());
                document.getElementById('progression-view-element').addEventListener('click', () => { App.state.progressionViewType = 'element'; App.render.progressionViewer(); });
                document.getElementById('progression-view-lesson').addEventListener('click', () => { App.state.progressionViewType = 'lesson'; App.render.progressionViewer(); });

                document.getElementById('view-mode-toggle').addEventListener('click', () => this.utils.toggleViewMode());
                document.getElementById('pe-bundle-toggle').addEventListener('change', e => { App.state.isPeBundleMode = e.target.checked; App.render.setActiveTab(App.state.currentActiveTab); });
                document.getElementById('export-planner-btn').addEventListener('click', () => this.export.showExportOptions());
                document.getElementById('import-planner-btn').addEventListener('click', () => this.import.handleImport());
                
                document.getElementById('export-options-list').addEventListener('click', e => {
                    const btn = e.target.closest('.export-option-btn');
                    if (btn) {
                        const format = btn.dataset.format;
                        const planner = App.utils.findPlanner(App.state.currentPlannerId);
                        if (!planner) return;
                        App.export.handleExportClick(format, planner);
                        if (format !== 'clipboard') {
                            this.utils.closeAllModals();
                        }
                    }
                });
                
                document.getElementById('import-options-confirm').addEventListener('click', () => this.import.processImport());

                this.dom.plannerTableContainer.addEventListener('click', e => this.handlers.mainTableClick(e));
                this.dom.plannerTableContainer.addEventListener('blur', e => { if (e.target.matches('.editable')) this.handlers.titleEdit(e) }, true);
                this.dom.tabContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) this.render.setActiveTab(e.target.dataset.tab); });
                document.body.addEventListener('mouseover', e => this.handlers.tooltipShow(e));
                document.body.addEventListener('mouseout', () => this.handlers.tooltipHide());

                this.dom.plannerTableContainer.addEventListener('dragstart', e => this.handlers.dragStart(e));
                this.dom.plannerTableContainer.addEventListener('dragover', e => this.handlers.dragOver(e));
                this.dom.plannerTableContainer.addEventListener('dragleave', e => this.handlers.dragLeave(e));
                this.dom.plannerTableContainer.addEventListener('drop', e => this.handlers.drop(e));

                document.getElementById('planner-modal-save').addEventListener('click', () => this.utils.savePlanner());
                document.getElementById('pe-modal-save').addEventListener('click', () => this.utils.savePeAssignments());
                document.getElementById('planner-modal-delete').addEventListener('click', () => { if (confirm('Are you sure? This cannot be undone.')) { const id = document.getElementById('planner-id-input').value; this.state.programData.planners = this.state.programData.planners.filter(p => p.id !== id); this.persistence.saveProgramData(); this.history.clear(); this.utils.closeAllModals(); this.utils.showView('welcome-view'); this.state.currentPlannerId = null; this.render.navigator(); } });
                
                document.getElementById('add-link-btn').addEventListener('click', () => this.utils.addLinkToDetailsModal());
                document.getElementById('lesson-links-container').addEventListener('click', (e) => { if(e.target.classList.contains('remove-link-btn')) this.utils.removeLinkFromDetailsModal(e.target); });
                document.getElementById('lesson-details-modal-close').addEventListener('click', () => this.utils.saveLessonDetails());

                document.body.addEventListener('click', e => { if(e.target.matches('.modal-backdrop, [id$="-modal-cancel"], [id$="-modal-close"]')) this.utils.closeAllModals(); });

                document.getElementById('menu-toggle').addEventListener('click', () => this.dom.body.classList.toggle('sidebar-open'));
                document.getElementById('sidebar-backdrop').addEventListener('click', () => this.dom.body.classList.remove('sidebar-open'));

                document.addEventListener('keydown', (e) => {
                    if (document.activeElement.isContentEditable || document.querySelector('.modal-backdrop:not(.hidden)')) return;
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); this.history.undo(); }
                        if (e.key === 'y') { e.preventDefault(); this.history.redo(); }
                    }
                });
            },

            // --- MODULES ---
            popover: {
                dom: {},
                state: { isVisible: false, activeCell: null, activeRowId: null },
                init() {
                    this.dom.container = document.getElementById('element-popover');
                    this.dom.title = document.getElementById('popover-title');
                    this.dom.content = document.getElementById('popover-content');
                    document.getElementById('popover-close').addEventListener('click', () => this.hide());
                    this.dom.content.addEventListener('change', (e) => {
                        if (e.target.type === 'radio') this.handleSelectionChange(e.target);
                    });
                },
                _handleOutsideClick(e) {
                    if (this.state.isVisible && !this.dom.container.contains(e.target) && !this.state.activeCell.contains(e.target)) {
                        this.hide();
                    }
                },
                show(cell, parentCode, rowId) {
                    if (this.state.isVisible) this.hide();
                    this.state.activeCell = cell;
                    this.state.activeRowId = rowId;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    const rowData = App.utils.findRowData(planner, rowId);
                    if (!planner || !rowData) return;
                    const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                    this.dom.title.textContent = parentInfo ? parentInfo.name : 'Select Elements';
                    this.dom.content.innerHTML = this.buildContentHTML(parentInfo, planner.gradeBand, rowData);
                    this.dom.container.classList.remove('hidden');
                    this.state.isVisible = true;
                    this.position(cell);
                    setTimeout(() => document.addEventListener('click', this._handleOutsideClick.bind(this), { capture: true, once: true }), 0);
                },
                hide() {
                    this.dom.container.classList.add('hidden');
                    this.state.isVisible = false;
                    this.state.activeCell = null;
                    this.state.activeRowId = null;
                },
                position(targetCell) {
                    const rect = targetCell.getBoundingClientRect();
                    const popover = this.dom.container;
                    let top = rect.bottom + 8;
                    let left = rect.left;
                    if (top + popover.offsetHeight > window.innerHeight) top = rect.top - popover.offsetHeight - 8;
                    if (left + popover.offsetWidth > window.innerWidth) left = rect.right - popover.offsetWidth;
                    if (left < 8) left = 8;
                    popover.style.top = `${top}px`;
                    popover.style.left = `${left}px`;
                },
                buildContentHTML(parentInfo, gradeBand, rowData) {
                    let children = [];
                    if (parentInfo) {
                        const parentProgressions = parentInfo.children[0]?.allProgressions || {};
                        const gradeBandProgressions = parentProgressions[gradeBand] || [];
                        const validCodesForBand = new Set(gradeBandProgressions.map(p => p.code));
                        children = parentInfo.children.filter(child => validCodesForBand.has(child.code));
                    }
                    if (children.length === 0) return '<p class="text-center text-gray-500 dark:text-gray-400 p-8">No elements for this category in the selected grade band.</p>';
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    return children.map(child => {
                        const elData = App.dataMaps.ngss3dMap.get(child.code);
                        let indicatorHTML = '';
                        if (elData) {
                            const linkedPEs = [...elData.relatedPes].filter(peId => (planner.assignedPes || []).some(p => p.id === peId));
                            if (linkedPEs.length > 0) {
                                indicatorHTML = `<span class="pe-link-indicator" title="Linked to assigned PE(s): ${linkedPEs.join(', ')}">PE</span>`;
                            }
                        }
                        const currentStatus = rowData.trackingData[child.code] || '';
                        const u = `status-${child.code}`;
                        return `<div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <div>
                                        <strong class="font-semibold">${child.code}</strong>${indicatorHTML}
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${child.text}</p>
                                    </div>
                                    <div class="flex gap-1.5 flex-shrink-0">
                                        <input type="radio" id="${u}-none" name="${u}" value="" ${!currentStatus&&'checked'} class="hidden peer/none"><label for="${u}-none" title="None" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-gray-300 dark:border-gray-600 font-bold text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 peer-checked/none:ring-2 ring-gray-400">-</label>
                                        <input type="radio" id="${u}-i" name="${u}" value="I" ${currentStatus==='I'&&'checked'} class="hidden peer/i"><label for="${u}-i" title="Introduced" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-yellow-400 font-bold text-sm bg-yellow-200 text-yellow-800 hover:bg-yellow-300 peer-checked/i:ring-2 ring-yellow-500">I</label>
                                        <input type="radio" id="${u}-d" name="${u}" value="D" ${currentStatus==='D'&&'checked'} class="hidden peer/d"><label for="${u}-d" title="Developed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-green-400 font-bold text-sm bg-green-200 text-green-800 hover:bg-green-300 peer-checked/d:ring-2 ring-green-500">D</label>
                                        <input type="radio" id="${u}-a" name="${u}" value="A" ${currentStatus==='A'&&'checked'} class="hidden peer/a"><label for="${u}-a" title="Assessed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-blue-400 font-bold text-sm bg-blue-200 text-blue-800 hover:bg-blue-300 peer-checked/a:ring-2 ring-blue-500">A</label>
                                    </div>
                                </div>`;
                    }).join('');
                },
                handleSelectionChange(radioInput) {
                    const rowId = this.state.activeRowId;
                    if (!rowId) return;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    const rowData = App.utils.findRowData(planner, rowId);
                    if (!rowData) return;
                    App.history.saveState(planner);
                    const code = radioInput.name.replace('status-', '');
                    if (radioInput.value) {
                        rowData.trackingData[code] = radioInput.value;
                    } else {
                        delete rowData.trackingData[code];
                    }
                    App.render.renderPlannerContent();
                    App.render.setActiveTab(App.state.currentActiveTab);
                    App.persistence.debouncedSave();
                }
            },

            db: {
                db: null,
                DB_NAME: 'NGSSDataDB',
                STORE_NAME: 'ngss_data',
                DB_VERSION: 1,
                init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                        request.onerror = (event) => reject("IndexedDB error: " + request.error);
                        request.onsuccess = (event) => {
                            this.db = event.target.result;
                            resolve();
                        };
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                                db.createObjectStore(this.STORE_NAME);
                            }
                        };
                    });
                },
                get(key) {
                    return new Promise((resolve, reject) => {
                        if (!this.db) return reject("DB not initialized");
                        const transaction = this.db.transaction([this.STORE_NAME], 'readonly');
                        const store = transaction.objectStore(this.STORE_NAME);
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                set(key, value) {
                    return new Promise((resolve, reject) => {
                        if (!this.db) return reject("DB not initialized");
                        const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(this.STORE_NAME);
                        const request = store.put(value, key);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }
            },
            
            persistence: {
                saveProgramData() { localStorage.setItem('ngssProgramPlannerData', JSON.stringify(App.state.programData)); },
                loadProgramData() { const data = localStorage.getItem('ngssProgramPlannerData'); App.state.programData = data ? JSON.parse(data) : { programName: "My K-12 Science Program", planners: [] }; },
                debouncedSave() { clearTimeout(App.state.saveTimeout); App.dom.saveStatus.textContent = 'Saving...'; App.state.saveTimeout = setTimeout(() => { const planner = App.utils.findPlanner(App.state.currentPlannerId); if (planner) { planner.activeTab = App.state.currentActiveTab; this.saveProgramData(); App.dom.saveStatus.innerHTML = `Saved ‚úì <span class="font-normal">${new Date().toLocaleTimeString()}</span>`; } }, 1000); },
                updateStateFromTableOrder() {
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    if (!planner) return;
                    const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                    if (!tbody) return;
                    const newRowsState = [];
                    const allRowsMap = new Map();
                    planner.rows.forEach(row => {
                        allRowsMap.set(row.id, row.type === 'lesson-set' ? { ...row, children: [] } : { ...row });
                        if (row.children) {
                            row.children.forEach(child => allRowsMap.set(child.id, { ...child }));
                        }
                    });
                    let currentLessonSet = null;
                    Array.from(tbody.children).forEach(rowEl => {
                        const id = rowEl.dataset.id;
                        const rowData = allRowsMap.get(id);
                        if (!rowData) return;
                        if (rowData.type === 'lesson-set') {
                            currentLessonSet = rowData;
                            newRowsState.push(currentLessonSet);
                        } else if (rowData.type === 'lesson') {
                            if (currentLessonSet) {
                                currentLessonSet.children.push(rowData);
                            } else {
                                newRowsState.push(rowData);
                            }
                        }
                    });
                    planner.rows = newRowsState;
                }
            },

            history: {
                saveState(planner) {
                    if (!planner) return;
                    const stateCopy = JSON.parse(JSON.stringify(planner));
                    App.state.undoStack.push(stateCopy);
                    App.state.redoStack = []; 
                    this.updateUndoRedoButtons();
                },
                undo() {
                    if (App.state.undoStack.length === 0) return;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    const currentState = JSON.parse(JSON.stringify(planner));
                    App.state.redoStack.push(currentState);
                    const previousState = App.state.undoStack.pop();
                    Object.assign(planner, previousState);
                    App.render.plannerView(App.state.currentPlannerId);
                    App.persistence.saveProgramData(); 
                    this.updateUndoRedoButtons();
                },
                redo() {
                    if (App.state.redoStack.length === 0) return;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    const currentState = JSON.parse(JSON.stringify(planner));
                    App.state.undoStack.push(currentState);
                    const nextState = App.state.redoStack.pop();
                    Object.assign(planner, nextState);
                    App.render.plannerView(App.state.currentPlannerId);
                    App.persistence.saveProgramData();
                    this.updateUndoRedoButtons();
                },
                clear() {
                    App.state.undoStack = [];
                    App.state.redoStack = [];
                    this.updateUndoRedoButtons();
                },
                updateUndoRedoButtons() {
                    App.dom.undoBtn.disabled = App.state.undoStack.length === 0;
                    App.dom.redoBtn.disabled = App.state.redoStack.length === 0;
                }
            },

            render: {
                navigator() { App.dom.navigatorList.innerHTML = ''; App.state.programData.planners.forEach(planner => { const item = document.createElement('li'); item.className = `planner-item flex items-center gap-2 p-2 rounded-md cursor-pointer transition-colors user-select-none ${planner.id === App.state.currentPlannerId ? 'bg-blue-600 font-bold' : 'hover:bg-gray-700'}`; item.dataset.plannerId = planner.id; item.innerHTML = `<input type="checkbox" class="planner-checkbox" title="Select for progression view"><span class="planner-title flex-grow pointer-events-none">${planner.title}</span><span class="planner-band text-xs bg-gray-600 px-2 py-0.5 rounded-full text-white">${planner.gradeBand}</span>`; App.dom.navigatorList.appendChild(item); }); },
                plannerView(plannerId) {
                    const planner = App.utils.findPlanner(plannerId); if (!planner) { App.utils.showView('welcome-view'); return; }
                    App.state.currentPlannerId = plannerId;
                    App.history.clear(); 

                    document.getElementById('planner-title').textContent = planner.title;
                    document.getElementById('planner-subtitle').textContent = `${planner.course} (${planner.gradeBand})`;
                    document.getElementById('planner-phenomenon').textContent = planner.phenomenon || 'Not specified.';
                    document.getElementById('planner-question').textContent = planner.question || 'Not specified.';

                    const allColumns = App.utils.gatherColumns(planner.gradeBand);
                    
                    this.tabs(allColumns);
                    this.renderPlannerContent(); 

                    this.setActiveTab(planner.activeTab || 'pe');
                    App.utils.showView('planner-view');
                    this.navigator();
                },
                renderPlannerContent() {
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    if (!planner) return;
                    const allColumns = App.utils.gatherColumns(planner.gradeBand);

                    this.table(allColumns);
                    this.rowsFromState(planner.rows || []);
                },
                table(columnGroups) {
                    App.dom.plannerTableContainer.innerHTML = ''; 
                    const table = document.createElement('table'); 
                    table.className = 'table-view fixed-layout'; // Using fixed-layout class
                    const thead = document.createElement('thead');
                    
                    let headerRowHTML = `<tr>
                        <th class="sticky-col-1 bg-gray-100 dark:bg-gray-800 border-b border-r border-gray-300 dark:border-gray-700">Actions</th>
                        <th class="sticky-col-2 bg-gray-100 dark:bg-gray-800 border-b border-r border-gray-300 dark:border-gray-700">Scope</th>
                        <th class="sticky-col-3 bg-gray-100 dark:bg-gray-800 border-b border-r border-gray-300 dark:border-gray-700 text-left pl-2">Instructional Sequence</th>`;
                    
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);

                    Object.keys(columnGroups).forEach(key => {
                        if (key === 'pe') {
                            (planner?.assignedPes || []).forEach(peObj => {
                                 const peCode = peObj.id;
                                 const peData = App.dataMaps.peMap.get(peCode);
                                 const tooltip = peData ? `${peCode}: ${peData.description.replace(/"/g, '&quot;')}` : peCode;
                                 const secondaryClass = peObj.isSecondary ? 'font-normal italic text-gray-500 dark:text-gray-400' : 'font-semibold';
                                 headerRowHTML += `<th class="data-col-header cursor-pointer ${secondaryClass}" data-tab-group="pe" data-code="${peCode}" data-tooltip="${tooltip}"><div class="vertical-header-text">${peCode}</div></th>`;
                            });
                            if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                                headerRowHTML += `<th class="font-normal" data-tab-group="pe"><div>Assign PEs</div></th>`;
                            }
                        } else {
                            columnGroups[key].cols.forEach(col => {
                                headerRowHTML += `<th class="data-col-header cursor-pointer" data-tab-group="${key}" data-code="${col.code}" data-tooltip="${col.title}"><div class="vertical-header-text">${col.title}</div></th>`;
                            });
                        }
                    });
                    headerRowHTML += '</tr>'; thead.innerHTML = headerRowHTML; table.appendChild(thead); table.appendChild(document.createElement('tbody')); App.dom.plannerTableContainer.appendChild(table);
                },
                rowsFromState(rowsData) {
                    const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                    tbody.innerHTML = '';
                    if (!rowsData || rowsData.length === 0) return;
                    rowsData.forEach(rowData => {
                        tbody.appendChild(this.createRowElement(rowData));
                        if (rowData.type === 'lesson-set' && rowData.children) {
                            rowData.children.forEach(childRowData => {
                                const childRow = this.createRowElement(childRowData, rowData.id);
                                if (rowData.isCollapsed) childRow.classList.add('hidden');
                                tbody.appendChild(childRow);
                            });
                        }
                    });
                    this.updateTableHeaderHighlights();
                },
                createRowElement(rowData, parentId = null) {
                    const row = document.createElement('tr');
                    const searchTerm = App.dom.searchInput.value.toLowerCase();
                    if (searchTerm && rowData.type === 'lesson') {
                        const rowText = (rowData.title + ' ' + Object.keys(rowData.trackingData || {}).join(' ')).toLowerCase();
                        if (!rowText.includes(searchTerm)) {
                            row.classList.add('filtered-out');
                        }
                    }
                    
                    row.className += ` ${rowData.type}-row group/row`; row.dataset.rowType = rowData.type; row.dataset.id = rowData.id;
                    row.draggable = !App.state.isViewMode;

                    const planner = App.utils.findPlanner(App.state.currentPlannerId); const columnGroups = App.utils.gatherColumns(planner.gradeBand);
                    const borderClass = "border-b border-r border-gray-200 dark:border-gray-700";

                    if (rowData.type === 'lesson-set') {
                        const isCollapsedClass = rowData.isCollapsed ? 'is-collapsed' : '';
                        const rotateClass = rowData.isCollapsed ? '-rotate-90' : '';
                        const editableSpan = `<span class="editable group-[.view-mode-active]:cursor-default group-[.view-mode-active]:bg-transparent group-[.view-mode-active]:outline-none hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="${!App.state.isViewMode}">${rowData.title}</span>`;
                        
                        let cellsHTML = `
                            <td class="sticky-col-1 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 align-middle"><span class="drag-handle cursor-grab group-[.view-mode-active]:hidden mr-2">‚†ø</span> <span class="delete-btn cursor-pointer text-gray-400 font-bold invisible group-hover/row:visible hover:text-red-500 transition-colors group-[.view-mode-active]:hidden" title="Delete Lesson Set">‚úñ</span></td>
                            <td class="sticky-col-2 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 align-middle"></td>
                            <td class="sticky-col-3 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 font-semibold cursor-pointer ${isCollapsedClass}"><span class="collapse-icon inline-block mr-1 transition-transform ${rotateClass}">‚ñº</span> ${editableSpan}</td>`;
                        
                        Object.keys(columnGroups).forEach(key => {
                            if (key === 'pe') {
                                const peCount = planner?.assignedPes?.length || 0;
                                if (peCount > 0) {
                                    cellsHTML += `<td data-tab-group="pe" class="p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50" colspan="${peCount}"></td>`;
                                } else {
                                    cellsHTML += `<td data-tab-group="pe" class="p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50"></td>`;
                                }
                            } else {
                                columnGroups[key].cols.forEach(() => {
                                    cellsHTML += `<td data-tab-group="${key}" class="p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50"></td>`;
                                });
                            }
                        });
                        row.innerHTML = cellsHTML;

                    } else {
                        if (parentId) row.dataset.parentId = parentId;
                        const scope = rowData.scope || '';
                        const scopeClass = App.constants.scopeClasses[scope] || '';
                        const scopeCursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer';
                        const editableSpan = `<span class="editable group-[.view-mode-active]:cursor-default group-[.view-mode-active]:bg-transparent group-[.view-mode-active]:outline-none hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="${!App.state.isViewMode}">${rowData.title}</span>`;
                        const notesIcon = `<span class="notes-btn cursor-pointer text-base" title="Edit Notes & Links">üìù</span>`;
                        
                        let cellsHTML = `
                            <td class="sticky-col-1 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 align-middle">
                                <div class="flex items-center justify-start gap-2 text-gray-400 w-full overflow-hidden">
                                    <span class="drag-handle cursor-grab group-[.view-mode-active]:hidden">‚†ø</span>
                                    <div class="flex items-center gap-2 invisible group-hover/row:visible">
                                        ${notesIcon}
                                        <span class="delete-btn cursor-pointer font-bold hover:text-red-500 transition-colors group-[.view-mode-active]:hidden" title="Delete Lesson">‚úñ</span>
                                        <span class="add-below-btn cursor-pointer hover:text-green-500 transition-colors group-[.view-mode-active]:hidden" title="Add Lesson Below">+</span>
                                        <span class="copy-row-btn cursor-pointer hover:text-blue-500 transition-colors group-[.view-mode-active]:hidden" title="Duplicate Lesson">‚ùê</span>
                                    </div>
                                </div>
                            </td>
                            <td data-scope-cell="true" class="sticky-col-2 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 align-middle font-bold text-center ${scopeCursorClass} ${scopeClass}" data-tooltip="Click to cycle Assessment Scope">${scope}</td>
                            <td class="sticky-col-3 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 text-left ${parentId ? 'pl-10' : ''}"><div class="truncate">${editableSpan}</div></td>`;

                        Object.keys(columnGroups).forEach(key => {
                             if (key === 'pe') {
                                 (planner?.assignedPes || []).forEach(peObj => {
                                     cellsHTML += this.createTrackingCellHTML({ code: peObj.id, type: 'pe' }, rowData);
                                 });
                                 if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                                    cellsHTML += `<td data-tab-group="pe" class="p-2 ${borderClass}"></td>`;
                                 }
                             } else {
                                cellsHTML += columnGroups[key].cols.map(col => this.createTrackingCellHTML({ code: col.code, title: col.title, type: '3d', tabGroup: key }, rowData)).join('');
                             }
                        });
                        row.innerHTML = cellsHTML;
                    } return row;
                },
                createTrackingCellHTML(column, rowData) {
                    const commonCellClasses = "p-2 border border-gray-200 dark:border-gray-700 align-top";
                    if (column.type === 'pe') {
                        const status = rowData.trackingData?.[column.code] || '';
                        const statusClass = App.constants.statusClasses[status] || '';
                        const cursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer hover:bg-yellow-300/50 dark:hover:bg-yellow-500/50';
                        return `<td class="${commonCellClasses} text-center font-bold ${cursorClass} ${statusClass}" data-tab-group="pe" data-pe-code="${column.code}" data-tooltip="Click to change status for ${column.code}">${status}</td>`;
                    }
                    const parentCode = column.code; 
                    const cellTooltip = `${column.title}. Click to edit elements.`;
                    const cursorClass = App.state.isViewMode ? 'cursor-default' : 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50';
                    const cellContent = this.generateCellContent(parentCode, rowData);
                    return `<td class="${commonCellClasses} ${cursorClass}" data-tab-group="${column.tabGroup}" data-parent-code="${parentCode}" data-tooltip="${cellTooltip}">${cellContent}</td>`;
                },
                generateCellContent(parentCode, rowData) {
                    const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                    const childrenCodes = parentInfo ? parentInfo.children.map(c => c.code) : [];
                    const trackedChildren = childrenCodes.filter(code => rowData.trackingData?.[code]).map(code => ({ code, status: rowData.trackingData[code] }));
                    const badgeHTML = trackedChildren.map(child => {
                        const details = App.dataMaps.ngss3dMap.get(child.code) || {description: 'N/A', text: 'N/A'};
                        const text = (details.text || details.description).replace(/"/g, '&quot;');
                        const badgeTooltip = `<b>${child.code} (${child.status})</b>: ${text}`;
                        const badgeColor = App.constants.statusBadgeClasses[child.status] || 'bg-gray-200 dark:bg-gray-600';
                        return `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${badgeTooltip}">${child.code}</span>`;
                    }).join('');
                    return `<div class="flex flex-wrap gap-1 items-center min-h-[24px]">${badgeHTML}</div>`;
                },
                tabs(columnGroups) { App.dom.tabContainer.innerHTML = ''; Object.keys(columnGroups).forEach(key => { if(columnGroups[key].cols.length > 0 || key === 'pe') { const btn = document.createElement('button'); btn.className = 'tab-button px-4 py-2 cursor-pointer border border-transparent rounded-t-lg font-medium transition-colors text-sm'; btn.dataset.tab = key; btn.textContent = columnGroups[key].name; App.dom.tabContainer.appendChild(btn); } }); },
                setActiveTab(tabKey) {
                    const table = App.dom.plannerTableContainer.querySelector('table');
                    if (!table || !App.dom.tabContainer.querySelector(`[data-tab="${tabKey}"]`)) {
                        tabKey = 'pe';
                    }
                    App.state.currentActiveTab = tabKey;
                    App.dom.tabContainer.querySelectorAll('.tab-button').forEach(b => {
                        const isActive = b.dataset.tab === tabKey;
                        b.classList.toggle('bg-white', isActive); b.classList.toggle('dark:bg-gray-800/50', isActive); b.classList.toggle('border-gray-300', isActive); b.classList.toggle('dark:border-gray-700', isActive); b.classList.toggle('border-b-white', isActive); b.classList.toggle('dark:border-b-gray-800/50', isActive); b.classList.toggle('text-blue-600', isActive); b.classList.toggle('dark:text-blue-400', isActive); b.classList.toggle('bg-gray-100', !isActive); b.classList.toggle('dark:bg-transparent', !isActive); b.classList.toggle('text-gray-500', !isActive); b.classList.toggle('dark:text-gray-400', !isActive); b.classList.toggle('hover:text-gray-700', !isActive); b.classList.toggle('dark:hover:text-gray-200', !isActive);
                    });
                    if (table) {
                        const planner = App.utils.findPlanner(App.state.currentPlannerId);
                        let bundledParentCodes = null;
                        if (App.state.isPeBundleMode && planner) {
                            bundledParentCodes = new Set();
                            const assignedPes = (planner.assignedPes || []).map(p => p.id);
                            assignedPes.forEach(peCode => {
                                const links = App.dataMaps.peTo3dMap.get(peCode);
                                if (links) {
                                    links.specificCodes.forEach(specificCode => {
                                        const element = App.dataMaps.ngss3dMap.get(specificCode);
                                        if (element && element.parentCode) {
                                            bundledParentCodes.add(element.parentCode);
                                        }
                                    });
                                }
                            });
                        }
                        table.querySelectorAll('th[data-tab-group], td[data-tab-group]').forEach(cell => {
                            const isVisibleForTab = cell.dataset.tabGroup === tabKey;
                            let isVisibleForBundle = true; 
                            if (bundledParentCodes !== null && cell.dataset.tabGroup !== 'pe') {
                                const code = cell.dataset.code || cell.dataset.parentCode;
                                isVisibleForBundle = bundledParentCodes.has(code);
                            }
                            cell.style.display = (isVisibleForTab && isVisibleForBundle) ? '' : 'none';
                        });
                    }
                    App.persistence.debouncedSave();
                },
                updateTableHeaderHighlights() {
                    const planner = App.utils.findPlanner(App.state.currentPlannerId); if (!planner) return;
                    const assignedPes = planner.assignedPes || [];
                    const primaryLinks = new Set();
                    const secondaryLinks = new Set();

                    assignedPes.forEach(peObj => {
                        const links = App.dataMaps.peTo3dMap.get(peObj.id);
                        if (!links) return;
                        
                        const targetSet = peObj.isSecondary ? secondaryLinks : primaryLinks;
                        links.componentCodes.forEach(code => targetSet.add(code));
                        links.specificCodes.forEach(code => {
                            const el = App.dataMaps.ngss3dMap.get(code);
                            if(el && el.parentCode) targetSet.add(el.parentCode);
                        });
                        links.secondaryComponentCodes.forEach(code => secondaryLinks.add(code));
                    });
                
                    App.dom.plannerTableContainer.querySelectorAll('thead th[data-code]').forEach(th => {
                        const code = th.dataset.code;
                        th.classList.remove('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold', 'bg-gray-300', 'dark:bg-gray-700', 'bg-gray-400/50', 'dark:bg-gray-600/50');
                        th.classList.add('bg-gray-200', 'dark:bg-gray-800');

                        const isPrimaryPe = assignedPes.some(p => p.id === code && !p.isSecondary);
                        const isSecondaryPe = assignedPes.some(p => p.id === code && p.isSecondary);

                        if (isPrimaryPe) {
                            th.classList.add('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold');
                        } else if (isSecondaryPe) {
                            th.classList.add('bg-blue-100', 'dark:bg-blue-900/20');
                        } else if (primaryLinks.has(code)) {
                            th.classList.add('bg-gray-300', 'dark:bg-gray-700');
                        } else if (secondaryLinks.has(code)) {
                            th.classList.add('bg-gray-400/50', 'dark:bg-gray-600/50');
                        }
                    });
                },
                progressionViewer() { 
                    const btnElement = document.getElementById('progression-view-element');
                    const btnLesson = document.getElementById('progression-view-lesson');
                    
                    btnElement.classList.toggle('bg-white', App.state.progressionViewType === 'element');
                    btnElement.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'element');
                    btnLesson.classList.toggle('bg-white', App.state.progressionViewType === 'lesson');
                    btnLesson.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'lesson');
                    
                    if (App.state.progressionViewType === 'lesson') {
                        this.renderProgressionByLesson();
                    } else {
                        this.renderProgressionByElement();
                    }
                    App.utils.showView('progression-view'); 
                },
                renderProgressionByElement() {
                    const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                    if (selectedPlannerIds.length === 0) { 
                        alert('Please select at least one planner from the navigator to view its progression.'); 
                        return; 
                    } 
                    const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id)); 
                    const tableContainer = document.getElementById('progression-table-view');
                    tableContainer.innerHTML = '';
                    document.getElementById('progression-subtitle').textContent = `Comparing: ${selectedPlanners.map(p => p.title).join(', ')}`; 
                    
                    const allTrackedElements = new Map(); 
                    const allUnique3DElements = new Map();

                    selectedPlanners.forEach(planner => { 
                        (planner.rows || []).forEach(row => { 
                            const processLesson = (lesson, lessonSetTitle = null) => { 
                                if (!lesson.trackingData) return;
                                Object.entries(lesson.trackingData).forEach(([code, status]) => { 
                                    const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                                    if (elementData) {
                                        if (!allTrackedElements.has(code)) { 
                                            allTrackedElements.set(code, []);
                                            allUnique3DElements.set(code, elementData);
                                        } 
                                        allTrackedElements.get(code).push({ plannerId: planner.id, lessonTitle: lesson.title, lessonSetTitle: lessonSetTitle, status: status });
                                    }
                                }); 
                            }; 
                            if (row.type === 'lesson') processLesson(row); 
                            else if (row.type === 'lesson-set' && row.children) row.children.forEach(lesson => processLesson(lesson, row.title)); 
                        }); 
                    }); 

                    const groupedElements = { PE: [], SEP: [], DCI: [], CCC: [] };
                    const groupNames = { PE: "Performance Expectations", SEP: "Science and Engineering Practices", DCI: "Disciplinary Core Ideas", CCC: "Crosscutting Concepts & Connections" };

                    allUnique3DElements.forEach((elementData, code) => {
                        if (App.dataMaps.peMap.has(code)) {
                            groupedElements.PE.push([code, elementData]);
                        } else {
                            const dim = elementData.dimension || '';
                            if (dim.startsWith('SEP')) groupedElements.SEP.push([code, elementData]);
                            else if (dim.startsWith('DCI')) groupedElements.DCI.push([code, elementData]);
                            else groupedElements.CCC.push([code, elementData]);
                        }
                    });

                    for (const key in groupedElements) {
                        groupedElements[key].sort((a, b) => a[0].localeCompare(b[0]));
                    }

                    let tableHTML = `<table class="w-full border-collapse"><thead><tr class="bg-gray-200 dark:bg-gray-800"><th class="sticky p-2 border border-gray-300 dark:border-gray-700 text-left top-0 bg-gray-200 dark:bg-gray-800">3D Element / PE</th>`;
                    selectedPlanners.forEach(p => { tableHTML += `<th class="p-2 border border-gray-300 dark:border-gray-700 text-left sticky top-0 bg-gray-200 dark:bg-gray-800">${p.title}</th>`; });
                    tableHTML += `</tr></thead><tbody>`;

                    Object.keys(groupedElements).forEach(groupKey => {
                        const elements = groupedElements[groupKey];
                        if (elements.length > 0) {
                            tableHTML += `<tr><th colspan="${selectedPlanners.length + 1}" class="p-2 text-left bg-gray-100 dark:bg-gray-900/50 font-bold text-lg text-gray-700 dark:text-gray-300 border-t-4 border-b-2 border-gray-300 dark:border-gray-600">${groupNames[groupKey]}</th></tr>`;
                            
                            elements.forEach(([code, elementData]) => {
                                const desc = elementData.text || elementData.description || '';
                                const elementTooltip = desc.replace(/"/g, '&quot;');
                                tableHTML += `<tr class="border-b dark:border-gray-700">
                                    <td class="p-2 border border-gray-300 dark:border-gray-700 align-top font-semibold sticky left-0 bg-gray-50 dark:bg-gray-800/50 shadow-[4px_0_5px_-2px_rgba(0,0,0,0.05)] dark:shadow-[4px_0_5px_-2px_rgba(0,0,0,0.2)]">
                                        <strong data-tooltip="${elementTooltip}">${code}</strong><br><small class="font-normal text-gray-600 dark:text-gray-400">${desc}</small>
                                    </td>`;
                                selectedPlanners.forEach(planner => {
                                    const entriesForPlanner = (allTrackedElements.get(code) || []).filter(e => e.plannerId === planner.id);
                                    let cellContent = '<div class="flex flex-col space-y-2">';
                                    if (entriesForPlanner.length > 0) {
                                        cellContent += entriesForPlanner.map(e => {
                                           const tooltip = `${e.lessonSetTitle ? `${e.lessonSetTitle} &rarr; ` : ''}${e.lessonTitle}`;
                                           const badgeColor = App.constants.statusBadgeClasses[e.status] || 'bg-gray-200 dark:bg-gray-600';
                                           return `<div class="flex items-center gap-2 text-sm">
                                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 ${badgeColor}" data-tooltip="${tooltip.replace(/"/g, '&quot;')}">${e.status}</span>
                                                    <span class="truncate" title="${tooltip}">${tooltip}</span>
                                                   </div>`;
                                        }).join('');
                                    }
                                    cellContent += '</div>';
                                    tableHTML += `<td class="p-2 border border-gray-300 dark:border-gray-700 align-top">${cellContent}</td>`;
                                });
                                tableHTML += `</tr>`;
                            });
                        }
                    });
                    tableHTML += `</tbody></table>`;
                    tableContainer.innerHTML = tableHTML;
                },
                renderProgressionByLesson() {
                    const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                    if (selectedPlannerIds.length === 0) { 
                        alert('Please select at least one planner from the navigator to view its progression.'); 
                        return; 
                    } 
                    const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id));
                    
                    const container = document.getElementById('progression-table-view');
                    container.innerHTML = '';
                    document.getElementById('progression-subtitle').textContent = `Storyline for: ${selectedPlanners.map(p => p.title).join(', ')}`;

                    selectedPlanners.forEach(planner => {
                        const plannerSection = document.createElement('div');
                        plannerSection.className = 'mb-8 border-b-4 border-gray-300 dark:border-gray-600 pb-4';
                        plannerSection.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">${planner.title} <small class="text-base font-normal text-gray-500">(${planner.gradeBand})</small></h2>`;
                        
                        (planner.rows || []).forEach(row => {
                            const rowEl = document.createElement('div');
                            rowEl.className = 'mb-4';
                            if (row.type === 'lesson-set') {
                                rowEl.innerHTML = `<h3 class="text-lg font-bold p-2 bg-blue-100 dark:bg-blue-900/50 rounded-t-lg text-blue-800 dark:text-blue-200">${row.title}</h3>`;
                                (row.children || []).forEach(lesson => {
                                    rowEl.innerHTML += this.createStorylineLessonHTML(lesson);
                                });
                            } else {
                                rowEl.innerHTML = this.createStorylineLessonHTML(row);
                            }
                            plannerSection.appendChild(rowEl);
                        });
                        container.appendChild(plannerSection);
                    });
                },
                createStorylineLessonHTML(lesson) {
                     const groupedBadges = { PE: [], SEP: [], DCI: [], CCC: [] };

                     Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                        const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                        const desc = elementData ? (elementData.text || elementData.description) : 'Unknown Element';
                        const tooltip = `<b>${code} (${status})</b>: ${desc.replace(/"/g, '&quot;')}`;
                        const badgeColor = App.constants.statusBadgeClasses[status] || 'bg-gray-200 dark:bg-gray-600';
                        const badgeHTML = `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${tooltip}">${code}</span>`;

                        if (App.dataMaps.peMap.has(code)) {
                            groupedBadges.PE.push(badgeHTML);
                        } else if (elementData) {
                            const dim = elementData.dimension || '';
                            if (dim.startsWith('SEP')) groupedBadges.SEP.push(badgeHTML);
                            else if (dim.startsWith('DCI')) groupedBadges.DCI.push(badgeHTML);
                            else groupedBadges.CCC.push(badgeHTML);
                        }
                    });

                    let finalHTML = '';
                    const groupOrder = ['PE', 'DCI', 'SEP', 'CCC'];
                    const groupNames = { PE: 'PEs', DCI: 'DCIs', SEP: 'SEPs', CCC: 'CCCs' };

                    groupOrder.forEach(key => {
                        if (groupedBadges[key].length > 0) {
                            finalHTML += `<div class="flex items-start gap-2 mb-1.5">
                                            <strong class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 w-10 flex-shrink-0 pt-0.5">${groupNames[key]}:</strong>
                                            <div class="flex flex-wrap gap-1.5">${groupedBadges[key].join('')}</div>
                                          </div>`;
                        }
                    });

                    return `
                        <div class="p-3 border dark:border-gray-700 bg-white dark:bg-gray-800/50">
                            <h4 class="font-semibold">${lesson.title}</h4>
                            <div class="mt-2 space-y-2">
                                ${finalHTML || '<p class="text-xs text-gray-500 dark:text-gray-400">No elements tracked.</p>'}
                            </div>
                        </div>
                    `;
                },
                
                summary() {
                    // 1. Determine which planners to summarize
                    const checkedBoxes = document.querySelectorAll('.planner-checkbox:checked');
                    let selectedPlanners = [];
                    
                    if (checkedBoxes.length > 0) {
                        selectedPlanners = Array.from(checkedBoxes).map(cb => {
                            return App.utils.findPlanner(cb.closest('.planner-item').dataset.plannerId);
                        }).filter(p => p); 
                    } else {
                        const current = App.utils.findPlanner(App.state.currentPlannerId);
                        if (current) selectedPlanners = [current];
                    }

                    if (selectedPlanners.length === 0) {
                        document.getElementById('summary-content').innerHTML = '<p class="p-4 text-gray-500">Please select a planner or check boxes in the navigator to view a summary.</p>';
                        return;
                    }

                    // 2. Setup Headers & Filter UI
                    const titleText = selectedPlanners.length === 1 ? selectedPlanners[0].title : 'Combined Summary';
                    const subText = selectedPlanners.length === 1 
                        ? `${selectedPlanners[0].course} (${selectedPlanners[0].gradeBand})` 
                        : `Aggregating data from ${selectedPlanners.length} selected planners.`;
                    
                    document.querySelector('#summary-view h1').textContent = titleText;
                    document.getElementById('summary-subtitle').textContent = subText;

                    const container = document.getElementById('summary-content');
                    const isChecked = App.state.summaryShowCoveredOnly ? 'checked' : '';
                    
                    // Generate Active Filter Badge HTML
                    let filterBadge = '';
                    if (App.state.summaryChartFilter) {
                        const { type, value } = App.state.summaryChartFilter;
                        let label = value;
                        if (value === 'I') label = 'Introduced';
                        if (value === 'D') label = 'Developed';
                        if (value === 'A') label = 'Assessed';
                        if (value === '') label = 'Not Scoped';
                        if (value === 'F') label = 'Formative';
                        if (value === 'S') label = 'Summative';
                        
                        filterBadge = `
                            <button id="clear-filter-btn" class="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm font-bold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                                <span>Filter: ${type.charAt(0).toUpperCase() + type.slice(1)} = ${label}</span>
                                <span class="text-lg leading-none">&times;</span>
                            </button>
                        `;
                    }

                    container.innerHTML = `
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div id="filter-container">${filterBadge}</div>
                            <label class="flex items-center cursor-pointer">
                                <span class="mr-3 text-sm font-medium text-gray-900 dark:text-gray-300">Show Covered Elements Only</span>
                                <div class="relative">
                                    <input type="checkbox" id="summary-coverage-toggle" class="sr-only peer" ${isChecked}>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                </div>
                            </label>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                                <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">3D Element Status Distribution</h3>
                                <div class="relative h-64"><canvas id="status-chart"></canvas></div>
                                <p class="text-xs text-center mt-2 text-gray-400">Click bars to filter report by status</p>
                            </div>
                            <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                                <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">Dimension Usage Balance</h3>
                                <div class="relative h-64"><canvas id="dimension-chart"></canvas></div>
                                <p class="text-xs text-center mt-2 text-gray-400">Click ring to filter report by dimension</p>
                            </div>
                            <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                                <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">Assessment Scope</h3>
                                <div class="relative h-64"><canvas id="scope-chart"></canvas></div>
                                <p class="text-xs text-center mt-2 text-gray-400">Click slices to filter report by scope</p>
                            </div>
                        </div>
                        
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                            <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-100">Element Coverage Report</h3>
                            <div id="element-coverage-report" class="space-y-6"></div>
                        </div>
                    `;

                    // 3. Attach Listeners
                    document.getElementById('summary-coverage-toggle').addEventListener('change', (e) => {
                        App.state.summaryShowCoveredOnly = e.target.checked;
                        this.summary();
                    });
                    
                    if (document.getElementById('clear-filter-btn')) {
                        document.getElementById('clear-filter-btn').addEventListener('click', () => {
                            App.state.summaryChartFilter = null;
                            this.summary();
                        });
                    }

                    // 4. Aggregate Data
                    const globalStats = {
                        status: { I: 0, D: 0, A: 0 },
                        dimension: { SEP: 0, DCI: 0, CCC: 0, PE: 0 },
                        scope: { F: 0, S: 0, None: 0 }
                    };
                    
                    const coverageMap = new Map(); 
                    const filter = App.state.summaryChartFilter;

                    selectedPlanners.forEach(planner => {
                        const allLessons = [];
                        (planner.rows || []).forEach(row => {
                            if (row.type === 'lesson') allLessons.push(row);
                            else if (row.type === 'lesson-set') allLessons.push(...(row.children || []));
                        });

                        allLessons.forEach(lesson => {
                            const scopeKey = lesson.scope || 'None';
                            
                            globalStats.scope[scopeKey]++;
                            Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                                if (globalStats.status[status] !== undefined) globalStats.status[status]++;
                                
                                const element = App.dataMaps.ngss3dMap.get(code);
                                if (element) {
                                    if (element.dimension.startsWith('SEP')) globalStats.dimension.SEP++;
                                    else if (element.dimension.startsWith('DCI')) globalStats.dimension.DCI++;
                                    else globalStats.dimension.CCC++;
                                } else if (App.dataMaps.peMap.has(code)) {
                                    globalStats.dimension.PE++;
                                }
                            });

                            if (filter && filter.type === 'scope') {
                                const targetScope = filter.value === 'None' ? '' : (filter.value === 'Formative' ? 'F' : 'S');
                                if ((lesson.scope || '') !== targetScope) return;
                            }

                            Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                                if (!coverageMap.has(code)) coverageMap.set(code, { I: 0, D: 0, A: 0 });
                                coverageMap.get(code)[status]++;
                            });
                        });
                    });

                    // 5. Render Interactive Charts
                    const handleChartClick = (type, labelMap) => (e, elements) => {
                        if (!elements || elements.length === 0) return;
                        const index = elements[0].index;
                        const chart = e.chart; 
                        const label = chart.data.labels[index];
                        let value = label;
                        if (labelMap) value = labelMap[label];
                        App.state.summaryChartFilter = { type, value };
                        this.summary(); 
                    };

                    new Chart(document.getElementById('status-chart'), {
                        type: 'bar',
                        data: {
                            labels: ['Introduced', 'Developed', 'Assessed'],
                            datasets: [{ 
                                label: 'Count', 
                                data: [globalStats.status.I, globalStats.status.D, globalStats.status.A], 
                                backgroundColor: ['#FBBF24', '#34D399', '#60A5FA'],
                                borderRadius: 4
                            }]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                            onClick: handleChartClick('status', { 'Introduced': 'I', 'Developed': 'D', 'Assessed': 'A' }),
                            onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                        }
                    });

                    new Chart(document.getElementById('dimension-chart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['SEPs', 'DCIs', 'CCCs', 'PEs'],
                            datasets: [{ 
                                data: [globalStats.dimension.SEP, globalStats.dimension.DCI, globalStats.dimension.CCC, globalStats.dimension.PE], 
                                backgroundColor: ['#818CF8', '#F87171', '#FB923C', '#60A5FA'],
                                borderWidth: 0
                            }]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false,
                            onClick: handleChartClick('dimension', { 'SEPs': 'sep', 'DCIs': 'dci', 'CCCs': 'ccc', 'PEs': 'pe' }),
                            onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                        }
                    });

                    new Chart(document.getElementById('scope-chart'), {
                        type: 'pie',
                        data: {
                            labels: ['Formative', 'Summative', 'Not Scoped'],
                            datasets: [{ 
                                data: [globalStats.scope.F, globalStats.scope.S, globalStats.scope.None], 
                                backgroundColor: ['#6366F1', '#EC4899', '#E5E7EB'],
                                borderWidth: 0
                            }]
                        },
                        options: { 
                            responsive: true, maintainAspectRatio: false,
                            onClick: handleChartClick('scope'),
                            onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                        }
                    });
                    
                    // 6. Render Coverage Report
                    const coverageReportContainer = document.getElementById('element-coverage-report');
                    const relevantBands = new Set(selectedPlanners.map(p => p.gradeBand));
                    
                    let reportHTML = '';
                    let groupOrder = ['dci', 'sep', 'ccc'];
                    if (filter && filter.type === 'dimension') {
                        if (filter.value === 'pe') groupOrder = []; 
                        else groupOrder = [filter.value];
                    }
                    
                    const groups = { dci: [], sep: [], ccc: [] };
                    App.dataMaps.parentToChildrenMap.forEach((parentInfo, parentCode) => {
                        if (parentCode === 'PE') return;
                        let dimKey = '';
                        if (parentInfo.dimension.startsWith('DCI')) dimKey = 'dci';
                        else if (parentInfo.dimension === 'SEP') dimKey = 'sep';
                        else if (parentInfo.dimension === 'CCC' || parentInfo.dimension === 'C-ETAS') dimKey = 'ccc';
                        else if (parentInfo.dimension === 'CNS') {
                            if (['VOM', 'BEE', 'OTR', 'ENP'].includes(parentCode)) dimKey = 'sep';
                            else dimKey = 'ccc';
                        }
                        if (dimKey && groups[dimKey]) {
                            groups[dimKey].push({ code: parentCode, ...parentInfo });
                        }
                    });

                    groupOrder.forEach(groupKey => {
                        const parentsInGroup = groups[groupKey];
                        if (!parentsInGroup || parentsInGroup.length === 0) return;

                        let groupHTML = `<div class="mb-6"><h4 class="text-xl font-bold border-b-2 pb-2 mb-4 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-100">${groupKey.toUpperCase()}</h4>`;
                        let hasVisibleParents = false;

                        parentsInGroup.forEach(parentInfo => {
                            const childrenForReport = parentInfo.children.filter(child => {
                                const inSelectedBands = Array.from(relevantBands).some(band => child.allProgressions[band]?.length > 0);
                                const isTracked = coverageMap.has(child.code);
                                return inSelectedBands || isTracked;
                            });

                            const visibleChildren = childrenForReport.filter(child => {
                                const coverage = coverageMap.get(child.code);
                                const isCovered = !!coverage;
                                if (App.state.summaryShowCoveredOnly && !isCovered) return false;
                                if (filter && filter.type === 'status') {
                                    if (!coverage || !coverage[filter.value]) return false;
                                }
                                return true;
                            });

                            if (visibleChildren.length === 0) return;
                            hasVisibleParents = true;

                            groupHTML += `<div class="mb-5 pl-2">
                                            <h5 class="font-bold text-gray-700 dark:text-gray-300 mb-2">${parentInfo.name}</h5>
                                            <ul class="space-y-3">`;
                            
                            visibleChildren.forEach(child => {
                                const coverage = coverageMap.get(child.code);
                                let coverageString = '';
                                let rowClass = 'bg-gray-50 dark:bg-gray-700/30'; 

                                if (coverage) {
                                    coverageString = Object.entries(coverage)
                                        .filter(([, count]) => count > 0)
                                        .map(([status, count]) => {
                                            const isMatch = (filter && filter.type === 'status' && filter.value === status);
                                            const border = isMatch ? 'border-2 border-black dark:border-white ring-2 ring-offset-1 ring-blue-400' : 'border border-black/10';
                                            return `<span class="px-2 py-0.5 rounded-full text-xs font-bold ${App.constants.statusBadgeClasses[status]} ${border}">${status}: ${count}</span>`;
                                        })
                                        .join(' ');
                                    rowClass = 'bg-white dark:bg-gray-800 border-l-4 border-blue-400';
                                } else {
                                    coverageString = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-400">Not Covered</span>`;
                                }

                                groupHTML += `<li class="p-3 rounded-md border border-gray-100 dark:border-gray-700 ${rowClass}">
                                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                                                    <div class="text-sm">
                                                        <span class="font-bold text-gray-800 dark:text-gray-200">${child.code}</span>
                                                        <span class="text-gray-600 dark:text-gray-400 block mt-1">${child.text}</span>
                                                    </div>
                                                    <div class="flex-shrink-0 flex flex-wrap gap-1.5 mt-1 sm:mt-0">${coverageString}</div>
                                                </div>
                                               </li>`;
                            });
                            groupHTML += `</ul></div>`;
                        });
                        
                        groupHTML += `</div>`;
                        if (hasVisibleParents) reportHTML += groupHTML;
                    });

                    if (reportHTML === '') {
                        reportHTML = `<div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg border border-dashed border-gray-300 dark:border-gray-700">
                            <p class="text-gray-500 text-lg">No elements match the current filters.</p>
                            ${filter ? `<button id="clear-filter-empty-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Clear Filter</button>` : ''}
                        </div>`;
                    }

                    coverageReportContainer.innerHTML = reportHTML;
                    
                    if(document.getElementById('clear-filter-empty-btn')) {
                         document.getElementById('clear-filter-empty-btn').addEventListener('click', () => {
                            App.state.summaryChartFilter = null;
                            this.summary();
                        });
                    }

                    App.utils.showView('summary-view');
                },
            },

            tour: {
                instance: null,
                init() {
                    this.instance = new Shepherd.Tour({
                        useModalOverlay: true,
                        defaultStepOptions: {
                            classes: 'shadow-md bg-gray-100 dark:bg-gray-700',
                            scrollTo: true
                        }
                    });

                    this.instance.addStep({
                        id: 'step1', text: 'Welcome! This is the Navigator. All your planners are listed here. Let\'s create a new one.',
                        attachTo: { element: '#new-planner-btn', on: 'bottom' }, buttons: [{ action() { this.next(); }, text: 'Next' }]
                    });
                    this.instance.addStep({
                        id: 'step2', text: 'After creating a planner, assign the Performance Expectations (PEs) you\'ll be targeting.',
                        attachTo: { element: '#assign-pe-btn', on: 'bottom' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                    });
                    this.instance.addStep({
                        id: 'step3', text: 'Your instructional sequence appears here. You can edit titles, add lessons, and drag-and-drop to reorder.',
                        attachTo: { element: '#planner-table-container', on: 'top' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                    });
                     this.instance.addStep({
                        id: 'step4', text: 'Use these tabs to switch between tracking PEs and the three dimensions (DCIs, SEPs, CCCs).',
                        attachTo: { element: '#tab-container', on: 'bottom' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                    });
                     this.instance.addStep({
                        id: 'step5', text: 'Click inside a cell to open a popover and track an element\'s status (Introduced, Developed, or Assessed) for that lesson.',
                        attachTo: { element: '#planner-table-container tbody tr:first-child td:last-child', on: 'left' }, isRequired: ['#planner-table-container tbody tr'], buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.next(); }, text: 'Next' }]
                    });
                    this.instance.addStep({
                        id: 'step6', text: 'You can check multiple planners in the navigator and click Summary to see aggregated analytics.',
                        attachTo: { element: '#view-summary-btn', on: 'right' }, buttons: [{ action() { this.back(); }, text: 'Back' }, { action() { this.complete(); }, text: 'Finish' }]
                    });

                    this.instance.on('complete', () => {
                        localStorage.setItem('ngssPlannerTourCompleted', 'true');
                    });
                },
                start() {
                    if (App.state.currentPlannerId === null && App.state.programData.planners.length > 0) {
                        App.render.plannerView(App.state.programData.planners[0].id);
                    } else if (App.state.programData.planners.length === 0) {
                        const newPlanner = {
                            id: `planner-${Date.now()}`, title: 'Sample 4th Grade Unit', course: '4th Grade Science', gradeBand: 'elementary', standardSet: 'NGSS',
                            phenomenon: 'A wrecking ball can knock down a wall.', question: 'How does energy change and move?', description: 'A sample unit.',
                            assignedPes: [{id: "4-PS3-1", isSecondary: false}, {id:"4-PS3-2", isSecondary: false}, {id:"4-PS3-4", isSecondary: false}],
                            rows: [
                                { id: `row-${Date.now()}-1`, type: 'lesson-set', title: 'Lesson Set 1', isCollapsed: false, children: [
                                    { id: `row-${Date.now()}-2`, type: 'lesson', title: 'Lesson 1', trackingData: {'4-PS3-1':'I'}, scope:'F', details:{notes:'', links:[]} }
                                ]}
                            ]
                        };
                        App.state.programData.planners.push(newPlanner);
                        App.persistence.saveProgramData();
                        App.render.navigator();
                        App.render.plannerView(newPlanner.id);
                    }
                    setTimeout(() => this.instance.start(), 200);
                }
            }
        };
        
        async function loadDataAndInit() {
            try {
                await App.db.init();
                const cachedMaps = await App.db.get('processed_maps');

                if (cachedMaps) {
                    console.log("Loading processed data maps from cache.");
                    App.dataMaps.peMap = new Map(cachedMaps.peMap);
                    App.dataMaps.ngss3dMap = new Map(cachedMaps.ngss3dMap);
                    App.dataMaps.peTo3dMap = new Map(cachedMaps.peTo3dMap.map(([key, value]) => [key, { componentCodes: new Set(value.componentCodes), secondaryComponentCodes: new Set(value.secondaryComponentCodes), specificCodes: new Set(value.specificCodes) }]));
                    App.dataMaps.parentToChildrenMap = new Map(cachedMaps.parentToChildrenMap);
                    App.dataMaps.major3DMap = new Map(cachedMaps.major3DMap);
                    App.dataMaps.nameToCodeMap = new Map(cachedMaps.nameToCodeMap);
                    App.dataMaps.textToSpecificCodeMap = new Map(cachedMaps.textToSpecificCodeMap);
                    App.state.allNgssData = await App.db.get('raw_ngss_data');
                    if (!App.state.allNgssData) throw new Error("Raw data missing from cache.");
                } else {
                    console.log("Data not found in cache. Fetching from server and processing...");
                    const dataPath = 'https://philm013.github.io/JSON/';
                    const [ngss3d, k5, m68, h912] = await Promise.all([
                        fetch(`${dataPath}ngss3DElements.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss3DElements.json`); return res.json(); }),
                        fetch(`${dataPath}ngssK5.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngssK5.json`); return res.json(); }),
                        fetch(`${dataPath}ngss68.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss68.json`); return res.json(); }),
                        fetch(`${dataPath}ngss912.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss912.json`); return res.json(); })
                    ]);
                    
                    App.state.allNgss3dElements = ngss3d;
                    const msData = { gradeId: 'MS', gradeLabel: 'Middle School', topics: m68 };
                    const hsData = { gradeId: 'HS', gradeLabel: 'High School', topics: h912 };
                    App.state.allNgssData = [...k5, msData, hsData];
                    
                    App.buildDataMaps();
                    
                    const serializableMaps = {
                        peMap: [...App.dataMaps.peMap],
                        ngss3dMap: [...App.dataMaps.ngss3dMap],
                        peTo3dMap: [...App.dataMaps.peTo3dMap].map(([key, value]) => [key, { componentCodes: [...value.componentCodes], secondaryComponentCodes: [...value.secondaryComponentCodes], specificCodes: [...value.specificCodes] }]),
                        parentToChildrenMap: [...App.dataMaps.parentToChildrenMap],
                        major3DMap: [...App.dataMaps.major3DMap],
                        nameToCodeMap: [...App.dataMaps.nameToCodeMap],
                        textToSpecificCodeMap: [...App.dataMaps.textToSpecificCodeMap],
                    };
                    await App.db.set('processed_maps', serializableMaps);
                    await App.db.set('raw_ngss_data', App.state.allNgssData);
                    console.log("Data processed and cached.");
                }

                App.init();

            } catch (error) {
                console.error("Failed to load NGSS data:", error);
                document.getElementById('loading-indicator').textContent = 'Error loading data. Please check the console and refresh. Make sure you are running this from a web server and the ../JSON/ folder is accessible.';
            }
        }
        
        loadDataAndInit();
    });
    </script>
</body>
</html>
