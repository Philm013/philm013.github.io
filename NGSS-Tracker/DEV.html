<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 NGSS 3D Progression Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script>
        tailwind.config = { darkMode: 'media' }
    </script>
    <style>
        /* --- SCROLLBARS --- */
        #planner-table-container, .modal-content, #progression-table-view, #summary-content, #popover-content {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar, .modal-content::-webkit-scrollbar, #progression-table-view::-webkit-scrollbar, #summary-content::-webkit-scrollbar, #popover-content::-webkit-scrollbar {
            width: 8px; height: 8px;
        }
        #planner-table-container::-webkit-scrollbar-track, .modal-content::-webkit-scrollbar-track, #progression-table-view::-webkit-scrollbar-track, #summary-content::-webkit-scrollbar-track, #popover-content::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        #planner-table-container::-webkit-scrollbar-thumb, .modal-content::-webkit-scrollbar-thumb, #progression-table-view::-webkit-scrollbar-thumb, #summary-content::-webkit-scrollbar-thumb, #popover-content::-webkit-scrollbar-thumb {
            background-color: #a0aec0; border-radius: 10px; border: 2px solid #e2e8f0;
        }
        .dark #planner-table-container, .dark .modal-content, .dark #progression-table-view, .dark #summary-content, .dark #popover-content {
            scrollbar-color: #4a5568 #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-track, .dark .modal-content::-webkit-scrollbar-track, .dark #progression-table-view::-webkit-scrollbar-track, .dark #summary-content::-webkit-scrollbar-track, .dark #popover-content::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark #planner-table-container::-webkit-scrollbar-thumb, .dark .modal-content::-webkit-scrollbar-thumb, .dark #progression-table-view::-webkit-scrollbar-thumb, .dark #summary-content::-webkit-scrollbar-thumb, .dark #popover-content::-webkit-scrollbar-thumb {
            background-color: #4a5568; border-color: #2d3748;
        }
        
        /* --- STRICT FIXED LAYOUT --- */
        table.fixed-layout {
            table-layout: fixed;
            width: max-content; 
            min-width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
        }

        #planner-table-container thead th {
            position: sticky; top: 0; z-index: 20;
            height: 160px;
            vertical-align: bottom;
            padding: 8px 4px;
            border-bottom: 2px solid #cbd5e0;
            background-clip: padding-box;
        }
        .dark #planner-table-container thead th { border-bottom-color: #4a5568; }

        .vertical-header-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            white-space: nowrap;
            text-align: left;
            max-height: 140px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        /* --- STICKY COLUMNS --- */
        .sticky-col-1 { 
            position: sticky; left: 0; z-index: 25; 
        }
        .sticky-col-2 { 
            position: sticky; left: 65px; z-index: 24; 
        }
        .sticky-col-3 { 
            position: sticky; left: 105px; z-index: 23; 
            box-shadow: 4px 0 5px -2px rgba(0,0,0,0.05);
        }
        .dark .sticky-col-3 { box-shadow: 4px 0 5px -2px rgba(0,0,0,0.25); }
        
        col.sticky-col-1 { width: 65px; min-width: 65px; }
        col.sticky-col-2 { width: 40px; min-width: 40px; }
        col.sticky-col-3 { width: 400px; min-width: 400px; }
        col.data-col { width: 50px; min-width: 50px; }
        col.collapsed { width: 0; min-width: 0; }


        #planner-table-container thead th.sticky-col-1, 
        #planner-table-container thead th.sticky-col-2, 
        #planner-table-container thead th.sticky-col-3 {
			z-index: 30; height: auto; vertical-align: middle; padding-bottom: 10px;
		}

        /* --- MISC --- */
        body.sidebar-open #sidebar { transform: translateX(0); }
        body.sidebar-open #sidebar-backdrop { opacity: 1; pointer-events: auto; }
        body.modal-open #menu-toggle { display: none; }
        .pe-link-indicator { display: inline-block; font-size: 0.7em; padding: 1px 5px; background-color: #e6f4ff; color: #005a9c; border: 1px solid #b3d7ff; border-radius: 4px; font-weight: bold; vertical-align: middle; margin-left: 4px; }
        .dark .pe-link-indicator { background-color: #1e3a8a; color: #93c5fd; border-color: #3b82f6; }
        tr.filtered-out { display: none; }
        #pe-modal-list { overflow-y: auto; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .group-toggle-header { top: 0; z-index: 21 !important; height: auto !important; vertical-align: middle !important; padding: 4px !important; }
        .collapsed-placeholder { width: 30px; min-width: 30px; font-size: 0.8rem; }
    </style>
</head>
<body id="body-tag" class="bg-gray-100 dark:bg-gray-900 font-sans text-gray-800 dark:text-gray-200 antialiased">
    <div id="loading-indicator" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center text-lg text-gray-500 dark:text-gray-400 z-[2000] transition-opacity duration-500">Loading NGSS Planner...</div>

    <div class="relative flex h-screen overflow-hidden">
        <aside id="sidebar" class="bg-gray-800 text-gray-100 flex flex-col w-80 flex-shrink-0 p-4 transform transition-transform duration-300 ease-in-out z-[1000] -translate-x-full md:relative md:translate-x-0 fixed top-0 left-0 h-full md:shadow-lg">
            <h2 class="text-xl font-bold border-b border-gray-600 pb-3 mb-4">Planner Navigator</h2>
            
            <div id="navigator-controls" class="grid grid-cols-1 gap-2 mb-4">
                <button id="new-planner-btn" class="w-full px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">+ New Planner</button>
                <div class="grid grid-cols-2 gap-2">
                    <button id="view-summary-btn" class="w-full px-3 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition-colors font-semibold text-sm">Summary</button>
                    <button id="view-progression-btn" class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-semibold text-sm">Progression</button>
                </div>
            </div>
            
            <ul id="navigator-list" class="overflow-y-auto space-y-1"></ul>
        </aside>

        <div id="main-wrapper" class="flex-1 flex flex-col overflow-x-hidden">
            <button id="menu-toggle" class="md:hidden absolute top-4 left-4 z-[40] bg-gray-800/80 backdrop-blur-sm text-white p-2 rounded-md text-xl">☰</button>
            <div id="sidebar-backdrop" class="md:hidden fixed inset-0 bg-black/40 z-[999] opacity-0 pointer-events-none transition-opacity duration-300"></div>

            <main id="main-content" class="flex-1 flex flex-col p-3 md:p-5 min-h-0">
                <div id="welcome-view" class="view active flex-col items-center justify-center">
                    <!-- Content will be dynamically generated by App.render.welcomeView() -->
                </div>

                <div id="planner-view" class="view flex-1 flex flex-col h-full">
                    <!-- Streamlined Header & Toolbar -->
                    <div class="flex flex-col gap-2 mb-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        <!-- Row 1: Title, Settings, and Info -->
                        <div class="flex justify-between items-start gap-4">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h1 id="planner-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100 leading-tight"></h1>
                                    <button id="edit-planner-btn" class="px-2 py-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-lg" title="Planner Settings">⚙️</button>
                                </div>
                                <p id="planner-subtitle" class="text-sm text-gray-500 dark:text-gray-400"></p>
                            </div>
                            <div class="text-right">
                                <details class="group relative">
                                    <summary class="list-none cursor-pointer text-blue-600 dark:text-blue-400 font-medium flex items-center gap-1 text-xs">
                                        <span class="group-open:rotate-90 transition-transform">▶</span> Show Phenomenon & Driving Question
                                    </summary>
                                    <div class="absolute top-full right-0 mt-1 z-50 w-96 p-4 bg-white dark:bg-gray-800 border border-blue-200 dark:border-blue-900 rounded-lg shadow-xl text-sm">
                                        <p class="font-bold text-blue-800 dark:text-blue-200">Anchoring Phenomenon:</p>
                                        <p id="planner-phenomenon" class="mb-2 text-gray-700 dark:text-gray-300 italic"></p>
                                        <p class="font-bold text-blue-800 dark:text-blue-200">Driving Question:</p>
                                        <p id="planner-question" class="text-gray-700 dark:text-gray-300 italic"></p>
                                    </div>
                                </details>
                                <span id="save-status" class="italic text-gray-400 text-xs mt-1 block"></span>
                            </div>
                        </div>

                        <!-- Row 2: Actions, Tabs, and History -->
                        <div class="flex justify-between items-center gap-2">
                             <div class="flex items-center gap-2">
                                <button id="add-lesson-set-btn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium">+ Set</button>
                                <button id="add-lesson-btn" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs font-medium">+ Lesson</button>
                                <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 dark:text-gray-400 text-xs whitespace-nowrap pl-2 border-l ml-1">
                                    <span>Bundled PEs Only</span>
                                    <input type="checkbox" id="pe-bundle-toggle" class="accent-blue-600">
                                </label>
                            </div>

                            <div id="tab-container" class="tabs flex border-b-2 border-gray-300 dark:border-gray-700 -mb-px flex-1 justify-center"></div>

                            <div class="flex items-center gap-2">
                                <div class="relative group">
                                    <button id="export-dropdown-btn" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs">Export</button>
                                    <div id="export-dropdown-menu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg border dark:border-gray-700 z-50 hidden group-hover:block">
                                        <a href="#" id="export-xlsx-btn" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export to XLSX...</a>
                                        <a href="#" id="export-json-btn" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export as JSON</a>
                                        <a href="#" id="export-html-btn" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Export as HTML</a>
                                    </div>
                                </div>
                                <button id="import-planner-btn" class="px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs">Import</button>
                                <div class="flex gap-1 border-l border-gray-300 dark:border-gray-600 pl-2">
                                    <button id="undo-btn" disabled class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 disabled:opacity-30 disabled:cursor-not-allowed text-xs" title="Undo (Ctrl+Z)">↶</button>
                                    <button id="redo-btn" disabled class="px-2 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 disabled:opacity-30 disabled:cursor-not-allowed text-xs" title="Redo (Ctrl+Y)">↷</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="planner-table-container" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800/50"></div>
                </div>
                
                <div id="progression-view" class="view flex-1 flex flex-col">
                     <div class="flex justify-between items-center mb-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Progression Storyline</h1>
                            <p id="progression-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                                <button id="progression-view-element" class="px-3 py-1 text-sm font-medium rounded-md">By Element</button>
                                <button id="progression-view-lesson" class="px-3 py-1 text-sm font-medium rounded-md">By Lesson</button>
                            </div>
                            <button id="export-progression-btn" class="px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm font-medium transition-colors">Export View</button>
                        </div>
                     </div>
                     <div id="progression-table-view" class="flex-grow overflow-auto border border-gray-300 dark:border-gray-700 rounded-lg p-4"></div>
                </div>
                 <div id="summary-view" class="view flex-1 flex flex-col">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100">Planner Summary & Analytics</h1>
                            <p id="summary-subtitle" class="subtitle text-base text-gray-500 dark:text-gray-400"></p>
                        </div>
                        <button id="export-summary-btn" class="flex-shrink-0 px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm font-medium transition-colors">Export Summary</button>
                    </div>
                    <div id="summary-content" class="flex-grow overflow-auto p-4 space-y-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="planner-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b dark:border-gray-700">
                 <h3 id="planner-modal-title" class="text-xl font-semibold text-gray-900 dark:text-gray-100">New Planner</h3>
            </div>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="planner-id-input">
                <div>
                    <label for="planner-title-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Planner Title</label>
                    <input type="text" id="planner-title-input" placeholder="e.g., Grade 4 Energy Unit" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div>
                    <label for="planner-course-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Course / Subject</label>
                    <input type="text" id="planner-course-input" placeholder="e.g., 4th Grade Science" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="planner-band-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Grade Band</label>
                        <select id="planner-band-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="primary">Grades K-2</option>
                            <option value="elementary">Grades 3-5</option>
                            <option value="middle">Grades 6-8</option>
                            <option value="high">Grades 9-12</option>
                        </select>
                    </div>
                    <div>
                        <label for="planner-standard-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Standard Set</label>
                        <select id="planner-standard-select" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                            <option value="NGSS">NGSS</option>
                        </select>
                    </div>
                </div>
                <div id="new-planner-structure-fields" class="grid grid-cols-2 gap-4 border-t pt-4 dark:border-gray-700">
                    <div>
                        <label for="planner-sets-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Number of Lesson Sets</label>
                        <input type="number" id="planner-sets-input" value="4" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="planner-lessons-per-set-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Lessons per Set</label>
                        <input type="number" id="planner-lessons-per-set-input" value="2" min="1" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                    </div>
                </div>
                 <div>
                    <label for="planner-phenomenon-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Anchoring Phenomenon</label>
                    <textarea id="planner-phenomenon-input" rows="2" placeholder="e.g., A wrecking ball can knock down a building." class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                 <div>
                    <label for="planner-question-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unit Driving Question</label>
                    <textarea id="planner-question-input" rows="2" placeholder="e.g., How can something small cause a big change?" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
                <div>
                    <label for="planner-description-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description (Optional)</label>
                    <textarea id="planner-description-input" rows="3" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-400 dark:placeholder:text-gray-500"></textarea>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-between items-center">
                <button id="planner-modal-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors font-semibold text-sm hidden">Delete</button>
                <div class="flex-grow text-right space-x-2">
                    <button id="planner-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                    <button id="planner-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Planner</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="pe-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100 sticky top-0 bg-white dark:bg-gray-800">Assign Performance Expectations</h3>
            <div class="modal-content p-6 overflow-y-auto" id="pe-modal-list"></div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right space-x-2 sticky bottom-0">
                <button id="pe-modal-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="pe-modal-save" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Save Changes</button>
            </div>
        </div>
    </div>
    <div id="element-detail-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h3 id="element-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Element Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <p id="element-modal-description" class="text-base"></p>
                <div id="element-progression"></div>
                <div id="element-linked-pes"></div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="element-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="export-master-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">XLSX Export Options</h3>
            <div class="modal-content p-6 overflow-y-auto">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Select which XLSX formats you would like to export. All selected items will be bundled into a single file.</p>
                <div id="export-master-options-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-end gap-2">
                <button id="export-master-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold text-sm">Cancel</button>
                <button id="export-master-download" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-semibold text-sm">Download Selected</button>
            </div>
        </div>
    </div>
     <div id="lesson-details-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <h3 id="lesson-details-modal-title" class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Lesson Details</h3>
            <div class="modal-content p-6 space-y-4 overflow-y-auto">
                <div>
                    <label for="lesson-notes-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="lesson-notes-input" rows="6" class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Links & Resources</label>
                    <div id="lesson-links-container" class="space-y-2"></div>
                    <div class="flex gap-2 mt-2">
                         <input type="url" id="new-link-input" placeholder="https://example.com" class="flex-grow px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700">
                         <button id="add-link-btn" class="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">Add</button>
                    </div>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg text-right">
                <button id="lesson-details-modal-close" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 font-semibold text-sm">Close</button>
            </div>
        </div>
    </div>
    <div id="import-options-modal-backdrop" class="modal-backdrop fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="modal bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
             <h3 class="p-6 text-xl font-semibold border-b dark:border-gray-700 text-gray-900 dark:text-gray-100">Import Options</h3>
            <div class="modal-content p-6 overflow-y-auto space-y-4">
                <p>You are importing planner: <strong id="import-planner-name" class="text-blue-600 dark:text-blue-400"></strong></p>
                <p class="text-gray-600 dark:text-gray-400">How would you like to import it?</p>
                <div class="space-y-3">
                    <label class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer">
                        <input type="radio" name="import-option" value="create" class="mr-2" checked>
                        <strong>Create New Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Adds the imported planner to your list. If an ID conflict exists, a new one will be created.</small>
                    </label>
                    <label id="import-merge-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="merge" class="mr-2" disabled>
                        <strong>Merge with Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Combines PEs and rows with the currently open planner. This option is only available when a planner is open.</small>
                    </label>
                    <label id="import-replace-label" class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg has-[:checked]:bg-blue-50 has-[:checked]:dark:bg-blue-900/20 has-[:checked]:border-blue-500 has-[:checked]:dark:border-blue-700 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                        <input type="radio" name="import-option" value="replace" class="mr-2" disabled>
                        <strong>Replace Current Planner</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Deletes the currently open planner and replaces it with the imported one. This cannot be undone.</small>
                    </label>
                </div>
            </div>
            <div class="modal-actions p-4 bg-gray-50 dark:bg-gray-800/50 border-t dark:border-gray-700 rounded-b-lg flex justify-end space-x-2">
                <button id="import-options-cancel" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors font-semibold text-sm">Cancel</button>
                <button id="import-options-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors font-semibold text-sm">Confirm Import</button>
            </div>
        </div>
    </div>
    <div id="element-popover" class="hidden absolute z-[1001] bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-300 dark:border-gray-600 w-full max-w-md flex flex-col transition-opacity duration-150">
        <div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50 rounded-t-lg">
            <h4 id="popover-title" class="font-semibold text-gray-800 dark:text-gray-200 text-sm"></h4>
            <button id="popover-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 text-xl font-bold leading-none">&times;</button>
        </div>
        <div id="popover-content" class="overflow-y-auto max-h-[50vh]"></div>
    </div>


    <div id="tooltip" class="fixed bg-gray-900 text-white px-3 py-1.5 rounded-md z-[1002] pointer-events-none opacity-0 transition-opacity text-sm max-w-md shadow-lg"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        /** @namespace App */
        const App = {
            state: {
                programData: {},
                currentPlannerId: null,
                currentActiveTab: 'pe',
                saveTimeout: null,
                draggedGroup: null, 
                isPeBundleMode: false,
                undoStack: [],
                redoStack: [],
                pendingImportData: null,
                allNgssData: [],
                allNgss3dElements: [],
                progressionViewType: 'element',
                summaryShowCoveredOnly: false,
                summaryChartFilter: null,
                activeCharts: {},
                collapsedSections: new Set(),
            },
			dataMaps: {
                peMap: new Map(),
                ngss3dMap: new Map(),
                peTo3dMap: new Map(),
                parentToChildrenMap: new Map(),
                major3DMap: new Map(),
                nameToCodeMap: new Map(),
                textToSpecificCodeMap: new Map(),
                fuzzyMatchCache: new Map(),
                // Updated to include ETS grade keys (K-2, 3-5, etc.)
                gradeBandMap: { 
                    'K': 'primary', '1': 'primary', '2': 'primary', 'K-2': 'primary',
                    '3': 'elementary', '4': 'elementary', '5': 'elementary', '3-5': 'elementary',
                    'MS': 'middle', '6-8': 'middle',
                    'HS': 'high', '9-12': 'high'
                }
            },
            dom: {
                sidebar: document.getElementById('sidebar'),
                navigatorList: document.getElementById('navigator-list'),
                mainContent: document.getElementById('main-content'),
                plannerView: document.getElementById('planner-view'),
                plannerTableContainer: document.getElementById('planner-table-container'),
                tabContainer: document.getElementById('tab-container'),
                saveStatus: document.getElementById('save-status'),
                tooltip: document.getElementById('tooltip'),
                loadingIndicator: document.getElementById('loading-indicator'),
                body: document.getElementById('body-tag'),
                undoBtn: document.getElementById('undo-btn'),
                redoBtn: document.getElementById('redo-btn'),
                plannerPhenomenon: document.getElementById('planner-phenomenon'),
                plannerQuestion: document.getElementById('planner-question'),
                welcomeView: document.getElementById('welcome-view'),
            },
            constants: {
                statusClasses: {
                    I: 'bg-yellow-200/50 dark:bg-yellow-700/30 border-yellow-300',
                    D: 'bg-green-200/50 dark:bg-green-700/30 border-green-300',
                    A: 'bg-blue-200/50 dark:bg-blue-700/30 border-blue-300',
                },
                statusBadgeClasses: {
                    I: 'bg-yellow-200 text-yellow-800 dark:bg-yellow-300 dark:text-yellow-900',
                    D: 'bg-green-200 text-green-800 dark:bg-green-300 dark:text-green-900',
                    A: 'bg-blue-200 text-blue-800 dark:bg-blue-300 dark:text-blue-900',
                },
                scopeClasses: {
                    F: 'bg-indigo-200/60 dark:bg-indigo-700/40 border-indigo-300',
                    S: 'bg-rose-200/60 dark:bg-rose-700/40 border-rose-300'
                }
            },
            examples: {
                planners: [
                    { "id": "planner-1721248800001", "title": "Grade 7 Earth Systems: Plate Tectonics", "course": "7th Grade Science", "gradeBand": "middle", "standardSet": "NGSS", "phenomenon": "The Hawaiian Islands are a chain of volcanoes that formed in the middle of the Pacific Plate, far from any plate boundary.", "question": "How can new land form in the middle of the ocean?", "description": "A unit exploring the mechanisms of plate tectonics, the rock cycle, and geological time to explain large-scale Earth features and processes.", "activeTab": "dci", "assignedPes": [ { "id": "MS-ESS2-1", "isSecondary": false }, { "id": "MS-ESS2-2", "isSecondary": false }, { "id": "MS-ESS2-3", "isSecondary": false }, { "id": "MS-ESS1-4", "isSecondary": true } ], "rows": [ { "id": "row-1721248800002", "type": "lesson-set", "title": "Anchor Lesson", "isCollapsed": false, "children": [ { "id": "row-1721248800003", "type": "lesson", "title": "Lesson 1: Hawaiian Hot Spot Phenomenon", "trackingData": { "SEP.1-M1": "I", "CCC.2-M2": "I" }, "scope": "", "details": { "notes": "Introduce the phenomenon using maps and videos. Students generate initial questions.", "links": [] } }, { "id": "row-1721248800004", "type": "lesson", "title": "Lesson 2: Initial Models", "trackingData": { "SEP.2-M3": "I", "MS-ESS2-2": "I" }, "scope": "F", "details": { "notes": "Students draw initial models to explain how the Hawaiian islands could have formed.", "links": [] } } ] }, { "id": "row-1721248800005", "type": "lesson-set", "title": "Investigation 1: Earth's Layers & Convection", "isCollapsed": false, "children": [ { "id": "row-1721248800006", "type": "lesson", "title": "Lesson 3: What's Inside Earth?", "trackingData": { "ESS2.A-M1": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800007", "type": "lesson", "title": "Lesson 4: Modeling Mantle Convection", "trackingData": { "ESS2.A-M1": "D", "SEP.2-M3": "D", "CCC.5-M1": "I" }, "scope": "F", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800008", "type": "lesson", "title": "Lesson 5: Tectonic Plates Puzzle", "trackingData": { "ESS2.B-M1": "I", "MS-ESS2-3": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800009", "type": "lesson", "title": "Lesson 6: Plate Boundary Types", "trackingData": { "ESS2.B-M1": "D" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800010", "type": "lesson", "title": "Lesson 7: Revisiting Initial Models", "trackingData": { "SEP.2-M3": "D", "CCC.2-M2": "D" }, "scope": "F", "details": { "notes": "", "links": [] } } ] }, { "id": "row-1721248800011", "type": "lesson-set", "title": "Investigation 2: The Rock Cycle", "isCollapsed": false, "children": [ { "id": "row-1721248800012", "type": "lesson", "title": "Lesson 8: Rock Identification Lab", "trackingData": { "ESS2.A-M2": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800013", "type": "lesson", "title": "Lesson 9: Crayon Rock Cycle Model", "trackingData": { "ESS2.A-M2": "D", "MS-ESS2-1": "I", "CCC.7-M1": "I" }, "scope": "F", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800014", "type": "lesson", "title": "Lesson 10: Weathering and Erosion Stations", "trackingData": { "ESS2.A-M3": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800015", "type": "lesson", "title": "Lesson 11: How Landscapes Change", "trackingData": { "ESS2.A-M3": "D", "MS-ESS2-2": "D" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800016", "type": "lesson", "title": "Lesson 12: Connecting the Rock Cycle to Plate Tectonics", "trackingData": { "MS-ESS2-1": "D", "CCC.7-M1": "D" }, "scope": "F", "details": { "notes": "", "links": [] } } ] }, { "id": "row-1721248800017", "type": "lesson-set", "title": "Investigation 3: Geologic Time", "isCollapsed": false, "children": [ { "id": "row-1721248800018", "type": "lesson", "title": "Lesson 13: Reading Rock Layers", "trackingData": { "ESS1.C-M1": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800019", "type": "lesson", "title": "Lesson 14: Index Fossils", "trackingData": { "ESS1.C-M1": "D", "MS-ESS1-4": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800020", "type": "lesson", "title": "Lesson 15: Geologic Time Scale", "trackingData": { "MS-ESS1-4": "D", "CCC.6-M1": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800021", "type": "lesson", "title": "Lesson 16: Mapping Earth's History", "trackingData": { "MS-ESS2-3": "D" }, "scope": "F", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800022", "type": "lesson", "title": "Lesson 17: Analyzing Global Data", "trackingData": { "SEP.4-M4": "I", "MS-ESS2-3": "A" }, "scope": "F", "details": { "notes": "", "links": [] } } ] }, { "id": "row-1721248800023", "type": "lesson-set", "title": "Investigation 4: Synthesizing the Model", "isCollapsed": false, "children": [ { "id": "row-1721248800024", "type": "lesson", "title": "Lesson 18: Explaining Volcanoes and Earthquakes", "trackingData": { "ESS2.B-M1": "A" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800025", "type": "lesson", "title": "Lesson 19: The Supercontinent Cycle", "trackingData": { "MS-ESS2-2": "A" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800026", "type": "lesson", "title": "Lesson 20: Finalizing the Hawaiian Islands Model", "trackingData": { "SEP.2-M3": "A", "CCC.2-M2": "A" }, "scope": "F", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800027", "type": "lesson", "title": "Lesson 21: Constructing an Argument", "trackingData": { "SEP.7-M3": "I" }, "scope": "", "details": { "notes": "", "links": [] } }, { "id": "row-1721248800028", "type": "lesson", "title": "Lesson 22: Peer Review and Refinement", "trackingData": { "SEP.7-M3": "D" }, "scope": "", "details": { "notes": "", "links": [] } } ] }, { "id": "row-1721248800029", "type": "lesson-set", "title": "Transfer Task", "isCollapsed": false, "children": [ { "id": "row-1721248800030", "type": "lesson", "title": "Lesson 23: New Scenario - East African Rift Valley", "trackingData": { "MS-ESS2-1": "A", "MS-ESS2-2": "A" }, "scope": "S", "details": { "notes": "Students apply their model to a new divergent boundary scenario.", "links": [] } }, { "id": "row-1721248800031", "type": "lesson", "title": "Final Assessment", "trackingData": { "MS-ESS2-3": "A", "SEP.7-M3": "A", "ESS1.C-M1": "A", "ESS2.A-M1": "A", "ESS2.B-M1": "A" }, "scope": "S", "details": { "notes": "Unit test covering all targeted PEs and 3D elements.", "links": [] } } ] } ] },
                    { "id": "planner-1721249900001", "title": "Grade 4 Energy: Chain Reactions", "course": "4th Grade Science", "gradeBand": "elementary", "standardSet": "NGSS", "phenomenon": "A complex Rube Goldberg machine uses many different steps to pop a balloon.", "question": "How can we make a chain of events happen to complete a task?", "description": "This unit explores concepts of energy, energy transfer, and energy conversion through the lens of designing and building chain reaction machines.", "activeTab": "pe", "assignedPes": [ { "id": "4-PS3-1", "isSecondary": false }, { "id": "4-PS3-2", "isSecondary": false }, { "id": "4-PS3-3", "isSecondary": false }, { "id": "4-PS3-4", "isSecondary": false }, { "id": "3-5-ETS1-1", "isSecondary": true } ], "rows": [ { "id": "row-1721249900002", "type": "lesson-set", "title": "Anchor Lesson", "isCollapsed": false, "children": [ { "id": "row-1721249900003", "type": "lesson", "title": "Lesson 1: The Incredible Machine", "trackingData": { "CCC.5-E2": "I", "SEP.1-E1": "I" }, "scope": "", "details": {"notes": "Students watch a video of a Rube Goldberg machine and list their observations and questions.", "links": []} }, { "id": "row-1721249900004", "type": "lesson", "title": "Lesson 2: What is Energy?", "trackingData": { "PS3.A-E1": "I", "4-PS3-1": "I" }, "scope": "F", "details": {"notes": "Class discussion to build a consensus definition of energy.", "links": []} } ] }, { "id": "row-1721249900005", "type": "lesson-set", "title": "Investigation 1: Speed & Collisions", "isCollapsed": false, "children": [ { "id": "row-1721249900006", "type": "lesson", "title": "Lesson 3: Ramp Races", "trackingData": { "PS3.A-E1": "D", "4-PS3-1": "D", "SEP.3-E2": "I" }, "scope": "F", "details": {"notes": "Investigating how the height of a ramp affects the speed of a marble.", "links": []} }, { "id": "row-1721249900007", "type": "lesson", "title": "Lesson 4: Marble Collisions", "trackingData": { "PS3.B-E1": "I", "PS3.C-E1": "I", "4-PS3-3": "I" }, "scope": "", "details": {"notes": "Students observe what happens when a moving marble hits a stationary one.", "links": []} }, { "id": "row-1721249900008", "type": "lesson", "title": "Lesson 5: Domino Chain Reactions", "trackingData": { "PS3.B-E1": "D", "CCC.2-E2": "I" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900009", "type": "lesson", "title": "Lesson 6: Energy Transfer Investigation", "trackingData": { "4-PS3-3": "D", "SEP.3-E2": "D" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900010", "type": "lesson", "title": "Lesson 7: Designing a Collision Device", "trackingData": { "4-PS3-3": "A", "3-5-ETS1-1": "I" }, "scope": "F", "details": {"notes": "", "links": []} } ] }, { "id": "row-1721249900011", "type": "lesson-set", "title": "Investigation 2: Energy Conversion", "isCollapsed": false, "children": [ { "id": "row-1721249900012", "type": "lesson", "title": "Lesson 8: Simple Circuits", "trackingData": { "PS3.B-E2": "I", "4-PS3-2": "I" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900013", "type": "lesson", "title": "Lesson 9: From Electricity to Light & Sound", "trackingData": { "PS3.B-E2": "D", "4-PS3-2": "D", "CCC.5-E2": "D" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900014", "type": "lesson", "title": "Lesson 10: Building an Electromagnet", "trackingData": { "4-PS3-4": "I" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900015", "type": "lesson", "title": "Lesson 11: Hand-Cranked Generators", "trackingData": { "PS3.D-E1": "I", "4-PS3-4": "D" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900016", "type": "lesson", "title": "Lesson 12: Energy Conversion Stations", "trackingData": { "4-PS3-4": "A", "PS3.B-E2": "A" }, "scope": "F", "details": {"notes": "", "links": []} } ] }, { "id": "row-1721249900017", "type": "lesson-set", "title": "Investigation 3: Applying Energy Concepts", "isCollapsed": false, "children": [ { "id": "row-1721249900018", "type": "lesson", "title": "Lesson 13: What's the Energy Source?", "trackingData": { "PS3.D-E1": "D" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900019", "type": "lesson", "title": "Lesson 14: Design a Solution", "trackingData": { "4-PS3-4": "A", "3-5-ETS1-1": "D" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900020", "type": "lesson", "title": "Lesson 15: Cause and Effect Chains", "trackingData": { "CCC.2-E2": "D", "SEP.6-E3": "I" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900021", "type": "lesson", "title": "Lesson 16: Explaining Energy Transfer", "trackingData": { "4-PS3-2": "A", "SEP.6-E3": "D" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900022", "type": "lesson", "title": "Lesson 17: Energy in Everyday Life", "trackingData": { "PS3.D-E1": "A" }, "scope": "", "details": {"notes": "", "links": []} } ] }, { "id": "row-1721249900023", "type": "lesson-set", "title": "Investigation 4: Rube Goldberg Design Challenge", "isCollapsed": false, "children": [ { "id": "row-1721249900024", "type": "lesson", "title": "Lesson 18: Defining the Problem", "trackingData": { "3-5-ETS1-1": "D" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900025", "type": "lesson", "title": "Lesson 19: Brainstorming & Planning", "trackingData": { "SEP.6-E3": "D" }, "scope": "", "details": {"notes": "", "links": []} }, { "id": "row-1721249900026", "type": "lesson", "title": "Lesson 20: Build Day 1", "trackingData": { "4-PS3-1": "A" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900027", "type": "lesson", "title": "Lesson 21: Build Day 2 & Testing", "trackingData": { "4-PS3-3": "A" }, "scope": "F", "details": {"notes": "", "links": []} }, { "id": "row-1721249900028", "type": "lesson", "title": "Lesson 22: Refining the Design", "trackingData": { "3-5-ETS1-1": "A" }, "scope": "", "details": {"notes": "", "links": []} } ] }, { "id": "row-1721249900029", "type": "lesson-set", "title": "Transfer Task", "isCollapsed": false, "children": [ { "id": "row-1721249900030", "type": "lesson", "title": "Lesson 23: Machine Showcase", "trackingData": { "SEP.6-E3": "A", "CCC.5-E2": "A" }, "scope": "S", "details": {"notes": "Students present their machines and explain the energy transfers and conversions.", "links": []} }, { "id": "row-1721249900031", "type": "lesson", "title": "Final Assessment", "trackingData": { "4-PS3-1": "A", "4-PS3-2": "A", "4-PS3-4": "A", "PS3.A-E1": "A", "PS3.B-E1": "A", "PS3.B-E2": "A" }, "scope": "S", "details": {"notes": "Written assessment requiring students to analyze a new chain reaction diagram.", "links": []} } ] } ] }
                ]
            },

            init() {
                this.persistence.loadProgramData();
                this.render.navigator();
                this.attachEventListeners();
                this.popover.init();
                this.render.welcomeView();
                this.utils.showView('welcome-view');

                this.dom.loadingIndicator.style.opacity = '0';
                setTimeout(() => {
                    this.dom.loadingIndicator.style.display = 'none';
                }, 500);
            },
            
            buildDataMaps() {
                const { ngss3dMap, peMap, peTo3dMap, parentToChildrenMap, major3DMap, nameToCodeMap, textToSpecificCodeMap, fuzzyMatchCache } = this.dataMaps;
                ngss3dMap.clear(); peMap.clear(); peTo3dMap.clear(); parentToChildrenMap.clear(); major3DMap.clear(); nameToCodeMap.clear(); textToSpecificCodeMap.clear(); fuzzyMatchCache.clear();
                
                const processElementForMaps = (element) => {
                    if (!element.name) return;
                    const firstColonIndex = element.name.indexOf(':');
                    if (firstColonIndex > -1) {
                        const code = element.name.substring(0, firstColonIndex).trim();
                        const nameOnly = element.name.substring(firstColonIndex + 1).trim();
                        major3DMap.set(code, nameOnly);
                        nameToCodeMap.set(element.name, code); 
                        nameToCodeMap.set(nameOnly, code);
                    }
                };
                
                if (!this.state.allNgss3dElements) return;

                this.state.allNgss3dElements.forEach(dim => {
                    const elementsToProcess = dim.elements || dim.core_ideas || [];
                    if (dim.understandings) {
                        dim.understandings.forEach(u => { if(u.elements) elementsToProcess.push(...u.elements); });
                    }

                    elementsToProcess.forEach(el => {
                         const processProgressions = (item) => {
                             if(item.progressions){
                                 Object.values(item.progressions).forEach(pArr=>{
                                     if(Array.isArray(pArr)) {
                                         pArr.forEach(i=>{
                                             if(!i) return;
                                             i.parentName = item.name;
                                             i.parentCode = item.name.split(':')[0].trim();
                                             i.dimension = dim.short_name;
                                             i.allProgressions = item.progressions;
                                             i.relatedPes = new Set();
                                             ngss3dMap.set(i.code,i);
                                             textToSpecificCodeMap.set(i.text.trim(), i.code);
                                         });
                                     }
                                 });
                             }
                         };
                        processElementForMaps(el);
                        processProgressions(el);
                        if (el.components) {
                            el.components.forEach(comp => {
                                processElementForMaps(comp);
                                processProgressions(comp);
                            });
                        }
                    });
                });
                
                if (!this.state.allNgssData) return;

                this.state.allNgssData.forEach(gradeData => {
                    if(!gradeData.topics) return;
                    gradeData.topics.forEach(t => {
                        if(!t.performanceExpectations) return;
                        t.performanceExpectations.forEach(p => {
                            peMap.set(p.id, p);
                            if (!p.details) return;

                            const componentCodes = new Set();
                            const secondaryComponentCodes = new Set();
                            const specificCodes = new Set();

                            ['sep', 'dci', 'ccc'].forEach(key => {
                                const refs = p.details[key] || [];
                                refs.forEach(ref => {
                                    let lineMatched = false;
                                    const textLines = Array.isArray(ref.text) ? ref.text : (ref.text ? [ref.text] : []);
                                    
                                    textLines.forEach(line => {
                                        if (!line || typeof line !== 'string') return;
                                        const cleanLine = line.trim();
                                        if(!cleanLine) return;

                                        const specCode = App.utils.findBestMatchingSpecificElement(cleanLine, gradeData.gradeLabel);
                                        if (specCode) {
                                            specificCodes.add(specCode);
                                            const el = ngss3dMap.get(specCode);
                                            if (el) {
                                                el.relatedPes.add(p.id);
                                                if (el.parentCode) componentCodes.add(el.parentCode);
                                            }
                                            lineMatched = true;
                                        }
                                        
                                        const potentialCode = nameToCodeMap.get(cleanLine);
                                        if (potentialCode) {
                                            componentCodes.add(potentialCode);
                                        }
                                    });
                                    
                                    const isSecondary = ref.id.includes('(secondary)');
                                    const cleanId = ref.id.replace(' (secondary)', '').trim();
                                    const nameOnly = cleanId.includes(':') ? cleanId.split(':').pop().trim() : cleanId;
                                    const cCode = nameToCodeMap.get(cleanId) || nameToCodeMap.get(nameOnly);
                                    if (cCode) {
                                        if(isSecondary) {
                                            secondaryComponentCodes.add(cCode);
                                        } else {
                                            componentCodes.add(cCode);
                                        }
                                    }
                                });
                            });

                            if (componentCodes.size > 0 || secondaryComponentCodes.size > 0 || specificCodes.size > 0) {
                                peTo3dMap.set(p.id, { componentCodes, secondaryComponentCodes, specificCodes });
                            }
                        });
                    });
                });
                
                const processParent = (parent, dimShortName) => {
                    if (!parent.progressions) return;
                    const parentCode = parent.code || parent.name.split(':')[0].trim();
                    const children = [];
                    Object.values(parent.progressions).forEach(bandProg => { if(bandProg) children.push(...bandProg) });
                    const uniqueChildren = Array.from(new Map(children.map(item => [item.code, item])).values());
                    parentToChildrenMap.set(parentCode, {name: parent.name, children: uniqueChildren, dimension: dimShortName});
                };

                this.state.allNgss3dElements.forEach(dim => {
                    (dim.elements || []).forEach(el => processParent(el, dim.short_name));
                    (dim.core_ideas || []).forEach(el => {
                        if (el.progressions) {
                            processParent(el, dim.short_name);
                        } else if (el.components) {
                            el.components.forEach(comp => processParent(comp, dim.short_name));
                        }
                    });
                });
                parentToChildrenMap.set('PE', {name: "Performance Expectations", children: [], dimension: 'PE'});
            },

            attachEventListeners() {
                document.getElementById('new-planner-btn').addEventListener('click', () => this.utils.openPlannerModal());
                document.getElementById('view-progression-btn').addEventListener('click', () => this.render.progressionViewer());
                document.getElementById('view-summary-btn').addEventListener('click', () => this.render.summary());
                
                this.dom.navigatorList.addEventListener('click', e => { 
                    if (e.target.type === 'checkbox') return; 
                    const item = e.target.closest('.planner-item'); 
                    if (item) { 
                        const plannerId = item.dataset.plannerId;
                        this.render.plannerView(plannerId); 
                        item.querySelector('.planner-checkbox').checked = true;
                        if (window.innerWidth <= 768) this.dom.body.classList.remove('sidebar-open'); 
                    } 
                });
                this.dom.welcomeView.addEventListener('click', e => {
                    const card = e.target.closest('.planner-card');
                    if (card) {
                        const plannerId = card.dataset.plannerId;
                        this.render.plannerView(plannerId);
                        const navItem = this.dom.navigatorList.querySelector(`[data-planner-id="${plannerId}"]`);
                        if(navItem) navItem.querySelector('.planner-checkbox').checked = true;
                    }

                    const exampleBtn = e.target.closest('.load-example-btn');
                    if (exampleBtn) {
                        const index = parseInt(exampleBtn.dataset.exampleIndex, 10);
                        this.utils.loadExamplePlanner(index);
                    }
                });

                document.getElementById('add-lesson-set-btn').addEventListener('click', () => this.utils.addRow('lesson-set', 'New Lesson Set...'));
                document.getElementById('add-lesson-btn').addEventListener('click', () => this.utils.addRow('lesson', 'New Lesson...'));
                document.getElementById('edit-planner-btn').addEventListener('click', () => { const p = this.utils.findPlanner(this.state.currentPlannerId); if(p) this.utils.openPlannerModal(p); });
                
                this.dom.undoBtn.addEventListener('click', () => this.history.undo());
                this.dom.redoBtn.addEventListener('click', () => this.history.redo());
                document.getElementById('progression-view-element').addEventListener('click', () => { App.state.progressionViewType = 'element'; App.render.progressionViewer(); });
                document.getElementById('progression-view-lesson').addEventListener('click', () => { App.state.progressionViewType = 'lesson'; App.render.progressionViewer(); });
                document.getElementById('export-progression-btn').addEventListener('click', () => this.export.exportProgressionView());
                document.getElementById('export-summary-btn').addEventListener('click', () => this.export.exportSummaryView());

                document.getElementById('pe-bundle-toggle').addEventListener('change', e => { App.state.isPeBundleMode = e.target.checked; App.render.setActiveTab(App.state.currentActiveTab); });
                
                // Export Dropdown Listeners
                document.getElementById('export-xlsx-btn').addEventListener('click', (e) => { e.preventDefault(); this.export.showExportOptions(); });
                document.getElementById('export-json-btn').addEventListener('click', (e) => { e.preventDefault(); this.export.asJson(); });
                document.getElementById('export-html-btn').addEventListener('click', (e) => { e.preventDefault(); this.export.asHtml(); });
                
                document.getElementById('import-planner-btn').addEventListener('click', () => this.import.handleImport());
                
                document.getElementById('export-master-download').addEventListener('click', () => this.export.handleMasterExport());
                
                document.getElementById('import-options-confirm').addEventListener('click', () => this.import.processImport());

                this.dom.plannerTableContainer.addEventListener('click', e => this.handlers.mainTableClick(e));
                this.dom.plannerTableContainer.addEventListener('blur', e => { if (e.target.matches('.editable')) this.handlers.titleEdit(e) }, true);
                this.dom.tabContainer.addEventListener('click', e => {
                    const tabBtn = e.target.closest('.tab-button');
                    if (tabBtn) this.render.setActiveTab(tabBtn.dataset.tab);
                    const peBtn = e.target.closest('#assign-pe-btn');
                    if(peBtn) this.utils.openPeAssignmentModal();
                });
                document.body.addEventListener('mouseover', e => this.handlers.tooltipShow(e));
                document.body.addEventListener('mouseout', () => this.handlers.tooltipHide());

                this.dom.plannerTableContainer.addEventListener('dragstart', e => this.handlers.dragStart(e));
                this.dom.plannerTableContainer.addEventListener('dragover', e => this.handlers.dragOver(e));
                this.dom.plannerTableContainer.addEventListener('dragleave', e => this.handlers.dragLeave(e));
                this.dom.plannerTableContainer.addEventListener('drop', e => this.handlers.drop(e));

                document.getElementById('planner-modal-save').addEventListener('click', () => this.utils.savePlanner());
                document.getElementById('pe-modal-save').addEventListener('click', () => this.utils.savePeAssignments());
                document.getElementById('planner-modal-delete').addEventListener('click', () => { if (confirm('Are you sure? This cannot be undone.')) { const id = document.getElementById('planner-id-input').value; this.state.programData.planners = this.state.programData.planners.filter(p => p.id !== id); this.persistence.saveProgramData(); this.history.clear(); this.utils.closeAllModals(); this.render.welcomeView(); this.utils.showView('welcome-view'); this.state.currentPlannerId = null; this.render.navigator(); } });
                
                document.getElementById('add-link-btn').addEventListener('click', () => this.utils.addLinkToDetailsModal());
                document.getElementById('lesson-links-container').addEventListener('click', (e) => { if(e.target.classList.contains('remove-link-btn')) this.utils.removeLinkFromDetailsModal(e.target); });
                document.getElementById('lesson-details-modal-close').addEventListener('click', () => this.utils.saveLessonDetails());

                document.body.addEventListener('click', e => { if(e.target.matches('.modal-backdrop, [id$="-modal-cancel"], [id$="-modal-close"]')) this.utils.closeAllModals(); });

                document.getElementById('menu-toggle').addEventListener('click', () => this.dom.body.classList.toggle('sidebar-open'));
                document.getElementById('sidebar-backdrop').addEventListener('click', () => this.dom.body.classList.remove('sidebar-open'));

                document.addEventListener('keydown', (e) => {
                    if (e.target.matches('input, textarea, [contenteditable]')) return;
                    if (document.querySelector('.modal-backdrop:not(.hidden)')) return;
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') { e.preventDefault(); this.history.undo(); }
                        if (e.key === 'y' || (e.shiftKey && e.key === 'Z')) { e.preventDefault(); this.history.redo(); }
                    }
                });
            },
        };

        // ... (App.popover, App.db, App.persistence - No changes needed) ...
        App.popover = {
            dom: {},
            state: { isVisible: false, activeCell: null, activeRowId: null },
            init() {
                this.dom.container = document.getElementById('element-popover');
                this.dom.title = document.getElementById('popover-title');
                this.dom.content = document.getElementById('popover-content');
                document.getElementById('popover-close').addEventListener('click', () => this.hide());
                this.dom.content.addEventListener('change', (e) => {
                    if (e.target.type === 'radio') this.handleSelectionChange(e.target);
                });
            },
            _handleOutsideClick(e) {
                if (this.state.isVisible && !this.dom.container.contains(e.target) && !this.state.activeCell.contains(e.target)) {
                    this.hide();
                }
            },
            show(cell, parentCode, rowId) {
                if (this.state.isVisible) this.hide();
                this.state.activeCell = cell;
                this.state.activeRowId = rowId;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const rowData = App.utils.findRowData(planner, rowId);
                if (!planner || !rowData) return;
                const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                this.dom.title.textContent = parentInfo ? parentInfo.name : 'Select Elements';
                this.dom.content.innerHTML = this.buildContentHTML(parentInfo, planner.gradeBand, rowData);
                this.dom.container.classList.remove('hidden');
                this.state.isVisible = true;
                this.position(cell);
                setTimeout(() => document.addEventListener('click', this._handleOutsideClick.bind(this), { capture: true, once: true }), 0);
            },
            hide() {
                this.dom.container.classList.add('hidden');
                this.state.isVisible = false;
                this.state.activeCell = null;
                this.state.activeRowId = null;
            },
            position(targetCell) {
                const rect = targetCell.getBoundingClientRect();
                const popover = this.dom.container;
                let top = rect.bottom + 8;
                let left = rect.left;
                if (top + popover.offsetHeight > window.innerHeight) top = rect.top - popover.offsetHeight - 8;
                if (left + popover.offsetWidth > window.innerWidth) left = rect.right - popover.offsetWidth;
                if (left < 8) left = 8;
                popover.style.top = `${top}px`;
                popover.style.left = `${left}px`;
            },
            buildContentHTML(parentInfo, gradeBand, rowData) {
                let children = [];
                if (parentInfo) {
                    const parentProgressions = parentInfo.children[0]?.allProgressions || {};
                    const gradeBandProgressions = parentProgressions[gradeBand] || [];
                    const validCodesForBand = new Set(gradeBandProgressions.map(p => p.code));
                    children = parentInfo.children.filter(child => validCodesForBand.has(child.code));
                }
                if (children.length === 0) return '<p class="text-center text-gray-500 dark:text-gray-400 p-8">No elements for this category in the selected grade band.</p>';
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                return children.map(child => {
                    const elData = App.dataMaps.ngss3dMap.get(child.code);
                    let indicatorHTML = '';
                    if (elData) {
                        const linkedPEs = [...elData.relatedPes].filter(peId => (planner.assignedPes || []).some(p => p.id === peId));
                        if (linkedPEs.length > 0) {
                            indicatorHTML = `<span class="pe-link-indicator" title="Linked to assigned PE(s): ${linkedPEs.join(', ')}">PE</span>`;
                        }
                    }
                    const currentStatus = rowData.trackingData[child.code] || '';
                    const u = `status-${child.code}`;
                    return `<div class="p-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div>
                                    <strong class="font-semibold">${child.code}</strong>${indicatorHTML}
                                    <p class="text-sm text-gray-600 dark:text-gray-400">${child.text}</p>
                                </div>
                                <div class="flex gap-1.5 flex-shrink-0">
                                    <input type="radio" id="${u}-none" name="${u}" value="" ${!currentStatus&&'checked'} class="hidden peer/none"><label for="${u}-none" title="None" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-gray-300 dark:border-gray-600 font-bold text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 peer-checked/none:ring-2 ring-gray-400">-</label>
                                    <input type="radio" id="${u}-i" name="${u}" value="I" ${currentStatus==='I'&&'checked'} class="hidden peer/i"><label for="${u}-i" title="Introduced" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-yellow-400 font-bold text-sm bg-yellow-200 text-yellow-800 hover:bg-yellow-300 peer-checked/i:ring-2 ring-yellow-500">I</label>
                                    <input type="radio" id="${u}-d" name="${u}" value="D" ${currentStatus==='D'&&'checked'} class="hidden peer/d"><label for="${u}-d" title="Developed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-green-400 font-bold text-sm bg-green-200 text-green-800 hover:bg-green-300 peer-checked/d:ring-2 ring-green-500">D</label>
                                    <input type="radio" id="${u}-a" name="${u}" value="A" ${currentStatus==='A'&&'checked'} class="hidden peer/a"><label for="${u}-a" title="Assessed" class="w-7 h-7 flex items-center justify-center rounded-full cursor-pointer border border-blue-400 font-bold text-sm bg-blue-200 text-blue-800 hover:bg-blue-300 peer-checked/a:ring-2 ring-blue-500">A</label>
                                </div>
                            </div>`;
                }).join('');
            },
            handleSelectionChange(radioInput) {
                const rowId = this.state.activeRowId;
                if (!rowId) return;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const rowData = App.utils.findRowData(planner, rowId);
                if (!rowData) return;
                App.history.saveState();
                const code = radioInput.name.replace('status-', '');
                if (radioInput.value) {
                    rowData.trackingData[code] = radioInput.value;
                } else {
                    delete rowData.trackingData[code];
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            }
        };

        App.db = {
            db: null,
            DB_NAME: 'NGSSDataDB',
            STORE_NAME: 'ngss_data',
            DB_VERSION: 1,
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.DB_NAME, this.DB_VERSION);
                    request.onerror = (event) => reject("IndexedDB error: " + request.error);
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.STORE_NAME)) {
                            db.createObjectStore(this.STORE_NAME);
                        }
                    };
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction([this.STORE_NAME], 'readonly');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            set(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return reject("DB not initialized");
                    const transaction = this.db.transaction([this.STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(this.STORE_NAME);
                    const request = store.put(value, key);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        };
        
        App.persistence = {
            saveProgramData() { localStorage.setItem('ngssProgramPlannerData', JSON.stringify(App.state.programData)); },
            loadProgramData() { const data = localStorage.getItem('ngssProgramPlannerData'); App.state.programData = data ? JSON.parse(data) : { programName: "My K-12 Science Program", planners: [] }; },
            debouncedSave() { clearTimeout(App.state.saveTimeout); App.dom.saveStatus.textContent = 'Saving...'; App.state.saveTimeout = setTimeout(() => { const planner = App.utils.findPlanner(App.state.currentPlannerId); if (planner) { planner.activeTab = App.state.currentActiveTab; this.saveProgramData(); App.dom.saveStatus.innerHTML = `Saved ✓ <span class="font-normal">${new Date().toLocaleTimeString()}</span>`; } }, 1000); },
            updateStateFromTableOrder() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                if (!tbody) return;
                const newRowsState = [];
                const allRowsMap = new Map();
                planner.rows.forEach(row => {
                    allRowsMap.set(row.id, row.type === 'lesson-set' ? { ...row, children: [] } : { ...row });
                    if (row.children) {
                        row.children.forEach(child => allRowsMap.set(child.id, { ...child }));
                    }
                });
                let currentLessonSet = null;
                Array.from(tbody.children).forEach(rowEl => {
                    const id = rowEl.dataset.id;
                    const rowData = allRowsMap.get(id);
                    if (!rowData) return;
                    if (rowData.type === 'lesson-set') {
                        currentLessonSet = rowData;
                        newRowsState.push(currentLessonSet);
                    } else if (rowData.type === 'lesson') {
                        if (currentLessonSet) {
                            currentLessonSet.children.push(rowData);
                        } else {
                            newRowsState.push(rowData);
                        }
                    }
                });
                planner.rows = newRowsState;
            }
        };

        App.history = {
            saveState() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                const stateCopy = JSON.parse(JSON.stringify(planner));
                App.state.undoStack.push(stateCopy);
                App.state.redoStack = []; 
                this.updateUndoRedoButtons();
            },
            _restoreState(stateToApply) {
                const plannerIndex = App.state.programData.planners.findIndex(p => p.id === App.state.currentPlannerId);
                if (plannerIndex > -1) {
                    App.state.programData.planners[plannerIndex] = stateToApply;
                    App.render.plannerView(App.state.currentPlannerId);
                    App.persistence.saveProgramData();
                    this.updateUndoRedoButtons();
                }
            },
            undo() {
                if (App.state.undoStack.length === 0) return;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const currentState = JSON.parse(JSON.stringify(planner));
                App.state.redoStack.push(currentState);
                const previousState = App.state.undoStack.pop();
                this._restoreState(previousState);
            },
            redo() {
                if (App.state.redoStack.length === 0) return;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                const currentState = JSON.parse(JSON.stringify(planner));
                App.state.undoStack.push(currentState);
                const nextState = App.state.redoStack.pop();
                this._restoreState(nextState);
            },
            clear() {
                App.state.undoStack = [];
                App.state.redoStack = [];
                this.updateUndoRedoButtons();
            },
            updateUndoRedoButtons() {
                App.dom.undoBtn.disabled = App.state.undoStack.length === 0;
                App.dom.redoBtn.disabled = App.state.redoStack.length === 0;
            }
        };

        App.render = {
            navigator() { App.dom.navigatorList.innerHTML = ''; App.state.programData.planners.forEach(planner => { const item = document.createElement('li'); item.className = `planner-item flex items-center gap-2 p-2 rounded-md cursor-pointer transition-colors user-select-none ${planner.id === App.state.currentPlannerId ? 'bg-blue-600 font-bold' : 'hover:bg-gray-700'}`; item.dataset.plannerId = planner.id; item.innerHTML = `<input type="checkbox" class="planner-checkbox" title="Select for progression view"><span class="planner-title flex-grow pointer-events-none">${planner.title}</span><span class="planner-band text-xs bg-gray-600 px-2 py-0.5 rounded-full text-white">${planner.gradeBand}</span>`; App.dom.navigatorList.appendChild(item); }); },
            welcomeView() {
                App.dom.welcomeView.innerHTML = '';
                const planners = App.state.programData.planners;
                let userPlannersHTML = '';
                let noPlannersHTML = '';

                if (planners.length > 0) {
                    userPlannersHTML = `
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">Your Planners</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl w-full">
                            ${planners.map(p => `
                                <div class="planner-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer border dark:border-gray-700 flex flex-col" data-planner-id="${p.id}">
                                    <div class="p-6 flex-grow">
                                        <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400">${p.title}</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${p.course} (${p.gradeBand})</p>
                                        <p class="mt-4 text-sm text-gray-600 dark:text-gray-300">${p.description || 'No description provided.'}</p>
                                    </div>
                                    <div class="bg-gray-50 dark:bg-gray-700/50 px-6 py-3 text-right text-sm font-bold text-blue-600 dark:text-blue-400">Open Planner →</div>
                                </div>
                            `).join('')}
                        </div>
                         <p class="mt-8 text-gray-500 dark:text-gray-400">Or, <button onclick="App.utils.openPlannerModal()" class="text-blue-600 dark:text-blue-400 font-semibold hover:underline">create a new planner</button>.</p>
                    `;
                } else {
                    noPlannersHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 mb-12">
                            <h2 class="text-2xl font-semibold mb-2">Welcome to the NGSS 3D Progression Planner</h2>
                            <p>You don't have any planners yet. Create a new one, or load an example below to get started.</p>
                        </div>
                    `;
                }

                const examplesHTML = `
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-6 text-center">${planners.length > 0 ? 'Start with an Example' : ''}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full">
                        ${App.examples.planners.map((p, index) => `
                            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border dark:border-gray-700 flex flex-col">
                                <div class="p-6 flex-grow">
                                    <h3 class="text-xl font-semibold text-purple-600 dark:text-purple-400">${p.title}</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${p.course} (${p.gradeBand})</p>
                                    <p class="mt-4 text-sm text-gray-600 dark:text-gray-300">${p.description || 'No description provided.'}</p>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 text-right">
                                    <button class="load-example-btn px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 font-semibold text-sm" data-example-index="${index}">Load Example</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                App.dom.welcomeView.innerHTML = `
                    <div class="w-full text-center">${userPlannersHTML}</div>
                    <hr class="my-12 w-full max-w-4xl border-gray-200 dark:border-gray-700 ${planners.length === 0 ? 'hidden' : ''}">
                    <div class="w-full text-center">${noPlannersHTML}</div>
                    <div class="w-full flex flex-col items-center">${examplesHTML}</div>
                `;
            },
            plannerView(plannerId) {
                const planner = App.utils.findPlanner(plannerId); if (!planner) { this.render.welcomeView(); App.utils.showView('welcome-view'); return; }
                App.state.currentPlannerId = plannerId;
                App.history.clear(); 
                App.state.collapsedSections.clear();

                document.getElementById('planner-title').textContent = planner.title;
                document.getElementById('planner-subtitle').textContent = `${planner.course} (${planner.gradeBand})`;
                App.dom.plannerPhenomenon.textContent = planner.phenomenon || 'Not specified.';
                App.dom.plannerQuestion.textContent = planner.question || 'Not specified.';

                const allColumns = App.utils.gatherColumns(planner.gradeBand);
                
                this.tabs(allColumns);
                this.renderPlannerContent(); 

                this.setActiveTab(planner.activeTab || 'pe');
                App.utils.showView('planner-view');
                this.navigator();
            },
            renderPlannerContent() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                const allColumns = App.utils.gatherColumns(planner.gradeBand);

                this.table(allColumns);
                this.rowsFromState(planner.rows || []);
                this.updateColumnVisibility();
            },
            table(columnGroups) {
                App.dom.plannerTableContainer.innerHTML = ''; 
                const table = document.createElement('table'); 
                table.className = 'table-view fixed-layout';
                const colgroup = document.createElement('colgroup');
                
                let groupHeaderRow = `<tr class="group-header-row">`;
                let mainHeaderRow = `<tr>`;
                
                // Sticky columns
                colgroup.innerHTML = '<col class="sticky-col-1"><col class="sticky-col-2"><col class="sticky-col-3">';
                groupHeaderRow += `<th class="sticky-col-1 bg-gray-100 dark:bg-gray-800"></th><th class="sticky-col-2 bg-gray-100 dark:bg-gray-800"></th><th class="sticky-col-3 bg-gray-100 dark:bg-gray-800"></th>`;
                mainHeaderRow += `<th class="sticky-col-1 bg-gray-100 dark:bg-gray-800 border-b border-r">Actions</th><th class="sticky-col-2 bg-gray-100 dark:bg-gray-800 border-b border-r">Scope</th><th class="sticky-col-3 bg-gray-100 dark:bg-gray-800 border-b border-r text-left pl-2">Instructional Sequence</th>`;

                const planner = App.utils.findPlanner(App.state.currentPlannerId);

                Object.keys(columnGroups).forEach(key => {
                    if (key === 'pe') {
                        const peCount = planner?.assignedPes?.length || 1;
                        groupHeaderRow += `<th class="group-toggle-header bg-gray-200 dark:bg-gray-800" data-tab-group="pe" colspan="${peCount}">PEs</th>`;

                        (planner?.assignedPes || []).forEach(peObj => {
                             const peCode = peObj.id;
                             colgroup.innerHTML += `<col class="data-col" data-tab-group="pe" data-code="${peCode}">`;
                             const peData = App.dataMaps.peMap.get(peCode);
                             const tooltip = peData ? `${peCode}: ${peData.description.replace(/"/g, '&quot;')}` : peCode;
                             const secondaryClass = peObj.isSecondary ? 'font-normal italic text-gray-500 dark:text-gray-400' : 'font-semibold';
                             mainHeaderRow += `<th class="cursor-pointer ${secondaryClass}" data-tab-group="pe" data-code="${peCode}" data-tooltip="${tooltip}"><div class="vertical-header-text">${peCode}</div></th>`;
                        });
                        if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                             colgroup.innerHTML += `<col class="data-col" data-tab-group="pe">`;
                             mainHeaderRow += `<th class="font-normal" data-tab-group="pe"><div>Assign PEs</div></th>`;
                        }
                    } else {
                        Object.entries(columnGroups[key].groups).forEach(([groupKey, groupData]) => {
                            if (groupData.cols.length > 0) {
                                const fullGroupKey = `${key}-${groupKey}`;
                                const isCollapsed = App.state.collapsedSections.has(fullGroupKey);
                                const icon = isCollapsed ? '▶' : '▼';
                                const colspan = groupData.cols.length;
                                groupHeaderRow += `<th class="group-toggle-header bg-gray-200 dark:bg-gray-800 border-l border-r border-gray-300 dark:border-gray-700 cursor-pointer" data-tab-group="${key}" data-group-toggle="${fullGroupKey}" colspan="${colspan}"><span class="toggle-icon">${icon}</span> ${groupData.name}</th>`;
                                
                                groupData.cols.forEach(col => {
                                    colgroup.innerHTML += `<col class="data-col" data-tab-group="${key}" data-group-parent="${fullGroupKey}" data-code="${col.code}">`;
                                    mainHeaderRow += `<th class="cursor-pointer" data-tab-group="${key}" data-group-parent="${fullGroupKey}" data-code="${col.code}" data-tooltip="${col.title}"><div class="vertical-header-text">${col.title}</div></th>`;
                                });
                            }
                        });
                    }
                });
                mainHeaderRow += '</tr>'; 
                groupHeaderRow += '</tr>';
                const thead = document.createElement('thead');
                thead.innerHTML = groupHeaderRow + mainHeaderRow; 
                table.appendChild(colgroup);
                table.appendChild(thead); 
                table.appendChild(document.createElement('tbody')); 
                App.dom.plannerTableContainer.appendChild(table);
            },
            rowsFromState(rowsData) {
                const tbody = App.dom.plannerTableContainer.querySelector('tbody');
                tbody.innerHTML = '';
                if (!rowsData || rowsData.length === 0) return;
                rowsData.forEach(rowData => {
                    tbody.appendChild(this.createRowElement(rowData));
                    if (rowData.type === 'lesson-set' && rowData.children) {
                        rowData.children.forEach(childRowData => {
                            const childRow = this.createRowElement(childRowData, rowData.id);
                            if (rowData.isCollapsed) childRow.classList.add('hidden');
                            tbody.appendChild(childRow);
                        });
                    }
                });
                this.updateTableHeaderHighlights();
            },
            createRowElement(rowData, parentId = null) {
                const row = document.createElement('tr');
                
                row.className = `${rowData.type}-row group/row`; row.dataset.rowType = rowData.type; row.dataset.id = rowData.id;
                row.draggable = true;

                const planner = App.utils.findPlanner(App.state.currentPlannerId); const columnGroups = App.utils.gatherColumns(planner.gradeBand);
                const borderClass = "border-b border-r border-gray-200 dark:border-gray-700";

                if (rowData.type === 'lesson-set') {
                    const isCollapsedClass = rowData.isCollapsed ? 'is-collapsed' : '';
                    const rotateClass = rowData.isCollapsed ? '-rotate-90' : '';
                    const editableSpan = `<span class="editable hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="true">${rowData.title}</span>`;
                    
                    let totalCols = 1; // Start with 1 for the placeholder cell itself
                    Object.values(columnGroups).forEach(dim => {
                        if (dim.key === 'pe') {
                            totalCols += planner?.assignedPes?.length || 1;
                        } else {
                            Object.values(dim.groups).forEach(group => totalCols += group.cols.length);
                        }
                    });

                    row.innerHTML = `
                        <td class="sticky-col-1 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 align-middle"><span class="drag-handle cursor-grab mr-2">⠿</span> <span class="delete-btn cursor-pointer text-gray-400 font-bold invisible group-hover/row:visible hover:text-red-500 transition-colors" title="Delete Lesson Set">✖</span></td>
                        <td class="sticky-col-2 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 align-middle"></td>
                        <td class="sticky-col-3 p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 font-semibold cursor-pointer ${isCollapsedClass}"><span class="collapse-icon inline-block mr-1 transition-transform ${rotateClass}">▼</span> ${editableSpan}</td>
                        <td class="p-2 ${borderClass} bg-blue-100 dark:bg-blue-900/50" colspan="${totalCols}"></td>`;

                } else {
                    if (parentId) row.dataset.parentId = parentId;
                    const scope = rowData.scope || '';
                    const scopeClass = App.constants.scopeClasses[scope] || '';
                    const editableSpan = `<span class="editable hover:bg-white/70 dark:hover:bg-black/20 focus:bg-white/70 dark:focus:bg-black/20 outline-none focus:outline-blue-500 rounded px-1" contenteditable="true">${rowData.title}</span>`;
                    const notesIcon = `<span class="notes-btn cursor-pointer text-base" title="Edit Notes & Links">📝</span>`;
                    
                    let cellsHTML = `
                        <td class="sticky-col-1 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 align-middle">
                            <div class="flex items-center justify-start gap-2 text-gray-400 w-full overflow-hidden">
                                <span class="drag-handle cursor-grab">⠿</span>
                                <div class="flex items-center gap-2 invisible group-hover/row:visible">
                                    ${notesIcon}
                                    <span class="delete-btn cursor-pointer font-bold hover:text-red-500 transition-colors" title="Delete Lesson">✖</span>
                                    <span class="add-below-btn cursor-pointer hover:text-green-500 transition-colors" title="Add Lesson Below">+</span>
                                    <span class="copy-row-btn cursor-pointer hover:text-blue-500 transition-colors" title="Duplicate Lesson">❐</span>
                                </div>
                            </div>
                        </td>
                        <td data-scope-cell="true" class="sticky-col-2 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 align-middle font-bold text-center cursor-pointer ${scopeClass}" data-tooltip="Click to cycle Assessment Scope">${scope}</td>
                        <td class="sticky-col-3 p-2 ${borderClass} bg-gray-50 dark:bg-gray-800 text-left ${parentId ? 'pl-10' : ''}"><div class="truncate">${editableSpan}</div></td>`;

                    Object.keys(columnGroups).forEach(key => {
                         if (key === 'pe') {
                             (planner?.assignedPes || []).forEach(peObj => {
                                 cellsHTML += this.createTrackingCellHTML({ code: peObj.id, type: 'pe' }, rowData);
                             });
                             if (!planner?.assignedPes || planner.assignedPes.length === 0) {
                                cellsHTML += `<td data-tab-group="pe" class="p-2 ${borderClass}"></td>`;
                             }
                         } else {
                            Object.entries(columnGroups[key].groups).forEach(([groupKey, groupData]) => {
                                const fullGroupKey = `${key}-${groupKey}`;
                                cellsHTML += groupData.cols.map(col => this.createTrackingCellHTML({ code: col.code, title: col.title, type: '3d', tabGroup: key, parentGroup: fullGroupKey }, rowData)).join('');
                            });
                         }
                    });
                    row.innerHTML = cellsHTML;
                } return row;
            },
            createTrackingCellHTML(column, rowData) {
                const commonCellClasses = "p-2 border border-gray-200 dark:border-gray-700 align-top";
                if (column.type === 'pe') {
                    const status = rowData.trackingData?.[column.code] || '';
                    const statusClass = App.constants.statusClasses[status] || '';
                    const cursorClass = 'cursor-pointer hover:bg-yellow-300/50 dark:hover:bg-yellow-500/50';
                    return `<td class="${commonCellClasses} text-center font-bold ${cursorClass} ${statusClass}" data-tab-group="pe" data-code="${column.code}" data-tooltip="Click to change status for ${column.code}">${status}</td>`;
                }
                const parentCode = column.code; 
                const cellTooltip = `${column.title}. Click to edit elements.`;
                const cursorClass = 'cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50';
                const cellContent = this.generateCellContent(parentCode, rowData);
                return `<td class="${commonCellClasses} ${cursorClass}" data-tab-group="${column.tabGroup}" data-group-parent="${column.parentGroup}" data-code="${parentCode}" data-tooltip="${cellTooltip}">${cellContent}</td>`;
            },
            generateCellContent(parentCode, rowData) {
                const parentInfo = App.dataMaps.parentToChildrenMap.get(parentCode);
                const childrenCodes = parentInfo ? parentInfo.children.map(c => c.code) : [];
                const trackedChildren = childrenCodes.filter(code => rowData.trackingData?.[code]).map(code => ({ code, status: rowData.trackingData[code] }));
                const badgeHTML = trackedChildren.map(child => {
                    const details = App.dataMaps.ngss3dMap.get(child.code) || {description: 'N/A', text: 'N/A'};
                    const text = (details.text || details.description).replace(/"/g, '&quot;');
                    const badgeTooltip = `<b>${child.code} (${child.status})</b>: ${text}`;
                    const badgeColor = App.constants.statusBadgeClasses[child.status] || 'bg-gray-200 dark:bg-gray-600';
                    return `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${badgeTooltip}">${child.code}</span>`;
                }).join('');
                return `<div class="flex flex-wrap gap-1 items-center min-h-[24px]">${badgeHTML}</div>`;
            },
            tabs(columnGroups) {
                App.dom.tabContainer.innerHTML = '';
                const tabOrder = ['pe', 'dci', 'sep', 'ccc'];
                tabOrder.forEach(key => {
                    if (columnGroups[key] && (columnGroups[key].totalCols > 0 || key === 'pe')) {
                        const tabContent = key === 'pe'
                            ? `<button id="assign-pe-btn" class="px-2 py-1 bg-cyan-600 text-white rounded hover:bg-cyan-700 text-xs font-medium hidden">Assign PEs</button><span>${columnGroups[key].name}</span>`
                            : `<span>${columnGroups[key].name}</span>`;
                        
                        const btn = document.createElement('div');
                        btn.className = 'tab-button px-4 py-2 cursor-pointer border border-transparent rounded-t-lg font-medium transition-colors text-sm flex items-center gap-2';
                        btn.dataset.tab = key;
                        btn.innerHTML = tabContent;
                        App.dom.tabContainer.appendChild(btn);
                    }
                });
            },
            setActiveTab(tabKey) {
                const table = App.dom.plannerTableContainer.querySelector('table');
                if (!table || !App.dom.tabContainer.querySelector(`[data-tab="${tabKey}"]`)) {
                    tabKey = 'pe';
                }
                App.state.currentActiveTab = tabKey;
                App.dom.tabContainer.querySelectorAll('.tab-button').forEach(b => {
                    const isActive = b.dataset.tab === tabKey;
                    b.classList.toggle('bg-white', isActive); b.classList.toggle('dark:bg-gray-800/50', isActive); b.classList.toggle('border-gray-300', isActive); b.classList.toggle('dark:border-gray-700', isActive); b.classList.toggle('border-b-white', isActive); b.classList.toggle('dark:border-b-gray-800/50', isActive); b.classList.toggle('text-blue-600', isActive); b.classList.toggle('dark:text-blue-400', isActive);
                    b.classList.toggle('bg-gray-100', !isActive); b.classList.toggle('dark:bg-transparent', !isActive); b.classList.toggle('text-gray-500', !isActive); b.classList.toggle('dark:text-gray-400', !isActive); b.classList.toggle('hover:text-gray-700', !isActive); b.classList.toggle('dark:hover:text-gray-200', !isActive);
                    
                    if (b.dataset.tab === 'pe') {
                        const assignBtn = b.querySelector('#assign-pe-btn');
                        if (assignBtn) assignBtn.classList.toggle('hidden', !isActive);
                    }
                });
                
                this.updateColumnVisibility();
                
                App.persistence.debouncedSave();
            },
            updateColumnVisibility() {
                const table = App.dom.plannerTableContainer.querySelector('table');
                if (!table) return;
                const tabKey = App.state.currentActiveTab;
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                let bundledParentCodes = null;

                if (App.state.isPeBundleMode && planner) {
                    bundledParentCodes = new Set();
                    const assignedPes = (planner.assignedPes || []).map(p => p.id);
                    assignedPes.forEach(peCode => {
                        const links = App.dataMaps.peTo3dMap.get(peCode);
                        if (links) {
                            links.componentCodes.forEach(code => bundledParentCodes.add(code));
                            links.secondaryComponentCodes.forEach(code => bundledParentCodes.add(code));
                            links.specificCodes.forEach(specificCode => {
                                const element = App.dataMaps.ngss3dMap.get(specificCode);
                                if (element && element.parentCode) {
                                    bundledParentCodes.add(element.parentCode);
                                }
                            });
                        }
                    });
                }
                
                // Update Colgroup
                table.querySelectorAll('colgroup col[data-code]').forEach(col => {
                    const colTab = col.dataset.tabGroup;
                    const colCode = col.dataset.code;
                    const colParentGroup = col.dataset.groupParent;

                    let isVisible = (colTab === tabKey);
                    if (bundledParentCodes !== null && colTab !== 'pe') {
                        isVisible = isVisible && bundledParentCodes.has(colCode);
                    }
                    if (App.state.collapsedSections.has(colParentGroup)) {
                        isVisible = false;
                    }
                    col.classList.toggle('collapsed', !isVisible);
                });

                // Update Group Headers
                table.querySelectorAll('th[data-group-toggle]').forEach(th => {
                    const groupTab = th.dataset.tabGroup;
                    const fullGroupKey = th.dataset.groupToggle;
                    let isVisible = (groupTab === tabKey);
                    if (bundledParentCodes !== null) {
                        const hasVisibleChild = Array.from(table.querySelectorAll(`col[data-group-parent="${fullGroupKey}"]`))
                            .some(col => bundledParentCodes.has(col.dataset.code));
                        isVisible = isVisible && hasVisibleChild;
                    }
                    th.style.display = isVisible ? '' : 'none';
                });

                 // Update main header cells and body cells
                table.querySelectorAll('th[data-code], td[data-code]').forEach(cell => {
                    const cellCol = table.querySelector(`col[data-code="${cell.dataset.code}"]`);
                    if (cellCol) {
                         cell.style.display = cellCol.classList.contains('collapsed') ? 'none' : '';
                    }
                });

                // Update placeholder cells for collapsed groups
                table.querySelectorAll('.collapsed-placeholder').forEach(ph => {
                    const groupKey = ph.dataset.groupToggle;
                    const groupTab = ph.dataset.tabGroup;
                    let isVisible = (groupTab === tabKey) && App.state.collapsedSections.has(groupKey);
                    
                    if (bundledParentCodes !== null) {
                         const hasVisibleChild = Array.from(table.querySelectorAll(`col[data-group-parent="${groupKey}"]`))
                            .some(col => bundledParentCodes.has(col.dataset.code));
                        isVisible = isVisible && hasVisibleChild;
                    }
                    ph.style.display = isVisible ? '' : 'none';
                });
            },
            updateTableHeaderHighlights() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId); if (!planner) return;
                const assignedPes = planner.assignedPes || [];
                const primaryLinks = new Set();
                const secondaryLinks = new Set();

                assignedPes.forEach(peObj => {
                    const links = App.dataMaps.peTo3dMap.get(peObj.id);
                    if (!links) return;
                    
                    const targetSet = peObj.isSecondary ? secondaryLinks : primaryLinks;
                    links.componentCodes.forEach(code => targetSet.add(code));
                    links.specificCodes.forEach(code => {
                        const el = App.dataMaps.ngss3dMap.get(code);
                        if(el && el.parentCode) targetSet.add(el.parentCode);
                    });
                    links.secondaryComponentCodes.forEach(code => secondaryLinks.add(code));
                });
            
                App.dom.plannerTableContainer.querySelectorAll('thead th[data-code]').forEach(th => {
                    const code = th.dataset.code;
                    th.classList.remove('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold', 'bg-gray-300', 'dark:bg-gray-700', 'bg-gray-400/50', 'dark:bg-gray-600/50');
                    th.classList.add('bg-gray-200', 'dark:bg-gray-800');

                    const isPrimaryPe = assignedPes.some(p => p.id === code && !p.isSecondary);
                    const isSecondaryPe = assignedPes.some(p => p.id === code && p.isSecondary);

                    if (isPrimaryPe) {
                        th.classList.add('bg-blue-200', 'dark:bg-blue-900/50', 'font-bold');
                    } else if (isSecondaryPe) {
                        th.classList.add('bg-blue-100', 'dark:bg-blue-900/20');
                    } else if (primaryLinks.has(code)) {
                        th.classList.add('bg-gray-300', 'dark:bg-gray-700');
                    } else if (secondaryLinks.has(code)) {
                        th.classList.add('bg-gray-400/50', 'dark:bg-gray-600/50');
                    }
                });
            },
            progressionViewer() { 
                const btnElement = document.getElementById('progression-view-element');
                const btnLesson = document.getElementById('progression-view-lesson');
                
                btnElement.classList.toggle('bg-white', App.state.progressionViewType === 'element');
                btnElement.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'element');
                btnLesson.classList.toggle('bg-white', App.state.progressionViewType === 'lesson');
                btnLesson.classList.toggle('dark:bg-gray-900', App.state.progressionViewType === 'lesson');
                
                if (App.state.progressionViewType === 'lesson') {
                    this.renderProgressionByLesson();
                } else {
                    this.renderProgressionByElement();
                }
                App.utils.showView('progression-view'); 
            },
            renderProgressionByElement() {
                const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                if (selectedPlannerIds.length === 0) { 
                    alert('Please select at least one planner from the navigator to view its progression.'); 
                    return; 
                } 
                const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id)); 
                const tableContainer = document.getElementById('progression-table-view');
                tableContainer.innerHTML = '';
                document.getElementById('progression-subtitle').textContent = `Comparing: ${selectedPlanners.map(p => p.title).join(', ')}`; 
                
                const allTrackedElements = new Map(); 
                const allUnique3DElements = new Map();

                selectedPlanners.forEach(planner => { 
                    (planner.rows || []).forEach(row => { 
                        const processLesson = (lesson, lessonSetTitle = null) => { 
                            if (!lesson.trackingData) return;
                            Object.entries(lesson.trackingData).forEach(([code, status]) => { 
                                const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                                if (elementData) {
                                    if (!allTrackedElements.has(code)) { 
                                        allTrackedElements.set(code, []);
                                        allUnique3DElements.set(code, elementData);
                                    } 
                                    allTrackedElements.get(code).push({ plannerId: planner.id, lessonTitle: lesson.title, lessonSetTitle: lessonSetTitle, status: status });
                                }
                            }); 
                        }; 
                        if (row.type === 'lesson') processLesson(row); 
                        else if (row.type === 'lesson-set' && row.children) row.children.forEach(lesson => processLesson(lesson, row.title)); 
                    }); 
                }); 

                const groupedElements = { PE: [], SEP: [], DCI: [], CCC: [] };
                const groupNames = { PE: "Performance Expectations", SEP: "Science and Engineering Practices", DCI: "Disciplinary Core Ideas", CCC: "Crosscutting Concepts & Connections" };

                allUnique3DElements.forEach((elementData, code) => {
                    if (App.dataMaps.peMap.has(code)) {
                        groupedElements.PE.push([code, elementData]);
                    } else {
                        const dim = elementData.dimension || '';
                        if (dim.startsWith('SEP')) groupedElements.SEP.push([code, elementData]);
                        else if (dim.startsWith('DCI')) groupedElements.DCI.push([code, elementData]);
                        else groupedElements.CCC.push([code, elementData]);
                    }
                });

                for (const key in groupedElements) {
                    groupedElements[key].sort((a, b) => a[0].localeCompare(b[0]));
                }

                let tableHTML = `<table class="w-full border-collapse"><thead><tr class="bg-gray-200 dark:bg-gray-800"><th class="sticky p-2 border border-gray-300 dark:border-gray-700 text-left top-0 bg-gray-200 dark:bg-gray-800">3D Element / PE</th>`;
                selectedPlanners.forEach(p => { tableHTML += `<th class="p-2 border border-gray-300 dark:border-gray-700 text-left sticky top-0 bg-gray-200 dark:bg-gray-800">${p.title}</th>`; });
                tableHTML += `</tr></thead><tbody>`;

                Object.keys(groupedElements).forEach(groupKey => {
                    const elements = groupedElements[groupKey];
                    if (elements.length > 0) {
                        tableHTML += `<tr><th colspan="${selectedPlanners.length + 1}" class="p-2 text-left bg-gray-100 dark:bg-gray-900/50 font-bold text-lg text-gray-700 dark:text-gray-300 border-t-4 border-b-2 border-gray-300 dark:border-gray-600">${groupNames[groupKey]}</th></tr>`;
                        
                        elements.forEach(([code, elementData]) => {
                            const desc = elementData.text || elementData.description || '';
                            const elementTooltip = desc.replace(/"/g, '&quot;');
                            tableHTML += `<tr class="border-b dark:border-gray-700">
                                <td class="p-2 border border-gray-300 dark:border-gray-700 align-top font-semibold sticky left-0 bg-gray-50 dark:bg-gray-800/50 shadow-[4px_0_5px_-2px_rgba(0,0,0,0.05)] dark:shadow-[4px_0_5px_-2px_rgba(0,0,0,0.2)]">
                                    <strong data-tooltip="${elementTooltip}">${code}</strong><br><small class="font-normal text-gray-600 dark:text-gray-400">${desc}</small>
                                </td>`;
                            selectedPlanners.forEach(planner => {
                                const entriesForPlanner = (allTrackedElements.get(code) || []).filter(e => e.plannerId === planner.id);
                                let cellContent = '<div class="flex flex-col space-y-2">';
                                if (entriesForPlanner.length > 0) {
                                    cellContent += entriesForPlanner.map(e => {
                                       const tooltip = `${e.lessonSetTitle ? `${e.lessonSetTitle} &rarr; ` : ''}${e.lessonTitle}`;
                                       const badgeColor = App.constants.statusBadgeClasses[e.status] || 'bg-gray-200 dark:bg-gray-600';
                                       return `<div class="flex items-center gap-2 text-sm">
                                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold flex-shrink-0 ${badgeColor}" data-tooltip="${tooltip.replace(/"/g, '&quot;')}">${e.status}</span>
                                                <span class="truncate" title="${tooltip}">${tooltip}</span>
                                               </div>`;
                                    }).join('');
                                }
                                cellContent += '</div>';
                                tableHTML += `<td class="p-2 border border-gray-300 dark:border-gray-700 align-top">${cellContent}</td>`;
                            });
                            tableHTML += `</tr>`;
                        });
                    }
                });
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            },
            renderProgressionByLesson() {
                const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId); 
                if (selectedPlannerIds.length === 0) { 
                    alert('Please select at least one planner from the navigator to view its progression.'); 
                    return; 
                } 
                const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id));
                
                const container = document.getElementById('progression-table-view');
                container.innerHTML = '';
                document.getElementById('progression-subtitle').textContent = `Storyline for: ${selectedPlanners.map(p => p.title).join(', ')}`;

                selectedPlanners.forEach(planner => {
                    const plannerSection = document.createElement('div');
                    plannerSection.className = 'mb-8 border-b-4 border-gray-300 dark:border-gray-600 pb-4';
                    plannerSection.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-200">${planner.title} <small class="text-base font-normal text-gray-500">(${planner.gradeBand})</small></h2>`;
                    
                    (planner.rows || []).forEach(row => {
                        const rowEl = document.createElement('div');
                        rowEl.className = 'mb-4';
                        if (row.type === 'lesson-set') {
                            rowEl.innerHTML = `<h3 class="text-lg font-bold p-2 bg-blue-100 dark:bg-blue-900/50 rounded-t-lg text-blue-800 dark:text-blue-200">${row.title}</h3>`;
                            (row.children || []).forEach(lesson => {
                                rowEl.innerHTML += this.createStorylineLessonHTML(lesson);
                            });
                        } else {
                            rowEl.innerHTML = this.createStorylineLessonHTML(row);
                        }
                        plannerSection.appendChild(rowEl);
                    });
                    container.appendChild(plannerSection);
                });
            },
            createStorylineLessonHTML(lesson) {
                 const groupedBadges = { PE: [], SEP: [], DCI: [], CCC: [] };

                 Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                    const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                    const desc = elementData ? (elementData.text || elementData.description) : 'Unknown Element';
                    const tooltip = `<b>${code} (${status})</b>: ${desc.replace(/"/g, '&quot;')}`;
                    const badgeColor = App.constants.statusBadgeClasses[status] || 'bg-gray-200 dark:bg-gray-600';
                    const badgeHTML = `<span class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap ${badgeColor}" data-tooltip="${tooltip}">${code}</span>`;

                    if (App.dataMaps.peMap.has(code)) {
                        groupedBadges.PE.push(badgeHTML);
                    } else if (elementData) {
                        const dim = elementData.dimension || '';
                        if (dim.startsWith('SEP')) groupedBadges.SEP.push(badgeHTML);
                        else if (dim.startsWith('DCI')) groupedBadges.DCI.push(badgeHTML);
                        else groupedBadges.CCC.push(badgeHTML);
                    }
                });

                let finalHTML = '';
                const groupOrder = ['PE', 'DCI', 'SEP', 'CCC'];
                const groupNames = { PE: 'PEs', DCI: 'DCIs', SEP: 'SEPs', CCC: 'CCCs' };

                groupOrder.forEach(key => {
                    if (groupedBadges[key].length > 0) {
                        finalHTML += `<div class="flex items-start gap-2 mb-1.5">
                                        <strong class="text-xs font-bold uppercase text-gray-500 dark:text-gray-400 w-10 flex-shrink-0 pt-0.5">${groupNames[key]}:</strong>
                                        <div class="flex flex-wrap gap-1.5">${groupedBadges[key].join('')}</div>
                                      </div>`;
                    }
                });

                return `
                    <div class="p-3 border dark:border-gray-700 bg-white dark:bg-gray-800/50">
                        <h4 class="font-semibold">${lesson.title}</h4>
                        <div class="mt-2 space-y-2">
                            ${finalHTML || '<p class="text-xs text-gray-500 dark:text-gray-400">No elements tracked.</p>'}
                        </div>
                    </div>
                `;
            },
            
            summary() {
                // 0. Clean up previous charts
                Object.values(App.state.activeCharts).forEach(chart => { if(chart) chart.destroy(); });
                App.state.activeCharts = {};

                // 1. Determine which planners to summarize
                const checkedBoxes = document.querySelectorAll('.planner-checkbox:checked');
                let selectedPlanners = [];
                
                if (checkedBoxes.length > 0) {
                    selectedPlanners = Array.from(checkedBoxes).map(cb => {
                        return App.utils.findPlanner(cb.closest('.planner-item').dataset.plannerId);
                    }).filter(p => p); 
                } else {
                    const current = App.utils.findPlanner(App.state.currentPlannerId);
                    if (current) selectedPlanners = [current];
                }

                if (selectedPlanners.length === 0) {
                    document.getElementById('summary-content').innerHTML = '<p class="p-4 text-gray-500">Please select a planner or check boxes in the navigator to view a summary.</p>';
                    document.querySelector('#summary-view h1').textContent = 'Planner Summary & Analytics';
                    document.getElementById('summary-subtitle').textContent = '';
                    return;
                }

                // 2. Setup Headers & Filter UI
                const titleText = selectedPlanners.length === 1 ? selectedPlanners[0].title : 'Combined Summary';
                const subText = selectedPlanners.length === 1 
                    ? `${selectedPlanners[0].course} (${selectedPlanners[0].gradeBand})` 
                    : `Aggregating data from ${selectedPlanners.length} selected planners.`;
                
                document.querySelector('#summary-view h1').textContent = titleText;
                document.getElementById('summary-subtitle').textContent = subText;

                const container = document.getElementById('summary-content');
                const isChecked = App.state.summaryShowCoveredOnly ? 'checked' : '';
                
                // Generate Active Filter Badge HTML
                let filterBadge = '';
                if (App.state.summaryChartFilter) {
                    const { type, value } = App.state.summaryChartFilter;
                    let label = value;
                    if (value === 'I') label = 'Introduced';
                    if (value === 'D') label = 'Developed';
                    if (value === 'A') label = 'Assessed';
                    if (value === '') label = 'Not Scoped';
                    if (value === 'F') label = 'Formative';
                    if (value === 'S') label = 'Summative';
                    
                    filterBadge = `
                        <button id="clear-filter-btn" class="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded-full text-sm font-bold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                            <span>Filter: ${type.charAt(0).toUpperCase() + type.slice(1)} = ${label}</span>
                            <span class="text-lg leading-none">&times;</span>
                        </button>
                    `;
                }

                container.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <div id="filter-container">${filterBadge}</div>
                        <label class="flex items-center cursor-pointer">
                            <span class="mr-3 text-sm font-medium text-gray-900 dark:text-gray-300">Show Covered Elements Only</span>
                            <div class="relative">
                                <input type="checkbox" id="summary-coverage-toggle" class="sr-only peer" ${isChecked}>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                            </div>
                        </label>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                            <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">3D Element Status Distribution</h3>
                            <div class="relative h-64"><canvas id="status-chart"></canvas></div>
                            <p class="text-xs text-center mt-2 text-gray-400">Click bars to filter report by status</p>
                        </div>
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                            <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">Dimension Usage Balance</h3>
                            <div class="relative h-64"><canvas id="dimension-chart"></canvas></div>
                            <p class="text-xs text-center mt-2 text-gray-400">Click ring to filter report by dimension</p>
                        </div>
                        <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 hover:border-blue-400 transition-colors">
                            <h3 class="font-bold mb-2 text-gray-700 dark:text-gray-200">Assessment Scope</h3>
                            <div class="relative h-64"><canvas id="scope-chart"></canvas></div>
                            <p class="text-xs text-center mt-2 text-gray-400">Click slices to filter report by scope</p>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-gray-100">Element Coverage Report</h3>
                        <div id="element-coverage-report" class="space-y-6"></div>
                    </div>
                `;

                // 3. Attach Listeners
                document.getElementById('summary-coverage-toggle').addEventListener('change', (e) => {
                    App.state.summaryShowCoveredOnly = e.target.checked;
                    this.summary();
                });
                
                if (document.getElementById('clear-filter-btn')) {
                    document.getElementById('clear-filter-btn').addEventListener('click', () => {
                        App.state.summaryChartFilter = null;
                        this.summary();
                    });
                }

                // 4. Aggregate Data
                const globalStats = {
                    status: { I: 0, D: 0, A: 0 },
                    dimension: { SEP: 0, DCI: 0, CCC: 0, PE: 0 },
                    scope: { F: 0, S: 0, None: 0 }
                };
                
                const coverageMap = new Map(); 
                const filter = App.state.summaryChartFilter;

                selectedPlanners.forEach(planner => {
                    const allLessons = [];
                    (planner.rows || []).forEach(row => {
                        if (row.type === 'lesson') allLessons.push(row);
                        else if (row.type === 'lesson-set') allLessons.push(...(row.children || []));
                    });

                    allLessons.forEach(lesson => {
                        const scopeKey = lesson.scope || 'None';
                        
                        globalStats.scope[scopeKey]++;
                        Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                            if (globalStats.status[status] !== undefined) globalStats.status[status]++;
                            
                            const element = App.dataMaps.ngss3dMap.get(code);
                            if (element) {
                                if (element.dimension.startsWith('SEP')) globalStats.dimension.SEP++;
                                else if (element.dimension.startsWith('DCI')) globalStats.dimension.DCI++;
                                else globalStats.dimension.CCC++;
                            } else if (App.dataMaps.peMap.has(code)) {
                                globalStats.dimension.PE++;
                            }
                        });

                        if (filter && filter.type === 'scope') {
                            const targetScope = filter.value === 'None' ? '' : (filter.value === 'Formative' ? 'F' : 'S');
                            if ((lesson.scope || '') !== targetScope) return;
                        }

                        Object.entries(lesson.trackingData || {}).forEach(([code, status]) => {
                            if (!coverageMap.has(code)) coverageMap.set(code, { I: 0, D: 0, A: 0 });
                            coverageMap.get(code)[status]++;
                        });
                    });
                });

                // 5. Render Interactive Charts
                const handleChartClick = (type, labelMap) => (e, elements) => {
                    if (!elements || elements.length === 0) return;
                    const index = elements[0].index;
                    const chart = e.chart; 
                    const label = chart.data.labels[index];
                    let value = label;
                    if (labelMap) value = labelMap[label];
                    App.state.summaryChartFilter = { type, value };
                    this.summary(); 
                };

                App.state.activeCharts.status = new Chart(document.getElementById('status-chart'), {
                    type: 'bar',
                    data: {
                        labels: ['Introduced', 'Developed', 'Assessed'],
                        datasets: [{ 
                            label: 'Count', 
                            data: [globalStats.status.I, globalStats.status.D, globalStats.status.A], 
                            backgroundColor: ['#FBBF24', '#34D399', '#60A5FA'],
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                        onClick: handleChartClick('status', { 'Introduced': 'I', 'Developed': 'D', 'Assessed': 'A' }),
                        onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                    }
                });

                App.state.activeCharts.dimension = new Chart(document.getElementById('dimension-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SEPs', 'DCIs', 'CCCs', 'PEs'],
                        datasets: [{ 
                            data: [globalStats.dimension.SEP, globalStats.dimension.DCI, globalStats.dimension.CCC, globalStats.dimension.PE], 
                            backgroundColor: ['#818CF8', '#F87171', '#FB923C', '#60A5FA'],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        onClick: handleChartClick('dimension', { 'SEPs': 'sep', 'DCIs': 'dci', 'CCCs': 'ccc', 'PEs': 'pe' }),
                        onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                    }
                });

                App.state.activeCharts.scope = new Chart(document.getElementById('scope-chart'), {
                    type: 'pie',
                    data: {
                        labels: ['Formative', 'Summative', 'Not Scoped'],
                        datasets: [{ 
                            data: [globalStats.scope.F, globalStats.scope.S, globalStats.scope.None], 
                            backgroundColor: ['#6366F1', '#EC4899', '#E5E7EB'],
                            borderWidth: 0
                        }]
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        onClick: handleChartClick('scope'),
                        onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default'; }
                    }
                });
                
                // 6. Render Coverage Report - Updated to show elements from ANY selected planner
                const coverageReportContainer = document.getElementById('element-coverage-report');
                
                // Collect all unique grade bands from selected planners to ensure we display relevant parent categories
                const relevantBands = new Set(selectedPlanners.map(p => p.gradeBand));
                
                let reportHTML = '';
                let groupOrder = ['dci', 'sep', 'ccc'];
                if (filter && filter.type === 'dimension') {
                    if (filter.value === 'pe') groupOrder = []; 
                    else groupOrder = [filter.value];
                }
                
                // We iterate through parentToChildrenMap directly to find relevant groups
                const groups = { dci: [], sep: [], ccc: [] };
                
                App.dataMaps.parentToChildrenMap.forEach((parentInfo, parentCode) => {
                    if (parentCode === 'PE') return;
                    
                    let dimKey = '';
                    if (parentInfo.dimension.startsWith('DCI')) dimKey = 'dci';
                    else if (parentInfo.dimension === 'SEP') dimKey = 'sep';
                    else if (parentInfo.dimension === 'CCC' || parentInfo.dimension === 'C-ETAS') dimKey = 'ccc';
                    else if (parentInfo.dimension === 'CNS') {
                        // CNS belongs to both SEP and CCC depending on the code
                        if (['VOM', 'BEE', 'OTR', 'ENP'].includes(parentCode)) dimKey = 'sep';
                        else dimKey = 'ccc';
                    }
                    
                    if (dimKey && groups[dimKey]) {
                        groups[dimKey].push({ code: parentCode, ...parentInfo });
                    }
                });

                groupOrder.forEach(groupKey => {
                    const parentsInGroup = groups[groupKey];
                    if (!parentsInGroup || parentsInGroup.length === 0) return;

                    let groupHTML = `<div class="mb-6"><h4 class="text-xl font-bold border-b-2 pb-2 mb-4 border-gray-200 dark:border-gray-600 text-gray-800 dark:text-gray-100">${groupKey.toUpperCase()}</h4>`;
                    let hasVisibleParents = false;

                    parentsInGroup.forEach(parentInfo => {
                        // Check if any children are relevant either by band OR by coverage
                        const childrenForReport = parentInfo.children.filter(child => {
                            // Is it in one of the selected grade bands?
                            const inSelectedBands = Array.from(relevantBands).some(band => child.allProgressions[band]?.length > 0);
                            // Is it tracked in the aggregated data?
                            const isTracked = coverageMap.has(child.code);
                            return inSelectedBands || isTracked;
                        });

                        const visibleChildren = childrenForReport.filter(child => {
                            const coverage = coverageMap.get(child.code);
                            const isCovered = !!coverage;
                            if (App.state.summaryShowCoveredOnly && !isCovered) return false;
                            if (filter && filter.type === 'status') {
                                if (!coverage || !coverage[filter.value]) return false;
                            }
                            return true;
                        });

                        if (visibleChildren.length === 0) return;
                        hasVisibleParents = true;

                        groupHTML += `<div class="mb-5 pl-2">
                                        <h5 class="font-bold text-gray-700 dark:text-gray-300 mb-2">${parentInfo.name}</h5>
                                        <ul class="space-y-3">`;
                        
                        visibleChildren.forEach(child => {
                            const coverage = coverageMap.get(child.code);
                            let coverageString = '';
                            let rowClass = 'bg-gray-50 dark:bg-gray-700/30'; 

                            if (coverage) {
                                coverageString = Object.entries(coverage)
                                    .filter(([, count]) => count > 0)
                                    .map(([status, count]) => {
                                        const isMatch = (filter && filter.type === 'status' && filter.value === status);
                                        const border = isMatch ? 'border-2 border-black dark:border-white ring-2 ring-offset-1 ring-blue-400' : 'border border-black/10';
                                        return `<span class="px-2 py-0.5 rounded-full text-xs font-bold ${App.constants.statusBadgeClasses[status]} ${border}">${status}: ${count}</span>`;
                                    })
                                    .join(' ');
                                rowClass = 'bg-white dark:bg-gray-800 border-l-4 border-blue-400';
                            } else {
                                coverageString = `<span class="px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-400">Not Covered</span>`;
                            }

                            groupHTML += `<li class="p-3 rounded-md border border-gray-100 dark:border-gray-700 ${rowClass}">
                                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                                                <div class="text-sm">
                                                    <span class="font-bold text-gray-800 dark:text-gray-200">${child.code}</span>
                                                    <span class="text-gray-600 dark:text-gray-400 block mt-1">${child.text}</span>
                                                </div>
                                                <div class="flex-shrink-0 flex flex-wrap gap-1.5 mt-1 sm:mt-0">${coverageString}</div>
                                            </div>
                                           </li>`;
                        });
                        groupHTML += `</ul></div>`;
                    });
                    
                    groupHTML += `</div>`;
                    if (hasVisibleParents) reportHTML += groupHTML;
                });

                if (reportHTML === '') {
                    reportHTML = `<div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg border border-dashed border-gray-300 dark:border-gray-700">
                        <p class="text-gray-500 text-lg">No elements match the current filters.</p>
                        ${filter ? `<button id="clear-filter-empty-btn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Clear Filter</button>` : ''}
                    </div>`;
                }

                coverageReportContainer.innerHTML = reportHTML;
                
                if(document.getElementById('clear-filter-empty-btn')) {
                     document.getElementById('clear-filter-empty-btn').addEventListener('click', () => {
                        App.state.summaryChartFilter = null;
                        this.summary();
                    });
                }

                App.utils.showView('summary-view');
            },
        };

        App.handlers = {
            mainTableClick(e) {
                const target = e.target;
                const rowEl = target.closest('[data-id]');

                const groupToggle = target.closest('[data-group-toggle]');
                if (groupToggle) {
                    const groupKey = groupToggle.dataset.groupToggle;

                    if (App.state.collapsedSections.has(groupKey)) {
                        App.state.collapsedSections.delete(groupKey);
                        groupToggle.querySelector('.toggle-icon').textContent = '▼';
                        groupToggle.classList.remove('collapsed-placeholder');

                    } else {
                        App.state.collapsedSections.add(groupKey);
                        groupToggle.querySelector('.toggle-icon').textContent = '▶';
                        groupToggle.classList.add('collapsed-placeholder');
                    }
                    App.render.updateColumnVisibility();
                    return;
                }
                
                if (!rowEl) return;
                
                const rowId = rowEl.dataset.id;
                
                const notesBtn = target.closest('.notes-btn');
                if (notesBtn) { App.utils.openLessonDetailsModal(rowId); return; }
                
                const deleteBtn = target.closest('.delete-btn');
                if (deleteBtn) { if (confirm('Delete this row?')) { App.utils.deleteRow(rowId); } return; }
                
                const addBelowBtn = target.closest('.add-below-btn');
                if (addBelowBtn) { App.utils.addRowAdjacent(rowId, 'below'); return; }

                const copyBtn = target.closest('.copy-row-btn');
                if (copyBtn) { App.utils.copyRow(rowId); return; }

                const peCell = target.closest('[data-code]');
                if (peCell && peCell.dataset.tabGroup === 'pe') { App.utils.cyclePeStatus(rowId, peCell.dataset.code); return; }

                const scopeCell = target.closest('[data-scope-cell]');
                if(scopeCell) { App.utils.cycleScopeStatus(rowId); return; }

                const trackingCell = target.closest('[data-code]'); 
                if (trackingCell && trackingCell.dataset.tabGroup !== 'pe') { App.popover.show(trackingCell, trackingCell.dataset.code, rowId); return; }

                const headerCell = target.closest('th[data-code]'); 
                if (headerCell) { App.utils.openElementDetailModal(headerCell.dataset.code); return; }
                
                const lessonSetRow = target.closest('.lesson-set-row');
                if (lessonSetRow && !target.matches('.editable')) { 
                    App.history.saveState();
                    const planner = App.utils.findPlanner(App.state.currentPlannerId); 
                    const rowData = App.utils.findRowData(planner, rowId); 
                    if (rowData) { 
                        rowData.isCollapsed = !rowData.isCollapsed; 
                        App.render.rowsFromState(planner.rows); 
                        App.render.updateColumnVisibility();
                        App.render.setActiveTab(App.state.currentActiveTab); 
                        App.persistence.debouncedSave(); 
                    } 
                }
            },
            titleEdit(e) {
                clearTimeout(this.titleEditTimeout);
                this.titleEditTimeout = setTimeout(() => {
                    const rowId = e.target.closest('[data-id]').dataset.id;
                    const planner = App.utils.findPlanner(App.state.currentPlannerId);
                    App.history.saveState();
                    const rowData = App.utils.findRowData(planner, rowId);
                    if (rowData) {
                        rowData.title = e.target.textContent;
                        App.persistence.debouncedSave();
                    }
                }, 500); 
            },
            tooltipShow(e) { const target = e.target.closest('[data-tooltip]'); if (!target || !target.dataset.tooltip) return; App.dom.tooltip.innerHTML = target.dataset.tooltip; App.dom.tooltip.style.opacity = '1'; const targetRect = target.getBoundingClientRect(); App.dom.tooltip.style.left = `${e.clientX + 10}px`; App.dom.tooltip.style.top = `${e.clientY + 10}px`; },
            tooltipHide() { App.dom.tooltip.style.opacity = '0'; },
            dragStart(e) {
                if (!e.target.matches('tr')) return;
                const draggedRow = e.target;
                App.state.draggedGroup = [draggedRow];

                if (draggedRow.dataset.rowType === 'lesson-set') {
                    const setId = draggedRow.dataset.id;
                    const childRows = App.dom.plannerTableContainer.querySelectorAll(`tr[data-parent-id="${setId}"]`);
                    childRows.forEach(child => App.state.draggedGroup.push(child));
                }
                
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    App.state.draggedGroup.forEach(row => row.classList.add('opacity-50', 'bg-yellow-200'));
                }, 0);
            },
            dragOver(e) {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (targetRow && App.state.draggedGroup && !App.state.draggedGroup.includes(targetRow)) {
                    targetRow.classList.add('bg-blue-100');
                }
            },
            dragLeave(e) {
                e.preventDefault();
                const targetRow = e.target.closest('tr');
                if (targetRow) {
                    targetRow.classList.remove('bg-blue-100');
                }
            },
            drop(e) {
                App.history.saveState();
                e.preventDefault();
                const dropTarget = e.target.closest('tbody tr');
                if (dropTarget && App.state.draggedGroup && !App.state.draggedGroup.includes(dropTarget)) {
                    const tbody = dropTarget.parentNode;
                    const targetRect = dropTarget.getBoundingClientRect();
                    const targetMidY = targetRect.top + targetRect.height / 2;
                    const referenceNode = (e.clientY < targetMidY) ? dropTarget : dropTarget.nextSibling;
                    App.state.draggedGroup.forEach(draggedRow => { tbody.insertBefore(draggedRow, referenceNode); });
                }
                document.querySelectorAll('.bg-blue-100').forEach(el => el.classList.remove('bg-blue-100'));
                if (App.state.draggedGroup) { App.state.draggedGroup.forEach(row => row.classList.remove('opacity-50', 'bg-yellow-200')); }
                App.state.draggedGroup = null;
                App.persistence.updateStateFromTableOrder();
                App.persistence.debouncedSave();
            }
        };

        App.utils = {
             findPlanner: (id) => App.state.programData.planners.find(p => p.id === id),
             findRowData(planner, rowId) {
                if (!planner || !planner.rows) return null;
                for (const row of planner.rows) {
                    if (row.id === rowId) return row;
                    if (row.type === 'lesson-set' && row.children) {
                        const foundInChildren = row.children.find(child => child.id === rowId);
                        if (foundInChildren) return foundInChildren;
                    }
                }
                return null;
             },
             findRowAndParent(planner, rowId) {
                if (!planner || !planner.rows) return null;
                for (let i = 0; i < planner.rows.length; i++) {
                    const row = planner.rows[i];
                    if (row.id === rowId) {
                        return { row: row, parentArray: planner.rows, index: i };
                    }
                    if (row.type === 'lesson-set' && row.children) {
                        for (let j = 0; j < row.children.length; j++) {
                            const child = row.children[j];
                            if (child.id === rowId) {
                                return { row: child, parentArray: row.children, index: j };
                            }
                        }
                    }
                }
                return null;
             },
             showView: (id) => { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('flex');},
             openModal(modalId) { document.getElementById(modalId).classList.replace('hidden', 'flex'); App.dom.body.classList.add('modal-open'); },
             closeAllModals: () => { document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.replace('flex', 'hidden') ); App.dom.body.classList.remove('modal-open'); App.popover.hide(); },
             normalizeText: (t) => t.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim(),
             escapeRegExp: (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
            getGradeBandKey: (l) => {
                if (!l) return null;
                const lc = l.toLowerCase();
                if (['kindergarten', 'first', 'second', 'k-2'].some(k => lc.includes(k))) return 'primary';
                if (['third', 'fourth', 'fifth', '3-5'].some(k => lc.includes(k))) return 'elementary';
                if (lc.includes('middle')) return 'middle';
                if (lc.includes('high')) return 'high';
                return null;
            },
            findBestMatchingSpecificElement(text, grade) {
                const clean = text.trim().replace(/^[\*•]\s*/, '').replace(/\s*\([^)]*\)\s*$/, '').trim();
                if (clean.length < 15) return null;
                const cacheKey = `${grade}|${clean}`;
                if (App.dataMaps.fuzzyMatchCache.has(cacheKey)) return App.dataMaps.fuzzyMatchCache.get(cacheKey);
                const normText = this.normalizeText(clean);
                const words = normText.split(' ').filter(w => w.length > 1);
                if (words.length === 0) return null;
                const threshold = words.length < 10 ? 0.75 : 0.80;
                const gradeKey = this.getGradeBandKey(grade);
                let best = { code: null, score: 0, base: 0, len: Infinity };
                for (const [offText, code] of App.dataMaps.textToSpecificCodeMap.entries()) {
                    const normOffText = this.normalizeText(offText);
                    const found = words.reduce((count, word) => {
                        const rgx = new RegExp(`\\b${this.escapeRegExp(word)}\\b`);
                        if (rgx.test(normOffText)) return count + 1;
                        const singular = word.endsWith('s') ? word.slice(0, -1) : null;
                        if (singular && singular.length > 2 && new RegExp(`\\b${this.escapeRegExp(singular)}\\b`).test(normOffText)) return count + 1;
                        const plural = !word.endsWith('s') ? word + 's' : null;
                        if (plural && new RegExp(`\\b${this.escapeRegExp(plural)}\\b`).test(normOffText)) return count + 1;
                        return count;
                    }, 0);
                    const baseScore = found / words.length;
                    let weightedScore = baseScore;
                    const el = App.dataMaps.ngss3dMap.get(code);
                    if (gradeKey && el && el.allProgressions[gradeKey]) {
                         weightedScore += 0.2;
                    }
                    if (weightedScore > best.score || (weightedScore === best.score && offText.length < best.len)) {
                        best = { code, score: weightedScore, base: baseScore, len: offText.length };
                    }
                }
                const result = best.base >= threshold ? best.code : null;
                App.dataMaps.fuzzyMatchCache.set(cacheKey, result);
                return result;
            },
             gatherColumns(gradeBand) {
                const dims = { 
                    pe: { name: "PEs", key: 'pe', totalCols: 0, groups: {} }, 
                    dci: { name: "DCIs", key: 'dci', totalCols: 0, groups: { PS: { name: "Physical Science", cols: [] }, LS: { name: "Life Science", cols: [] }, ESS: { name: "Earth & Space Science", cols: [] }, ETS: { name: "Engineering", cols: [] } } }, 
                    sep: { name: "SEPs & Nature of Science", key: 'sep', totalCols: 0, groups: { SEP: { name: "SEPs", cols: [] }, CNS: { name: "Nature of Science", cols: [] } } }, 
                    ccc: { name: "CCCs, NOS, & ETAS", key: 'ccc', totalCols: 0, groups: { CCC: { name: "CCCs", cols: [] }, CNS: { name: "Nature of Science", cols: [] }, ETAS: { name: "Eng & Tech Apps", cols: [] } } }
                };

                const nosForSep = new Set(['VOM', 'BEE', 'OTR', 'ENP']);
                const nosForCcc = new Set(['WOK', 'AOC', 'HE', 'AQAW']);

                App.dataMaps.parentToChildrenMap.forEach((parentData, parentCode) => {
                    if (parentCode === 'PE') return;

                    const isRelevant = parentData.children.some(child => child.allProgressions[gradeBand]?.length > 0);
                    if (isRelevant) {
                        const columnInfo = { code: parentCode, title: parentData.name };
                        const dimension = parentData.dimension;

                        if (dimension.startsWith('DCI-PS')) { dims.dci.groups.PS.cols.push(columnInfo); dims.dci.totalCols++; }
                        else if (dimension.startsWith('DCI-LS')) { dims.dci.groups.LS.cols.push(columnInfo); dims.dci.totalCols++; }
                        else if (dimension.startsWith('DCI-ESS')) { dims.dci.groups.ESS.cols.push(columnInfo); dims.dci.totalCols++; }
                        else if (dimension.startsWith('DCI-ETS')) { dims.dci.groups.ETS.cols.push(columnInfo); dims.dci.totalCols++; }
                        else if (dimension === 'SEP') { dims.sep.groups.SEP.cols.push(columnInfo); dims.sep.totalCols++; }
                        else if (dimension === 'CCC') { dims.ccc.groups.CCC.cols.push(columnInfo); dims.ccc.totalCols++; }
                        else if (dimension === 'CNS') {
                            if (nosForSep.has(parentCode)) { dims.sep.groups.CNS.cols.push(columnInfo); dims.sep.totalCols++; }
                            if (nosForCcc.has(parentCode)) { dims.ccc.groups.CNS.cols.push(columnInfo); dims.ccc.totalCols++; }
                        } else if (dimension === 'C-ETAS') {
                            dims.ccc.groups.ETAS.cols.push(columnInfo); dims.ccc.totalCols++;
                        }
                    }
                });
                return dims;
            },
            cyclePeStatus(rowId, peCode) {
                App.history.saveState();
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                const currentStatus = rowData.trackingData[peCode];
                const cycle = { '': 'I', 'I': 'D', 'D': 'A', 'A': '' };
                const newStatus = cycle[currentStatus || ''];
                if (newStatus) { rowData.trackingData[peCode] = newStatus; } 
                else { delete rowData.trackingData[peCode]; }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            cycleScopeStatus(rowId) {
                App.history.saveState();
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                const currentScope = rowData.scope;
                const cycle = { '': 'F', 'F': 'S', 'S': '' };
                rowData.scope = cycle[currentScope || ''];
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            addRow(type, text) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState();
                const newRowData = { id: `row-${Date.now()}`, type, title: text };
                if (type === 'lesson-set') {
                    newRowData.children = [];
                    newRowData.isCollapsed = false;
                    planner.rows.push(newRowData);
                } else {
                    newRowData.trackingData = {};
                    newRowData.scope = '';
                    newRowData.details = { notes: '', links: [] };
                    const lastSet = planner.rows.filter(r => r.type === 'lesson-set').pop();
                    if (lastSet && !lastSet.isCollapsed) {
                        lastSet.children.push(newRowData);
                    } else {
                        planner.rows.push(newRowData);
                    }
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            addRowAdjacent(referenceRowId, position = 'below') {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState();
                const location = this.findRowAndParent(planner, referenceRowId);
                if (!location) return;
                const newLesson = {
                    id: `row-${Date.now()}`,
                    type: 'lesson',
                    title: 'New Lesson...',
                    trackingData: {},
                    scope: '',
                    details: { notes: '', links: [] }
                };
                const insertIndex = position === 'below' ? location.index + 1 : location.index;
                location.parentArray.splice(insertIndex, 0, newLesson);
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            copyRow(sourceRowId) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                if (!planner) return;
                App.history.saveState();
                const location = this.findRowAndParent(planner, sourceRowId);
                if (!location) return;
                const sourceRowData = location.row;
                const newRowData = JSON.parse(JSON.stringify(sourceRowData));
                newRowData.id = `row-${Date.now()}`;
                newRowData.title = `${sourceRowData.title} (Copy)`;
                location.parentArray.splice(location.index + 1, 0, newRowData);
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            deleteRow(rowId) {
                const planner = this.findPlanner(App.state.currentPlannerId); if (!planner) return;
                App.history.saveState();
                let foundAndRemoved = false;
                planner.rows = planner.rows.filter(row => {
                    if (row.id === rowId) {
                        foundAndRemoved = true;
                        return false;
                    }
                    return true;
                });
                if (!foundAndRemoved) {
                    planner.rows.forEach(row => {
                        if (row.type === 'lesson-set' && row.children) {
                            row.children = row.children.filter(child => child.id !== rowId);
                        }
                    });
                }
                App.render.renderPlannerContent();
                App.render.setActiveTab(App.state.currentActiveTab);
                App.persistence.debouncedSave();
            },
            openPlannerModal(p=null){
                const t=document.getElementById('planner-modal-title');const d=document.getElementById('planner-modal-delete');
                const structureFields = document.getElementById('new-planner-structure-fields');
                document.getElementById('planner-id-input').value=p?p.id:'';
                document.getElementById('planner-title-input').value=p?p.title:'';
                document.getElementById('planner-course-input').value=p?p.course:'';
                document.getElementById('planner-band-select').value=p?p.gradeBand:'elementary';
                document.getElementById('planner-standard-select').value=p?p.standardSet:'NGSS';
                document.getElementById('planner-phenomenon-input').value = p ? p.phenomenon : '';
                document.getElementById('planner-question-input').value = p ? p.question : '';
                document.getElementById('planner-description-input').value=p?p.description:'';
                if(p) {
                    t.textContent='Edit Planner';
                    d.style.display='inline-block';
                    structureFields.style.display = 'none';
                } else {
                    t.textContent='New Planner';
                    d.style.display='none';
                    structureFields.style.display = 'grid';
                }
                this.openModal('planner-modal-backdrop'); 
            },
            savePlanner() { 
                const id = document.getElementById('planner-id-input').value;
                const isEditing = !!id;
                if(isEditing) App.history.saveState();

                const data = {
                    title: document.getElementById('planner-title-input').value,
                    course: document.getElementById('planner-course-input').value,
                    gradeBand: document.getElementById('planner-band-select').value,
                    standardSet: document.getElementById('planner-standard-select').value,
                    phenomenon: document.getElementById('planner-phenomenon-input').value,
                    question: document.getElementById('planner-question-input').value,
                    description: document.getElementById('planner-description-input').value
                };

                if (!data.title) { alert('Planner Title is required.'); return; }

                if (isEditing) {
                    Object.assign(App.utils.findPlanner(id), data);
                } else {
                    data.id = `planner-${Date.now()}`;
                    const numSets = parseInt(document.getElementById('planner-sets-input').value) || 1;
                    const lessonsPerSet = parseInt(document.getElementById('planner-lessons-per-set-input').value) || 1;
                    
                    const genId = () => `row-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
                    const makeLesson = (lessonNum) => ({ id: genId(), type: 'lesson', title: `Lesson ${lessonNum}`, trackingData: {}, scope: '', details: { notes: '', links: [] } });
                    
                    data.rows = [];
                    let lessonCounter = 1;
                    for(let i=1; i<=numSets; i++) {
                        const children = [];
                        for(let j=1; j<=lessonsPerSet; j++) {
                            children.push(makeLesson(lessonCounter++));
                        }
                        data.rows.push({ id: genId(), type: 'lesson-set', title: `Lesson Set ${i}`, isCollapsed: false, children });
                    }

                    data.activeTab = 'pe';
                    data.assignedPes = [];
                    App.state.programData.planners.push(data);
                }
                App.persistence.saveProgramData();
                App.render.navigator();
                App.render.welcomeView();
                if (!isEditing) {
                    App.render.plannerView(data.id);
                } else if (id === App.state.currentPlannerId) {
                    App.render.plannerView(id);
                }
                App.utils.closeAllModals();
            },
            openPeAssignmentModal() { 
                const p = App.utils.findPlanner(App.state.currentPlannerId); if(!p) return;
                const list = document.getElementById('pe-modal-list');
                list.innerHTML = '';
                const r = Object.keys(App.dataMaps.gradeBandMap).filter(g => App.dataMaps.gradeBandMap[g] === p.gradeBand); 
                list.className = 'grid grid-cols-1 md:grid-cols-2 gap-4'; 

                App.state.allNgssData.forEach(g => {
                    if(r.includes(g.gradeId)){
                        (g.topics || []).forEach(t => {
                            if (!t.performanceExpectations) return; // FIX: Defensive check
                            t.performanceExpectations.forEach(pe => {
                                const assignedPeObj = p.assignedPes?.find(p_obj => p_obj.id === pe.id);
                                const isChecked = !!assignedPeObj;
                                const isSecondaryChecked = assignedPeObj?.isSecondary || false;

                                const d = document.createElement('div');
                                d.className = 'pe-modal-item relative p-4 border rounded-lg shadow-sm transition-all has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 dark:border-gray-700 dark:has-[:checked]:bg-blue-900/20 dark:has-[:checked]:border-blue-700';
                                
                                const links = App.dataMaps.peTo3dMap.get(pe.id) || { componentCodes: new Set(), secondaryComponentCodes: new Set() };
                                let linksHTML = '<dl class="mt-2 text-xs text-gray-500 dark:text-gray-400 space-y-1">';
                                ['SEP', 'DCI', 'CCC'].forEach(dim => {
                                    const codes = [...links.componentCodes, ...links.secondaryComponentCodes].filter(code => {
                                        const parentInfo = App.dataMaps.parentToChildrenMap.get(code);
                                        return parentInfo && parentInfo.dimension.startsWith(dim);
                                    });
                                    if (codes.length > 0) {
                                        linksHTML += `<div><dt class="font-semibold inline">${dim}: </dt><dd class="inline">${codes.join(', ')}</dd></div>`;
                                    }
                                });
                                linksHTML += '</dl>';
                                
                                d.innerHTML=`
                                    <label class="block">
                                        <div class="flex items-start">
                                            <input type="checkbox" value="${pe.id}" ${isChecked ? 'checked' : ''} class="h-4 w-4 mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                                            <div class="ml-3 text-sm flex-1">
                                                <span class="font-bold text-gray-900 dark:text-gray-100">${pe.id}</span>
                                                <p class="text-gray-600 dark:text-gray-400">${pe.description}</p>
                                            </div>
                                        </div>
                                        ${linksHTML}
                                        <div class="flex items-center mt-2 pl-7">
                                            <input type="checkbox" id="secondary-toggle-${pe.id}" class="secondary-pe-toggle h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500 cursor-pointer" ${isSecondaryChecked ? 'checked' : ''}>
                                            <label for="secondary-toggle-${pe.id}" class="ml-2 text-xs text-gray-600 dark:text-gray-400 cursor-pointer">Mark as a supporting PE</label>
                                        </div>
                                    </label>`;
                                list.appendChild(d);
                            });
                        });
                    }
                }); 
                this.openModal('pe-modal-backdrop');
            },
            savePeAssignments() { 
                const p = App.utils.findPlanner(App.state.currentPlannerId); if (!p) return;
                App.history.saveState();
                p.assignedPes = Array.from(document.querySelectorAll('#pe-modal-list input[type="checkbox"][value]:checked')).map(i => {
                    const container = i.closest('.pe-modal-item');
                    const isSecondary = container.querySelector('.secondary-pe-toggle').checked;
                    return { id: i.value, isSecondary: isSecondary };
                });
                App.persistence.saveProgramData(); App.render.plannerView(p.id); this.closeAllModals(); 
            },
            openElementDetailModal(code) {
                let title, description, progressionHTML = '', linkedPEsHTML = '';
                const planner = this.findPlanner(App.state.currentPlannerId);

                if (App.dataMaps.peMap.has(code)) {
                    const pe = App.dataMaps.peMap.get(code);
                    title = `PE: ${pe.id}`;
                    description = pe.description;
                    const linked3D = App.dataMaps.peTo3dMap.get(code);
                    if (linked3D && linked3D.specificCodes.size > 0) {
                        progressionHTML = '<h4 class="font-bold mt-4">Linked 3D Elements:</h4><ul class="list-disc pl-5 space-y-1">';
                        linked3D.specificCodes.forEach(specCode => {
                            const element = App.dataMaps.ngss3dMap.get(specCode);
                            if (element) {
                                progressionHTML += `<li><strong>${specCode}:</strong> ${element.text}</li>`;
                            }
                        });
                        progressionHTML += '</ul>';
                    }
                } else if (App.dataMaps.parentToChildrenMap.has(code)) {
                    const parentInfo = App.dataMaps.parentToChildrenMap.get(code);
                    title = parentInfo.name;
                    description = `This is a parent element for a set of specific performance expectations across grade bands.`;
                    
                    const bands = ['primary', 'elementary', 'middle', 'high'];
                    progressionHTML = '<h4 class="font-bold mt-4">Grade Band Progression:</h4><div class="space-y-3">';
                    bands.forEach(band => {
                        const elementsInBand = parentInfo.children.filter(c => c.allProgressions[band]?.length > 0);
                        if (elementsInBand.length > 0) {
                            progressionHTML += `
                                <div>
                                    <h5 class="font-semibold capitalize">${band.replace('primary', 'K-2').replace('elementary', '3-5').replace('middle', '6-8').replace('high', '9-12')}</h5>
                                    <ul class="list-disc pl-6 text-sm text-gray-700 dark:text-gray-300">
                                        ${elementsInBand.map(el => `<li><strong>${el.code}:</strong> ${el.text}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                    });
                    progressionHTML += '</div>';

                    if (planner && planner.assignedPes) {
                        const linkedPEs = new Set();
                        planner.assignedPes.forEach(peObj => {
                            const links = App.dataMaps.peTo3dMap.get(peObj.id);
                            if (links) {
                                links.specificCodes.forEach(specificCode => {
                                    const element = App.dataMaps.ngss3dMap.get(specificCode);
                                    if (element && element.parentCode === code) {
                                        linkedPEs.add(peObj.id);
                                    }
                                });
                            }
                        });

                        if (linkedPEs.size > 0) {
                            linkedPEsHTML = `<h4 class="font-bold mt-4">Linked PEs in this planner:</h4><div class="flex flex-wrap gap-2">${Array.from(linkedPEs).map(pe => `<span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full dark:bg-blue-900 dark:text-blue-300">${pe}</span>`).join('')}</div>`;
                        }
                    }
                } else {
                    return; 
                }

                document.getElementById('element-modal-title').textContent = title;
                document.getElementById('element-modal-description').innerHTML = description;
                document.getElementById('element-progression').innerHTML = progressionHTML;
                document.getElementById('element-linked-pes').innerHTML = linkedPEsHTML;
                this.openModal('element-detail-modal-backdrop');
            },

            openLessonDetailsModal(rowId) {
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                
                const modal = document.getElementById('lesson-details-modal-backdrop');
                modal.dataset.currentRowId = rowId;

                document.getElementById('lesson-details-modal-title').textContent = `Details for: ${rowData.title}`;
                document.getElementById('lesson-notes-input').value = rowData.details?.notes || '';
                this.renderLinksInModal(rowData.details?.links || []);
                this.openModal('lesson-details-modal-backdrop');
            },

            renderLinksInModal(links) {
                const container = document.getElementById('lesson-links-container');
                container.innerHTML = links.map((link, index) => `
                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-700 p-2 rounded">
                        <a href="${link}" target="_blank" class="flex-grow text-blue-600 dark:text-blue-400 truncate">${link}</a>
                        <button class="remove-link-btn text-red-500 font-bold" data-index="${index}">✖</button>
                    </div>
                `).join('');
            },

            addLinkToDetailsModal() {
                const input = document.getElementById('new-link-input');
                let url = input.value.trim();
                if (!url) return;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                if (!rowData.details) rowData.details = { notes: '', links: [] };
                if (!rowData.details.links) rowData.details.links = [];
                rowData.details.links.push(url);
                this.renderLinksInModal(rowData.details.links);
                input.value = '';
            },

            removeLinkFromDetailsModal(button) {
                 const index = parseInt(button.dataset.index, 10);
                 const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                const rowData = this.findRowData(planner, rowId);
                rowData.details.links.splice(index, 1);
                this.renderLinksInModal(rowData.details.links);
            },
            
            saveLessonDetails() {
                const modal = document.getElementById('lesson-details-modal-backdrop');
                const rowId = modal.dataset.currentRowId;
                const planner = this.findPlanner(App.state.currentPlannerId);
                App.history.saveState();

                const rowData = this.findRowData(planner, rowId);
                if (!rowData) return;
                
                if (!rowData.details) rowData.details = { notes: '', links: [] };
                rowData.details.notes = document.getElementById('lesson-notes-input').value;
                
                App.persistence.debouncedSave();
                this.closeAllModals();
            },

            clonePlannerWithNewIds(planner) {
                const newPlanner = JSON.parse(JSON.stringify(planner));
                newPlanner.id = `planner-${Date.now()}`;
                const processRows = (rows) => {
                    if (!rows) return;
                    rows.forEach(row => {
                        row.id = `row-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                        if (row.children) {
                            processRows(row.children);
                        }
                    });
                };
                processRows(newPlanner.rows);
                return newPlanner;
            },

            loadExamplePlanner(index) {
                const originalPlanner = App.examples.planners[index];
                if (!originalPlanner) return;

                const newPlanner = this.clonePlannerWithNewIds(originalPlanner);
                App.state.programData.planners.push(newPlanner);
                App.persistence.saveProgramData();
                App.render.navigator();
                App.render.plannerView(newPlanner.id);
                const navItem = App.dom.navigatorList.querySelector(`[data-planner-id="${newPlanner.id}"]`);
                if(navItem) navItem.querySelector('.planner-checkbox').checked = true;
            }
        };

        App.export = {
            showExportOptions() {
                const optionsContainer = document.getElementById('export-master-options-list');
                optionsContainer.innerHTML = `
                    <label class="block p-4 border rounded-lg has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/20 has-[:checked]:border-blue-500 cursor-pointer">
                        <input type="checkbox" name="export-option" value="xlsx-dim" class="mr-2 accent-purple-600" checked>
                        <strong>XLSX (by Dimension)</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Creates a sheet for each dimension (PEs, DCIs, etc.).</small>
                    </label>
                     <label class="block p-4 border rounded-lg has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/20 has-[:checked]:border-blue-500 cursor-pointer">
                        <input type="checkbox" name="export-option" value="xlsx-combined" class="mr-2 accent-purple-600">
                        <strong>XLSX (Combined View)</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Creates a single sheet with combined 3D elements.</small>
                    </label>
                    <label class="block p-4 border rounded-lg has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/20 has-[:checked]:border-blue-500 cursor-pointer">
                        <input type="checkbox" name="export-option" value="progression" class="mr-2 accent-purple-600">
                        <strong>Progression View (XLSX)</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Exports the Progression by Element view.</small>
                    </label>
                    <label class="block p-4 border rounded-lg has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900/20 has-[:checked]:border-blue-500 cursor-pointer">
                        <input type="checkbox" name="export-option" value="storyline" class="mr-2 accent-purple-600">
                        <strong>Storyline View (XLSX)</strong>
                        <small class="block text-gray-500 dark:text-gray-400">Exports the Progression by Lesson view.</small>
                    </label>
                `;
                
                App.utils.openModal('export-master-modal-backdrop');
            },
            
            handleMasterExport() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) return;

                const selectedOptions = Array.from(document.querySelectorAll('#export-master-options-list input:checked')).map(cb => cb.value);
                if (selectedOptions.length === 0) {
                    alert('Please select at least one item to export.');
                    return;
                }

                const workbook = XLSX.utils.book_new();
                
                if (selectedOptions.includes('xlsx-dim')) {
                    this.addDimensionSheetsToWorkbook(workbook, planner);
                }
                if (selectedOptions.includes('xlsx-combined')) {
                    const worksheet = this.createCombinedSheet(planner);
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Combined View');
                }
                if (selectedOptions.includes('progression')) {
                    this.addProgressionSheetToWorkbook(workbook, 'element');
                }
                if (selectedOptions.includes('storyline')) {
                    this.addProgressionSheetToWorkbook(workbook, 'lesson');
                }

                if(workbook.SheetNames.length > 0) {
                    XLSX.writeFile(workbook, `${planner.title}_Export.xlsx`);
                }
                
                App.utils.closeAllModals();
            },

            downloadFile(filename, content, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            asJson() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) { alert('No active planner to export.'); return; }
                const jsonString = JSON.stringify(planner, null, 2);
                this.downloadFile(`${planner.title}.json`, jsonString, 'application/json');
            },

            asHtml() {
                const planner = App.utils.findPlanner(App.state.currentPlannerId);
                if (!planner) { alert('No active planner to export.'); return; }
                const tableContainer = document.getElementById('planner-table-container').cloneNode(true);
                tableContainer.querySelectorAll('[contenteditable]').forEach(el => el.setAttribute('contenteditable', 'false'));
                tableContainer.querySelectorAll('.drag-handle, .delete-btn, .add-below-btn, .copy-row-btn, .notes-btn').forEach(el => el.remove());

                const htmlContent = `
                    <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>${planner.title}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style>
                        body { overflow: auto; height: auto; display: block; font-family: sans-serif; }
                        table { table-layout: fixed; border-collapse: collapse; min-width: 100%; border-spacing: 0; }
                        th, td { border: 1px solid #e5e7eb; }
                        col.collapsed { width: 0 !important; min-width: 0 !important; }
                        th[data-tab-group], td[data-tab-group], col[data-tab-group] { display: none; }
                        
                        thead th { height: 160px; vertical-align: bottom; padding: 4px; }
                        .vertical-header-text { writing-mode: vertical-rl; transform: rotate(180deg); white-space: nowrap; text-align: left; max-height: 140px; width: 100%; display: flex; align-items: center; justify-content: flex-start; }

                        .sticky-col-1 { position: sticky; left: 0; z-index: 5; background-color: #f3f4f6; }
                        .sticky-col-2 { position: sticky; left: 65px; z-index: 4; background-color: #f3f4f6; }
                        .sticky-col-3 { position: sticky; left: 105px; z-index: 3; background-color: #f3f4f6; box-shadow: 4px 0 5px -2px rgba(0,0,0,0.1); }
                        
                        thead th.sticky-col-1, thead th.sticky-col-2, thead th.sticky-col-3 { height: auto; vertical-align: middle; z-index: 10; padding: 10px; }
                        .group-toggle-header { display: table-cell !important; }
                    <\/style>
                    </head><body class="bg-gray-50 p-8"><main>
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">${planner.title}</h1>
                        <p class="text-gray-600">${planner.course} (${planner.gradeBand})</p>
                    </div>
                    <div id="tab-container" class="mt-4 flex border-b-2 border-gray-300 -mb-px">${document.getElementById('tab-container').innerHTML}</div>
                    <div id="planner-table-container" class="overflow-auto border border-gray-300 rounded-b-lg rounded-tr-lg bg-white shadow-sm">${tableContainer.innerHTML}</div>
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const firstTab = document.querySelector('.tab-button');
                            if (firstTab) { activateTab(firstTab); }
                            document.getElementById('tab-container').addEventListener('click', e => {
                                const tabButton = e.target.closest('.tab-button');
                                if (tabButton) { activateTab(tabButton); }
                            });
                            function activateTab(tabButton) {
                                document.querySelectorAll('.tab-button').forEach(btn => {
                                    btn.classList.remove('bg-white', 'border-gray-300', 'border-b-white', 'text-blue-600');
                                    btn.classList.add('bg-gray-100', 'text-gray-500');
                                });
                                tabButton.classList.remove('bg-gray-100', 'text-gray-500');
                                tabButton.classList.add('bg-white', 'border-gray-300', 'border-b-white', 'text-blue-600');
                                const tabKey = tabButton.dataset.tab;
                                document.querySelectorAll('th[data-tab-group], td[data-tab-group], col[data-tab-group]').forEach(cell => {
                                    cell.style.display = cell.dataset.tabGroup === tabKey ? '' : 'none';
                                });
                            }
                        });
                    <\/script>
                    </main></body></html>`;
                this.downloadFile(`${planner.title}.html`, htmlContent, 'text/html');
            },
            
            _generateCombinedSheetData(planner) {
                const headers = ['Lesson', 'Primary PE', 'Secondary PE', 'Primary DCI Element', 'DCI: I/D/A', 'DCI: Full or Partial?', 'SEP Element', 'SEP: I/D/A', 'SEP: Full or Partial?', 'CCC Element', 'CCC: I/D/A', 'CCC: Full or Partial?', 'NOS Connection', 'ETAS Connection'];
                const sheetData = [headers];
                const merges = [];
                const rowInfo = {};

                const statusMap = { I: 'Introduced', D: 'Developed', A: 'Assessed' };
                const assignedPeMap = new Map((planner.assignedPes || []).map(p => [p.id, p]));

                const processRow = (plannerRow) => {
                    if (plannerRow.type === 'lesson-set') {
                        const rowIndex = sheetData.length;
                        sheetData.push([plannerRow.title]);
                        rowInfo[rowIndex] = { type: 'unit' };
                        merges.push({ s: { r: rowIndex, c: 0 }, e: { r: rowIndex, c: headers.length - 1 } });
                        (plannerRow.children || []).forEach(child => processRow(child));
                    } else if (plannerRow.type === 'lesson') {
                        const lessonTitleRowIndex = sheetData.length;
                        sheetData.push([plannerRow.title]);
                        rowInfo[lessonTitleRowIndex] = { type: 'lessonTitle' };
                        merges.push({ s: { r: lessonTitleRowIndex, c: 0 }, e: { r: lessonTitleRowIndex, c: headers.length - 1 } });

                        const nonAssessed = { primaryPEs: [], secondaryPEs: [], dcis: [], seps: [], cccs: [] };
                        const assessed = { primaryPEs: [], secondaryPEs: [], dcis: [], seps: [], cccs: [] };

                        Object.entries(plannerRow.trackingData || {}).forEach(([code, status]) => {
                            const element = { code, status };
                            const targetGroup = (status === 'A') ? assessed : nonAssessed;

                            if (assignedPeMap.has(code)) {
                                if (assignedPeMap.get(code).isSecondary) targetGroup.secondaryPEs.push(element);
                                else targetGroup.primaryPEs.push(element);
                            } else {
                                const elData = App.dataMaps.ngss3dMap.get(code);
                                if (elData?.dimension.startsWith('DCI')) targetGroup.dcis.push(element);
                                else if (elData?.dimension.startsWith('SEP')) targetGroup.seps.push(element);
                                else if (elData?.dimension.startsWith('CCC')) targetGroup.cccs.push(element);
                            }
                        });

                        const nonAssessedRow = new Array(headers.length).fill([]);
                        nonAssessedRow[0] = 'Non-Assessed Elements';
                        nonAssessedRow[1] = nonAssessed.primaryPEs.map(e => e.code);
                        nonAssessedRow[2] = nonAssessed.secondaryPEs.map(e => e.code);
                        nonAssessedRow[3] = nonAssessed.dcis.map(e => e.code);
                        nonAssessedRow[4] = nonAssessed.dcis.map(e => statusMap[e.status]);
                        nonAssessedRow[6] = nonAssessed.seps.map(e => e.code);
                        nonAssessedRow[7] = nonAssessed.seps.map(e => statusMap[e.status]);
                        nonAssessedRow[9] = nonAssessed.cccs.map(e => e.code);
                        nonAssessedRow[10] = nonAssessed.cccs.map(e => statusMap[e.status]);
                        sheetData.push(nonAssessedRow);
                        rowInfo[sheetData.length - 1] = { type: 'dataRow' };

                        const assessedRow = new Array(headers.length).fill([]);
                        assessedRow[0] = 'Formative Assessment';
                        assessedRow[1] = assessed.primaryPEs.map(e => e.code);
                        assessedRow[2] = assessed.secondaryPEs.map(e => e.code);
                        assessedRow[3] = assessed.dcis.map(e => e.code);
                        assessedRow[4] = assessed.dcis.map(e => statusMap[e.status]);
                        assessedRow[6] = assessed.seps.map(e => e.code);
                        assessedRow[7] = assessed.seps.map(e => statusMap[e.status]);
                        assessedRow[9] = assessed.cccs.map(e => e.code);
                        assessedRow[10] = assessed.cccs.map(e => statusMap[e.status]);
                        sheetData.push(assessedRow);
                        rowInfo[sheetData.length - 1] = { type: 'dataRow' };
                    }
                };
                
                (planner.rows || []).forEach(row => processRow(row));
                return { sheetData, merges, rowInfo };
            },

            createCombinedSheet(planner) {
                let { sheetData, merges, rowInfo } = this._generateCombinedSheetData(planner);

                sheetData = sheetData.map(row => row.map(cell => {
                    if (Array.isArray(cell)) {
                        return cell.join('\n');
                    }
                    return cell;
                }));

                const thinBorder = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FF4B5563" } }, border: thinBorder, alignment: { horizontal: "center", vertical: "center", wrapText: true } };
                const unitStyle = { font: { bold: true, sz: 14, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FF4338CA" } }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const lessonTitleStyle = { font: { bold: true }, fill: { fgColor: { rgb: "FFDBEAFE" } }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const subTitleStyle = { font: { italic: true }, border: thinBorder, alignment: { indent: 1, vertical: "top" } };
                const dataCellStyle = { border: thinBorder, alignment: { vertical: "top", wrapText: true } };

                const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                worksheet['!merges'] = merges;
                worksheet['!cols'] = sheetData[0].map(h => ({ wch: h.toLowerCase().includes('element') ? 20 : 18 }));
                worksheet['!cols'][0].wch = 35;

                Object.keys(worksheet).forEach(cellAddress => {
                    if (cellAddress.startsWith('!')) return;
                    const cell = worksheet[cellAddress];
                    const { r, c } = XLSX.utils.decode_cell(cellAddress);
                    
                    if (r === 0) {
                        cell.s = headerStyle;
                        return;
                    }
                    
                    const styleInfo = rowInfo[r];
                    if (styleInfo) {
                        if (styleInfo.type === 'unit') {
                            cell.s = unitStyle;
                        } else if (styleInfo.type === 'lessonTitle') {
                            cell.s = lessonTitleStyle;
                        } else if (styleInfo.type === 'dataRow') {
                            cell.s = (c === 0) ? subTitleStyle : dataCellStyle;
                        }
                    }
                });
                
                return worksheet;
            },

            addDimensionSheetsToWorkbook(workbook, planner) {
                const columnGroups = App.utils.gatherColumns(planner.gradeBand);
                const thinBorder = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                const headerStyle = { font: { bold: true }, fill: { fgColor: { rgb: "FFD9E1F2" } }, border: thinBorder, alignment: { horizontal: "center", wrapText: true, vertical: "center", textRotation: 90 } };
                const secondaryHeaderStyle = { font: { bold: true, italic: true }, fill: { fgColor: { rgb: "FFD9E1F2" } }, border: thinBorder, alignment: { horizontal: "center", wrapText: true, vertical: "center", textRotation: 90 } };
                const lessonSetStyle = { font: { bold: true, sz: 14 }, fill: { fgColor: { rgb: "FFB4C6E7" } }, border: thinBorder };
                const baseCellStyle = { border: thinBorder, alignment: { wrapText: true, vertical: "top" } };
                const indentedCellStyle = { ...baseCellStyle, alignment: { ...baseCellStyle.alignment, indent: 1 } };
                const statusStyles = {
                    I: { fill: { fgColor: { rgb: "FFFFFF00" } } },
                    D: { fill: { fgColor: { rgb: "FFC6E0B4" } } },
                    A: { fill: { fgColor: { rgb: "FFB4C6E7" } } },
                };

                Object.keys(columnGroups).forEach(key => {
                    let columns = [];
                    if (key === 'pe') {
                        columns = (planner.assignedPes || []).map(peObj => ({ code: peObj.id, title: peObj.id, isSecondary: peObj.isSecondary }));
                    } else {
                        columns = Object.values(columnGroups[key].groups).flatMap(g => g.cols.map(c => ({ code: c.code, title: c.title, isSecondary: false })));
                    }

                    if (columns.length === 0) return;

                    const sheetData = [];
                    const headerRow = ['Instructional Sequence', ...columns.map(c => c.title)];
                    sheetData.push(headerRow);

                    const lessonSetRowIndexes = [];
                    const indentedLessonRowIndexes = [];
                    const rowIndexToLesson = new Map();

                    (planner.rows || []).forEach(row => {
                        const processLessonRow = (lesson, isChild) => {
                            const lessonDataRow = [lesson.title];
                            columns.forEach(col => {
                                let cellValue = '';
                                if (key === 'pe') {
                                    cellValue = lesson.trackingData?.[col.code] || '';
                                } else {
                                    const parentInfo = App.dataMaps.parentToChildrenMap.get(col.code);
                                    if (parentInfo) {
                                        cellValue = parentInfo.children
                                            .filter(child => lesson.trackingData?.[child.code])
                                            .map(child => `${child.code} (${lesson.trackingData[child.code]})`)
                                            .join('\n');
                                    }
                                }
                                lessonDataRow.push(cellValue);
                            });
                            sheetData.push(lessonDataRow);
                            if (isChild) indentedLessonRowIndexes.push(sheetData.length - 1);
                            rowIndexToLesson.set(sheetData.length - 1, lesson);
                        };

                        if (row.type === 'lesson-set') {
                            sheetData.push([row.title, ...Array(columns.length).fill('')]);
                            lessonSetRowIndexes.push(sheetData.length - 1);
                            (row.children || []).forEach(child => processLessonRow(child, true));
                        } else if (row.type === 'lesson') {
                            processLessonRow(row, false);
                        }
                    });

                    if (sheetData.length > 1) {
                        const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                        worksheet['!cols'] = [{ wch: 45 }, ...columns.map(() => ({ wch: 15 }))];
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                        
                        for (let R = range.s.r; R <= range.e.r; ++R) {
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                                if (!worksheet[cellAddress]) continue;

                                if (R === 0) {
                                    worksheet[cellAddress].s = (columns[C - 1]?.isSecondary) ? secondaryHeaderStyle : headerStyle;
                                } else if (lessonSetRowIndexes.includes(R)) {
                                    worksheet[cellAddress].s = lessonSetStyle;
                                } else {
                                    let style = (C === 0 && indentedLessonRowIndexes.includes(R)) ? indentedCellStyle : baseCellStyle;
                                    const lesson = rowIndexToLesson.get(R);
                                    if (lesson && C > 0) {
                                        let dominantStatus = '';
                                        if (key === 'pe') {
                                            dominantStatus = worksheet[cellAddress].v;
                                        } else {
                                            const statuses = (worksheet[cellAddress].v || '').split('\n').map(s => s.match(/\((.)\)/)?.[1]).filter(Boolean);
                                            if (statuses.includes('A')) dominantStatus = 'A';
                                            else if (statuses.includes('D')) dominantStatus = 'D';
                                            else if (statuses.includes('I')) dominantStatus = 'I';
                                        }
                                        if (statusStyles[dominantStatus]) {
                                            style = { ...style, ...statusStyles[dominantStatus], alignment: { ...style.alignment, horizontal: "center" } };
                                        }
                                    }
                                    worksheet[cellAddress].s = style;
                                }
                            }
                        }
                        worksheet['!merges'] = lessonSetRowIndexes.map(r => ({ s: { r, c: 0 }, e: { r, c: columns.length } }));
                        XLSX.utils.book_append_sheet(workbook, worksheet, columnGroups[key].name);
                    }
                });
            },

            exportProgressionView() {
                const workbook = XLSX.utils.book_new();
                this.addProgressionSheetToWorkbook(workbook, App.state.progressionViewType);
                if (workbook.SheetNames.length > 0) {
                    XLSX.writeFile(workbook, 'NGSS_Progression_Export.xlsx');
                } else {
                    alert('No progression data to export. Please select planners from the navigator.');
                }
            },

            addProgressionSheetToWorkbook(workbook, viewType) {
                const selectedPlannerIds = Array.from(App.dom.navigatorList.querySelectorAll('.planner-checkbox:checked')).map(cb => cb.closest('.planner-item').dataset.plannerId);
                if (selectedPlannerIds.length === 0) return;
                const selectedPlanners = selectedPlannerIds.map(id => App.utils.findPlanner(id));

                if (viewType === 'element') {
                    this._addProgressionByElementSheet(workbook, selectedPlanners);
                } else {
                    this._addProgressionByLessonSheet(workbook, selectedPlanners);
                }
            },

            _addProgressionByElementSheet(workbook, selectedPlanners) {
                const sheetData = [];
                const merges = [];
                const thinBorder = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FF4B5563" } }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const groupHeaderStyle = { font: { bold: true, sz: 14 }, fill: { fgColor: { rgb: "FFD9E1F2" } }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const elementCodeStyle = { font: { bold: true }, border: thinBorder, alignment: { vertical: "top", wrapText: true } };
                const defaultStyle = { border: thinBorder, alignment: { vertical: "top", wrapText: true } };

                const allTrackedElements = new Map();
                const allUnique3DElements = new Map();

                selectedPlanners.forEach(planner => {
                    (planner.rows || []).forEach(row => {
                        const processLesson = (lesson, lessonSetTitle = null) => {
                            if (!lesson.trackingData) return;
                            Object.entries(lesson.trackingData).forEach(([code, status]) => {
                                const elementData = App.dataMaps.ngss3dMap.get(code) || App.dataMaps.peMap.get(code);
                                if (elementData) {
                                    if (!allTrackedElements.has(code)) {
                                        allTrackedElements.set(code, []);
                                        allUnique3DElements.set(code, elementData);
                                    }
                                    allTrackedElements.get(code).push({ plannerId: planner.id, lessonTitle: lesson.title, lessonSetTitle: lessonSetTitle, status: status });
                                }
                            });
                        };
                        if (row.type === 'lesson') processLesson(row);
                        else if (row.type === 'lesson-set' && row.children) row.children.forEach(lesson => processLesson(lesson, row.title));
                    });
                });
                
                const header = ['Element', ...selectedPlanners.map(p => p.title)];
                sheetData.push(header);

                const groupedElements = { PE: [], DCI: [], SEP: [], CCC: [] };
                const groupNames = { PE: "Performance Expectations", DCI: "Disciplinary Core Ideas", SEP: "Science and Engineering Practices", CCC: "Crosscutting Concepts & Connections" };
                allUnique3DElements.forEach((elementData, code) => {
                    const dim = elementData.dimension || '';
                    if (App.dataMaps.peMap.has(code)) groupedElements.PE.push([code, elementData]);
                    else if (dim.startsWith('DCI')) groupedElements.DCI.push([code, elementData]);
                    else if (dim.startsWith('SEP')) groupedElements.SEP.push([code, elementData]);
                    else groupedElements.CCC.push([code, elementData]);
                });
                for (const key in groupedElements) { groupedElements[key].sort((a, b) => a[0].localeCompare(b[0])); }

                Object.entries(groupedElements).forEach(([groupKey, elements]) => {
                    if (elements.length > 0) {
                        const groupHeaderRow = [groupNames[groupKey]];
                        merges.push({ s: { r: sheetData.length, c: 0 }, e: { r: sheetData.length, c: header.length - 1 } });
                        sheetData.push(groupHeaderRow);

                        elements.forEach(([code, elementData]) => {
                            const row = [
                                `${code}\n${elementData.text || elementData.description || ''}`
                            ];
                            selectedPlanners.forEach(planner => {
                                const entries = (allTrackedElements.get(code) || []).filter(e => e.plannerId === planner.id);
                                const cellContent = entries.map(e => `${e.status}: ${e.lessonSetTitle ? `${e.lessonSetTitle} → ` : ''}${e.lessonTitle}`).join('\n');
                                row.push(cellContent);
                            });
                            sheetData.push(row);
                        });
                    }
                });

                const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                worksheet['!merges'] = merges;
                worksheet['!cols'] = [{ wch: 60 }, ...selectedPlanners.map(() => ({ wch: 40 }))];
                
                Object.keys(worksheet).forEach(cellAddress => {
                    if (cellAddress.startsWith('!')) return;
                    const cell = worksheet[cellAddress];
                    const { r, c } = XLSX.utils.decode_cell(cellAddress);
                    if (r === 0) cell.s = headerStyle;
                    else if (merges.some(m => m.s.r === r)) cell.s = groupHeaderStyle;
                    else if (c === 0) cell.s = elementCodeStyle;
                    else cell.s = defaultStyle;
                });

                XLSX.utils.book_append_sheet(workbook, worksheet, 'Progression by Element');
            },

            _addProgressionByLessonSheet(workbook, selectedPlanners) {
                const sheetData = [];
                const merges = [];
                const thinBorder = { top: { style: "thin" }, bottom: { style: "thin" }, left: { style: "thin" }, right: { style: "thin" } };
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFFFF" } }, fill: { fgColor: { rgb: "FF4B5563" } }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const plannerStyle = { font: { bold: true, sz: 12 }, border: thinBorder, alignment: { vertical: "center", horizontal: "center" } };
                const defaultStyle = { border: thinBorder, alignment: { vertical: "top", wrapText: true } };

                const header = ['Planner', 'Lesson Set', 'Lesson', 'PEs', 'DCIs', 'SEPs', 'CCCs'];
                sheetData.push(header);

                selectedPlanners.forEach(planner => {
                    const plannerStartRow = sheetData.length;
                    (planner.rows || []).forEach(row => {
                        const processLesson = (lesson, lessonSetTitle = '') => {
                            const groupedCodes = { PE: [], DCI: [], SEP: [], CCC: [] };
                            Object.keys(lesson.trackingData || {}).forEach(code => {
                                if (App.dataMaps.peMap.has(code)) groupedCodes.PE.push(code);
                                else {
                                    const elData = App.dataMaps.ngss3dMap.get(code);
                                    if (elData) {
                                        if (elData.dimension.startsWith('DCI')) groupedCodes.DCI.push(code);
                                        else if (elData.dimension.startsWith('SEP')) groupedCodes.SEP.push(code);
                                        else groupedCodes.CCC.push(code);
                                    }
                                }
                            });
                            sheetData.push([
                                planner.title, lessonSetTitle, lesson.title,
                                groupedCodes.PE.join('\n'), groupedCodes.DCI.join('\n'),
                                groupedCodes.SEP.join('\n'), groupedCodes.CCC.join('\n')
                            ]);
                        };
                        if (row.type === 'lesson-set') {
                            (row.children || []).forEach(lesson => processLesson(lesson, row.title));
                        } else if (row.type === 'lesson') {
                            processLesson(row);
                        }
                    });
                    const plannerEndRow = sheetData.length - 1;
                    if (plannerStartRow <= plannerEndRow) {
                        merges.push({ s: { r: plannerStartRow, c: 0 }, e: { r: plannerEndRow, c: 0 } });
                    }
                });

                const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
                worksheet['!merges'] = merges;
                worksheet['!cols'] = [{ wch: 30 }, { wch: 30 }, { wch: 40 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];

                Object.keys(worksheet).forEach(cellAddress => {
                    if (cellAddress.startsWith('!')) return;
                    const cell = worksheet[cellAddress];
                    const { r, c } = XLSX.utils.decode_cell(cellAddress);
                    if (r === 0) cell.s = headerStyle;
                    else if (c === 0) cell.s = plannerStyle;
                    else cell.s = defaultStyle;
                });

                XLSX.utils.book_append_sheet(workbook, worksheet, 'Progression by Lesson');
				},

            exportSummaryView() {
                const summaryContainer = document.getElementById('summary-content');
                if (!summaryContainer.hasChildNodes()) {
                    alert("No summary to export. Please select a planner first.");
                    return;
                }

                const title = document.querySelector('#summary-view h1').textContent;
                const subtitle = document.getElementById('summary-subtitle').textContent;

                const statusChartImg = App.state.activeCharts.status ? App.state.activeCharts.status.toBase64Image() : '';
                const dimensionChartImg = App.state.activeCharts.dimension ? App.state.activeCharts.dimension.toBase64Image() : '';
                const scopeChartImg = App.state.activeCharts.scope ? App.state.activeCharts.scope.toBase64Image() : '';

                const reportContent = document.getElementById('element-coverage-report').outerHTML;
                const filterContent = document.getElementById('filter-container').innerHTML;

                const htmlContent = `
                    <!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Summary - ${title}</title>
                    <script src="https://cdn.tailwindcss.com"><\/script>
                    <style> @media print { body { -webkit-print-color-adjust: exact; } button, input { display: none !important; } } </style>
                    </head><body class="bg-gray-100 p-8 font-sans">
                    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow">
                        <div class="mb-6 border-b pb-4">
                            <h1 class="text-3xl font-bold text-gray-800">${title}</h1>
                            <p class="text-gray-600">${subtitle}</p>
                        </div>
                        <div class="my-4">${filterContent}</div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <div class="p-4 border rounded-lg"><h3 class="font-bold mb-2 text-gray-700">3D Element Status Distribution</h3><img src="${statusChartImg}" alt="Status Chart" class="w-full"></div>
                            <div class="p-4 border rounded-lg"><h3 class="font-bold mb-2 text-gray-700">Dimension Usage Balance</h3><img src="${dimensionChartImg}" alt="Dimension Chart" class="w-full"></div>
                            <div class="p-4 border rounded-lg"><h3 class="font-bold mb-2 text-gray-700">Assessment Scope</h3><img src="${scopeChartImg}" alt="Scope Chart" class="w-full"></div>
                        </div>
                        ${reportContent}
                    </div>
                    </body></html>
                `;
                this.downloadFile(`${title.replace(/\s/g, '_')}_Summary.html`, htmlContent, 'text/html');
            }
        };
		 
        async function loadDataAndInit() {
            try {
                await App.db.init();
                const cachedMaps = await App.db.get('processed_maps');

                if (cachedMaps) {
                    console.log("Loading processed data maps from cache.");
                    App.dataMaps.peMap = new Map(cachedMaps.peMap);
                    App.dataMaps.ngss3dMap = new Map(cachedMaps.ngss3dMap);
                    App.dataMaps.peTo3dMap = new Map(cachedMaps.peTo3dMap.map(([key, value]) => [key, { componentCodes: new Set(value.componentCodes), secondaryComponentCodes: new Set(value.secondaryComponentCodes), specificCodes: new Set(value.specificCodes) }]));
                    App.dataMaps.parentToChildrenMap = new Map(cachedMaps.parentToChildrenMap);
                    App.dataMaps.major3DMap = new Map(cachedMaps.major3DMap);
                    App.dataMaps.nameToCodeMap = new Map(cachedMaps.nameToCodeMap);
                    App.dataMaps.textToSpecificCodeMap = new Map(cachedMaps.textToSpecificCodeMap);
                    App.state.allNgssData = await App.db.get('raw_ngss_data');
                    if (!App.state.allNgssData) throw new Error("Raw data missing from cache.");
                } else {
                    console.log("Data not found in cache. Fetching from server and processing...");
                    const dataPath = 'https://philm013.github.io/JSON/';
                    const [ngss3d, k5, m68, h912] = await Promise.all([
                        fetch(`${dataPath}ngss3DElements.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss3DElements.json`); return res.json(); }),
                        fetch(`${dataPath}ngssK5.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngssK5.json`); return res.json(); }),
                        fetch(`${dataPath}ngss68.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss68.json`); return res.json(); }),
                        fetch(`${dataPath}ngss912.json`).then(res => { if (!res.ok) throw new Error(`Fetch failed for ngss912.json`); return res.json(); })
                    ]);
                    
                    App.state.allNgss3dElements = ngss3d;
                    const msData = { gradeId: 'MS', gradeLabel: 'Middle School', topics: m68 };
                    const hsData = { gradeId: 'HS', gradeLabel: 'High School', topics: h912 };
                    App.state.allNgssData = [...k5, msData, hsData];
                    
                    App.buildDataMaps();
                    
                    const serializableMaps = {
                        peMap: [...App.dataMaps.peMap],
                        ngss3dMap: [...App.dataMaps.ngss3dMap],
                        peTo3dMap: [...App.dataMaps.peTo3dMap].map(([key, value]) => [key, { componentCodes: [...value.componentCodes], secondaryComponentCodes: [...value.secondaryComponentCodes], specificCodes: [...value.specificCodes] }]),
                        parentToChildrenMap: [...App.dataMaps.parentToChildrenMap],
                        major3DMap: [...App.dataMaps.major3DMap],
                        nameToCodeMap: [...App.dataMaps.nameToCodeMap],
                        textToSpecificCodeMap: [...App.dataMaps.textToSpecificCodeMap],
                    };
                    await App.db.set('processed_maps', serializableMaps);
                    await App.db.set('raw_ngss_data', App.state.allNgssData);
                    console.log("Data processed and cached.");
                }

                App.init();

            } catch (error) {
                console.error("Failed to load NGSS data:", error);
                document.getElementById('loading-indicator').textContent = 'Error loading data. Please check the console and refresh. Make sure you are running this from a web server and the ../JSON/ folder is accessible.';
            }
        }
        
        loadDataAndInit();
    });
    </script>
</body>
</html>
