
        :root {
            --bg: #111827; --grid: #1f2937; --text: #f3f4f6; --accent: #6366f1; 
            --panel: #1f2937; --panel-border: #374151;
            --shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            --font-ui: 'Nunito', sans-serif; --font-hand: 'Patrick Hand', cursive;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        input, textarea { user-select: text; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: var(--font-ui); color: var(--text); height: 100vh; touch-action: none; }

        /* --- LAYOUT --- */
        #app { display: none; width: 100vw; height: 100vh; }

        /* SIDEBAR */
        #sidebar { 
            width: 320px; background: var(--panel); border-right: 1px solid var(--panel-border); 
            z-index: 2000; display: flex; flex-direction: column; transition: 0.3s; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.3); position: absolute; height: 100%; top:0; left:0;
        }
        #sidebar.closed { transform: translateX(-100%); }
        
        #sidebar .in-txt {
            background: #374151;
            border: 1px solid #4b5563;
            color: var(--text);
            padding: 10px;
            border-radius: 8px;
            font-size: 1rem;
        }
        #sidebar .in-txt:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        /* VIEWPORT */
        #viewport { flex: 1; position: relative; overflow: hidden; background: var(--bg); cursor: default; touch-action: none; width: 100vw; height: 100vh; }
        #viewport.panning { cursor: grab; }
        #viewport.panning:active { cursor: grabbing; }
        #viewport.drawing { cursor: crosshair; }

        #world { position: absolute; top:0; left:0; transform-origin: 0 0; will-change: transform; }
        #bg-grid { position: absolute; inset:0; pointer-events: none; background-image: radial-gradient(#374151 2px, transparent 2px); background-size: 24px 24px; opacity: 0.5; }

        /* MINIMAP */
        #minimap-container {
            position: absolute; /* Will be adjusted by JS */
            z-index: 1500;
            padding: 8px;
            touch-action: none;
        }
        #minimap {
            width: 100%; height: 100%;
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid #4b5563;
            border-radius: 12px;
            cursor: crosshair;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            position: relative;
        }
        #minimap-drag-handle {
            position: absolute; left: -4px; top: -4px; right: -4px; bottom: -4px;
            cursor: grab;
        }
        #minimap-resize-handle {
            position: absolute;
            right: 0; bottom: 0;
            width: 20px; height: 20px;
            cursor: nwse-resize;
            z-index: 1501;
        }
        #minimap-resize-handle::after {
            content: '';
            position: absolute;
            right: 4px; bottom: 4px;
            width: 8px; height: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.5);
            border-right: 2px solid rgba(255,255,255,0.5);
        }


        /* LAYERS */
        svg { overflow: visible; }
        #ink-layer { position:absolute; inset:0; pointer-events:none; z-index: 1; }
        #items-layer { position:absolute; inset:0; z-index: 2; pointer-events: none; }
        #ghost-layer { position:absolute; inset:0; pointer-events:none; z-index: 3; }

        /* ITEMS - REACTIVE LAYOUT STYLES */
        .item { 
            position: absolute; 
            display: flex; flex-direction: column; 
            transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1), width 0.1s, height 0.1s;
            touch-action: none; pointer-events: auto; 
            will-change: transform, width, height;
        }
        .item.no-transition {
            transition: none !important;
        }

        /* DRAGGING STATE */
        .item.dragging { 
            /* transition is handled by no-transition class */
            z-index: 9999 !important; 
            opacity: 0.95; 
            filter: drop-shadow(0 15px 30px rgba(0,0,0,0.4));
            transform: scale(1.02) !important;
        }

        /* ZONE DROP TARGET */
        .item.zone { transition: background-color 0.2s, border-color 0.2s, width 0.1s, height 0.1s; }
        .item.zone.drag-over {
            box-shadow: 0 0 0 4px var(--accent), 0 0 40px rgba(99,102,241,0.2) !important;
            background: rgba(99,102,241,0.08) !important;
            border-color: var(--accent) !important;
        }

        /* GHOST SLOT & GUIDES */
        .ghost-slot {
            position: absolute;
            border: 2px dashed rgba(99,102,241,0.4);
            background: rgba(99,102,241,0.1);
            border-radius: 12px;
            pointer-events: none;
            z-index: 3;
            box-sizing: border-box;
        }
        .snap-guide {
            position: absolute;
            background: #ef4444;
            pointer-events: none;
            z-index: 9998;
        }
        .snap-guide.v { width: 1px; }
        .snap-guide.h { height: 1px; }

        .snap-anim { animation: snapPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes snapPop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .jiggle-wrapper { width:100%; height:100%; display:flex; flex-direction:column; background:white; border-radius:16px; box-shadow: var(--shadow); position:relative; overflow:hidden; color: #1e293b; border: 2px solid transparent; transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s; }
        .item.selected .jiggle-wrapper { box-shadow: 0 0 0 3px var(--accent), 0 20px 25px -5px rgba(0,0,0,0.5) !important; z-index: 50; border-color: var(--accent) !important; }
        .item.grouped .jiggle-wrapper {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.7), 0 10px 15px -3px rgba(0,0,0,0.5) !important;
            border-color: #3b82f6 !important;
        }
        .item.grouped.selected .jiggle-wrapper {
            box-shadow: 0 0 0 3px var(--accent), 0 0 0 6px #3b82f6, 0 20px 25px -5px rgba(0,0,0,0.5) !important;
        }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(-5deg) scale(1.05); } 75% { transform: rotate(5deg) scale(1.05); } 100% { transform: rotate(0deg); } }
        .item.jiggling .jiggle-wrapper { animation: shake 0.4s ease-in-out infinite; border-color: #ef4444; z-index: 500; }

        /* SEAMLESS CONSENSUS ITEMS */
        .item.consensus-child .jiggle-wrapper {
            background: transparent !important;
            box-shadow: none !important;
            border: 2px solid transparent;
            overflow: visible;
        }
        .item.consensus-child.selected .jiggle-wrapper {
            border: 2px dashed var(--accent) !important;
        }
        .item.consensus-child .i-head { display: none !important; }
        .item.consensus-child textarea { padding: 0; background: transparent; font-weight: bold; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        .item.consensus-child img { background: transparent; }

        /* HEADER ACTIONS */
        .i-head { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px 0 12px; font-size: 0.9rem; font-weight: 700; cursor: grab; flex-shrink: 0; z-index: 2; background: rgba(255,255,255,0.5); border-bottom: 1px solid rgba(0,0,0,0.1); user-select: none; -webkit-user-select: none; }
        .i-head:active { cursor: grabbing; }

        /* COMMENT BADGE */
        .cmt-badge {
            position: absolute; top: 6px; right: 40px;
            background: #ef4444; color: white;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 0.7rem; display: flex; align-items: center;
            justify-content: center; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 100;
            cursor: pointer; pointer-events: auto;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* HEADER BUTTONS */
        .btn-toggle { cursor: pointer; font-size: 0.75rem; padding: 4px 8px; border-radius: 10px; margin-left: 8px; border: 1px solid #e2e8f0; background: white; transition: 0.2s; }
        .btn-toggle.active { background: #dcfce7; color: #166534; border-color: #22c55e; }
        .btn-toggle.results-btn { background: #e0e7ff; color: #4338ca; border-color: #6366f1; display: none; }
        .btn-toggle.results-btn.active { display: inline-block; animation: popIn 0.3s; }

        /* GLOBAL CONTEXT MENU */
        #context-menu {
            position: absolute; display: none; flex-wrap: wrap; 
            background: #ffffff; border: 1px solid #cbd5e1; border-radius: 16px; 
            padding: 8px; gap: 6px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); 
            z-index: 3000; width: 260px; animation: popIn 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }

        @media (max-width: 768px) {
            #context-menu { 
                position: fixed !important; bottom: 20px !important; left: 50% !important; top: auto !important; 
                transform: translateX(-50%) !important; width: 90% !important; max-width: 400px; 
            }
        }

        .ctx-row { display: flex; gap: 5px; width: 100%; margin-bottom: 5px; }
        .ctx-row:last-child { margin-bottom: 0; }

        .ctx-btn { 
            flex: 1; height: 36px; border: 1px solid #e2e8f0; background: #f8fafc; 
            border-radius: 8px; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; font-size: 0.9rem; font-weight: 700; color: #475569; 
            padding: 0 8px; white-space: nowrap; 
        }
        .ctx-btn:hover { background: #e2e8f0; }
        .ctx-btn.btn-del { color: #ef4444; background: #fef2f2; border-color: #fca5a5; }

        /* MENU BUTTON */
        .menu-trigger { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 1.4rem; line-height: 1; color: #4b5563; }
        .menu-trigger:hover { background: rgba(0,0,0,0.1); }

        /* CONTENT */
        .item.note textarea { width: 100%; height: 100%; border: none; background: transparent; padding: 16px; font-family: var(--font-hand); font-size: 1.4rem; resize: none; line-height: 1.4; color: #1e293b; }
        .item.note img { width: 100%; flex: 1; object-fit: contain; background: transparent; pointer-events: none; min-height: 0; display: block; }
        .caption-in { width: 100%; height: 40px; border: none; border-top: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); padding: 8px; font-family: var(--font-ui); font-size: 0.9rem; resize: none; color: #1e293b; flex-shrink: 0; }

        .i-body { flex: 1; position: relative; min-height: 0; display: flex; flex-direction: column; }
        .zone-label { position:absolute; top:-25px; left:0; color: var(--accent); font-weight:800; letter-spacing:1px; font-size:0.9rem; white-space:nowrap; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; }
        .cer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 100%; width: 100%; pointer-events: none; }
        .cer-col { border-right: 2px dashed #cbd5e1; position: relative; display: flex; justify-content: center; padding-top: 10px; font-weight: 800; color: #94a3b8; letter-spacing: 1px; font-size: 0.8rem; }
        .consensus-bg { background-image: radial-gradient(#bae6fd 1px, transparent 1px); background-size: 20px 20px; background-color: #f0f9ff; }
        
        /* ZONE RESULTS WIDGET */
        .zone-res-box { display: none; background: #f8fafc; border-top: 1px solid #cbd5e1; max-height: 50%; overflow-y: auto; padding: 10px; font-size: 0.9rem; flex-shrink: 0; }
        .zone-res-box.active { display: block; }
        .result-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .bar-bg { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--accent); transition: width 0.5s; }

        .disc-item { padding: 8px; border-bottom: 1px solid #e2e8f0; margin-bottom: 8px; background: white; border-radius: 8px; }
        .disc-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; margin-right: 6px; }
        .dt-notice { background:#fef3c7; color:#d97706; }
        .dt-wonder { background:#bae6fd; color:#0284c7; }
        .dt-idea { background:#bbf7d0; color:#16a34a; }
        .dt-feedback { background:#fecaca; color:#dc2626; }

        /* HANDLES */
        .resize-h { position: absolute; bottom:-15px; right:-15px; width:40px; height:40px; cursor: nwse-resize; opacity: 0; background:transparent; z-index:20; }
        .item.selected .resize-h { opacity: 1; border: 2px solid var(--accent); border-radius: 50%; background: white; }

        /* --- DESKTOP TOOLBAR (>768px) --- */
        #desktop-toolbar {
            position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: #1e293b; padding: 8px 12px; border-radius: 20px;
            display: none; gap: 8px; z-index: 200; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
            align-items: center;
        }
        .tb-btn { height: 44px; min-width: 44px; padding: 0 16px; border: none; background: rgba(255,255,255,0.1); color: white; border-radius: 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; white-space: nowrap; }
        .tb-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .tb-btn.active { background: var(--accent); color: white; }
        .sep { width:1px; height: 24px; background:rgba(255,255,255,0.2); margin:0 4px; flex-shrink: 0; }

        /* --- MOBILE DOCK (<768px) --- */
        #mobile-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.95); backdrop-filter: blur(10px);
            border: 1px solid #374151; border-radius: 24px;
            display: flex; align-items: center; padding: 6px; gap: 6px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);
            z-index: 1000; width: auto; max-width: 95vw;
        }
        .dock-btn {
            width: 36px; height: 36px; border-radius: 16px; border: none;
            background: transparent; color: #9ca3af; font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s; position: relative; flex-shrink: 0;
        }
        .dock-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); transform: translateY(-4px); }
        .sep-mobile { width:1px; height:24px; background:#4b5563; margin:0 2px; }

        /* --- DRAWERS (Sub-menus) --- */
        .drawer {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--panel); border: 1px solid var(--panel-border);
            border-radius: 20px; padding: 12px; display: none; flex-wrap: wrap; gap: 8px;
            width: 320px; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            opacity: 0; transition: 0.2s; pointer-events: none; z-index: 999;
        }
        .drawer.open { display: flex; opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: auto; }

        .tool-row { display: flex; gap: 8px; width: 100%; justify-content: center; margin-bottom: 8px; }
        .color-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #374151; cursor: pointer; }
        .color-btn.active { border-color: white; transform: scale(1.2); }
        #host-id { user-select: text; }
        .sub-btn {
            padding: 10px 16px; background: #374151; color: white; border-radius: 12px;
            border: 1px solid #4b5563; font-size: 0.9rem; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .sub-btn:hover { background: #4b5563; }

        /* SVG ICON BUTTONS */
        .icon-btn {
            width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center;
            background: #374151; border: 1px solid #4b5563; border-radius: 8px; cursor: pointer;
            color: #e2e8f0; transition: 0.2s;
        }
        .icon-btn:hover { background: #4b5563; color: white; }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* COMMON UI */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 4000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px; font-weight: 600; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: fadeUp 0.3s ease-out; display:flex; align-items:center; gap:8px; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

        .modal-bg { position: fixed; inset:0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: white; padding: 24px; border-radius: 24px; width: 500px; max-width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); max-height: 85vh; overflow-y: auto; color: #1f2937; }
        .btn-p { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size:1rem; transition:0.2s; min-height: 48px; }
        .btn-s { width: 100%; padding: 14px; background: #f1f5f9; color: #334155; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size:1rem; margin-top:8px; min-height: 48px; }
        input.in-txt, select.in-txt { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; background: #fff; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 700; color: #64748b; margin-bottom: 6px; font-size: 0.9rem; }

        #marquee { position: absolute; border: 1px solid var(--accent); background: rgba(99,102,241,0.1); display: none; pointer-events: none; z-index: 100; }

        .tab-head { display: flex; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; min-height: 50px; border-radius: 12px 12px 0 0; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; font-weight: 700; font-size: 0.9rem; cursor: pointer; color: #64748b; }
        .tab-btn.active { background: white; color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 10px; flex-direction: column; }
        .tab-content.active { display: flex; }

        #landing { position: fixed; inset:0; background: #f1f5f9; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #1f2937; }
        .land-card { background: white; padding: 40px; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 500px; max-width: 90%; text-align: center; }
        .board-row { padding: 16px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-align: left; }

        /* RESPONSIVE SWITCHING */
        @media (min-width: 769px) {
            #mobile-dock { display: none !important; }
            #desktop-toolbar { display: flex !important; }
        }
        @media (max-width: 768px) {
            #desktop-toolbar { display: none !important; }
            #mobile-dock { display: flex !important; }
            #sidebar { position: fixed; width: 85%; max-width: 320px; }
        }
