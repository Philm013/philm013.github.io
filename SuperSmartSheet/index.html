<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smartsheet Pro</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-soft: #eef2ff;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --glass: rgba(255, 255, 255, 0.95);
            --row-mod: #fff7ed;
            --row-new: #f0fdf4;
            --row-del: #fef2f2;
            --row-bg-override: transparent;
        }

        /* LAYOUT ENGINE: Flexbox with fixed viewport height */
        body, html {
            height: 100%;
            width: 100%;
            background-color: var(--bg);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
            overflow: hidden; 
            overscroll-behavior: none;
        }

        .view-section { 
            display: none; 
            opacity: 0; 
            transition: opacity 0.2s ease; 
            height: 100dvh; 
            width: 100vw;
            overflow: hidden; 
            flex-direction: column; 
        }
        
        .view-section.active { 
            display: flex; 
            opacity: 1; 
        }

        #dashboardView { overflow-y: auto; }
        #editorView { overflow: hidden; }

        .hero-section { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 1rem .75rem 1.25rem; border-radius: 0 0 2.5rem 2.5rem; color: white; box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.3); margin-bottom: 0px; flex: 0 0 auto; }
        .sheet-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.25rem; position: relative; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .sheet-card:active { transform: scale(0.98); }
        .sheet-card:hover { border-color: var(--primary); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
        
        .glass-header { 
            background: var(--surface); 
            border-bottom: 1px solid var(--border); 
            padding: 0.75rem 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex: 0 0 auto;
            width: 100%;
        }
        
        .toolbar { 
            background: #f1f5f9; 
            border-bottom: 1px solid var(--border); 
            padding: 0.5rem 1rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: relative;
            z-index: 50;
            flex: 0 0 auto;
            width: 100%;
        }

        .search-container-desktop { display: block; }
        .search-trigger-mobile { display: none; }
        
        .mobile-search-bar { 
            display: none; 
            background: #f1f5f9; 
            border-bottom: 1px solid var(--border); 
            padding: 0 1rem; 
            overflow: hidden; 
            height: 0; 
            opacity: 0;
            transition: height 0.3s ease, opacity 0.2s ease, padding 0.3s ease;
            flex: 0 0 auto; 
            width: 100%;
        }
        .mobile-search-bar.show { 
            height: 50px; 
            opacity: 1; 
            padding: 10px 1rem; 
        }

        .counter-badge { display: flex; align-items: center; gap: 4px; font-size: 0.85rem; }
        
        @media (max-width: 768px) {
            .glass-header { padding: 0.5rem; }
            .toolbar { padding: 0.5rem; }
            .search-container-desktop { display: none; }
            .search-trigger-mobile { display: flex; }
            .mobile-search-bar { display: block; }
            #btnSync, #btnDiscard { padding: 0.25rem 0.75rem; font-size: 0.8rem; }
            .counter-group { gap: 8px !important; }
            .counter-badge b { font-size: 0.8rem; }
        }

        /* AUTO-FILL TABLE CONTAINER */
        .table-container { 
            background: var(--surface); 
            flex: 1 1 auto; /* Fills remaining height */
            overflow: auto; 
            position: relative; 
            width: 100%;
        }
        
        table { border-collapse: separate; border-spacing: 0; width: max-content; min-width: 100%; font-size: 0.9rem; table-layout: fixed; }
        thead th { background: #f8fafc; color: var(--text-muted); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 12px 8px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); position: sticky; top: 0; z-index: 10; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; user-select: none; cursor: pointer; transition: background-color 0.2s; box-sizing: border-box; }
        
        thead th.primary-header-cell { position: sticky; padding-bottom: 34px; overflow: visible; z-index: 12; }
        thead th.selected { background-color: var(--primary-soft) !important; color: var(--primary-dark); border-bottom: 2px solid var(--primary); }
        
        td {
            border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 0;
            background: var(--row-bg-override, var(--surface));
            white-space: normal;
            height: auto; min-height: 50px;
            vertical-align: top;
        }

        /* STICKY ACTIONS COLUMN (Reduced width on mobile) */
        th:first-child, td:first-child { 
            position: sticky; left: 0; z-index: 20; 
            background: var(--row-bg-override, var(--surface)); 
            border-right: 2px solid var(--border); 
            width: 170px; min-width: 170px; max-width: 170px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.02); overflow: visible; 
        }
        
        thead th:first-child { z-index: 30; background: #f8fafc; }

        .actions-wrapper { display: flex; justify-content: center; gap: 4px; width: 100%; height: 100%; align-items: flex-start; padding-top: 10px; }
        .action-btn { padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; border: 1px solid transparent; background: transparent; color: var(--text-muted); cursor: pointer; }
        .action-btn:hover { background: #f1f5f9; color: var(--text-main); border-color: #cbd5e1; }
        .action-btn.btn-del:hover { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
        
        .add-btn-group { display: flex; flex-direction: column; }
        .add-btn-part { width: 28px; height: 14px; font-size: 0.8rem; padding: 0; border: 1px solid transparent; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .add-btn-part:first-child { border-radius: 4px 4px 0 0; }
        .add-btn-part:last-child { border-radius: 0 0 4px 4px; }
        .add-btn-group:hover .add-btn-part { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        
        .drag-handle { cursor: grab; color: #94a3b8; }
        .drag-handle:active { cursor: grabbing; color: var(--primary); }

        .cell-textarea { width: 100%; height: 100%; min-height: 48px; border: none; background: transparent; padding: 12px; font-family: inherit; color: inherit; resize: none; overflow-y: hidden; line-height: 1.5; }
        .cell-textarea:focus { outline: none; background: white; box-shadow: inset 0 0 0 2px var(--primary); }

        .tree-wrap { display: flex; height: 100%; align-items: flex-start; padding-top: 12px; padding-left: 8px; }
        
        /* MODAL LAYOUT FIX */
        #setupModal .modal-body { display: flex; flex-direction: column; overflow: hidden; }
        #setupModal .tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #setupModal .tab-pane { display: none; }
        #setupModal .tab-pane.active { display: flex; flex: 1; flex-direction: column; overflow: hidden; height: 100%; }
        #setupRowTree { flex: 1; overflow-y: auto; }
        #setupColList { flex: 1; overflow-y: auto; }

        .setup-tree-controls {
            position: sticky; top: -8px; z-index: 10;
            margin: -8px -8px 8px -8px; padding: 4px 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: #f8fafc;
        }

        thead th.th-system { background: #f1f5f9; color: #475569; border-right: 1px dashed #cbd5e1; }
        td.td-system { background: #f8fafc; color: #64748b; font-family: monospace; font-size: 0.8rem; border-right: 1px dashed #cbd5e1; user-select: text; }
        .resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 40px; transform: translateX(50%); z-index: 100; cursor: col-resize; touch-action: none; display: none; justify-content: center; align-items: center; }
        .resizer::after { content: ""; width: 4px; height: 50%; background-color: var(--primary); border-radius: 4px; box-shadow: 0 0 8px rgba(79, 70, 229, 0.4); opacity: 0.7; }
        thead th.selected .resizer { display: flex; }
        .resizer:active::after, .resizer.resizing::after { height: 100%; background-color: var(--primary-dark); opacity: 1; width: 5px; }
        tr.row-new td { background-color: var(--row-bg-override, var(--row-new)) !important; }
        tr.row-modified td { background-color: var(--row-bg-override, var(--row-mod)) !important; }
        tr.row-deleted td { background-color: var(--row-del) !important; opacity: 0.5; text-decoration: line-through; pointer-events: none; }
        .sortable-ghost { opacity: 1 !important; background: #fff !important; box-shadow: 0 8px 24px rgba(0,0,0,0.15); position: relative; z-index: 1000; }
        .sortable-ghost td { background: #eef2ff !important; border-top: 2px solid var(--primary); border-bottom: 2px solid var(--primary); }
        .dragging-parent::after { content: ""; position: absolute; bottom: -4px; left: 4px; right: 4px; height: 6px; background: white; border: 1px solid #cbd5e1; border-radius: 0 0 4px 4px; z-index: -1; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .badge-cell { padding: 12px 8px; height: 100%; display: flex; align-items: flex-start; gap: 4px; overflow: hidden; cursor: pointer; white-space: normal; position: relative; flex-wrap: wrap;}
        .badge-pill { background: var(--primary-soft); color: var(--primary-dark); font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 99px; }
        
        /* POPOVER FIX: Fixed positioning to handle overflow:hidden on body */
        #multiPopover { 
            display: none; 
            position: fixed; /* Changed from absolute to fixed */
            z-index: 1050; 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); 
            width: 300px; 
            max-height: 350px; 
            overflow: hidden; 
            flex-direction: column; 
        }
        #multiPopover.show { display: flex !important; } /* Force display when shown */
        
        #multiPopover .popover-content { padding: 8px; overflow-y: auto; flex-grow: 1; }
        #multiPopover .popover-footer { padding: 8px; border-top: 1px solid var(--border); }
        #multiPopover .form-check { padding: 8px 12px; border-radius: 6px; }
        #multiPopover .form-check:hover { background-color: #f8fafc; }
        #multiPopover .form-check-input { margin-top: 0.2em; }
        .tree-indent { width: 16px; height: 100%; border-left: 1px dashed #cbd5e1; margin-right: 2px; }
        .tree-toggle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: var(--text-muted); cursor: pointer; margin-right: 4px; }
        .tree-toggle:hover { background: #e2e8f0; color: var(--primary); }
        .tree-toggle i { transition: transform 0.2s; font-size: 0.8rem; }
        .expanded i { transform: rotate(90deg); }
        .setup-tree-item { display: flex; align-items: center; padding: 6px; border-bottom: 1px solid #f8fafc; font-size: 0.9rem; }
        .setup-tree-item:hover { background-color: #f8fafc; }
        .setup-outline-group { padding-left: 50px; }
        .setup-selection-btns .btn-outline-xs { display: inline-flex; align-items: center; gap: 4px; }
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; }
        .log-line { font-family: monospace; font-size: 0.7rem; border-bottom: 1px solid #333; padding: 6px; color: #a5b4fc; }
        .nav-pills .nav-link { border-radius: 50px; color: var(--text-muted); padding: 8px 20px; font-weight: 600; font-size: 0.9rem; }
        .nav-pills .nav-link.active { background-color: var(--primary); color: white; }
        .btn-outline-xs { padding: 0.15rem 0.5rem; font-size: 0.75rem; border: 1px solid var(--border); color: var(--text-muted); }
        .btn-outline-xs:hover { background: var(--primary-soft); color: var(--primary-dark); border-color: var(--primary); }
        .header-outline-btns { position: absolute; bottom: 4px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .header-outline-btns .btn { --bs-btn-padding-y: .1rem; --bs-btn-padding-x: .4rem; --bs-btn-font-size: .65rem; border-radius: 4px; background: white; border: 1px solid var(--border); color: var(--text-muted); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .header-outline-btns .btn:hover { border-color: var(--primary); color: var(--primary); background-color: var(--primary-soft); }
        .outline-scroll-group { display: flex; gap: 4px; overflow-x: auto; border-radius: 6px; background: #eef2ff; padding: 4px; border: 1px solid #c7d2fe; scrollbar-width: none; }
        .outline-scroll-group::-webkit-scrollbar { display: none; }
        .outline-scroll-group .btn { border-radius: 4px; border: 1px solid transparent; font-size: 0.7rem; font-weight: 700; color: var(--primary-dark); background-color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex: 0 0 auto; min-width: 28px; }
        .outline-scroll-group .btn:last-child { padding: 0 8px; }
        .outline-scroll-group .btn:hover { background: white; border-color: var(--primary); }
        .mobile-toggle-btn { display: none; width: 100%; height: 100%; border: none; background: transparent; color: var(--text-muted); }
        
        @media (max-width: 768px) { 
            .modal.bottom-sheet .modal-dialog { position: fixed; bottom: 0; margin: 0; width: 100%; max-width: 100%; } 
            .modal.bottom-sheet .modal-content { border-radius: 24px 24px 0 0; border: none; min-height: 40vh; max-height: 85vh; } 
            
            /* Reduced width to the Actions column on mobile */
            th:first-child, td:first-child { width: 50px !important; min-width: 50px !important; max-width: 50px !important; } 
            
            .mobile-toggle-btn { display: flex; justify-content: center; align-items: center; cursor: pointer; } 
            .actions-wrapper { display: none; position: absolute; left: 40px; top: 5px; background: white; padding: 4px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid var(--border); width: auto; z-index: 1000; } 
            .actions-wrapper.show { display: flex; animation: fadeIn 0.1s ease-out; } 
            .action-btn { width: 36px; height: 36px; font-size: 1.1rem; } 
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="dashboardView" class="view-section active"><div class="hero-section"><div class="d-flex justify-content-between align-items-center mb-4"><h1 class="fw-bold m-0"><i class="bi bi-kanban-fill me-2"></i>Smartsheet Pro</h1><button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button></div><div class="bg-white p-1 rounded-pill shadow-lg d-flex"><input type="text" id="dashSheetId" class="form-control border-0 rounded-pill ps-4" placeholder="Paste Sheet ID..."><button class="btn btn-primary rounded-pill px-4 fw-bold" onclick="loadFromDash()">Open</button></div></div><div class="container mt-5"><h6 class="text-uppercase text-muted fw-bold small mb-3 ls-1">Library</h6><div id="libraryGrid" class="row g-3"></div><div id="emptyLib" class="text-center text-muted py-5" style="display:none;"><i class="bi bi-journal-album fs-1 d-block mb-3 opacity-25"></i> No recent sheets found.</div></div></div>

<!-- EDITOR VIEW -->
<div id="editorView" class="view-section">
    <div class="glass-header">
        <div class="d-flex align-items-center gap-3 overflow-hidden">
            <button class="btn btn-light rounded-circle shadow-sm border" onclick="toDash()"><i class="bi bi-chevron-left"></i></button>
            <div class="text-truncate">
                <div class="fw-bold text-truncate" id="sheetName">Loading...</div>
                <div class="small text-muted font-monospace" id="sheetIdDisplay">...</div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-white border shadow-sm font-monospace" onclick="viewRawData()" title="View Raw Data Table"><i class="bi bi-table"></i></button>
            <button class="btn btn-white border shadow-sm" onclick="toggleFullScreen()"><i class="bi bi-arrows-fullscreen"></i></button>
            <button class="btn btn-white border shadow-sm fw-bold" onclick="openSetup(true)"><i class="bi bi-sliders"></i></button>
        </div>
    </div>
    
    <!-- RESPONSIVE TOOLBAR -->
    <div class="toolbar">
        <!-- Left: Search Controls -->
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-light border search-trigger-mobile" onclick="toggleMobileSearch()">
                <i class="bi bi-search"></i>
            </button>
            <div class="search-container-desktop">
                <input type="text" id="desktopSearch" class="form-control form-control-sm border-0 bg-white shadow-sm" placeholder="Filter..." style="max-width: 150px;" onkeyup="syncSearch(this.value)">
            </div>
        </div>

        <!-- Right: Actions & Counters -->
        <div class="d-flex align-items-center gap-2 ms-2">
            <div class="d-flex gap-3 small text-muted counter-group">
                <span title="Modified" class="counter-badge"><i class="bi bi-pencil text-warning"></i> <b class="text-dark" id="cntMod">0</b></span>
                <span title="Added" class="counter-badge"><i class="bi bi-plus-circle text-success"></i> <b class="text-dark" id="cntAdd">0</b></span>
                <span title="Deleted" class="counter-badge"><i class="bi bi-trash text-danger"></i> <b class="text-dark" id="cntDel">0</b></span>
            </div>
            <div class="vr mx-1"></div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary rounded-pill fw-bold" onclick="discard()" id="btnDiscard" disabled>Discard</button>
                <button class="btn btn-sm btn-primary rounded-pill fw-bold" onclick="sync()" id="btnSync" disabled>Sync</button>
            </div>
        </div>
    </div>

    <!-- Mobile Slide-out Search Bar -->
    <div id="mobileSearchBar" class="mobile-search-bar">
        <input type="text" id="mobileSearchInput" class="form-control border-0 bg-white shadow-sm" placeholder="Search rows..." onkeyup="syncSearch(this.value)">
    </div>

    <input type="hidden" id="search">

    <div class="table-container" onclick="deselectColumn(event)">
        <table id="mainTable">
            <thead id="tHead"></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="setupModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content" style="height: 80vh;"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Sheet Setup</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body pt-2 d-flex flex-column h-100"><ul class="nav nav-pills nav-fill mb-3 bg-light rounded-pill p-1"><li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tabRows">Rows <span class="badge bg-white text-dark ms-1 rounded-pill" id="badgeRows">0</span></a></li><li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabCols">Columns <span class="badge bg-white text-dark ms-1 rounded-pill" id="badgeCols">0</span></a></li></ul><div class="tab-content flex-grow-1"><div class="tab-pane fade show active" id="tabRows"><div class="d-flex gap-2 mb-2 align-items-center"><input type="text" id="setupRowSearch" class="form-control form-control-sm" placeholder="Search rows..." onkeyup="renderSetupTree()"></div><div id="setupRowTree" class="border rounded bg-white p-2"></div></div><div class="tab-pane fade" id="tabCols"><div class="d-flex justify-content-between mb-2 px-1"><span class="small text-muted fw-bold">Toggle visible columns</span><div><button class="btn btn-sm btn-link text-decoration-none" onclick="toggleAllCols(true)">All</button><button class="btn btn-sm btn-link text-decoration-none" onclick="toggleAllCols(false)">None</button></div></div><div id="setupColList" class="d-flex flex-column gap-2 pb-3"></div></div></div></div><div class="modal-footer border-0"><button class="btn btn-primary w-100 py-2 rounded-pill fw-bold" onclick="applySetup()">Apply & Load</button></div></div></div></div>
<div class="modal fade" id="settingsModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content rounded-4 border-0 p-4"><h5 class="fw-bold mb-3">API Configuration</h5><label class="form-label small fw-bold text-muted">ACCESS TOKEN</label><input type="password" id="apiToken" class="form-control form-control-lg bg-light border-0 mb-3" placeholder="Token..."><button class="btn btn-primary w-100 rounded-pill" onclick="saveSettings()">Save</button></div></div></div>
<div class="modal fade" id="logsModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content bg-dark text-light"><div class="modal-header border-secondary"><h5 class="modal-title">System Logs</h5><button class="btn btn-sm btn-outline-light ms-auto me-2" onclick="copyLogs()">Copy</button><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0 bg-black" id="logContent" style="min-height:300px;"></div></div></div></div>
<div class="modal fade" id="rawDataModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable modal-fullscreen-lg-down"><div class="modal-content"><div class="modal-header bg-light border-bottom"><h5 class="modal-title font-monospace fw-bold"><i class="bi bi-database me-2 text-primary"></i>Raw Data Inspector</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0 position-relative"><div class="table-container" style="height: 100%;"><table id="rawTable" style="width:100%"><thead id="rawHead"></thead><tbody id="rawBody"></tbody></table></div></div></div></div></div>
<div id="loader" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.9); z-index:9999; flex-direction:column; align-items:center; justify-content:center;"><div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div><h6 class="fw-bold text-dark">Processing...</h6></div>
<div class="toast-container" id="toastArea"></div>

<!-- POPOVER FIX: Added style="display:none" to prevent phantom rendering -->
<div id="multiPopover" style="display:none"><div class="popover-content" id="multiOptions"></div><div class="popover-footer"><button class="btn btn-primary btn-sm w-100" onclick="saveMultiFromPopover()">Apply</button></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// --- SCRIPT START (No changes to CONFIG, STATE, etc.) ---
const CONFIG = { proxy: "https://cors-anywhere.herokuapp.com/", api: "https://api.smartsheet.com/2.0" };
const SMARTSHEET_COLORS = {'22':'#FFFF00','23':'#FFC0CB','24':'#00FFFF','25':'#FF00FF','26':'#C0C0C0','27':'#808080','30':'#008000','31':'#00FF00','32':'#800000','33':'#000080','34':'#808000','35':'#800080','36':'#FF0000','37':'#008080',};
let STATE = { sheetId: null, serverRows: [], allRows: [], activeRows: [], cols: [], colWidths: {}, selectedCol: null,visibleCols: new Set(), selectedRowIds: new Set(), adds: [], dels: new Set(), edits: {}, hierarchyChanges: {}, meta: { collapsed: new Set(), setupCollapsed: new Set(), rawCollapsed: new Set(), depth: {} }, tempMulti: null, logs: [] };
let sortableInstance = null;
document.addEventListener('DOMContentLoaded', () => { const t = localStorage.getItem('smToken'); if(!t) new bootstrap.Modal('#settingsModal').show(); renderLibrary(); document.addEventListener('click', closeMultiPopoverOnClickOutside); });
function renderLibrary() { const lib = JSON.parse(localStorage.getItem('smLib') || '[]'); const grid = document.getElementById('libraryGrid'); grid.innerHTML = ''; document.getElementById('emptyLib').style.display = lib.length ? 'none' : 'block'; lib.forEach(s => { const d = document.createElement('div'); d.className = 'col-12 col-md-6'; d.innerHTML = `<div class="sheet-card" onclick="loadSheet('${s.id}')"><div class="d-flex align-items-center"><div class="bg-light rounded-circle p-2 me-3 text-primary"><i class="bi bi-table"></i></div><div class="overflow-hidden me-auto"><div class="fw-bold text-truncate">${s.name}</div><div class="small text-muted font-monospace">${s.id}</div></div><button class="btn btn-sm text-danger z-2" onclick="removeSheet(event, '${s.id}')"><i class="bi bi-x-lg"></i></button></div></div>`; grid.appendChild(d); }); }
function addToLib(id, name) { let lib = JSON.parse(localStorage.getItem('smLib') || '[]'); lib = lib.filter(s => s.id !== id); lib.unshift({ id, name, date: Date.now() }); localStorage.setItem('smLib', JSON.stringify(lib.slice(0,10))); }
function removeSheet(e, id) { e.stopPropagation(); if(confirm('Remove?')) { let lib = JSON.parse(localStorage.getItem('smLib') || '[]'); localStorage.setItem('smLib', JSON.stringify(lib.filter(s => s.id !== id))); renderLibrary(); } }
function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(console.log); else document.exitFullscreen(); }
function generateOutlineButtonsHTML(context) { let max = 0; Object.values(STATE.meta.depth).forEach(d => max = Math.max(max, d)); const maxLevel = max + 1; let html = ''; for(let i = 1; i <= maxLevel; i++) { html += `<button class="btn" onclick="setOutline(${i}, '${context}')" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Collapse to Level ${i}">${i}</button>`; } html += `<button class="btn" onclick="setOutline(99, '${context}')" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Expand All">All</button>`; return html; };
function setOutline(level, context) { const targetSet = context === 'SETUP' ? STATE.meta.setupCollapsed : STATE.meta.collapsed; targetSet.clear(); if(level < 99) { STATE.allRows.forEach(r => { const d = STATE.meta.depth[r.id] || 0; if(d >= level - 1) targetSet.add(r.id); }); } if(context === 'SETUP') renderSetupTree(); else renderTable(); }
function viewRawData() { renderRawTable(); new bootstrap.Modal('#rawDataModal').show(); }
function renderRawTable() { const th = document.getElementById('rawHead'); const tb = document.getElementById('rawBody'); th.innerHTML = ''; tb.innerHTML = ''; let h = `<tr><th class="th-system" style="width:120px">Row ID</th><th class="th-system" style="width:120px">Parent ID</th><th class="th-system" style="width:60px">#</th>`; STATE.cols.forEach(c => { h += `<th style="width:200px">${c.title} <span class="fw-normal text-muted small">(${c.id})</span></th>`; }); h += '</tr>'; th.innerHTML = h; const all = STATE.allRows; all.forEach(r => { if(isRawHidden(r)) return; const tr = document.createElement('tr'); let html = `<td class="td-system">${r.id}</td><td class="td-system">${r.parentId || '-'}</td><td class="td-system text-center">${r.rowNumber}</td>`; STATE.cols.forEach(c => { const val = r.cells.find(x => x.columnId === c.id)?.displayValue ?? r.cells.find(x => x.columnId === c.id)?.value ?? ''; html += `<td>`; if(c.primary) { html += `<div class="tree-wrap">`; const depth = STATE.meta.depth[r.id] || 0; for(let i=0; i<depth; i++) html += `<div class="tree-indent"></div>`; const hasChild = all.some(x => x.parentId === r.id); if(hasChild) { const col = STATE.meta.rawCollapsed.has(r.id); html += `<div class="tree-toggle ${col?'':'expanded'}" onclick="toggleRaw('${r.id}')"><i class="bi bi-caret-right-fill"></i></div>`; } else { html += `<div style="width:28px"></div>`; } html += `<span>${val}</span></div>`; } else { html += `<div class="p-2 text-truncate">${val}</div>`; } html += `</td>`; }); tr.innerHTML = html; tb.appendChild(tr); }); }
function isRawHidden(r) { if(!r.parentId) return false; if(STATE.meta.rawCollapsed.has(r.parentId)) return true; const p = STATE.allRows.find(x => x.id === r.parentId); if(p) return isRawHidden(p); return false; }
function toggleRaw(id) { const rid = parseInt(id); if(STATE.meta.rawCollapsed.has(rid)) STATE.meta.rawCollapsed.delete(rid); else STATE.meta.rawCollapsed.add(rid); renderRawTable(); }
async function api(ep, method='GET', body=null) { const t = localStorage.getItem('smToken'); const opts = { method, headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' } }; if(body) opts.body = JSON.stringify(body); sysLog(`REQ ${method} ${ep}`, body); const res = await fetch(CONFIG.proxy + CONFIG.api + ep, opts); if(res.status === 403) { if(confirm("Proxy Locked. Open unlock page?")) window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank'); throw 'PROXY_LOCK'; } const json = await res.json(); if(!res.ok) { sysLog(`ERR ${res.status}`, json); throw (json.message || `Error ${res.status}`); } return json; }
function loadFromDash() { const id = document.getElementById('dashSheetId').value.trim(); if(id) loadSheet(id); }
function loadSheet(id) { STATE.sheetId = id; document.getElementById('dashboardView').classList.remove('active'); document.getElementById('editorView').classList.add('active'); resetState(); fetchData(); }
function resetState() { STATE.serverRows = []; STATE.allRows=[]; STATE.activeRows=[]; STATE.adds=[]; STATE.dels=new Set(); STATE.edits={}; STATE.hierarchyChanges={}; STATE.visibleCols.clear(); STATE.selectedRowIds.clear(); STATE.colWidths = {}; STATE.selectedCol = null; STATE.meta.collapsed.clear(); STATE.meta.setupCollapsed.clear(); STATE.meta.rawCollapsed.clear(); updateSyncUI(); document.getElementById('tBody').innerHTML=''; document.getElementById('sheetName').innerText='Loading...'; }
async function fetchData() { showLoader(true); try { const d = await api(`/sheets/${STATE.sheetId}?includeAll=true`); STATE.serverRows = JSON.parse(JSON.stringify(d.rows)); STATE.allRows = JSON.parse(JSON.stringify(d.rows)); STATE.cols = d.columns; document.getElementById('sheetName').innerText = d.name; document.getElementById('sheetIdDisplay').innerText = d.id; addToLib(d.id, d.name); STATE.selectedRowIds = new Set(STATE.allRows.map(r => r.id)); STATE.visibleCols = new Set(STATE.cols.map(c => c.id)); calcAllDepth(); openSetup(false); } catch(e) { if(e!=='PROXY_LOCK') showToast(e, 'danger'); } finally { showLoader(false); } }
function calcAllDepth() { STATE.meta.depth = {}; const map = new Map(); const allRowsForDepth = [...STATE.allRows, ...STATE.adds]; allRowsForDepth.forEach(r => map.set(r.id, r)); allRowsForDepth.forEach(r => { let d=0, curr=r; while(curr && curr.parentId && map.has(curr.parentId) && d<20) { d++; curr=map.get(curr.parentId); } STATE.meta.depth[r.id]=d; }); }
function toDash() { if(hasChanges() && !confirm("Unsaved changes. Exit?")) return; document.getElementById('editorView').classList.remove('active'); document.getElementById('dashboardView').classList.add('active'); renderLibrary(); }
function renderSetupTree() { const term = document.getElementById('setupRowSearch').value.toLowerCase(); const tree = document.getElementById('setupRowTree'); const primId = STATE.cols.find(c => c.primary)?.id; const rowMap = new Map(STATE.allRows.map(r => [r.id, r])); const outlineGroup = `<div class="outline-scroll-group setup-outline-group">${generateOutlineButtonsHTML('SETUP')}</div>`; const selectionGroup = `<div class="d-flex gap-2 setup-selection-btns"><button class="btn btn-outline-xs" onclick="toggleAllSetupRows(true)" data-bs-toggle="tooltip" title="Select all rows"><i class="bi bi-check-square-fill"></i> All</button><button class="btn btn-outline-xs" onclick="toggleAllSetupRows(false)" data-bs-toggle="tooltip" title="Deselect all rows"><i class="bi bi-square"></i> None</button></div>`; const controlsHTML = `<div class="setup-tree-controls">${outlineGroup}${selectionGroup}</div>`; let mainHTML = ''; STATE.allRows.forEach(r => { if(isSetupHidden(r, rowMap)) return; const txt = (r.cells.find(c => c.columnId === primId)?.displayValue || `Row ${r.rowNumber}`); if(term && !String(txt).toLowerCase().includes(term)) return; const d = STATE.meta.depth[r.id] || 0; const checked = STATE.selectedRowIds.has(r.id) ? 'checked' : ''; const padding = d * 20; const hasChild = STATE.allRows.some(x => x.parentId === r.id); const isCollapsed = STATE.meta.setupCollapsed.has(r.id); let toggleIcon = hasChild ? `<div class="tree-toggle ${isCollapsed ? '' : 'expanded'}" onclick="toggleSetup(${r.id})"><i class="bi bi-caret-right-fill"></i></div>` : `<div style="width:28px"></div>`; mainHTML += `<div class="setup-tree-item" style="padding-left: ${padding}px">${toggleIcon}<input type="checkbox" class="form-check-input me-2" onchange="toggleSetupRow(${r.id}, this.checked)" ${checked}><span class="text-truncate">${txt}</span></div>`; }); tree.innerHTML = controlsHTML + mainHTML; updateSetupBadges(); const tooltipTriggerList = tree.querySelectorAll('[data-bs-toggle="tooltip"]'); [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl)); }
function openSetup(isEdit = false) { renderSetupCols(); renderSetupTree(); updateSetupBadges(); new bootstrap.Modal('#setupModal').show(); }
function renderSetupCols() { const list = document.getElementById('setupColList'); if(!list) return; let html = ''; STATE.cols.forEach(c => { const checked = STATE.visibleCols.has(c.id) ? 'checked' : ''; html += `<div class="d-flex align-items-center p-2 border rounded bg-white"><input class="form-check-input m-0" type="checkbox" value="${c.id}" id="col_${c.id}" ${checked} onchange="updateSetupBadges()" style="cursor:pointer"><label class="form-check-label flex-grow-1 ms-3 fw-bold" for="col_${c.id}" style="cursor:pointer">${c.title}</label></div>`; }); list.innerHTML = html; }
function isSetupHidden(r, map) { if(!r.parentId) return false; if(STATE.meta.setupCollapsed.has(r.parentId)) return true; const p = map.get(r.parentId); if(p) return isSetupHidden(p, map); return false; }
function toggleSetup(id) { if(STATE.meta.setupCollapsed.has(id)) STATE.meta.setupCollapsed.delete(id); else STATE.meta.setupCollapsed.add(id); renderSetupTree(); }
function toggleSetupRow(id, status) { if(status) STATE.selectedRowIds.add(id); else STATE.selectedRowIds.delete(id); const children = STATE.allRows.filter(r => r.parentId === id); children.forEach(c => toggleSetupRow(c.id, status)); renderSetupTree(); }
function toggleAllSetupRows(status) { if(status) STATE.selectedRowIds = new Set(STATE.allRows.map(r => r.id)); else STATE.selectedRowIds.clear(); renderSetupTree(); }
function toggleAllCols(status) { document.querySelectorAll('#setupColList input').forEach(cb => cb.checked = status); updateSetupBadges(); }
function updateSetupBadges() { document.getElementById('badgeRows').innerText = STATE.selectedRowIds.size; document.getElementById('badgeCols').innerText = document.querySelectorAll('#setupColList input:checked').length; }
function applySetup() { STATE.visibleCols.clear(); document.querySelectorAll('#setupColList input:checked').forEach(cb => STATE.visibleCols.add(parseInt(cb.value))); if(STATE.visibleCols.size === 0) return alert("Select at least one column"); STATE.activeRows = STATE.allRows.filter(r => STATE.selectedRowIds.has(r.id)); bootstrap.Modal.getInstance('#setupModal').hide(); renderTable(); }
function selectColumn(e, colId) { e.stopPropagation(); if (STATE.selectedCol === colId) STATE.selectedCol = null; else STATE.selectedCol = colId; renderTable(); }
function deselectColumn(e) { if (!e.target.closest('th')) { if(STATE.selectedCol !== null) { STATE.selectedCol = null; renderTable(); } } }
function startResize(e, resizer) { e.preventDefault(); e.stopPropagation(); let x = e.touches ? e.touches[0].clientX : e.clientX; let th = resizer.parentElement; let w = th.getBoundingClientRect().width; resizer.classList.add('resizing'); const onMove = (evt) => { if(evt.cancelable) evt.preventDefault(); const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX; const newWidth = Math.max(50, w + (clientX - x)); th.style.width = `${newWidth}px`; }; const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onUp); if(th.dataset.colId) STATE.colWidths[parseInt(th.dataset.colId)] = parseInt(th.style.width); resizer.classList.remove('resizing'); }; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onUp); }
function renderTable() { const tb = document.getElementById('tBody'); const th = document.getElementById('tHead'); tb.innerHTML = ''; th.innerHTML = ''; const primColId = STATE.cols.find(c => c.primary)?.id; let h = `<tr><th class="text-center">Actions</th>`; STATE.cols.forEach(c => { if(STATE.visibleCols.has(c.id)) { const w = STATE.colWidths[c.id] ? `${STATE.colWidths[c.id]}px` : (c.id === primColId ? '250px' : '150px'); const selClass = STATE.selectedCol === c.id ? 'selected' : ''; const isPrimary = c.id === primColId; const primaryClass = isPrimary ? 'primary-header-cell' : ''; const outlineBtns = isPrimary ? `<div class="header-outline-btns">${generateOutlineButtonsHTML('MAIN')}</div>` : ''; h += `<th style="width:${w}" class="${selClass} ${primaryClass}" data-col-id="${c.id}" onclick="selectColumn(event, ${c.id})">${c.title}${outlineBtns}<div class="resizer" onmousedown="startResize(event, this)" ontouchstart="startResize(event, this)"></div></th>`; } }); h += `</tr>`; th.innerHTML = h; const all = STATE.activeRows; const term = document.getElementById('search').value.toLowerCase(); const viewDepth = {}; const activeIds = new Set(all.map(r => r.id)); all.forEach(r => { let d = 0, curr = r; while(curr && curr.parentId && activeIds.has(curr.parentId) && d < 20) { d++; curr = all.find(x => x.id === curr.parentId); } viewDepth[r.id] = d; }); all.forEach((r, idx) => { if(isHidden(r, activeIds) && !term) return; if(term) { const txt = (r.cells || []).map(c=>c.displayValue||c.value||'').join(' ').toLowerCase(); if(!txt.includes(term)) return; } const tr = document.createElement('tr'); tr.setAttribute('data-id', r.id); if(STATE.dels.has(r.id)) tr.className = 'row-deleted'; else if(String(r.id).startsWith('NEW')) tr.className = 'row-new'; else if(STATE.edits[r.id] || STATE.hierarchyChanges[r.id]) tr.className = 'row-modified'; if (r.format) { const formatParts = r.format.split(','); const bgColorCode = formatParts[15]; const cssColor = SMARTSHEET_COLORS[bgColorCode]; if (cssColor) { tr.style.setProperty('--row-bg-override', cssColor); } } let html = `<td class="text-center border-end p-0">`; if(STATE.dels.has(r.id)) { html += `<button class="btn btn-sm border-0 text-secondary" onclick="restoreRow('${r.id}')"><i class="bi bi-arrow-counterclockwise"></i></button>`; } else { html += `<button class="mobile-toggle-btn" onclick="toggleMobileActions(this)"><i class="bi bi-three-dots"></i></button><div class="actions-wrapper"><button class="action-btn drag-handle" title="Drag"><i class="bi bi-grip-vertical"></i></button><button class="action-btn" onclick="indentRow('${r.id}')" title="Indent"><i class="bi bi-text-indent-left"></i></button><button class="action-btn" onclick="outdentRow('${r.id}')" title="Outdent"><i class="bi bi-text-indent-right"></i></button><div class="add-btn-group" title="Add Row"><button class="add-btn-part" onclick="addNewRowAbove('${r.id}')"><i class="bi bi-chevron-up"></i></button><button class="add-btn-part" onclick="addNewRowBelow('${r.id}')"><i class="bi bi-chevron-down"></i></button></div><button class="action-btn btn-del" onclick="delRow('${r.id}')" title="Delete"><i class="bi bi-trash"></i></button></div>`; } html += `</td>`; STATE.cols.forEach(c => { if(!STATE.visibleCols.has(c.id)) return; const cid = c.id; let val = STATE.edits[r.id]?.[cid]; if(val === undefined) { const cell = (r.cells || []).find(x => x.columnId === cid); val = cell ? (cell.displayValue ?? cell.value ?? '') : ''; } html += `<td>`; if(c.primary) { html += `<div class="tree-wrap">`; const depth = viewDepth[r.id] || 0; for(let i=0; i<depth; i++) html += `<div class="tree-indent"></div>`; const hasChild = all.some(x => x.parentId === r.id); if(hasChild) { const col = STATE.meta.collapsed.has(r.id); html += `<div class="tree-toggle ${col?'':'expanded'}" onclick="toggle('${r.id}')"><i class="bi bi-caret-right-fill"></i></div>`; } else { html += `<div style="width:28px"></div>`; } } if(STATE.dels.has(r.id)) html += `<div class="p-2 small text-muted">${val}</div>`; else html += getCellHtml(r.id, c, val); if(c.primary) html += `</div>`; html += `</td>`; }); tr.innerHTML = html; tb.appendChild(tr); }); initSortable(); const tooltipTriggerList = document.querySelectorAll('#tHead [data-bs-toggle="tooltip"]'); [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl)); Array.from(tb.querySelectorAll('textarea')).forEach(ta => { ta.style.height='auto'; ta.style.height=(ta.scrollHeight)+'px'; }); }
function isHidden(r, activeSet) { if(!r.parentId) return false; if(!activeSet.has(r.parentId)) return false; if(STATE.meta.collapsed.has(r.parentId)) return true; const parentInActive = STATE.activeRows.find(x => x.id === r.parentId); if(parentInActive) return isHidden(parentInActive, activeSet); return false; }
function toggle(id) { const realId = isNaN(id) ? id : parseInt(id); if(STATE.meta.collapsed.has(realId)) STATE.meta.collapsed.delete(realId); else STATE.meta.collapsed.add(realId); renderTable(); }
function toggleMobileActions(btn) { const wrap = btn.nextElementSibling; if (wrap.classList.contains('show')) wrap.classList.remove('show'); else { document.querySelectorAll('.actions-wrapper.show').forEach(el => el.classList.remove('show')); wrap.classList.add('show'); } }
function getAllDescendants(parentId, allRows) { const children = allRows.filter(r => r.parentId === parentId); let results = [...children]; children.forEach(child => { results = [...results, ...getAllDescendants(child.id, allRows)]; }); return results; }
function initSortable() { if(sortableInstance) sortableInstance.destroy(); const tbody = document.getElementById('tBody'); sortableInstance = new Sortable(tbody, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', onStart: function(evt) { const rid = isNaN(evt.item.dataset.id) ? evt.item.dataset.id : parseInt(evt.item.dataset.id); const descendants = getAllDescendants(rid, STATE.activeRows); descendants.forEach(d => { const row = document.querySelector(`tr[data-id="${d.id}"]`); if(row) row.style.display = 'none'; }); if(descendants.length > 0) { evt.item.classList.add('dragging-parent'); const primaryCol = STATE.cols.find(c => c.primary); if(primaryCol && STATE.visibleCols.has(primaryCol.id)) { const cell = evt.item.querySelector('.tree-wrap'); if(cell) { const badge = document.createElement('span'); badge.className = "badge bg-primary rounded-pill ms-2 fw-normal"; badge.innerText = `+ ${descendants.length} sub-rows`; badge.id = "dragBadge"; cell.appendChild(badge); } } } }, onEnd: function (evt) { const item = evt.item; const rid = isNaN(item.dataset.id) ? item.dataset.id : parseInt(item.dataset.id); item.classList.remove('dragging-parent'); const badge = document.getElementById('dragBadge'); if(badge) badge.remove(); if (evt.oldIndex === evt.newIndex) { const descendants = getAllDescendants(rid, STATE.activeRows); descendants.forEach(d => { const row = document.querySelector(`tr[data-id="${d.id}"]`); if (row) row.style.display = ''; }); return; } const prevRow = item.previousElementSibling; let targetPrevId = null; if (prevRow) targetPrevId = isNaN(prevRow.dataset.id) ? prevRow.dataset.id : parseInt(prevRow.dataset.id); let newParentId = undefined; let siblingId = undefined; let toTop = false; if (targetPrevId) { const prevRowObj = STATE.allRows.find(r => r.id === targetPrevId); const isCollapsed = STATE.meta.collapsed.has(targetPrevId); const hasChildren = STATE.allRows.some(r => r.parentId === targetPrevId); if (prevRowObj && hasChildren && !isCollapsed) { newParentId = targetPrevId; toTop = true; } else if (prevRowObj) { newParentId = prevRowObj.parentId; siblingId = targetPrevId; } } else { toTop = true; } const allAndNewRows = [...STATE.allRows, ...STATE.adds]; const rowToUpdate = allAndNewRows.find(r => r.id === rid); if(rowToUpdate) rowToUpdate.parentId = newParentId; STATE.hierarchyChanges[rid] = { type: 'MOVE', parentId: newParentId, siblingId, toTop }; const newOrderIds = Array.from(evt.to.children).map(tr => isNaN(tr.dataset.id) ? tr.dataset.id : parseInt(tr.dataset.id)); STATE.activeRows.sort((a,b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id)); calcAllDepth(); renderTable(); updateSyncUI(); }, }); }
function updateSyncUI() { const modifiedCount = new Set([...Object.keys(STATE.edits), ...Object.keys(STATE.hierarchyChanges)]).size; document.getElementById('cntMod').innerText = modifiedCount; document.getElementById('cntAdd').innerText = STATE.adds.length; document.getElementById('cntDel').innerText = STATE.dels.size; const has = (modifiedCount + STATE.adds.length + STATE.dels.size) > 0; document.getElementById('btnSync').disabled = !has; document.getElementById('btnDiscard').disabled = !has; document.getElementById('btnSync').className = has ? "btn btn-sm btn-primary rounded-pill px-3 fw-bold" : "btn btn-sm btn-secondary rounded-pill px-3"; }
function discard() { if(!confirm('Discard all unsaved changes?')) return; STATE.allRows = JSON.parse(JSON.stringify(STATE.serverRows)); STATE.adds = []; STATE.dels.clear(); STATE.edits = {}; STATE.hierarchyChanges = {}; STATE.activeRows = STATE.allRows.filter(r => STATE.selectedRowIds.has(r.id)); calcAllDepth(); renderTable(); updateSyncUI(); showToast('Changes discarded', 'success'); }
async function sync() { if(!confirm('Sync to Smartsheet?')) return; showLoader(true); try { if(STATE.dels.size > 0) { await api(`/sheets/${STATE.sheetId}/rows?ids=${Array.from(STATE.dels).join(',')}&ignoreRowsNotFound=true`, 'DELETE'); } if (STATE.adds.length > 0) { const newRowsPayload = STATE.adds.map(r => { const editsForNewRow = STATE.edits[r.id] || {}; const finalCells = (r.cells || []).map(c => ({ ...c })); Object.keys(editsForNewRow).forEach(cid => { const existingCellIndex = finalCells.findIndex(cell => cell.columnId == cid); if (existingCellIndex > -1) finalCells[existingCellIndex].value = editsForNewRow[cid]; else finalCells.push({ columnId: parseInt(cid), value: editsForNewRow[cid] }); }); const cleanCells = finalCells.map(c => { const colDef = STATE.cols.find(col => col.id === c.columnId); const isMulti = colDef && (colDef.type.includes('MULTI') || (colDef.options && String(c.value).includes(','))); if(isMulti) { const arr = String(c.value).split(/,\s*/).filter(s => s !== ''); return { columnId: c.columnId, objectValue: { objectType: "MULTI_PICKLIST", values: arr } }; } return { columnId: c.columnId, value: c.value }; }); const o={cells:cleanCells}; if(r.parentId) o.parentId=r.parentId; else o.toTop=true; if(r.siblingId) o.siblingId = r.siblingId; return o; }); await api(`/sheets/${STATE.sheetId}/rows`, 'POST', newRowsPayload); } const updateIds = new Set([...Object.keys(STATE.edits), ...Object.keys(STATE.hierarchyChanges)]); if(updateIds.size > 0) { const updates = Array.from(updateIds) .filter(rid => !String(rid).startsWith("NEW")) .map(rid => { const payload = { id: parseInt(rid) }; if(STATE.edits[rid]) { payload.cells = Object.keys(STATE.edits[rid]).map(cid => { const colDef = STATE.cols.find(c => c.id === parseInt(cid)); let rawVal = STATE.edits[rid][cid]; const isMulti = colDef && (colDef.type.includes('MULTI') || (colDef.options && String(rawVal).includes(','))); if(isMulti) { const arr = String(rawVal).split(/,\s*/).filter(s => s !== ''); return { columnId: parseInt(cid), objectValue: { objectType: "MULTI_PICKLIST", values: arr } }; } return { columnId: parseInt(cid), value: rawVal }; }); } if(STATE.hierarchyChanges[rid]) { const change = STATE.hierarchyChanges[rid]; if(change.toTop) payload.toTop = true; else if(change.siblingId) payload.siblingId = change.siblingId; if(change.parentId !== undefined) payload.parentId = change.parentId; } return payload; }); if (updates.length > 0) { await api(`/sheets/${STATE.sheetId}/rows`, 'PUT', updates); } } const freshData = await api(`/sheets/${STATE.sheetId}?includeAll=true`); STATE.allRows = freshData.rows; STATE.serverRows = JSON.parse(JSON.stringify(freshData.rows)); STATE.activeRows = STATE.allRows.filter(r => STATE.selectedRowIds.has(r.id)); STATE.adds = []; STATE.dels.clear(); STATE.edits = {}; STATE.hierarchyChanges = {}; calcAllDepth(); renderTable(); updateSyncUI(); showToast('Sync Successful!', 'success'); } catch(e) { showToast('Sync Failed: ' + e, 'danger'); } finally { showLoader(false); } }
function indentRow(id) { const rid = isNaN(id) ? id : parseInt(id); const rowList = STATE.activeRows; const idx = rowList.findIndex(r => r.id === rid); if(idx <= 0) return; const prev = rowList[idx-1]; const allAndNewRows = [...STATE.allRows, ...STATE.adds]; const rowToUpdate = allAndNewRows.find(r => r.id === rid); if(rowToUpdate) rowToUpdate.parentId = prev.id; STATE.hierarchyChanges[rid] = { type: 'INDENT', parentId: prev.id }; calcAllDepth(); renderTable(); updateSyncUI(); }
function outdentRow(id) { const rid = isNaN(id) ? id : parseInt(id); const allAndNewRows = [...STATE.allRows, ...STATE.adds]; const row = allAndNewRows.find(r => r.id === rid); if(!row || !row.parentId) return; const parent = allAndNewRows.find(p => p.id === row.parentId); const newPid = parent ? parent.parentId : undefined; row.parentId = newPid; STATE.hierarchyChanges[rid] = { type: 'OUTDENT', parentId: newPid, siblingId: parent.id }; calcAllDepth(); renderTable(); updateSyncUI(); }
function delRow(id) { if(String(id).startsWith('NEW')) { STATE.adds = STATE.adds.filter(r => r.id !== id); STATE.activeRows = STATE.activeRows.filter(r => r.id !== id); } else STATE.dels.add(parseInt(id)); renderTable(); updateSyncUI(); }
function restoreRow(id) { STATE.dels.delete(parseInt(id)); renderTable(); updateSyncUI(); }
function hasChanges() { return Object.keys(STATE.edits).length > 0 || STATE.adds.length > 0 || STATE.dels.size > 0 || Object.keys(STATE.hierarchyChanges).length > 0; }
function getCellHtml(rid, col, val) { const safeVal = String(val || '').replace(/</g, "&lt;").replace(/>/g, "&gt;"); if(col.type === 'CHECKBOX') { const checked = (val === true || val === 'true'); return `<div class="d-flex justify-content-center align-items-center h-100"><input type="checkbox" class="form-check-input" ${checked?'checked':''} onchange="edit('${rid}', ${col.id}, this.checked)" style="transform:scale(1.2); cursor:pointer;"></div>`; } const isMulti = col.type.includes('MULTI') || (col.type === 'TEXT_NUMBER' && col.options && col.options.length > 0); if(isMulti) { let arr = []; if(Array.isArray(val)) arr = val; else if(val) arr = String(val).split(',').map(s=>s.trim()).filter(s=>s!==''); let badges = ''; if(arr.length === 0) badges = `<span class="text-muted small ps-1 opacity-50 fst-italic">Select...</span>`; else { arr.forEach(t => badges += `<span class="badge-pill">${t}</span>`); } const safeArr = encodeURIComponent(JSON.stringify(arr)); return `<div class="badge-cell" onclick="openMultiPopover(event, '${rid}', ${col.id}, '${safeArr}')">${badges}</div>`; } if(col.options && col.options.length > 0) { let opts = `<option value=""></option>`; col.options.forEach(o => { const sel = String(val) === String(o) ? 'selected' : ''; opts += `<option value="${o}">${o}</option>`; }); return `<select class="cell-textarea" onchange="edit('${rid}', ${col.id}, this.value)">${opts}</select>`; } return `<textarea class="cell-textarea" oninput="this.style.height='auto';this.style.height=(this.scrollHeight)+'px';" onchange="edit('${rid}', ${col.id}, this.value)">${safeVal}</textarea>`;}
function edit(rid, cid, val) { if(!STATE.edits[rid]) STATE.edits[rid] = {}; STATE.edits[rid][cid] = val; updateSyncUI(); const col = STATE.cols.find(c => c.id === cid); if(col && (col.type.includes('MULTI') || col.options)) renderTable(); }
function openMultiPopover(event, rid, cid, encoded) { event.stopPropagation(); const popover = document.getElementById('multiPopover'); const cell = event.currentTarget; const vals = JSON.parse(decodeURIComponent(encoded)); const col = STATE.cols.find(c => c.id === cid); STATE.tempMulti = { rid, cid }; const box = document.getElementById('multiOptions'); box.innerHTML = ''; const opts = Array.from(new Set([...(col.options || []), ...vals])); opts.forEach((o, i) => { if (!o) return; const checked = vals.includes(o) ? 'checked' : ''; const safeVal = String(o).replace(/"/g, '&quot;'); const uId = `opt_${i}`; box.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${safeVal}" id="${uId}" ${checked}><label class="form-check-label w-100" for="${uId}">${o}</label></div>`; }); 
    const rect = cell.getBoundingClientRect(); 
    // UPDATED POSITIONING: Fixed position based on viewport rect, no scroll offset needed due to overflow:hidden on body
    popover.style.top = `${rect.bottom}px`; 
    popover.style.left = `${rect.left}px`; 
    popover.classList.add('show'); 
}
function saveMultiFromPopover() { if (!STATE.tempMulti) return; const { rid, cid } = STATE.tempMulti; const selected = Array.from(document.querySelectorAll('#multiOptions input:checked')).map(cb => cb.value); const val = selected.join(', '); edit(rid, cid, val); document.getElementById('multiPopover').classList.remove('show'); STATE.tempMulti = null; }
function closeMultiPopoverOnClickOutside(event) { const popover = document.getElementById('multiPopover'); if (popover.classList.contains('show')) { if (!popover.contains(event.target) && !event.target.closest('.badge-cell')) { popover.classList.remove('show'); STATE.tempMulti = null; } } }
function _createAndInsertRow(parentId, insertionIndex, siblingId = null) { const tempId = 'NEW_' + Date.now(); const newRow = { id: tempId, cells: [], parentId, siblingId, rowNumber: 9999, format: ",,,,,,,,,,,,,,22,,,,,,", }; STATE.adds.push(newRow); STATE.activeRows.splice(insertionIndex, 0, newRow); calcAllDepth(); renderTable(); updateSyncUI(); setTimeout(() => { const newRowEl = document.querySelector(`tr[data-id="${tempId}"]`); if (newRowEl) { newRowEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); const firstInput = newRowEl.querySelector('textarea, select'); if (firstInput) firstInput.focus(); } }, 100); }
function addNewRowAbove(id) { const relativeId = String(id).startsWith('NEW') ? id : parseInt(id); const relativeIndex = STATE.activeRows.findIndex(r => r.id === relativeId); if (relativeIndex === -1) return; const relativeRow = STATE.activeRows[relativeIndex]; _createAndInsertRow(relativeRow.parentId, relativeIndex, relativeRow.id); }
function addNewRowBelow(id) { const relativeId = String(id).startsWith('NEW') ? id : parseInt(id); const relativeIndex = STATE.activeRows.findIndex(r => r.id === relativeId); if (relativeIndex === -1) return; const relativeRow = STATE.activeRows[relativeIndex]; const lastDescendantIndex = findLastDescendantIndex(relativeId, relativeIndex); _createAndInsertRow(relativeRow.parentId, lastDescendantIndex + 1); }
function findLastDescendantIndex(parentId, startIndex) { let lastIndex = startIndex; const parentDepth = STATE.meta.depth[parentId] || 0; for (let i = startIndex + 1; i < STATE.activeRows.length; i++) { const row = STATE.activeRows[i]; const rowDepth = STATE.meta.depth[row.id] || 0; if (rowDepth > parentDepth) { lastIndex = i; } else { break; } } return lastIndex; }
function showLoader(s) { const l=document.getElementById('loader'); if(l) l.style.display=s?'flex':'none'; }
function showToast(msg, type='primary') { const t = document.createElement('div'); t.className = `toast align-items-center text-white bg-${type} border-0 show mb-2 shadow`; t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`; document.getElementById('toastArea').appendChild(t); setTimeout(() => t.remove(), 4000); }
function sysLog(msg, data) { const line = document.createElement('div'); line.className = 'log-line'; line.innerHTML = `<span>[${new Date().toLocaleTimeString()}]</span> ${msg}`; if(data) line.innerHTML += `<br><span style="color:#666">${JSON.stringify(data).substring(0,200)}...</span>`; document.getElementById('logContent').prepend(line); STATE.logs.push({time:Date.now(), msg, data}); }
function showLogs() { new bootstrap.Modal('#logsModal').show(); }
function copyLogs() { navigator.clipboard.writeText(JSON.stringify(STATE.logs, null, 2)); showToast('Logs Copied'); }
function openSettings() { document.getElementById('apiToken').value = localStorage.getItem('smToken') || ''; new bootstrap.Modal('#settingsModal').show(); }
function saveSettings() { localStorage.setItem('smToken', document.getElementById('apiToken').value); bootstrap.Modal.getInstance('#settingsModal').hide(); }

// --- New Functions for Mobile Search ---
function toggleMobileSearch() {
    const bar = document.getElementById('mobileSearchBar');
    bar.classList.toggle('show');
    if(bar.classList.contains('show')) document.getElementById('mobileSearchInput').focus();
}

function syncSearch(val) {
    document.getElementById('search').value = val;
    document.getElementById('desktopSearch').value = val;
    document.getElementById('mobileSearchInput').value = val;
    renderTable();
}
</script>
</body>
</html>