<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SnapHunt</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --blue: #3b82f6; --yellow: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: white; overflow: hidden; overscroll-behavior: none; }
        .glass { background-color: rgba(31, 41, 55, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .header-left, .header-right { position: fixed; top: 1rem; z-index: 50; display: flex; align-items: center; padding: 0.5rem 1rem; border-radius: 9999px; }
        .header-left { left: 1rem; } .header-right { right: 1rem; }
        .icon-btn { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .panel { position: fixed; bottom: 0; left: 0; right: 0; z-index: 50; border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; max-height: 60vh; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.4s ease-in-out; }
        .panel.visible { transform: translateY(0); }
        .panel-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.125rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .panel-content { padding: 1rem; overflow-y: auto; flex-grow: 1; }
        .modal-container { position: fixed; inset: 0; z-index: 100; background-color: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-container.visible { opacity: 1; visibility: visible; }
        .modal-content { padding: 1.5rem; border-radius: 1.5rem; width: 100%; max-width: 24rem; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        .modal-container.visible .modal-content { transform: scale(1); }
        .view { position: fixed; inset: 0; transition: opacity 0.4s, transform 0.4s; will-change: opacity, transform; }
        .view.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .pulse-once { animation: pulse-once 1s ease-out; }
        @keyframes pulse-once { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        #compass-arrow { transition: transform 0.5s ease-out; }
        .unlock-btn { padding: 0.75rem; border-radius: 0.5rem; background-color: rgba(255, 255, 255, 0.1); border: 2px solid transparent; transition: all 0.2s; }
        .unlock-btn.active { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.2); }
        .chat-bubble { max-width: 75%; padding: 0.5rem 1rem; border-radius: 1rem; }
        .chat-bubble-self { background-color: var(--blue); border-bottom-right-radius: 0.25rem; }
        .chat-bubble-other { background-color: #374151; border-bottom-left-radius: 0.25rem; }
    </style>
</head>
<body>

    <audio id="sound-success" src="https://assets.mixkit.co/sfx/preview/mixkit-unlock-game-notification-253.mp3"></audio>
    <audio id="sound-powerup" src="https://assets.mixkit.co/sfx/preview/mixkit-video-game-power-up-3164.mp3"></audio>
    <audio id="sound-click" src="https://assets.mixkit.co/sfx/preview/mixkit-interface-click-1126.mp3"></audio>
    <audio id="sound-start" src="https://assets.mixkit.co/sfx/preview/mixkit-game-start-beeps-2041.mp3"></audio>
    <audio id="sound-message" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3"></audio>
    <audio id="sound-vote" src="https://assets.mixkit.co/sfx/preview/mixkit-quick-positive-video-game-notification-interface-265.mp3"></audio>
    
    <div id="view-onboarding" class="view flex flex-col items-center justify-center p-6"><div class="w-24 h-24 bg-gradient-to-tr from-gray-800 to-gray-900 rounded-3xl flex items-center justify-center shadow-2xl border border-white/10 mb-8"><i class="fa-solid fa-trophy text-5xl text-yellow-400"></i></div><h1 class="text-5xl font-black text-white mb-2">SNAP<span class="text-blue-500">HUNT</span></h1><p class="text-gray-400 text-xs uppercase font-bold tracking-[0.2em] mb-10">Your World is the Game Board</p><div class="bg-white/10 p-2 rounded-2xl mb-6 w-full max-w-xs"><input type="text" id="username-input" class="w-full bg-transparent text-white p-4 text-center font-bold text-xl outline-none" placeholder="ENTER CODENAME"></div><div class="w-full max-w-xs flex flex-col gap-4"><button onclick="app.showHostView()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg active:scale-95 transition-transform shadow-lg shadow-blue-600/30"><i class="fa-solid fa-crown mr-2"></i> CREATE A HUNT</button><button onclick="ui.showModal('modal-join')" class="w-full bg-white/10 text-white py-4 rounded-2xl font-bold text-lg active:scale-95 transition-transform glass"><i class="fa-solid fa-right-to-bracket mr-2"></i> JOIN A HUNT</button><button onclick="host.promptImport()" class="w-full bg-transparent border-2 border-gray-600 text-gray-400 py-3 rounded-2xl font-bold text-sm active:scale-95 transition-transform mt-2"><i class="fa-solid fa-upload mr-2"></i> Import a Hunt (.json)</button></div><button onclick="app.clearData()" class="text-gray-500 text-xs mt-8">Clear Saved Data</button></div>
    <div id="view-host" class="view hidden"><div id="host-creator"><div id="map-editor" class="h-screen w-screen"></div><div id="host-search-container" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-sm flex gap-2 glass p-2 rounded-full"><input type="text" id="host-search-input" placeholder="Search for a location to pin..." class="flex-1 bg-transparent px-4 outline-none text-sm"><button onclick="host.searchLocation()" class="w-10 h-10 bg-blue-600 rounded-full text-white"><i class="fa-solid fa-search"></i></button></div><div class="header-left glass"><button onclick="app.showOnboarding()" class="text-white mr-3"><i class="fa-solid fa-chevron-left"></i></button><input type="text" id="hunt-name-input" class="bg-transparent font-black text-xs tracking-wide outline-none" value="MY NEW HUNT"></div><div class="header-right"><button onclick="ui.showModal('modal-settings')" class="icon-btn glass" title="Settings"><i class="fa-solid fa-gear"></i></button><button onclick="host.shareHunt()" class="icon-btn glass bg-blue-600" title="Share & Invite"><i class="fa-solid fa-share-nodes"></i></button></div><div id="checkpoint-panel" class="panel glass visible"><div class="panel-header"><h3>Checkpoints</h3><span id="checkpoint-count" class="bg-white/20 px-2 py-1 rounded-full text-xs">0</span></div><div id="checkpoint-list" class="panel-content"><div class="text-center p-4 text-gray-400">Tap the map or search to add a checkpoint.</div></div><button onclick="host.startHunt()" class="w-full bg-green-600 text-white p-4 font-bold text-lg rounded-b-2xl flex items-center justify-center gap-2"><i class="fa-solid fa-play"></i> LAUNCH HUNT</button></div></div><div id="host-dashboard" class="hidden"><div id="map-live-host" class="h-screen w-screen"></div><div class="header-left glass"><span class="font-black text-xs tracking-wide text-red-500 mr-2">LIVE</span><span id="live-hunt-name" class="font-bold text-xs"></span></div><div class="header-right"><button onclick="ui.showModal('modal-leaderboard')" class="icon-btn glass"><i class="fa-solid fa-ranking-star"></i></button></div><div class="fixed bottom-4 left-4 right-4 z-50 glass rounded-xl p-2 flex gap-2"><input type="text" id="announce-input" placeholder="Send announcement..." class="flex-1 bg-transparent px-4 outline-none"><button onclick="host.sendAnnouncement()" class="w-10 h-10 bg-blue-600 rounded-full text-white"><i class="fa-solid fa-paper-plane"></i></button></div><button onclick="host.endHunt()" class="absolute bottom-20 left-1/2 -translate-x-1/2 z-50 bg-red-600 text-white font-bold py-3 px-6 rounded-full shadow-lg"><i class="fa-solid fa-flag-checkered mr-2"></i> END HUNT</button></div><div id="host-results" class="hidden p-6 pt-20 h-screen overflow-y-auto"><h2 class="text-4xl font-black text-center mb-2">Hunt Complete!</h2><p class="text-gray-400 text-center mb-6">Review the results and start the Photo Royale.</p><h3 class="font-bold text-lg mb-2">Final Leaderboard</h3><div id="final-leaderboard" class="flex flex-col gap-2 mb-6"></div><div class="flex gap-2"><button onclick="host.startVoting()" class="w-full bg-yellow-500 text-black p-4 font-bold text-lg rounded-xl mb-6 flex items-center justify-center gap-2"><i class="fa-solid fa-gavel"></i> Start Voting</button><button onclick="host.generateMemento()" class="w-full bg-purple-600 text-white p-4 font-bold text-lg rounded-xl mb-6 flex items-center justify-center gap-2"><i class="fa-solid fa-camera-retro"></i> Memento</button></div><h3 class="font-bold text-lg mb-2">Photo Submissions</h3><div id="review-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div></div></div>
    <div id="view-participant" class="view hidden"><div id="participant-lobby" class="flex flex-col items-center justify-center min-h-screen p-6 text-center"><h2 class="text-3xl font-bold" id="lobby-hunt-name"></h2><p class="text-gray-400 mb-6">Waiting for host to start the hunt...</p><div class="w-16 h-16 border-4 border-dashed border-white/20 rounded-full animate-spin mb-8"></div><h3 class="font-bold text-lg mb-2">Participants</h3><div id="participant-list" class="w-full max-w-xs flex flex-col gap-2"></div></div><div id="participant-game" class="hidden"><div id="map-game" class="h-screen w-screen"></div><div class="fixed top-4 left-4 right-4 z-50 flex justify-between items-center"><div class="glass px-3 py-2 rounded-xl text-sm"><span class="font-bold">Score: <span id="player-score">0</span></span></div><div class="flex gap-2"><button onclick="ui.toggleChat()" class="icon-btn glass"><i class="fa-solid fa-comments"></i></button><button onclick="ui.showModal('modal-leaderboard')" class="icon-btn glass"><i class="fa-solid fa-ranking-star"></i></button></div></div><div id="compass-container" class="fixed top-24 left-1/2 -translate-x-1/2 z-40 w-16 h-16 bg-gray-900/50 rounded-full flex items-center justify-center transition-opacity opacity-0"><i id="compass-arrow" class="fa-solid fa-location-arrow text-3xl text-yellow-400"></i></div><div id="clue-card" class="fixed bottom-36 left-4 right-4 z-50 glass p-4 rounded-xl shadow-lg transition-transform"><p class="font-bold text-lg mb-2">Next Checkpoint:</p><p id="clue-text" class="text-gray-300"></p></div><div id="powerup-tray" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-50 flex gap-3"></div><button id="action-button" onclick="participant.performAction()" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-blue-600 text-white w-16 h-16 rounded-full text-2xl shadow-lg shadow-blue-500/50 flex items-center justify-center disabled:bg-gray-500" disabled><i id="action-icon" class="fa-solid fa-location-arrow"></i></button><div id="chat-panel" class="panel glass hidden"><div class="panel-header"><h3>Team Chat</h3><button onclick="ui.toggleChat()"><i class="fa-solid fa-times"></i></button></div><div id="chat-messages" class="panel-content flex flex-col gap-2"></div><div class="p-2 flex gap-2 border-t border-white/10"><input type="text" id="chat-input" placeholder="Message..." class="flex-1 bg-transparent px-4 outline-none"><button onclick="participant.sendMessage()" class="w-10 h-10 bg-blue-600 rounded-full text-white"><i class="fa-solid fa-paper-plane"></i></button></div></div></div><div id="participant-postgame" class="hidden p-6 pt-20 h-screen overflow-y-auto text-center"><h2 class="text-4xl font-black">HUNT COMPLETE!</h2><p class="text-xl text-yellow-400 mb-6">Your final rank: #<span id="final-rank"></span></p><div id="postgame-leaderboard" class="mb-8"></div><div id="voting-area" class="hidden"><h3 class="text-2xl font-bold mb-2">Photo Royale!</h3><p class="mb-2">Vote for the best photo from:</p><p id="voting-checkpoint-name" class="font-bold text-lg mb-4"></p><div id="voting-gallery" class="flex overflow-x-auto snap-x snap-mandatory gap-4 p-4 -mx-6"></div></div><div id="waiting-for-voting" class="text-gray-400">Waiting for Host to start the voting round...</div></div></div>
    <div id="view-memento" class="view hidden p-6 pt-12 h-screen overflow-y-auto bg-gray-800"><div class="text-center mb-6"><h1 class="text-4xl font-black" id="memento-title"></h1><p class="text-gray-400">A SnapHunt Adventure</p></div><h3 class="font-bold text-lg mb-2">Final Results</h3><div id="memento-leaderboard" class="flex flex-col gap-2 mb-6"></div><h3 class="font-bold text-lg mb-2">Winning Photos</h3><div id="memento-gallery" class="grid grid-cols-1 gap-4"></div><div class="fixed top-4 right-4"><button onclick="app.showOnboarding()" class="icon-btn glass"><i class="fa-solid fa-times"></i></button></div></div>
    <div id="modal-join" class="modal-container"><div class="glass modal-content"><h3 class="text-xl font-bold mb-4">Join a Hunt</h3><p class="text-gray-400 text-sm mb-4">Enter the 6-digit Hunt Code.</p><div class="bg-white/10 p-2 rounded-xl mb-4"><input type="text" id="join-code-input" class="w-full bg-transparent text-white p-2 text-center font-bold text-2xl tracking-[.5em] uppercase outline-none" placeholder="______" maxlength="6"></div><button onclick="app.joinHunt()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg">LET'S GO!</button></div></div>
    <div id="modal-checkpoint-editor" class="modal-container"><div class="glass modal-content max-w-md"><h3 class="text-xl font-bold mb-4">Edit Checkpoint</h3><textarea id="clue-input" class="w-full bg-white/10 p-3 rounded-lg mb-4 outline-none" rows="3" placeholder="Enter clue or riddle..."></textarea><h4 class="font-bold mb-2">Unlock Method</h4><div class="grid grid-cols-3 gap-2 mb-4"><button data-method="geo" class="unlock-btn"><i class="fa-solid fa-location-dot"></i> Geo-fence</button><button data-method="photo" class="unlock-btn"><i class="fa-solid fa-camera"></i> Photo</button><button data-method="qr" class="unlock-btn"><i class="fa-solid fa-qrcode"></i> QR Code</button></div><div id="photo-prompt-container" class="hidden mb-4"><input type="text" id="photo-prompt-input" class="w-full bg-white/10 p-3 rounded-lg outline-none" placeholder="Photo prompt (e.g., Take a team selfie!)"></div><div class="flex gap-2"><button onclick="host.deleteCheckpoint()" class="w-1/3 bg-red-600/50 text-white py-3 rounded-xl font-bold">Delete</button><button onclick="host.saveCheckpoint()" class="w-2/3 bg-blue-600 text-white py-3 rounded-xl font-bold">SAVE</button></div></div></div>
    <div id="modal-settings" class="modal-container"><div class="glass modal-content"><h3 class="text-xl font-bold mb-4">Hunt Settings</h3><h4 class="font-bold mb-2 text-left">Game Mode</h4><div class="flex flex-col gap-2 text-left"><label class="bg-white/10 p-3 rounded-lg flex items-center"><input type="radio" name="gameMode" value="linear" class="mr-3" checked><div><p class="font-bold">Linear</p><p class="text-xs text-gray-400">Checkpoints must be completed in order.</p></div></label><label class="bg-white/10 p-3 rounded-lg flex items-center"><input type="radio" name="gameMode" value="scramble" class="mr-3"><div><p class="font-bold">Scramble</p><p class="text-xs text-gray-400">All checkpoints are available from the start.</p></div></label></div><div class="flex gap-2 mt-4"><button onclick="host.exportHunt()" class="w-1/2 bg-gray-600 text-white py-3 rounded-xl font-bold">Export</button><button onclick="host.saveSettings()" class="w-1/2 bg-blue-600 text-white py-3 rounded-xl font-bold">Save</button></div></div></div>
    <div id="modal-leaderboard" class="modal-container"><div class="glass modal-content"><h3 class="text-xl font-bold mb-4">Leaderboard</h3><div id="leaderboard-content" class="flex flex-col gap-2"></div></div></div>
    <div id="modal-camera" class="fixed inset-0 z-[110] bg-black hidden flex-col"><video id="camera-feed" class="w-full h-full object-cover" autoplay></video><div id="photo-prompt-overlay" class="absolute top-6 left-1/2 -translate-x-1/2 glass px-4 py-2 rounded-full text-sm font-bold"></div><button onclick="participant.takePhoto()" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-20 h-20 bg-white rounded-full border-4 border-black/50 active:scale-95"></button><button onclick="ui.hide('modal-camera')" class="absolute top-6 left-6 text-white text-3xl bg-black/30 w-12 h-12 rounded-full"><i class="fa-solid fa-times"></i></button></div>
    <div id="modal-qr-scanner" class="fixed inset-0 z-[110] bg-black hidden flex-col items-center justify-center"><p class="text-2xl font-bold mb-4">Scanning QR Code...</p><div class="w-64 h-64 border-4 border-white rounded-lg relative overflow-hidden"><div class="absolute top-0 w-full h-1 bg-green-400 animate-ping"></div></div><button onclick="ui.hide('modal-qr-scanner')" class="absolute top-6 left-6 text-white text-3xl bg-black/30 w-12 h-12 rounded-full"><i class="fa-solid fa-times"></i></button></div>
    <div id="modal-qr-share" class="modal-container"><div class="bg-white p-8 rounded-[32px] text-center" onclick="event.stopPropagation()"><div id="qrcode-display" class="flex justify-center p-2 mb-4"></div><p class="text-black font-bold text-lg">Scan to Join Hunt</p><p id="qr-code" class="text-gray-600 font-mono text-2xl tracking-widest my-2"></p></div><button onclick="app.copyLink(event)" class="mt-4 bg-white text-black px-6 py-3 rounded-full font-bold text-lg">Copy Invite Link</button></div>
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-all pointer-events-none -translate-y-4 z-[200]"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // ===================================================================
    //  APPLICATION JAVASCRIPT - FULL IMPLEMENTATION
    // ===================================================================

    const Utils = {
        vibrate: (duration = 50) => { if (navigator.vibrate) navigator.vibrate(duration); }
    };
    const SoundManager = { play: id => { Utils.vibrate(20); document.getElementById(id)?.play(); } };
    const EventBus = {
        events: {},
        on(event, listener) { this.events[event] = this.events[event] || []; this.events[event].push(listener); },
        emit(event, data) { if (this.events[event]) { this.events[event].forEach(listener => listener(data)); } }
    };

    const state = {
        currentUser: null, currentView: 'onboarding', huntData: null, playerState: {}, mapInstances: {}, geolocationWatcher: null,
        createEmptyHunt: () => ({ id: 'SNAP' + Math.random().toString(36).substr(2, 4).toUpperCase(), name: "My New Hunt", gameMode: 'linear', checkpoints: [], participants: {}, submissions: {} }),
        resetPlayerState: () => { state.playerState = { score: 0, powerups: [], completedCheckpoints: [], scoreMultiplier: 1 }; }
    };

    const ui = {
        showView(viewId) { state.currentView = viewId; document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); const viewEl = document.getElementById(viewId); viewEl.classList.remove('hidden'); },
        showModal(modalId) { const el = document.getElementById(modalId); el.classList.add('visible'); SoundManager.play('sound-click'); if(modalId === 'modal-leaderboard') this.renderLeaderboard(); },
        hideModal(modalId) { document.getElementById(modalId).classList.remove('visible'); },
        show(elementId) { document.getElementById(elementId).classList.remove('hidden'); },
        hide(elementId) { document.getElementById(elementId).classList.add('hidden'); },
        updateText(elementId, text) { document.getElementById(elementId).innerText = text; },
        toast(message, isPowerup = false) { const el = document.getElementById('toast'); el.textContent = message; el.style.backgroundColor = isPowerup ? 'var(--yellow)' : ''; el.style.color = isPowerup ? 'black' : 'white'; el.classList.remove('opacity-0', '-translate-y-4'); setTimeout(() => el.classList.add('opacity-0', '-translate-y-4'), 3000); },
        renderCheckpointList(checkpoints) { const listEl = document.getElementById('checkpoint-list'); document.getElementById('checkpoint-count').innerText = checkpoints.length; if (checkpoints.length === 0) { listEl.innerHTML = `<div class="text-center p-4 text-gray-400">Tap the map or search to add a checkpoint.</div>`; return; } listEl.innerHTML = checkpoints.map((cp, index) => `<div class="flex items-center p-3 bg-white/5 rounded-lg cursor-pointer" onclick="host.editCheckpoint(${index})"><div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold mr-3">${index + 1}</div><div class="flex-1 text-sm truncate">${cp.clue || 'Untitled Checkpoint'}</div><i class="fa-solid fa-${cp.unlockMethod === 'geo' ? 'location-dot' : cp.unlockMethod === 'photo' ? 'camera' : 'qrcode'} text-gray-400"></i></div>`).join(''); },
        renderParticipantList() { const listEl = document.getElementById('participant-list'); const participants = Object.values(state.huntData.participants); if (participants.length === 0) { listEl.innerHTML = `<div class="text-gray-400">You're the first one here!</div>`; return; } listEl.innerHTML = participants.map(p => `<div class="glass p-3 rounded-lg font-bold">${p.name}</div>`).join(''); },
        renderLeaderboard() { const content = document.getElementById('leaderboard-content'); const participants = Object.values(state.huntData.participants).sort((a,b) => b.score - a.score); content.innerHTML = participants.map((p, i) => `<div class="flex items-center p-2 bg-white/5 rounded-lg"><span class="font-bold w-8">${i+1}</span><span>${p.name}</span><span class="ml-auto font-bold">${p.score}</span></div>`).join(''); },
        renderPowerups() { document.getElementById('powerup-tray').innerHTML = state.playerState.powerups.map(p => `<button onclick="participant.usePowerup('${p}')" class="w-12 h-12 glass rounded-full text-xl text-yellow-400"><i class="fa-solid fa-${p==='hint'?'lightbulb':p==='compass'?'compass':'bolt'}"></i></button>`).join(''); },
        toggleChat() { document.getElementById('chat-panel').classList.toggle('visible'); }
    };

    const mapManager = {
        playerMarker: null,
        create(id) { if(state.mapInstances[id]) { state.mapInstances[id].invalidateSize(); return; } const map = L.map(id, { zoomControl: false }).setView([29.89, -81.31], 14); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB'}).addTo(map); state.mapInstances[id] = map; if(id==='editor') { map.on('click', (e) => host.addCheckpoint(e.latlng)); } return map; },
        renderMarkers(id) { const map = state.mapInstances[id]; if(!map) return; map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); }); state.huntData.checkpoints.forEach((cp, index) => { const isCompleted = state.playerState.completedCheckpoints?.includes(index); const isNext = state.activeCheckpointIndex === index; if (id === 'game' && state.huntData.gameMode === 'linear' && !isNext && !isCompleted) return; const marker = L.marker([cp.lat, cp.lng], { opacity: isCompleted ? 0.5 : 1 }).addTo(map); if (id === 'editor') marker.on('click', () => host.editCheckpoint(index)); }); },
        startGeo() { if(navigator.geolocation) { state.geolocationWatcher = navigator.geolocation.watchPosition(pos => { const latlng = [pos.coords.latitude, pos.coords.longitude]; if(this.playerMarker) { this.playerMarker.setLatLng(latlng); } else { this.playerMarker = L.circle(latlng, { radius: 20, color: 'var(--blue)', fillOpacity: 0.8 }).addTo(state.mapInstances.game); } state.mapInstances.game.panTo(latlng); }); } },
        stopGeo() { if(state.geolocationWatcher) navigator.geolocation.clearWatch(state.geolocationWatcher); },
        activateCompass() { ui.toast('Compass Activated!'); document.getElementById('compass-container').classList.remove('opacity-0'); setTimeout(() => document.getElementById('compass-container').classList.add('opacity-0'), 10000); }
    };

    const host = {
        editingCheckpointIndex: -1,
        init() { state.huntData = JSON.parse(localStorage.getItem('snapHuntData')) || state.createEmptyHunt(); ui.showView('view-host'); setTimeout(() => { const map = mapManager.create('editor'); map.invalidateSize(); this.updateUI(); mapManager.renderMarkers('editor'); }, 100); },
        updateUI() { document.getElementById('hunt-name-input').value = state.huntData.name; ui.renderCheckpointList(state.huntData.checkpoints); document.querySelector(`input[name="gameMode"][value="${state.huntData.gameMode}"]`).checked = true; },
        addCheckpoint(latlng) { state.huntData.checkpoints.push({lat: latlng.lat, lng: latlng.lng, clue:'', unlockMethod:'geo', photoPrompt:''}); this.editCheckpoint(state.huntData.checkpoints.length-1); mapManager.renderMarkers('editor'); },
        editCheckpoint(index) { this.editingCheckpointIndex = index; const cp = state.huntData.checkpoints[index]; document.getElementById('clue-input').value = cp.clue; document.getElementById('photo-prompt-input').value = cp.photoPrompt; document.querySelectorAll('.unlock-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.method === cp.unlockMethod); }); document.getElementById('photo-prompt-container').classList.toggle('hidden', cp.unlockMethod !== 'photo'); ui.showModal('modal-checkpoint-editor'); },
        saveCheckpoint() { if(this.editingCheckpointIndex < 0) return; const cp = state.huntData.checkpoints[this.editingCheckpointIndex]; cp.clue = document.getElementById('clue-input').value; cp.photoPrompt = document.getElementById('photo-prompt-input').value; cp.unlockMethod = document.querySelector('.unlock-btn.active').dataset.method; this.saveAndCloseEditor(); },
        deleteCheckpoint() { state.huntData.checkpoints.splice(this.editingCheckpointIndex, 1); this.saveAndCloseEditor(); },
        saveAndCloseEditor() { ui.hideModal('modal-checkpoint-editor'); this.editingCheckpointIndex = -1; this.updateUI(); mapManager.renderMarkers('editor'); localStorage.setItem('snapHuntData', JSON.stringify(state.huntData)); },
        saveSettings() { state.huntData.name = document.getElementById('hunt-name-input').value; state.huntData.gameMode = document.querySelector('input[name="gameMode"]:checked').value; localStorage.setItem('snapHuntData', JSON.stringify(state.huntData)); ui.hideModal('modal-settings'); ui.toast('Settings Saved!'); },
        shareHunt() { ui.updateText('qr-code', state.huntData.id); const qrEl = document.getElementById('qrcode-display'); qrEl.innerHTML = ''; new QRCode(qrEl, { text: `${location.origin}${location.pathname}?hunt=${state.huntData.id}`, width: 200, height: 200 }); ui.showModal('modal-qr-share'); },
        startHunt() { if (state.huntData.checkpoints.length === 0) { ui.toast("Add at least one checkpoint!"); return; } SoundManager.play('sound-start'); ui.hide('host-creator'); ui.show('host-dashboard'); setTimeout(() => { mapManager.create('live-host'); }, 100); ui.updateText('live-hunt-name', state.huntData.name); EventBus.emit('HUNT_STARTED', state.huntData); },
        endHunt() { EventBus.emit('HUNT_ENDED'); ui.hide('host-dashboard'); ui.show('host-results'); ui.renderLeaderboard(); },
        startVoting() { EventBus.emit('VOTING_STARTED'); ui.toast('Voting has begun!'); SoundManager.play('sound-vote'); },
        sendAnnouncement() { const msg = document.getElementById('announce-input').value; if(msg) { EventBus.emit('ANNOUNCEMENT', msg); ui.toast('Announcement Sent!'); document.getElementById('announce-input').value = ''; } },
        exportHunt() { const huntDataString = JSON.stringify(state.huntData, null, 2); const blob = new Blob([huntDataString], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `snaphunt-${state.huntData.id}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); ui.toast('Hunt data exported!'); },
        promptImport() { if (!app.validateUsername()) return; const input = document.createElement('input'); input.type = 'file'; input.accept = '.json,application/json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = event => { try { const importedData = JSON.parse(event.target.result); if (importedData.id && importedData.name && Array.isArray(importedData.checkpoints)) { state.huntData = importedData; localStorage.setItem('snapHuntData', JSON.stringify(state.huntData)); ui.toast('Hunt imported successfully!'); app.showHostView(); } else { ui.toast('Invalid hunt file format.'); } } catch (error) { ui.toast('Error reading or parsing file.'); console.error("Import Error:", error); } }; reader.readAsText(file); }; input.click(); },
        async searchLocation() { const query = document.getElementById('host-search-input').value; if (!query) return; ui.toast('Searching...'); try { const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`); const data = await response.json(); if (data && data.length > 0) { const { lat, lon } = data[0]; const map = state.mapInstances.editor; map.setView([lat, lon], 17); L.circle([lat, lon], { radius: 50, color: 'var(--yellow)' }).addTo(map); ui.toast('Location found! Tap to pin.'); } else { ui.toast('Location not found.'); } } catch (error) { ui.toast('Search failed.'); console.error(error); } },
        generateMemento() { ui.updateText('memento-title', state.huntData.name); document.getElementById('memento-leaderboard').innerHTML = document.getElementById('leaderboard-content').innerHTML; ui.showView('view-memento'); }
    };
    
    const participant = {
        init(huntData) { state.huntData = huntData; state.resetPlayerState(); state.huntData.participants[state.currentUser] = { name: state.currentUser, score: 0 }; ui.showView('view-participant'); ui.updateText('lobby-hunt-name', state.huntData.name); ui.renderParticipantList(); EventBus.emit('PLAYER_JOINED', state.currentUser); },
        handleHuntStart() { SoundManager.play('sound-start'); ui.hide('participant-lobby'); ui.show('participant-game'); setTimeout(() => { mapManager.create('game'); mapManager.startGeo(); this.loadNextCheckpoint(); }, 100); },
        loadNextCheckpoint() { if (state.huntData.gameMode === 'linear') { state.activeCheckpointIndex = state.playerState.completedCheckpoints.length; } else { state.activeCheckpointIndex = state.huntData.checkpoints.findIndex((c,i) => !state.playerState.completedCheckpoints.includes(i)); } if(state.activeCheckpointIndex === -1) { this.handleHuntEnd(); return; } const cp = state.huntData.checkpoints[state.activeCheckpointIndex]; ui.updateText('clue-text', cp.clue); const actionIcon = document.getElementById('action-icon').classList; actionIcon.remove('fa-location-arrow', 'fa-camera', 'fa-qrcode'); if (cp.unlockMethod === 'geo') actionIcon.add('fa-location-arrow'); if (cp.unlockMethod === 'photo') actionIcon.add('fa-camera'); if (cp.unlockMethod === 'qr') actionIcon.add('fa-qrcode'); mapManager.renderMarkers('game'); setTimeout(() => { document.getElementById('action-button').disabled = false; document.getElementById('action-button').classList.add('pulse-once'); }, 4000); },
        performAction() { Utils.vibrate(100); const cp = state.huntData.checkpoints[state.activeCheckpointIndex]; if (cp.unlockMethod === 'photo') { ui.updateText('photo-prompt-overlay', cp.photoPrompt); ui.show('modal-camera'); } else if (cp.unlockMethod === 'qr') { ui.showModal('modal-qr-scanner'); setTimeout(() => { ui.hideModal('modal-qr-scanner'); this.completeCheckpoint(); }, 2000); } else { this.completeCheckpoint(); } },
        takePhoto() { ui.hide('modal-camera'); this.completeCheckpoint(true); },
        completeCheckpoint(isPhoto = false) { SoundManager.play('sound-success'); const points = 100 * state.playerState.scoreMultiplier; state.playerState.score += points; state.playerState.scoreMultiplier = 1; state.playerState.completedCheckpoints.push(state.activeCheckpointIndex); ui.updateText('player-score', state.playerState.score); ui.toast(`Checkpoint Complete! +${points} points`); EventBus.emit('SCORE_UPDATE', { name: state.currentUser, score: state.playerState.score }); if (Math.random() < 0.5) { this.awardPowerup(); } document.getElementById('action-button').disabled = true; this.loadNextCheckpoint(); },
        awardPowerup() { const powers = ['hint', 'compass', 'bolt']; const p = powers[Math.floor(Math.random() * powers.length)]; state.playerState.powerups.push(p); ui.renderPowerups(); ui.toast('Power-up Awarded!', true); SoundManager.play('sound-powerup'); },
        usePowerup(power) { Utils.vibrate(); state.playerState.powerups.splice(state.playerState.powerups.indexOf(power), 1); ui.renderPowerups(); if(power==='hint') { ui.toast(`Hint: The clue relates to "${state.huntData.checkpoints[state.activeCheckpointIndex].clue.split(' ')[2]}"`); } if(power==='compass') { mapManager.activateCompass(); } if(power==='bolt') { state.playerState.scoreMultiplier = 2; ui.toast('Score Doubler Active!'); } },
        handleHuntEnd() { mapManager.stopGeo(); ui.hide('participant-game'); ui.show('participant-postgame'); },
        sendMessage() { const input = document.getElementById('chat-input'); const message = input.value.trim(); if (!message) return; const messagesEl = document.getElementById('chat-messages'); messagesEl.innerHTML += `<div class="flex justify-end"><div class="chat-bubble chat-bubble-self">${message}</div></div>`; input.value = ''; messagesEl.scrollTop = messagesEl.scrollHeight; SoundManager.play('sound-message'); EventBus.emit('CHAT_MESSAGE', { user: state.currentUser, message }); setTimeout(() => { messagesEl.innerHTML += `<div class="flex justify-start"><div class="chat-bubble chat-bubble-other">Got it! On my way.</div></div>`; messagesEl.scrollTop = messagesEl.scrollHeight; SoundManager.play('sound-message'); }, 2000); }
    };

    const app = {
        init() { state.currentUser = localStorage.getItem('snapHuntUser'); if(state.currentUser) document.getElementById('username-input').value = state.currentUser; EventBus.on('HUNT_STARTED', (data) => participant.handleHuntStart(data)); EventBus.on('HUNT_ENDED', () => participant.handleHuntEnd()); EventBus.on('PLAYER_JOINED', (name) => { if(state.huntData) { state.huntData.participants[name] = { name, score: 0 }; ui.toast(`${name} has joined!`); if(state.currentView === 'participant-lobby') ui.renderParticipantList(); } }); EventBus.on('SCORE_UPDATE', ({name, score}) => { if(state.huntData) state.huntData.participants[name].score = score; }); EventBus.on('ANNOUNCEMENT', (msg) => ui.toast(`Host: ${msg}`)); },
        validateUsername() { const name = document.getElementById('username-input').value.trim(); if(!name) { ui.toast("Please enter a codename!"); return false; } state.currentUser = name; localStorage.setItem('snapHuntUser', name); return true; },
        showHostView() { if(!this.validateUsername()) return; host.init(); },
        joinHunt() { if(!this.validateUsername()) return; const code = document.getElementById('join-code-input').value.toUpperCase(); const storedHunt = JSON.parse(localStorage.getItem('snapHuntData')); if (storedHunt && storedHunt.id === code) { ui.hideModal('modal-join'); participant.init(storedHunt); } else { ui.toast("Invalid Hunt Code!"); } },
        clearData() { localStorage.removeItem('snapHuntData'); localStorage.removeItem('snapHuntUser'); ui.toast('Saved data cleared.'); location.reload(); },
        showOnboarding() { location.reload(); },
        copyLink() { navigator.clipboard.writeText(`${location.href}?hunt=${state.huntData.id}`).then(() => ui.toast("Invite Link Copied!")); }
    };

    window.addEventListener('load', () => app.init());
    </script>
</body>
</html>