<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdReports 2.0 Review Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link rel="stylesheet" href="styles.css"/>
    <!-- TinyMCE Rich Text Editor -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@7/tinymce.min.js" referrerpolicy="origin"></script>

	<script type="module">
        // --- Configuration ---
        // IMPORTANT: Replace "YOUR_GEMINI_API_KEY" with your actual API key.
        // For production, this key should be managed securely (e.g., via a backend proxy) and not exposed client-side.
        const GEMINI_API_KEY = "AIzaSyC70cXxItO4NGCEWo2B9lM9ZfbBSepASRM"; // <-- REPLACE THIS with your actual API key

        // --- Initialize global rubrics object ---
        // This object will be populated by individual rubric JS files.
        if (!window.rubrics) {
		    window.rubrics = {};
		};

        // --- Promise for SDK Initialization ---
        // Creates a promise that the main application (app.js) can await
        // to ensure the AI SDK is loaded (or load attempt has completed) before proceeding.
        window.sdkInitializationPromise = new Promise(async (resolve) => {
            window.genAiInstance = null; // Initialize to null; will be set upon successful SDK load

            try {
                if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY") {
                    console.warn("[SDK Loader] Gemini API Key not configured in HTML. AI features will be disabled.");
                    // Resolve the promise even if API key is missing, so the app doesn't hang.
                    // The app.js (initializeAI) will handle the null genAiInstance.
                    resolve();
                    return;
                }

                // Original SDK URL and instantiation pattern
                const sdkUrl = "https://cdn.jsdelivr.net/npm/@google/genai@0.9.0/dist/web/index.mjs";
                console.log(`[SDK Loader] Attempting to load Google AI SDK from: ${sdkUrl}`);
                const module = await import(sdkUrl); // Load the SDK module
                const AiClass = module.GoogleGenerativeAI || module.GoogleGenAI; // Check for expected class

                if (AiClass) {
                    console.log("[SDK Loader] SDK Class loaded successfully.");
                    try {
                        // Instantiate the AI SDK with the API key
                        window.genAiInstance = new AiClass({apiKey:GEMINI_API_KEY});
                        console.log("[SDK Loader] Google AI SDK instance created and attached to window.genAiInstance.");
                    } catch (instantiationError) {
                        console.error("[SDK Loader] Error instantiating Google AI SDK:", instantiationError);
                        // genAiInstance will remain null if instantiation fails
                         if (instantiationError.message && instantiationError.message.includes('API_KEY_INVALID')) {
                             console.error("[SDK Loader] API Key appears invalid.");
                         }
                    }
                } else {
                    console.error(`[SDK Loader] Loaded Google AI SDK module from ${sdkUrl}, but couldn't find expected class.`);
                }
            } catch (err) {
                console.error("[SDK Loader] Failed to load Google AI SDK module:", err);
            } finally {
                // --- IMPORTANT ---
                // Resolve the promise *after* attempting SDK load/instantiation,
                // regardless of success or failure. This unblocks app.js.
                console.log("[SDK Loader] Resolving SDK initialization promise.");
                resolve();
            }
        });
    </script>

    <!-- Load Rubric Data Files -->
    <!-- Each file defines a rubric object and adds it to window.rubrics -->
    <script src="rubrics/science-k5.js"></script>
	<script src="rubrics/science-68.js"></script>
	<script src="rubrics/science-912.js"></script>
    <script src="rubrics/ela-k2.js"></script>
	<script src="rubrics/mll-science-k12.js"></script>
    <!-- Add other rubric data files here as needed -->


    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- For PDF generation (if used in export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script> <!-- For Markdown to HTML conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script> <!-- For HTML sanitization -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> <!-- For saving files (e.g., exports) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- For capturing HTML as image (if used) -->

</head>
<body>
    <!-- Application Header: Contains logo, rubric selector, AI model selector, and main action buttons -->
    <header>
        <div class="logo-container">
            <h1>EdReports 2.0 Review Tool</h1>
        </div>
        <div class="actions">
			<div class="ai-controls"> <!-- Grouping for rubric and AI model selection -->
                 <label for="rubricSelector" style="margin-right: 5px; vertical-align: middle;">Rubric:</label>
                 <select id="rubricSelector" class="form-control small" title="Select Rubric">
                     <!-- Rubric options will be populated by app.js -->
                 </select>
				 <label for="aiModelSelectorIndicator" style="margin-left: 10px; margin-right: 5px; vertical-align: middle;">AI Model:</label>
				 <select id="aiModelSelectorIndicator" class="aiModelSelectorIndicator form-control small" title="Select AI model for indicator analysis">
					 <!-- AI Model options for indicator analysis -->
					 <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
					 <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
					 <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
				 </select>
			 </div>
             <!-- Main action buttons -->
			<button id="loadPdfBtn" class="btn secondary">Manage & Load PDFs</button>
			<button id="saveBtn" class="btn primary">Save Review</button>
			<button id="importReviewBtn" class="btn secondary">Import HTML</button>
            <div class="dropdown">
                <button id="exportBtn" class="btn secondary">Export</button>
					<div class="dropdown-content">
						<a href="#" id="exportHTML">Export as HTML</a>
						<!-- Add other export options here -->
					</div>
            </div>
            <button id="newReviewBtn" class="btn secondary">New Review</button>
            <button id="loadReviewBtn" class="btn secondary">Load Review</button>
        </div>
    </header>

    <!-- Main Content Area: Holds review metadata and dynamic rubric content -->
    <main>
        <!-- Section for displaying and editing review metadata like title, publisher, etc. -->
        <section class="review-metadata">
            <h2>Review Information</h2>
            <button class="review-metadata-toggle">▼</button> <!-- Toggle visibility of metadata grid -->
            <div class="review-metadata-grid">
                <div class="form-group">
                    <label for="reviewTitle">Title of Material:</label>
                    <input type="text" id="reviewTitle" class="form-control">
                </div>
                <div class="form-group">
                    <label for="publisher">Publisher:</label>
                    <input type="text" id="publisher" class="form-control">
                </div>
                <div class="form-group">
                    <label for="gradeLevel">Grade Level:</label>
                    <select id="gradeLevel" class="form-control">
                        <!-- Grade level options populated by app.js based on selected rubric -->
                        <option value="">Select Grade Level</option>
                        <!-- Example static options (will be overridden if rubric defines them) -->
                        <option value="K">Grade K</option>
                        <option value="1">Grade 1</option>
                        <!-- ... more grades ... -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="reviewDate">Review Date:</label>
                    <input type="date" id="reviewDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="reviewerName">Reviewer Name:</label>
                    <input type="text" id="reviewerName" class="form-control">
                </div>
            </div>
        </section>

        <!-- Rubric Content will be dynamically loaded here by ui.js -->
        <section class="review-content">
            <div id="rubricContent">
                Loading rubric structure...
            </div>
        </section>
    </main>

    <!-- Modals for Core Functionality -->

    <!-- Modal for loading previously saved reviews -->
    <div id="loadReviewModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Load Saved Review</h2>
            <div id="savedReviewsList">
                <!-- List of saved reviews will be populated here by app.js -->
            </div>
        </div>
    </div>

    <!-- Modal for managing and loading PDF files for AI analysis -->
    <div id="loadPdfModal" class="modal">
        <div class="modal-content large">
            <span class="close" id="closePdfModalBtn">×</span>
            <h2>Manage & Load PDFs for AI Analysis</h2>
            <div class="pdf-add-section">
                <h4>Add New PDF</h4>
                <div class="form-group">
                    <label for="pdfUrlInput">Load from URL:</label>
                    <input type="url" id="pdfUrlInput" class="form-control" placeholder="Enter PDF URL">
                </div>
                <div style="text-align: center; margin: 5px 0;">OR</div>
                <div class="form-group">
                    <label for="pdfFileInput">Load from Local File:</label>
                    <input type="file" id="pdfFileInput" accept="*/*">
                </div>
                <button id="addPdfConfirmBtn" class="btn primary small">Add PDF</button>
                 <span id="pdfAddStatus" style="margin-left: 10px; font-style: italic;">
                     <!-- Status messages for PDF adding -->
                 </span>
            </div>
            <hr style="margin: 20px 0;">
            <div class="pdf-manage-section">
                <h4>Loaded PDFs</h4>
                <div id="loadedPdfsList" class="loaded-pdfs-list">
                    <p>No PDFs loaded yet.</p>
                    <!-- List of loaded PDFs will be populated here by pdf.js/app.js -->
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                 <button id="closePdfModalBtnBottom" class="btn secondary">Close</button>
            </div>
             <p style="margin-top: 15px; font-size: 0.9em; color: #777;">
                AI features analyze ALL loaded PDFs. When you save a review, the current set of loaded PDFs will be saved with it.
            </p>
        </div>
    </div>

    <!-- Floating button to open the AI Chat Query Modal -->
    <button id="floatingQueryBtn" class="floating-btn" title="Ask AI about loaded PDFs">
        <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Modal for AI chat queries about loaded PDFs -->
    <div id="chatQueryModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeChatQueryModalBtn">×</span>
            <h2>Chat with AI about Loaded PDFs</h2>
            <p class="ai-note">(Your questions will be applied to ALL currently loaded PDFs. You can also add specific indicator context.)</p>
            
            <!-- Area to display selected indicator context for the chat -->
            <div id="chatSelectedIndicatorContext" class="chat-selected-context">
                <!-- Context from selected indicators will be rendered here by app.js -->
            </div>

            <div id="chatLog" class="chat-log">
                <!-- Chat messages (user and AI) will be appended here by app.js -->
            </div>
            <div class="form-group">
                <label for="chatQueryInput">Your Message:</label>
                <textarea id="chatQueryInput" class="form-control" rows="3" placeholder="Type your question here..."></textarea>
            </div>
            <div class="form-group" id="chatControls">
                <label for="aiModelSelectorChat">AI Model:</label>
                <select id="aiModelSelectorChat" class="form-control small" title="Select AI model for chat queries">
                    <!-- AI Model options for chat -->
					 <option value="gemini-2.5-pro" selected>Gemini 2.5 Pro</option>
					 <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
					 <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                </select>
                <button id="submitChatQueryBtn" class="btn primary">Send</button>
                <button id="clearBtn" class="btn secondary" title="Clear chat history">Clear Chat</button>
                <button id="addIndicatorContextBtn" class="btn secondary small" title="Add context from specific indicators to your query">Add Indicator Context</button>
            </div>
            <div id="chatQuerySpinner" style="display: none; margin-top: 10px; text-align: center;">
                <i class="fas fa-spinner fa-spin"></i> Thinking... <!-- Spinner, managed by app.js -->
            </div>
        </div>
    </div>

    <!-- Modal for Selecting Indicators to Add Context to Chat -->
    <div id="selectIndicatorForChatModal" class="modal">
        <div class="modal-content large">
            <span class="close" id="closeSelectIndicatorForChatModalBtn">×</span>
            <h3>Select Indicators to Add Context to Chat</h3>
            <p>Select one or more indicators. Their title, criteria, and current evidence will be added to your next chat query.</p>
            <div id="indicatorForChatListContainer">
                <div id="indicatorForChatList" class="indicator-chat-list">
                    <!-- Indicator checkboxes will be populated here by app.js -->
                    <p>Loading indicators...</p>
                </div>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button id="cancelSelectIndicatorBtn" class="btn secondary">Cancel</button>
                <button id="addSelectedIndicatorsToChatBtn" class="btn primary">Add Selected to Chat</button>
            </div>
        </div>
    </div>

    <!-- Modal for viewing PDFs -->
	<div id="pdfViewerModal" class="modal pdf-viewer-modal">
		<div class="modal-content large pdf-viewer-content">
			<span class="close" id="closePdfViewerModalBtn">×</span>
			<h3 id="pdfViewerTitle">PDF Viewer</h3> <!-- Title can be updated by JS with PDF name -->
			<div class="pdf-iframe-container">
				<iframe id="pdfViewerIframe" src="about:blank" frameborder="0"></iframe>
			</div>
		</div>
	</div>

    <!-- Modal for displaying larger views of images -->
	<div id="imageViewerModal" class="image-viewer-modal">
		<span class="image-viewer-close">×</span>
		<img class="image-viewer-content" id="viewerImage" alt="Enlarged view">
	</div>

    <!-- Modal for providing custom instructions for AI analysis of an indicator -->
    <div id="aiInstructionModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAiInstructionModalBtn">×</span>
            <h3>Custom AI Instructions for Analysis</h3>
            <p>Provide specific instructions or context for the AI to consider when analyzing the selected indicator.</p>
            <p id="indicatorTitleDisplay">Analyzing: <strong>Indicator X.Y</strong></p> <!-- Updated by JS -->
            <div class="form-group">
                <label for="aiCustomInstruction">Instructions:</label>
                <!-- TinyMCE will be initialized on this textarea -->
                <textarea id="aiCustomInstruction" placeholder="e.g., Focus on student activities related to modeling. Ignore teacher notes."></textarea>
            </div>
            <div class="modal-actions">
                <button id="cancelAiInstructionBtn" class="btn secondary">Cancel</button>
                <button id="startAnalysisWithInstructionBtn" class="btn primary">Start Analysis</button>
            </div>
        </div>
    </div>

    <!-- NEW: Modal for displaying the Evidence Guide -->
    <div id="evidenceGuideModal" class="modal">
        <div class="modal-content large">
            <span class="close" id="closeEvidenceGuideModalBtn">×</span>
            <h2 id="evidenceGuideTitle">Evidence Guide</h2>
            <div id="evidenceGuideContent" class="evidence-guide-content">
                <!-- Content will be populated dynamically by app.js -->
            </div>
            <div class="modal-actions">
                <button id="closeEvidenceGuideModalBtnBottom" class="btn secondary">Close</button>
            </div>
        </div>
    </div>


<!-- Application-specific JavaScript files -->
<script src="db.js"></script>           <!-- IndexedDB interactions -->
<script src="ai-analyzer.js"></script> <!-- AI analysis logic -->
<script src="utils.js"></script>         <!-- Utility functions -->
<script src="ui.js"></script>            <!-- UI rendering and interactions specific to rubric structure -->
<script src="review.js"></script>        <!-- Review data management, saving, loading -->
<script src="export.js"></script>        <!-- Export functionality -->
<script src="app.js"></script>           <!-- Main application orchestration -->

</body>
</html>