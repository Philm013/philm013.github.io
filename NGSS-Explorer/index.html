<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NGSS 3D Explorer</title>
	<!-- Shepherd.js for Guided Tour -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <style>
        :root {
            --header-bg: #f7f7f7; --border-color: #e5e7eb; --row-hover-bg: #f0f5fa; --highlight-bg: #fff3bf;
            --dimension-header-bg: #004488; --dimension-header-text: #ffffff; --element-header-bg: #eef5fc;
            --dci-major-bg: #333; --dci-major-text: #fff; --text-color: #2c3e50; --body-bg: #f9fafb;
            --sidebar-bg: #ffffff; --copy-feedback-bg: #28a745; --button-bg: #f3f4f6; --button-hover-bg: #e5e7eb;
            --active-filter-bg: #e6f4ff; --active-filter-border: #007bff; --modal-overlay-bg: rgba(0, 0, 0, 0.6);
            --nav-btn-active-bg: #fff; --nav-btn-active-border: #005a9c; --search-highlight: #ffe082;
            --pe-highlight-row-bg: #e6f4ff; --pe-highlight-row-border: #005a9c;
            --pe-highlight-specific-bg: #ffecb3; --pe-highlight-specific-border: #f59e0b;
        }
        @keyframes flash { 0% { background-color: var(--pe-highlight-specific-bg); } 50% { background-color: inherit; } 100% { background-color: var(--pe-highlight-specific-bg); } }
        html, body { height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--body-bg); color: var(--text-color); line-height: 1.5; font-size: 15px; }
        .app-layout { display: flex; flex-direction: column; height: 100vh; }
        .app-header { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 0.75rem 1.5rem; background-color: var(--sidebar-bg); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .header-title-wrapper { display: flex; align-items: center; gap: 0.75rem; }
        .header-actions { display: flex; align-items: center; gap: 0.75rem; }
        h1 { padding: 0; margin: 0; background-color: transparent; border: none; font-size: 1.4rem; font-weight: 600; }
        #reset-app-btn, #settings-btn, #start-tour-btn { padding: 0.3em 0.8em; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); cursor: pointer; font-size: 0.9em; font-weight: 500; }
        #reset-app-btn:hover, #settings-btn:hover, #start-tour-btn:hover { background-color: var(--button-hover-bg); }
        .page-container { display: flex; gap: 1rem; padding: 1rem; flex-grow: 1; min-height: 0; }
        #sidebar { width: 320px; flex-shrink: 0; background-color: var(--sidebar-bg); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        #main-content { flex-grow: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.75rem; }
        .app-nav { flex-shrink: 0; display: flex; gap: 0.5rem; padding: 1rem 1rem 0.25rem; border-bottom: 1px solid var(--border-color); }
        .nav-btn { flex-grow: 1; padding: 0.6rem 1rem; border: 1px solid transparent; border-bottom-color: var(--border-color); border-radius: 6px 6px 0 0; background-color: var(--button-bg); cursor: pointer; font-size: 1.1em; font-weight: 500; text-align: center; }
        .nav-btn.active { background-color: var(--nav-btn-active-bg); border-color: var(--border-color); border-bottom-color: var(--nav-btn-active-bg); color: var(--nav-btn-active-border); font-weight: 600; }
        .controls { display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem; flex-grow: 1; overflow-y: auto; min-height: 0; }
        .controls h2 { margin: 0 0 0.5rem 0; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .controls h2 .manage-btn { font-size: 0.8em; font-weight: 500; cursor: pointer; }
        .controls label, .filter-group-label { font-weight: 600; font-size: 0.9em; margin-bottom: 0.25rem; display: block; color: #555; }
        #search-input { padding: 0.6em 0.8em; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; width: 350px; box-sizing: border-box; }
        .filter-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .filter-btn { padding: 0.5em; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); cursor: pointer; font-size: 0.85em; text-align: center; }
        .filter-btn:hover { background-color: var(--button-hover-bg); }
        .filter-btn.active { background-color: var(--dimension-header-bg); color: var(--dimension-header-text); border-color: var(--dimension-header-bg); font-weight: 600; }
        .filter-btn.reset-btn { background-color: #fce8e6; border-color: #f7c5c0; color: #c5221f;}
        .filter-btn:hover:disabled, .filter-btn:disabled { background-color: var(--button-bg); color: #999; cursor: not-allowed; }
        #sub-dimension-filters-container { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color); }
        .sub-filter-group h4 { font-size: 0.9em; margin: 0.8em 0 0.3em; color: #333; }
        #clear-sub-filters-btn { font-size: 0.8em; color: #005a9c; cursor: pointer; text-align: right; margin-top: 0.5rem; display: none; }
        #results-count { margin-top: 0.5rem; font-size: 0.9em; color: #555; }
        .explorer-view { display: none; flex-direction: column; flex-grow: 1; min-height: 0; }
        .explorer-view.is-visible { display: flex; }
        .table-container { background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-color); border-radius: 8px; overflow: auto; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.6em 1em; text-align: left; vertical-align: top; border-bottom: 1px solid var(--border-color); }
        thead th { background-color: var(--header-bg); font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tbody tr:not(.pe-details-row):hover { background-color: var(--row-hover-bg); }
        .search-highlight { background-color: var(--search-highlight); font-weight: bold; border-radius: 2px; }
        #navigation-controls { display: flex; gap: 1rem; align-items: center; }
        #back-btn { padding: 0.3em 0.8em; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); cursor: pointer; font-weight: 600; }
        #active-pe-filter-tag { display: none; padding: 0.5rem 1rem; background-color: var(--active-filter-bg); border: 1px solid var(--active-filter-border); border-radius: 6px; font-size: 0.95em; justify-content: space-between; align-items: center; }
        #active-pe-filter-tag span { font-weight: 600; }
        #clear-pe-filter-btn { background: none; border: none; font-size: 1.5rem; line-height: 1; cursor: pointer; color: #888; padding: 0 0.5rem; }
        #threed-explorer-table td:not(:last-child), #threed-explorer-table th:not(:last-child) { border-right: 1px solid var(--border-color); }
        .th-content-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .col-toggle-btn { background: transparent; border: 1px solid var(--border-color); cursor: pointer; font-size: 0.9em; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        .col-toggle-btn.active { background-color: var(--dimension-header-bg); color: var(--dimension-header-text); border-color: var(--dimension-header-bg); }
        .dimension-header td { background-color: var(--dimension-header-bg); color: var(--dimension-header-text); font-size: 1.1em; font-weight: 600; position: sticky; top: 40px; z-index: 9; }
        .element-header td:first-child, .dci-minor-header td:first-child { background-color: var(--element-header-bg); font-weight: 600; }
        .dci-major-header td { background-color: var(--dci-major-bg); color: var(--dci-major-text); font-weight: 600; position: sticky; top: 40px; z-index: 9; }
        .dci-minor-header td:first-child { padding-left: 2em; }
        td .item { margin-bottom: 0.5em; padding: 0.25rem; border-radius: 4px; transition: background-color 0.2s ease-in-out; }
        td .item strong { display: block; color: #005a9c; font-weight: 600; }
        .copyable, .item, .statement { cursor: copy; position: relative; }
        .copyable::after, .item::after, .statement::after { content: 'Copied!'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--copy-feedback-bg); color: white; padding: 0.25em 0.75em; border-radius: 1em; font-size: 0.9em; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; z-index: 100; }
        .copyable.copied::after, .item.copied::after, .statement.copied::after { opacity: 1; }
        .pe-highlight-row { background-color: var(--pe-highlight-row-bg); }
        .pe-highlight-row td:first-child { border-left: 4px solid var(--pe-highlight-row-border); }
        .pe-highlight-specific { background-color: var(--pe-highlight-specific-bg) !important; box-shadow: 0 0 0 2px var(--pe-highlight-specific-border) inset; }
        .scroll-target { animation: flash 1.5s 1; }
        #threed-explorer-table.col-isolated th, #threed-explorer-table.col-isolated td { display: none; }
        #threed-explorer-table.col-isolated th:first-child, #threed-explorer-table.col-isolated td:first-child { display: table-cell; width: 25% !important; }
        #threed-explorer-table.isolate-col-2 th:nth-child(2), #threed-explorer-table.isolate-col-2 td:nth-child(2),
        #threed-explorer-table.isolate-col-3 th:nth-child(3), #threed-explorer-table.isolate-col-3 td:nth-child(3),
        #threed-explorer-table.isolate-col-4 th:nth-child(4), #threed-explorer-table.isolate-col-4 td:nth-child(4),
        #threed-explorer-table.isolate-col-5 th:nth-child(5), #threed-explorer-table.isolate-col-5 td:nth-child(5) { display: table-cell; width: 75% !important; }
        #pe-explorer-table .pe-main-row { cursor: pointer; scroll-margin-top: 45px; }
        #pe-explorer-table .pe-main-row.expanded { background-color: var(--element-header-bg); font-weight: 600;}
        
        .pe-details-row { display: none; }
        .pe-details-row.is-visible { display: table-row; }
        .pe-details-row > td { background-color: #fdfdfd; padding: 0 !important; }

        /* --- IMPROVED PE DETAILS STYLING --- */

        /* Wrapper for the whole section */
        .pe-details-wrapper {
            padding: 2rem;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
            border-top: 1px solid #e5e7eb;
        }

        /* The Header Container */
        .pe-description-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Aligns buttons to top */
            gap: 2rem;
        }

/* Container for ID and Text */
        .pe-header-content {
            display: flex;
            align-items: baseline; /* Aligns the ID with the first line of text */
            gap: 0.75rem;
            flex-grow: 1;
            flex-wrap: nowrap; /* Forces them to stay on the same row */
            min-width: 0; /* Required for text truncation/wrapping to work in Flexbox */
        }

        .pe-header-content h3 {
            font-size: 1rem;
            color: #004488;
            margin: 0;
            white-space: nowrap; /* Keeps ID on one line */
            flex-shrink: 0; /* Prevents ID from getting squished */
            line-height: 1.5; /* Matches description line-height */
        }

        .pe-description-text {
            font-size: 1rem;
            color: #2c3e50;
            line-height: 1.5;
            margin: 0;
            flex-grow: 1;
            min-width: 0; /* Allows text to wrap naturally INSIDE this column */
        }

        .ai-controls { 
            display: flex; 
            gap: 0.5rem; 
            flex-shrink: 0; /* Prevents buttons from squishing */
            margin-top: 5px; /* Visual alignment with text */
        }

        /* Clarification & Boundary Boxes */
        .pe-details-info-box {
            padding: .25rem .55rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        /* Clarification: Soft Yellow/Gold Tone */
        .pe-details-info-box.clarification {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
        }
		.pe-details-info-box.clarification p, .pe-details-info-box.boundary p {
		margin-bottom: .1rem;
		}
		
        /* Boundary: Soft Red/Gray Tone */
        .pe-details-info-box.boundary {
            background-color: #f3f4f6;
            border-left: 4px solid #6b7280;
        }
        .pe-details-info-box h4 {
            color: #444;
            text-transform: uppercase;
            font-size: 0.75em;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
			margin-top: 0.1rem;
        }

        /* 3D Columns Container */
        .pe-details-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        /* Individual Column Styling */
        .pe-details-column {
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid; /* Border color defined per column below */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* General Header Styling */
        .pe-details-column h4 {
            margin: 0;
            padding: 0.75rem 1rem;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        /* --- SPECIFIC DIMENSION COLORS --- */

        /* SEP: Blue-Grey Theme */
        .pe-col-sep {
            background-color: #eef4fa; /* Lighter version of #b8cce4 */
            border-color: #b8cce4;
        }
        .pe-col-sep h4 {
            background-color: #b8cce4;
            color: #20354b; /* Dark text for contrast */
        }

        /* DCI: Peach/Orange Theme */
        .pe-col-dci {
            background-color: #fff6ee; /* Lighter version of #fbd4b4 */
            border-color: #fbd4b4;
        }
        .pe-col-dci h4 {
            background-color: #fbd4b4;
            color: #5c3b1e; /* Dark text for contrast */
        }

        /* CCC: Pale Green Theme */
        .pe-col-ccc {
            background-color: #f5f9ef; /* Lighter version of #d6e3bc */
            border-color: #d6e3bc;
        }
        .pe-col-ccc h4 {
            background-color: #d6e3bc;
            color: #424e2d; /* Dark text for contrast */
        }

		/* Column Content - IMPROVED FORMATTING */
		.pe-details-column ul {
			padding: 1rem 1.5rem;
			margin: 0;
			list-style: none;
		}

		.pe-details-column li {
			margin-bottom: 1.5rem; /* Increased spacing between items */
			font-size: 0.95rem;
			color: #2c3e50;
		}
		
		/* --- IMPROVED PARAGRAPH STYLING --- */

		/* Base style for ALL paragraphs (Spacing only) */
		.pe-details-paragraph {
			margin-top: 0;
			margin-bottom: 0.8rem;
			position: relative;
			line-height: 1.5;
		}

		/* Specific style ONLY for Bullet Points (Hanging Indent) */
		.pe-details-paragraph.is-bullet {
			padding-left: 1.2rem;  /* Push the whole block right */
			text-indent: -1.2rem;  /* Pull just the bullet back to the left */
		}

		/* Remove margin from the very last paragraph so it fits the container */
		.pe-details-paragraph:last-child {
			margin-bottom: 0;
		}

		/* The ID/Header (e.g., "Asking Questions...") */
		.pe-details-column li strong {
			
			margin-bottom: 0.5rem;
			color: #000;
			font-weight: 700;
			font-size: 1em;
		}

		/* The Description Text (Indented and formatted) */
		.pe-details-column li > div {
			margin-left: 0.75rem;       /* Indents the text */
			padding-left: 1rem;         /* Adds space between border and text */
			border-left: 3px solid;     /* Adds the colored guide line */
			border-color: rgba(0,0,0,0.1); /* Default gray border */
			line-height: 1.6;           /* Improves reading ease */
			color: #444;
		}

		/* Dynamic Border Colors based on Column Type */
		.pe-col-sep li > div { border-color: #b8cce4; } /* Blue line for SEPs */
		.pe-col-dci li > div { border-color: #fbd4b4; } /* Orange line for DCIs */
		.pe-col-ccc li > div { border-color: #d6e3bc; } /* Green line for CCCs */

        /* ---- STYLES FOR IN-COLUMN CONNECTIONS ---- */
        .pe-details-col-connections-wrapper {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            margin-top: 1rem;
        }
        .pe-details-col-connections-wrapper .connection-header,
        .pe-details-col-connections-wrapper .connection-subheader {
            display: block;
            text-align: center;
            font-weight: 700;
            color: #000;
            margin-bottom: 0.5rem;
        }
        .pe-details-col-connections-wrapper .connection-item-block {
            margin-top: 1rem;
        }
        .pe-details-col-connections-wrapper .connection-item-block:first-child {
            margin-top: 0;
        }

        /* Button Styling */
        .ai-controls button, .pe-details-actions button {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .analyze-pe-desc-btn {
            background-color: #004488;
            color: white;
            border: 1px solid #003366;
        }
        .analyze-pe-desc-btn:hover { background-color: #003366; }
        .reset-analysis-btn {
            background-color: #fff;
            border: 1px solid #ccc;
            color: #555;
        }
        .pe-details-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        .view-evidence-btn {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            color: #333;
        }


        /* Connections Section */
        .pe-details-connections {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #eee;
        }
        .pe-details-connections h3 {
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 1rem;
        }
        .pe-connections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .pe-connections-section {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .pe-connections-section h4 {
            margin: 0 0 0.5rem;
            font-size: 0.95em;
            color: #004488;
            font-weight: 700;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .pe-connections-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .pe-connections-section li {
            font-size: 0.9em;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .pe-connections-section li strong {
            color: #333;
        }
        .pe-connections-section p {
            font-size: 0.9em;
            margin: 0;
            line-height: 1.4;
        }

        .clickable-element-link { color: var(--dimension-header-bg); font-weight: 400; cursor: pointer; }
        .clickable-element-link:hover { text-decoration: underline; }
        .pe-nav-link { color: var(--dimension-header-bg); font-weight: 600; cursor: pointer; text-decoration: none; }
        .pe-nav-link:hover { text-decoration: underline; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-bg); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.is-visible { display: flex; }
        .modal-content { background: var(--sidebar-bg); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 800px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .modal-header h2 { margin: 0; font-size: 1.3rem; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; line-height: 1; cursor: pointer; color: #888; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-body ul { list-style: none; padding: 0; margin: 0; }
        .modal-body li { padding: 0.5rem 0.75rem; border-radius: 4px; }
        .modal-body li:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .modal-body li strong { color: var(--dimension-header-bg); }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem;}
        #settings-modal-body .setting-group { margin-bottom: 1.5rem; }
        #settings-modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        #settings-modal-body input, #settings-modal-body select { width: 100%; padding: 0.6rem; border-radius: 4px; border: 1px solid var(--border-color); box-sizing: border-box; font-size: 1em; }
        #settings-modal-body .cache-buttons { display: flex; gap: 0.5rem; }
        
        /* --- EVIDENCE STATEMENTS, FACETS & AI STYLES --- */
        #evidence-statements-modal-body { line-height: 1.5; padding-bottom: 1rem; }
        .statement, .es-entry { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.4rem 0.6rem; border-radius: 6px; transition: background-color 0.15s ease-in-out; margin: 2px 0; position: relative; }
        .statement:hover, .es-entry:hover { background-color: var(--row-hover-bg); }
        .es-entry.copyable::after { left: 30px; }
        .es-marker { flex-shrink: 0; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color); background-color: #fff; color: #666; font-size: 0.8em; font-weight: 600; line-height: 1; margin-top: 0.1em; font-family: monospace; }
        .es-text { flex-grow: 1; margin: 0; }
        .es-heading-entry { margin: 1.5rem 0 0.5rem; padding: 0 0 0.5rem 0; border-bottom: 2px solid var(--border-color); border-radius: 0; align-items: center; }
        .es-heading-entry:first-child { margin-top: 0; }
        .es-heading-entry:hover { background-color: transparent; }
        .es-heading-entry .es-marker { background-color: var(--dimension-header-bg); color: #fff; border-color: var(--dimension-header-bg); width: 28px; height: 28px; font-size: 1em; }
        .es-heading-text { font-size: 1.1em; color: var(--dimension-header-bg); font-weight: 600; margin: 0; }
        .es-item { margin-left: 0; }
        .es-nested-item { margin-left: 2rem; }
        .es-nested-item .es-marker { border-style: dashed; color: #888; font-weight: normal; font-size: 0.75em; }
        .es-deeply-nested-item { margin-left: 4rem; }
        .ai-editable-content { position: relative; }
        .ai-editable-content span { cursor: pointer; }
        .sep { color: #0072bc; font-weight: 500; }
        .dci { color: #f26522; font-weight: 500; }
        .ccc { color: #0b9444; font-weight: 500; }
        .sep-underline { text-decoration: underline; text-decoration-thickness: 3px; text-decoration-color: #0072bc; }
        .dci-underline { text-decoration: underline; text-decoration-thickness: 3px; text-decoration-color: #f26522; }
        .ccc-underline { text-decoration: underline; text-decoration-thickness: 3px; text-decoration-color: #0b9444; }
        .facet-table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1.5rem; background-color: #fdfdfd; }
        .facet-table th, .facet-table td { border-bottom: 1px solid var(--border-color); }
        .facet-table tr:last-child td { border-bottom: none; }
        .facet-table thead th { background-color: var(--element-header-bg); padding: 0.75rem 1rem; text-align: left; border-top-left-radius: 8px; border-top-right-radius: 8px;}
        .facet-table thead .facet-element-id { font-size: 1.1em; color: var(--dimension-header-bg); }
        .facet-table thead .facet-dimension-name { font-size: 0.9em; color: #555; }
        .facet-table thead .facet-element-text { font-size: 0.95em; font-weight: normal; padding-top: 0.5rem; }
        .facet-table tbody td { padding: 0; }
        .facet-item-row { display: flex; align-items: flex-start; padding: 0.6rem 1rem;}
        .facet-item-row .facet-num { width: 2.5em; text-align: right; color: #888; flex-shrink: 0; padding-right: 0.8em;}
        
        #ai-edit-toolbar {
            position: absolute; display: none; background-color: #2c3e50; border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); padding: 6px; z-index: 3000;
            gap: 4px; align-items: center; transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out;
            transform: translateY(10px);
        }
        #ai-edit-toolbar.is-visible { display: flex; transform: translateY(0); }
        #ai-edit-toolbar button {
            border: 1px solid transparent; cursor: pointer; padding: 6px 8px;
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 14px; font-weight: bold; gap: 4px; line-height: 1;
            transition: all 0.15s ease-in-out;
        }
        #ai-edit-toolbar button.sep-btn { background-color: #0072bc; }
        #ai-edit-toolbar button.dci-btn { background-color: #f26522; }
        #ai-edit-toolbar button.ccc-btn { background-color: #0b9444; }
        #ai-edit-toolbar button.sep-btn:hover { background-color: #008be2; }
        #ai-edit-toolbar button.dci-btn:hover { background-color: #ff8142; }
        #ai-edit-toolbar button.ccc-btn:hover { background-color: #0ec254; }
        #ai-edit-toolbar button.active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            transform: translateY(1px);
        }
        #ai-edit-toolbar .separator { width: 1px; height: 20px; background-color: rgba(255,255,255,0.2); margin: 0 4px; }
        
        .resize-handle {
            display: none; position: absolute; width: 24px; height: 24px;
            background-color: var(--dimension-header-bg); border: 2px solid #fff;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 3001; cursor: ew-resize; user-select: none;
            transform: translate(-50%, -50%);
        }
        .clickable-pe-link { cursor: pointer; }
        .clickable-pe-link:hover { background-color: var(--row-hover-bg); }
        #sidebar-toggle, #page-overlay { display: none; }
        #bundle-controls { padding: 0.5rem 1rem; background-color: var(--header-bg); border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 0.5rem 1rem; align-items: center; position: sticky; top: 0; z-index: 11; }
        #bundle-controls button { padding: 0.3em 0.8em; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--button-bg); cursor: pointer; }
        #bundle-controls button:hover { background-color: var(--button-hover-bg); }
        #bundle-view { background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid var(--border-color); border-radius: 8px; overflow-y: auto; flex-grow: 1; padding: 1.5rem; display: none; flex-direction: column;}
        #bundle-view .bundle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #bundle-view .bundle-header-actions { display: flex; gap: 0.5rem; align-items: center;}
        .pe-bundle-item { border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; background-color: #fdfdfd; }
        .bundle-summary { border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; background-color: var(--element-header-bg); }
        .bundle-summary h3 { margin-top: 0; }
        .bundle-summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem 2rem; }
        .bundle-summary-col ul { padding-left: 1.2rem; margin: 0; }
        .bundle-summary-col li { font-size: 0.9em; margin-bottom: 0.25rem; }
        .bundle-summary-col li strong { color: var(--dimension-header-bg); }
        .bundle-summary-connections-grid { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem 2rem; }
        .dci-group h4 { margin-bottom: 1rem; }
        .dci-sub-group:not(:first-child) { margin-top: 1.5rem; }
        h5.dci-sub-header { margin: 0 0 0.5rem 0; font-size: 0.95em; color: #444; border-bottom: 1px solid #ccc; padding-bottom: 0.25rem; font-weight: 600; }
        .bundle-summary-col li { font-size: 0.9em; margin-bottom: 0.5rem; }
        #pe-element-filters-container { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color); }
        #active-element-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .element-filter-tag { display: inline-flex; align-items: center; background-color: var(--active-filter-bg); border: 1px solid var(--active-filter-border); border-radius: 4px; padding: 0.2rem 0.2rem 0.2rem 0.6rem; font-size: 0.85em; }
        .element-filter-tag button { background: none; border: none; font-size: 1.2rem; line-height: 1; cursor: pointer; color: #888; padding: 0 0.2rem; }
        .modal-body-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .modal h4 { margin: 0 0 0.5rem; font-size: 1em; color: #333; }
        .element-choice { cursor: pointer; padding: 0.4rem; border-radius: 4px; }
        .element-choice:hover { background-color: var(--row-hover-bg); }
        .bundle-manager-list li { display: flex; justify-content: space-between; align-items: center; }
        .bundle-manager-list .actions button { font-size: 0.8em; margin-left: 0.5em; }
        .bundle-manager-list .bundle-name { font-weight: 600; }
        #save-bundle-modal-body { display: flex; flex-direction: column; gap: 0.5rem; }
        #save-bundle-modal-body input { font-size: 1.1em; padding: 0.5em; border-radius: 4px; border: 1px solid var(--border-color); }
        #save-bundle-modal-body .modal-actions { text-align: right; margin-top: 1rem; }
        /* MATRIX VIEW STYLES */
        #matrix-controls { padding: 0.5rem 0; background-color: var(--header-bg); border-bottom: 1px solid var(--border-color); display: flex; gap: 1rem; align-items: center; }
        #matrix-table th, #matrix-table td { min-width: 120px; white-space: normal; }
        #matrix-table th:first-child, #matrix-table td:first-child { min-width: 250px; max-width: 350px; font-weight: 600; }
        #matrix-table thead th { vertical-align: bottom; }
        #matrix-table thead th:first-child, #matrix-table tbody td:first-child { position: sticky; left: 0; background-color: var(--header-bg); border-right: 1px solid var(--border-color); }
        #matrix-table thead th:first-child { z-index: 11; }
        #matrix-table tbody td:first-child { z-index: 1; background-color: var(--element-header-bg); }
        .pe-matrix-link { display: inline-block; background-color: var(--button-bg); color: var(--dimension-header-bg); font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 4px; margin: 0.2rem; cursor: pointer; border: 1px solid var(--border-color); }
        .pe-matrix-link:hover { background-color: var(--button-hover-bg); text-decoration: underline; }
        #matrix-placeholder { flex-grow: 1; display: flex; align-items: center; justify-content: center; text-align: center; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; }
        #matrix-row-select-modal .modal-body-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        #matrix-row-select-modal label { display: block; padding: 0.4rem; border-radius: 4px; cursor: pointer; }
        #matrix-row-select-modal label:hover { background-color: var(--row-hover-bg); }
        #matrix-row-select-modal input { margin-right: 0.5rem; }
        
        /* Tour Customization */
        /* Z-index must be higher than app modals (2000) */
    .shepherd-element { z-index: 9999 !important; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .shepherd-has-title .shepherd-content .shepherd-header { background: #f7f7f7; padding: 1rem;}
    .shepherd-text { font-size: 0.95rem; line-height: 1.5; color: #2c3e50; }
    .shepherd-button { background-color: #004488; color: white; border-radius: 4px; padding: 0.5rem 1rem; transition: background 0.2s; }
    .shepherd-button:hover { background-color: #003366; }
    .shepherd-button-secondary { background-color: #f3f4f6; color: #333; }
    .shepherd-button-secondary:hover { background-color: #e5e7eb; }
       
        /* --- EVIDENCE STATEMENTS, FACETS & AI STYLES --- */
        body.ai-disabled .ai-controls,
        body.ai-disabled #refresh-facets-btn,
        body.ai-disabled #ai-edit-toolbar {
            display: none !important;
        }
        @media (max-width: 992px) {
            .app-layout { overflow-y: auto; }
            .page-container { flex-direction: column; }
            #sidebar { position: fixed; left: 0; top: 0; width: 320px; height: 100%; z-index: 1001; transform: translateX(-100%); transition: transform 0.3s ease-in-out; border-radius: 0; }
            #sidebar.is-visible { transform: translateX(0); }
            #page-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: none;}
            #page-overlay.is-visible { display: block; }
            .app-header { padding-left: 5rem; }
            .header-title-wrapper { display: none; }
            .app-header #search-input { flex-grow: 1; width: auto; }
            #sidebar-toggle { display: block; position: fixed; top: 0.75rem; left: 1rem; z-index: 1002; font-size: 1.5rem; background: var(--sidebar-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.1rem 0.6rem; cursor: pointer; }
            .filter-group { grid-template-columns: 1fr; }
            .nav-btn, .filter-btn { padding: 0.75em; }
        }
        
        @media (max-width: 767px) {
            #ai-edit-toolbar {
                position: fixed;
                bottom: 0; left: 0; right: 0;
                border-radius: 0;
                width: 100%;
                box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
                justify-content: space-around;
                padding: 8px;
                transform: translateY(100%);
            }
             #ai-edit-toolbar.is-visible { transform: translateY(0); }
        }

        @media print {
            body, .app-layout { overflow: visible; height: auto; }
            h1, .app-header, #sidebar, #sidebar-toggle, #top-bar, #pe-explorer, #threed-explorer, .bundle-header-actions, .pe-details-actions, .modal-footer, #ai-edit-toolbar, .resize-handle { display: none !important; }
            .page-container { display: block; padding: 0; }
            #main-content, #bundle-view { display: block !important; flex-grow: 1; box-shadow: none; border: none; padding: 0; }
            .bundle-summary { page-break-after: avoid; }
            .pe-bundle-item { page-break-inside: avoid; page-break-after: avoid; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <header class="app-header">
            <div class="header-title-wrapper">
                <h1>NGSS 3D + PE Explorer</h1>
            </div>
            <input type="text" id="search-input" placeholder="Search current view...">
            <div class="header-actions">
                <button id="settings-btn" title="AI Settings">Settings</button>
                <button id="reset-app-btn" title="Reset all filters and views">Reset</button>
				<button id="start-tour-btn" title="Start Guided Tour">‚ùì</button>
            </div>
        </header>
        <button id="sidebar-toggle" aria-label="Toggle filters menu">&#9776;</button>
        <div id="page-overlay"></div>

        <div class="page-container">
            <aside id="sidebar">
                <div class="app-nav">
                    <button id="nav-pe-explorer" class="nav-btn">PE Explorer</button>
                    <button id="nav-threed-explorer" class="nav-btn">3D Explorer</button>
                    <button id="nav-matrix-view" class="nav-btn">Matrix View</button>
                </div>
                <div class="controls">
                    <h2>Filters</h2>
                    <div id="sidebar-filters-container">
                        <div id="pe-filters-all">
                             <div id="bundle-filter-container" style="margin-top: 0.75rem;">
                                <h2>Filter by Bundle <span id="manage-bundles-btn" class="manage-btn filter-btn">Manage</span></h2>
                                <div id="bundle-filters" class="filter-group"></div>
                            </div>
                            <div id="grade-filters-container" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color);">
                                <div class="filter-group-label">Filter by Grade:</div>
                                <div id="grade-filters" class="filter-group"></div>
                            </div>
                            <div id="topic-filters-container" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed var(--border-color);">
                                <div class="filter-group-label">Filter by Topic:</div>
                                <div id="topic-filters" class="filter-group"></div>
                            </div>
                            <div id="pe-element-filters-container">
                                <div class="filter-group-label">Filter by 3D Element (must contain all selected):</div>
                                <div id="active-element-filters"></div>
                                <button id="add-element-filter-btn" class="filter-btn" style="margin-top: 0.5rem;">+ Add Element Filter</button>
                            </div>
                        </div>
                        <div id="threed-filters-all">
                            <div id="dimension-filters-container">
                                <div class="filter-group-label">Filter by Dimension:</div>
                                <div id="dimension-filters" class="filter-group"></div>
                                <div id="sub-dimension-filters-container" style="display: none;">
                                    <div class="filter-group-label">Filter by Element / Core Idea:</div>
                                    <div id="sub-dimension-filters" class="filter-group"></div>
                                    <div id="dci-minor-filters-container" style="display: none; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border-color);">
                                        <div class="filter-group-label">Filter by Component Idea:</div>
                                        <div id="dci-minor-filters" class="filter-group"></div>
                                    </div>
                                    <div id="clear-sub-filters-btn">Clear Sub-filters</div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div id="results-count"></div>
                </div>
            </aside>
            <main id="main-content">
                <div id="top-bar" style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                    <div id="navigation-controls" style="display: none;"><button id="back-btn">&larr; Back</button></div>
                    <div id="active-pe-filter-tag"><span></span><button id="clear-pe-filter-btn" title="Clear PE Filter">&times;</button></div>
                </div>
                <div id="pe-explorer" class="explorer-view">
                    <div id="bundle-controls" style="display: none;">
                        <span id="bundle-count">0 PEs selected</span>
                        <button id="view-bundle-btn" title="View details for all selected PEs">View Bundle Details</button>
                        <button id="save-bundle-btn" title="Save current selection as a named bundle">Save Bundle</button>
                        <button id="clear-bundle-btn" title="Deselect all PEs">Clear Selection</button>
                    </div>
                    <div class="table-container">
                        <table id="pe-explorer-table">
                            <thead><tr><th style="width: 2em;"><input type="checkbox" id="pe-bundle-select-all" title="Select/Deselect all visible"></th><th style="min-width: 80px;">PE ID</th><th>Description</th><th>Grade</th><th>Topic</th></tr></thead>
                            <tbody id="pe-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="bundle-view"></div>
                <div id="threed-explorer" class="explorer-view">
                    <div class="table-container">
                        <table id="threed-explorer-table">
                            <thead><tr><th style="width: 30%;">Dimension / Element</th><th style="width: 17.5%;"><div class="th-content-wrapper"><span>Grades K-2</span><button class="col-toggle-btn" data-col="2" title="Isolate this column">&lt;&gt;</button></div></th><th style="width: 17.5%;"><div class="th-content-wrapper"><span>Grades 3-5</span><button class="col-toggle-btn" data-col="3" title="Isolate this column">&lt;&gt;</button></div></th><th style="width: 17.5%;"><div class="th-content-wrapper"><span>Grades 6-8</span><button class="col-toggle-btn" data-col="4" title="Isolate this column">&lt;&gt;</button></div></th><th style="width: 17.5%;"><div class="th-content-wrapper"><span>Grades 9-12</span><button class="col-toggle-btn" data-col="5" title="Isolate this column">&lt;&gt;</button></div></th></tr></thead>
                            <tbody id="threed-table-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="matrix-view" class="explorer-view">
                    <div id="matrix-controls">
                        <button id="select-matrix-rows-btn" class="filter-btn active">Select/Refine Rows (3D Elements)</button>
                    </div>
                    <div id="matrix-table-container" class="table-container" style="display:none;">
                        <table id="matrix-table">
                            <thead id="matrix-table-head"></thead>
                            <tbody id="matrix-table-body"></tbody>
                        </table>
                    </div>
                    <div id="matrix-placeholder">
                        <div>
                            <h2>Welcome to the Matrix View</h2>
                            <p>This view helps visualize progressions of 3D Elements across grade levels.<br>Click the button above to select the 3D Elements you want to see as rows in the matrix.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- MODALS & POPUPS -->
    <div id="related-pe-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="related-pe-modal-title"></h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body"><p>This element is found in the following PEs:</p><ul id="related-pe-list"></ul></div></div></div>
    <div id="element-filter-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Select 3D Element to Filter By</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body"><div class="modal-body-grid" id="element-filter-choices"></div></div></div></div>
    <div id="bundle-manager-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Manage Saved Bundles</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body"><ul id="bundle-manager-list" class="bundle-manager-list"></ul></div></div></div>
    <div id="save-bundle-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Save Bundle</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body" id="save-bundle-modal-body"><label for="bundle-name-input">Bundle Name:</label><input type="text" id="bundle-name-input" placeholder="e.g., First Grade Forces Unit"><div class="modal-actions"><button id="cancel-save-bundle-btn" class="filter-btn">Cancel</button><button id="confirm-save-bundle-btn" class="filter-btn active">Save</button></div></div></div></div>
    <div id="matrix-row-select-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Select Matrix Rows</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body"><div class="modal-body-grid" id="matrix-row-choices"></div></div><div class="modal-footer"><button id="update-matrix-btn" class="filter-btn active">Update Matrix</button></div></div></div>
    <div id="evidence-statements-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2 id="evidence-statements-modal-title">Evidence Statements</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body ai-editable-content" id="evidence-statements-modal-body" data-part="evidenceStatements"></div><div class="modal-footer"><div class="ai-controls"><button id="analyze-es-btn" class="filter-btn active">Analyze with AI</button><button id="deconstruct-facets-btn" class="filter-btn">Deconstruct into 3D Facets</button><button class="filter-btn reset-btn reset-analysis-btn">Reset</button></div><button id="copy-es-html-btn" class="filter-btn">Copy HTML</button></div></div></div>
    <div id="facet-decomposition-modal" class="modal-overlay"><div class="modal-content" style="max-width: 900px;"><div class="modal-header"><h2 id="facet-modal-title"></h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body" id="facet-modal-body"><div id="facet-tables-container"></div></div><div class="modal-footer"><button id="refresh-facets-btn" class="filter-btn reset-btn">Refresh with AI</button><button id="copy-facets-btn" class="filter-btn">Copy as Text</button><button id="close-facets-btn" class="filter-btn">Close</button></div></div></div>
    <div id="settings-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h2>Settings</h2><button class="modal-close-btn" title="Close">&times;</button></div><div class="modal-body" id="settings-modal-body"><div class="setting-group"><label for="api-key-input">Gemini API Key</label><input type="password" id="api-key-input" placeholder="Enter your Google AI Studio API Key"><p style="font-size: 0.85em; color: #555; margin-top: 0.5rem;">Your API key is saved only in your browser's local storage.</p></div><div class="setting-group"><label for="ai-model-select">AI Model</label><select id="ai-model-select"><option value="gemini-flash-latest">gemini-flash-latest</option><option value="gemini-2.5-pro">gemini-2.5-pro</option></select></div><div class="setting-group"><label>Cache Management</label><p style="font-size: 0.85em; color: #555; margin-top: 0; margin-bottom: 0.5rem;">App data and AI results are cached in your browser. Clearing caches can fix issues but may slow down the next page load.</p><div class="cache-buttons"><button id="clear-ai-cache-btn" class="filter-btn reset-btn">Clear AI Cache</button><button id="clear-data-cache-btn" class="filter-btn reset-btn">Clear Data Cache</button></div></div></div><div class="modal-footer"><button id="save-settings-btn" class="filter-btn active">Save Settings</button></div></div></div>
    
    <div id="ai-edit-toolbar">
        <button class="sep-btn" data-action="set-class" data-value="sep" title="Set as SEP">S</button>
        <button class="sep-btn" data-action="set-class" data-value="sep-underline" title="Set as SEP (Underlined)">
            S <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3M4 21h16"/></svg>
        </button>
        <div class="separator"></div>
        <button class="dci-btn" data-action="set-class" data-value="dci" title="Set as DCI">D</button>
        <button class="dci-btn" data-action="set-class" data-value="dci-underline" title="Set as DCI (Underlined)">
            D <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3M4 21h16"/></svg>
        </button>
        <div class="separator"></div>
        <button class="ccc-btn" data-action="set-class" data-value="ccc" title="Set as CCC">C</button>
        <button class="ccc-btn" data-action="set-class" data-value="ccc-underline" title="Set as CCC (Underlined)">
            C <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3M4 21h16"/></svg>
        </button>
        <div class="separator"></div>
        <button data-action="unwrap" title="Remove Formatting" style="background-color: rgba(255,255,255,0.1);">
             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21H7z"/><path d="M22 21H7"/><path d="m5 12 5 5"/></svg>
        </button>
    </div>
    <div id="resize-handle-start" class="resize-handle"></div>
    <div id="resize-handle-end" class="resize-handle"></div>
    
    <script type="module">
       import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DOM ELEMENT REFERENCES ---
        const navPeExplorer = document.getElementById('nav-pe-explorer');
        const navThreedExplorer = document.getElementById('nav-threed-explorer');
        const navMatrixView = document.getElementById('nav-matrix-view');
        const peExplorerView = document.getElementById('pe-explorer');
        const threedExplorerView = document.getElementById('threed-explorer');
        const matrixView = document.getElementById('matrix-view');
        const bundleView = document.getElementById('bundle-view');
        const searchInput = document.getElementById('search-input');
        const resultsCountSpan = document.getElementById('results-count');
        const sidebarFiltersContainer = document.getElementById('sidebar-filters-container');
        const peFiltersAll = document.getElementById('pe-filters-all');
        const threedFiltersAll = document.getElementById('threed-filters-all');
        const gradeFilters = document.getElementById('grade-filters');
        const dimensionFilters = document.getElementById('dimension-filters');
        const subDimensionFiltersContainer = document.getElementById('sub-dimension-filters-container');
        const subDimensionFilters = document.getElementById('sub-dimension-filters');
        const dciMinorFiltersContainer = document.getElementById('dci-minor-filters-container');
        const dciMinorFilters = document.getElementById('dci-minor-filters');
        const clearSubFiltersBtn = document.getElementById('clear-sub-filters-btn');
        const activeElementFiltersDiv = document.getElementById('active-element-filters');
        const addElementFilterBtn = document.getElementById('add-element-filter-btn');
        const bundleFilters = document.getElementById('bundle-filters');
        const peTableBody = document.getElementById('pe-table-body');
        const threedTableBody = document.getElementById('threed-table-body');
        const matrixTableContainer = document.getElementById('matrix-table-container');
        const matrixTableHead = document.getElementById('matrix-table-head');
        const matrixTableBody = document.getElementById('matrix-table-body');
        const matrixPlaceholder = document.getElementById('matrix-placeholder');
        const navigationControls = document.getElementById('navigation-controls');
        const backBtn = document.getElementById('back-btn');
        const activePeFilterTag = document.getElementById('active-pe-filter-tag');
        const clearPeFilterBtn = document.getElementById('clear-pe-filter-btn');
        const bundleControls = document.getElementById('bundle-controls');
        const bundleCountSpan = document.getElementById('bundle-count');
        const viewBundleBtn = document.getElementById('view-bundle-btn');
        const saveBundleBtn = document.getElementById('save-bundle-btn');
        const clearBundleBtn = document.getElementById('clear-bundle-btn');
        const selectAllCheckbox = document.getElementById('pe-bundle-select-all');
        const relatedPeModal = document.getElementById('related-pe-modal');
        const relatedPeList = document.getElementById('related-pe-list');
        const elementFilterModal = document.getElementById('element-filter-modal');
        const bundleManagerModal = document.getElementById('bundle-manager-modal');
        const saveBundleModal = document.getElementById('save-bundle-modal');
        const matrixRowSelectModal = document.getElementById('matrix-row-select-modal');
        const resetAppBtn = document.getElementById('reset-app-btn');
        const evidenceStatementsModal = document.getElementById('evidence-statements-modal');
        const evidenceStatementsModalTitle = document.getElementById('evidence-statements-modal-title');
        const evidenceStatementsModalBody = document.getElementById('evidence-statements-modal-body');
        const facetDecompositionModal = document.getElementById('facet-decomposition-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const aiModelSelect = document.getElementById('ai-model-select');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const clearAiCacheBtn = document.getElementById('clear-ai-cache-btn');
        const clearDataCacheBtn = document.getElementById('clear-data-cache-btn');
        const aiEditToolbar = document.getElementById('ai-edit-toolbar');
        const handleStart = document.getElementById('resize-handle-start');
        const handleEnd = document.getElementById('resize-handle-end');

        // --- 2. STATE MANAGEMENT ---
        const CACHE_VERSION = '1.6'; // Incremented to fix the Connections data parsing issue.
        let currentView = 'pe';
        let activePeFilter = null;
        let peMap = new Map();
        let elementMap = new Map();
        let specificElementMap = new Map();
        let textToSpecificCodeMap = new Map();
        let nameToCodeMap = new Map();
        let elementToGradePeMap = new Map();
        let peBundle = new Set();
        let navigationHistory = [];
        let isolatedColumn = null;
        let activeElementFilters = new Set();
        let savedBundles = {};
        let activeBundleFilter = null;
        let fuzzyMatchCache = new Map();
        let gradeToTopicsMap = {};
        let allTopics = [];
        let sortedGradeLabels = [];
        let matrixRowElements = new Set();
        let isNavigatingHistory = false;
        let genAI;
        let savedAnalyses = {};
        let db;
        let selectedAiModel = 'gemini-flash-latest';
        
        let activeEditableTarget = null;
        let activeResizeSpan = null;
        let isResizing = false;
        let activeHandle = null;

        const updateAiFeatureVisibility = () => {
            const hasApiKey = !!localStorage.getItem('geminiApiKey');
            document.body.classList.toggle('ai-disabled', !hasApiKey);
        };

        // --- 3. CORE LOGIC & DATA PROCESSING ---

        const DB_NAME = 'NGSS_Explorer_Cache';
        const DB_VERSION = 2;
        const AI_STORE_NAME = 'analyses';
        const DATA_STORE_NAME = 'processed_data';
        const DATA_CACHE_KEY = 'ngss_data_cache';
        const openDb = () => new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e => { const d = e.target.result; if (!d.objectStoreNames.contains(AI_STORE_NAME)) d.createObjectStore(AI_STORE_NAME, { keyPath: 'id' }); if (!d.objectStoreNames.contains(DATA_STORE_NAME)) d.createObjectStore(DATA_STORE_NAME, { keyPath: 'id' }); }; r.onsuccess = e => { db = e.target.result; resolve(db); }; r.onerror = e => reject(e.target.errorCode); });
        const loadDataFromDB = () => new Promise((resolve, reject) => { if (!db) { resolve(null); return; } const t = db.transaction(DATA_STORE_NAME, 'readonly').objectStore(DATA_STORE_NAME).get(DATA_CACHE_KEY); t.onsuccess = e => resolve(e.target.result ? e.target.result.data : null); t.onerror = e => reject(e.target.errorCode); });
        const saveDataToDB = data => { if (!db) return; db.transaction(DATA_STORE_NAME, 'readwrite').objectStore(DATA_STORE_NAME).put({ id: DATA_CACHE_KEY, data }); };
        const clearDataCache = () => new Promise((resolve, reject) => { if (!db) { resolve(); return; } const r = db.transaction(DATA_STORE_NAME, 'readwrite').objectStore(DATA_STORE_NAME).clear(); r.onsuccess = () => resolve(); r.onerror = e => reject(e.target.errorCode); });
        const loadAnalysesFromDB = () => new Promise((resolve, reject) => { if (!db) { resolve({}); return; } const r = db.transaction(AI_STORE_NAME, 'readonly').objectStore(AI_STORE_NAME).getAll(); r.onsuccess = e => { const results = e.target.result, cache = {}; results.forEach(item => { if (!cache[item.peId]) cache[item.peId] = {}; cache[item.peId][item.part] = item.html; }); resolve(cache); }; r.onerror = e => reject(e.target.errorCode); });
        const saveAnalysisToDB = (peId, part, html) => { if (!db) return; db.transaction(AI_STORE_NAME, 'readwrite').objectStore(AI_STORE_NAME).put({ id: `${peId}-${part}`, peId, part, html }); };
        const deleteAnalysisFromDB = (peId, part) => { if (!db) return; db.transaction(AI_STORE_NAME, 'readwrite').objectStore(AI_STORE_NAME).delete(`${peId}-${part}`); };
        const clearAllAnalyses = () => new Promise((resolve, reject) => { if (!db) { resolve(); return; } const r = db.transaction(AI_STORE_NAME, 'readwrite').objectStore(AI_STORE_NAME).clear(); r.onsuccess = () => { savedAnalyses = {}; resolve(); }; r.onerror = e => reject(e.target.errorCode); });
        const updateUrlFromState = () => { if (isNavigatingHistory) return; const p = new URLSearchParams(); p.set('view', currentView); const q = searchInput.value.trim(); if (q) p.set('q', q); if (currentView === 'pe') { const g = gradeFilters.querySelector('.active')?.dataset.filter; if (g && g !== 'all') p.set('grade', g); const t = [...document.querySelectorAll('#topic-filters .filter-btn.active')].map(b => b.dataset.filter); if (t.length > 0 && !t.includes('all')) p.set('topic', t.join(',')); if (activeElementFilters.size > 0) p.set('elements', [...activeElementFilters].join(',')); if (activeBundleFilter) p.set('bundleFilter', activeBundleFilter); const e = peTableBody.querySelector('.pe-main-row.expanded')?.dataset.peId; if (e) p.set('expanded', e); } else if (['3d', 'matrix'].includes(currentView)) { if (activePeFilter) p.set('highlight', activePeFilter); if (isolatedColumn && currentView === '3d') p.set('isolate', isolatedColumn); const d = dimensionFilters.querySelector('.active')?.dataset.filter; if (d) p.set('dim', d); const s = [...subDimensionFilters.querySelectorAll('.active')].map(b => b.dataset.filter); if (s.length > 0) p.set('subDim', s.join(',')); const m = [...dciMinorFilters.querySelectorAll('.active')].map(b => b.dataset.filter); if (m.length > 0) p.set('minorDim', m.join(',')); } else if (currentView === 'bundle' && peBundle.size > 0) p.set('bundlePEs', [...peBundle].join(',')); if (currentView === 'matrix' && matrixRowElements.size > 0) { const a = new Set(); window.allNgss3dElements.forEach(d => (d.elements || d.core_ideas?.flatMap(c => c.components) || []).forEach(i => a.add(i.name.split(':')[0].trim()))); if (matrixRowElements.size !== a.size) p.set('matrixRows', [...matrixRowElements].join(',')); } const u = `${window.location.pathname}?${p.toString()}`; history.replaceState(null, '', u); };
        
        // --- HELPER FUNCTION: Standardized Scroll To PE Row ---
        const scrollToPeRow = (row) => {
            const cont = peExplorerView.querySelector('.table-container');
            const head = document.querySelector('#pe-explorer-table thead');
            if (cont && head && row) {
                cont.scrollTo({
                    top: row.offsetTop - head.offsetHeight,
                    behavior: 'smooth'
                });
            }
        };

        const applyStateFromUrl = () => { 
            isNavigatingHistory = true; 
            const p = new URLSearchParams(window.location.search); 
            searchInput.value = ''; 
            document.querySelectorAll('.filter-btn.active').forEach(b => b.classList.remove('active')); 
            gradeFilters.querySelector('[data-filter="all"]')?.classList.add('active'); 
            renderTopicFilters('all'); 
            subDimensionFiltersContainer.style.display = 'none'; 
            dciMinorFiltersContainer.style.display = 'none'; 
            activeElementFilters.clear(); 
            renderActiveElementFilters(); 
            activeBundleFilter = null; 
            renderBundleFilters(); 
            clearPeFilter(); 
            isolatedColumn = null; 
            peTableBody.querySelectorAll('.expanded, .is-visible').forEach(r => r.classList.remove('expanded', 'is-visible')); 
            matrixRowElements.clear(); 
            window.allNgss3dElements.forEach(d => (d.elements || d.core_ideas?.flatMap(c => c.components) || []).forEach(i => { const c = i.name.split(':')[0].trim(); if (c) matrixRowElements.add(c); })); 
            if (p.has('bundlePEs')) { const ids = p.get('bundlePEs').split(','); peBundle = new Set(ids.filter(id => peMap.has(id))); if (peBundle.size > 0) { updateBundleControls(); renderBundleView(); isNavigatingHistory = false; return; } } 
            const view = p.get('view') || 'pe'; 
            searchInput.value = p.get('q') || ''; 
            if (p.has('matrixRows')) matrixRowElements = new Set(p.get('matrixRows').split(',')); 
            if (p.has('grade')) { const g = p.get('grade'); gradeFilters.querySelector('.active')?.classList.remove('active'); gradeFilters.querySelector(`[data-filter="${g}"]`)?.classList.add('active'); renderTopicFilters(g); } 
            if (p.has('topic')) { const t = p.get('topic').split(','); document.querySelector('#topic-filters [data-filter="all"]')?.classList.remove('active'); t.forEach(topic => document.querySelector(`#topic-filters [data-filter="${topic}"]`)?.classList.add('active')); } 
            if (p.has('elements')) { activeElementFilters = new Set(p.get('elements').split(',')); renderActiveElementFilters(); } 
            if (p.has('bundleFilter')) { activeBundleFilter = p.get('bundleFilter'); renderBundleFilters(); } 
            activePeFilter = p.get('highlight') || null; 
            isolatedColumn = p.get('isolate') || null; 
            if (p.has('dim')) { const d = p.get('dim'); dimensionFilters.querySelector(`[data-filter="${d}"]`)?.classList.add('active'); renderSubFilters(d); } 
            if (p.has('subDim')) { const s = p.get('subDim').split(','); s.forEach(sub => subDimensionFilters.querySelector(`[data-filter="${sub}"]`)?.classList.add('active')); const d = p.get('dim'); if (d && d.startsWith('DCI') && s.length > 0) renderDciMinorFilters(s[0]); } 
            if (p.has('minorDim')) { const m = p.get('minorDim').split(','); m.forEach(minor => dciMinorFilters.querySelector(`[data-filter="${minor}"]`)?.classList.add('active')); } 
            switchView(view, null, false); 
            
            // --- LAZY LOAD & EXPAND FROM URL ---
            if (p.has('expanded')) { 
                const id = p.get('expanded'); 
                setTimeout(() => { 
                    const row = peTableBody.querySelector(`.pe-main-row[data-pe-id="${id}"]`); 
                    if (row) { 
                        const detailsRow = row.nextElementSibling;
                        const detailsCell = detailsRow.querySelector('td');
                        if (!detailsCell.hasChildNodes()) {
                            const pe = peMap.get(id);
                            if (pe) detailsCell.innerHTML = createPeDetailsHtml(pe);
                        }
                        row.classList.add('expanded'); 
                        row.nextElementSibling.classList.add('is-visible'); 
                        scrollToPeRow(row); // Use standardized scroll
                    } 
                }, 100); 
            } 
            isNavigatingHistory = false; 
        };
        const escapeRegExp = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const normalizeText = t => t.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim(); const getGradeBandKey = l => { if (!l) return null; const lc = l.toLowerCase(); if (['kindergarten', 'first', 'second', 'k-2'].some(k => lc.includes(k))) return 'primary'; if (['third', 'fourth', 'fifth', '3-5'].some(k => lc.includes(k))) return 'elementary'; if (lc.includes('middle')) return 'middle'; if (lc.includes('high')) return 'high'; return null; }; const findBestMatchingSpecificElement = (text, grade) => { const clean = text.trim().replace(/^[\*‚Ä¢]\s*/, '').replace(/\s*\([^)]*\)/g, '').trim(); if (clean.length < 15) return null; const cacheKey = `${grade}|${clean}`; if (fuzzyMatchCache.has(cacheKey)) return fuzzyMatchCache.get(cacheKey); const normText = normalizeText(clean); const words = normText.split(' ').filter(w => w.length > 1); if (words.length === 0) return null; const threshold = words.length < 10 ? 0.75 : 0.80; const gradeKey = getGradeBandKey(grade); let best = { code: null, score: 0, base: 0, len: Infinity }; for (const [offText, code] of textToSpecificCodeMap.entries()) { const normOffText = normalizeText(offText); const found = words.reduce((count, word) => { const rgx = new RegExp(`\\b${escapeRegExp(word)}\\b`); if (rgx.test(normOffText)) return count + 1; const singular = word.endsWith('s') ? word.slice(0, -1) : null; if (singular && singular.length > 2 && new RegExp(`\\b${escapeRegExp(singular)}\\b`).test(normOffText)) return count + 1; const plural = !word.endsWith('s') ? word + 's' : null; if (plural && new RegExp(`\\b${escapeRegExp(plural)}\\b`).test(normOffText)) return count + 1; return count; }, 0); const baseScore = found / words.length; let weightedScore = baseScore; const el = specificElementMap.get(code); if (gradeKey && el && el.gradeBandKey === gradeKey) weightedScore += 1.0; if (weightedScore > best.score || (weightedScore === best.score && offText.length < best.len)) { best = { code, score: weightedScore, base: baseScore, len: offText.length }; } } const result = best.base >= threshold ? best.code : null; fuzzyMatchCache.set(cacheKey, result); return result; };
        const processAllData = () => { window.allNgss3dElements.forEach(dim => (dim.elements || dim.core_ideas?.flatMap(c => c.components) || []).forEach(item => { const name = item.name.trim(); const parts = name.split(':'); const code = parts[0].trim(); if (!code) return; const nameOnly = parts.length > 1 ? parts.slice(1).join(':').trim() : name; if (!elementMap.has(code)) elementMap.set(code, { ...item, code, dimensionCode: dim.code, dimensionName: dim.dimension }); nameToCodeMap.set(name, code); nameToCodeMap.set(nameOnly, code); nameToCodeMap.set(code, code); Object.entries(item.progressions).forEach(([gradeKey, progs]) => (progs || []).forEach(prog => { if (!specificElementMap.has(prog.code)) specificElementMap.set(prog.code, { ...prog, parentCode: code, parentName: item.name, gradeBandKey: gradeKey, relatedPes: new Set() }); textToSpecificCodeMap.set(prog.text.trim(), prog.code); })); })); window.allNgssData.forEach(gradeData => gradeData.topics.forEach(topic => topic.performanceExpectations.forEach(pe => { const compCodes = new Set(); const specCodes = new Set(); ['sep', 'dci', 'ccc'].forEach(key => (pe.details[key] || []).forEach(ref => {
    let lines = Array.isArray(ref.text) ? [...ref.text] : (typeof ref.text === 'string' ? ref.text.split('\n') : []);
    let lineMatched = false;
    let componentName = ref.id;

    // --- FIX FOR CONNECTIONS DATA STRUCTURE ---
    const isConnection = ref.id.startsWith("Connections to");
    if (isConnection && lines.length > 0) {
        componentName = lines.shift().trim(); // Use first line as component name and remove it
    }

    // Match component code
    const cleanId = componentName.replace(' (secondary)', '').trim();
    let cCode = nameToCodeMap.get(cleanId) || nameToCodeMap.get(cleanId.split(':').pop().trim());
    if (cCode) compCodes.add(cCode);

    // Match specific progression codes from remaining lines
    lines.forEach(line => {
        if (!line.trim()) return;
        const specCode = findBestMatchingSpecificElement(line, gradeData.gradeLabel);
        if (specCode) {
            specCodes.add(specCode);
            const el = specificElementMap.get(specCode);
            if (el) {
                el.relatedPes.add(pe.id);
                // Ensure parent is added, even if primary lookup failed
                if (el.parentCode) compCodes.add(el.parentCode);
            }
            lineMatched = true;
        }
    });

    // Fallback if no specific code was found but we have a component code from the ID
    if (!lineMatched && cCode) {
       // This path is less common now but kept for safety
    }
}));
 peMap.set(pe.id, { ...pe, gradeLabel: gradeData.gradeLabel, topicTitle: topic.topicTitle, connections: topic.connections, associatedComponentCodes: compCodes, associatedSpecificCodes: specCodes }); }))); };
        
        const fetchRawData = async () => {
            try {
                // Fetch all 4 JSON files in parallel
                const [elementsRes, k5Res, msRes, hsRes] = await Promise.all([
                    fetch('https://philm013.github.io/JSON/ngss3DElements.json'),
                    fetch('https://philm013.github.io/JSON/ngssK5.json'),
                    fetch('https://philm013.github.io/JSON/ngss68.json'),
                    fetch('https://philm013.github.io/JSON/ngss912.json')
                ]);

                if (!elementsRes.ok || !k5Res.ok || !msRes.ok || !hsRes.ok) {
                    throw new Error("One or more data files could not be loaded.");
                }

                // Parse JSON
                window.allNgss3dElements = await elementsRes.json();
                const k5Data = await k5Res.json();
                const msData = await msRes.json();
                const hsData = await hsRes.json();

                // Combine grade levels into the structure the app expects
                window.allNgssData = [...k5Data, msData, ...hsData].flat();
                
            } catch (error) {
                console.error("Error fetching NGSS JSON data:", error);
                alert("Failed to load NGSS data files. Please check the console and ensure JSON files are in the correct directory.");
                throw error; // Stop execution
            }
        };

        const loadAndProcessData = async () => {
            // 1. Try to load processed data from IndexedDB Cache
            const cache = await loadDataFromDB();
            
            if (cache && cache.version === CACHE_VERSION) {
                console.log("Restoring data from browser cache...");
                peMap = new Map(cache.peMap);
                peMap.forEach(pe => {
                    pe.associatedComponentCodes = new Set(pe.associatedComponentCodes);
                    pe.associatedSpecificCodes = new Set(pe.associatedSpecificCodes);
                });
                elementMap = new Map(cache.elementMap);
                specificElementMap = new Map(cache.specificElementMap);
                specificElementMap.forEach(el => el.relatedPes = new Set(el.relatedPes));
                nameToCodeMap = new Map(cache.nameToCodeMap);
                textToSpecificCodeMap = new Map(cache.textToSpecificCodeMap);
                gradeToTopicsMap = cache.gradeToTopicsMap;
                allTopics = cache.allTopics;
                sortedGradeLabels = cache.sortedGradeLabels;
                
                // --- RESTORE RAW DATA FROM CACHE TO AVOID NETWORK REQUEST ---
                if (cache.allNgss3dElements && cache.allNgssData) {
                    window.allNgss3dElements = cache.allNgss3dElements;
                    window.allNgssData = cache.allNgssData;
                    return; 
                }
            }

            // 2. Cache Miss or empty: Fetch JSON files from server
            console.log("Cache miss or version mismatch. Downloading fresh data...");
            await fetchRawData();

            // 3. Process the raw data
            processAllData();

            // 4. Generate metadata
            let topics = new Set();
            window.allNgssData.forEach(d => {
                const t = d.topics.map(t => t.topicTitle);
                gradeToTopicsMap[d.gradeLabel] = [...new Set(t)];
                t.forEach(topic => topics.add(topic));
            });
            allTopics = [...topics].sort();
            
            const order = ['Kindergarten', 'First Grade', 'Second Grade', 'K-2 ETS', 'Third Grade', 'Fourth Grade', 'Fifth Grade', '3-5 ETS', 'Middle School', 'High School'];
            sortedGradeLabels = [...new Set([...peMap.values()].map(pe => pe.gradeLabel))].sort((a, b) => {
                const iA = order.indexOf(a),
                    iB = order.indexOf(b);
                return (iA === -1 && iB === -1) ? a.localeCompare(b) : (iA === -1 ? 1 : (iB === -1 ? -1 : iA - iB));
            });

            // 5. Save to Cache
            const dataToCache = {
                version: CACHE_VERSION,
                // --- SAVE RAW DATA TO CACHE ---
                allNgss3dElements: window.allNgss3dElements,
                allNgssData: window.allNgssData,
                // ------------------------------
                peMap: [...peMap].map(([id, pe]) => [id, { ...pe,
                    associatedComponentCodes: [...pe.associatedComponentCodes],
                    associatedSpecificCodes: [...pe.associatedSpecificCodes]
                }]),
                elementMap: [...elementMap],
                specificElementMap: [...specificElementMap].map(([id, el]) => [id, { ...el,
                    relatedPes: [...el.relatedPes]
                }]),
                nameToCodeMap: [...nameToCodeMap],
                textToSpecificCodeMap: [...textToSpecificCodeMap],
                gradeToTopicsMap,
                allTopics,
                sortedGradeLabels
            };

            try {
                saveDataToDB(dataToCache);
            } catch (e) {
                console.error("Error caching data:", e);
            }
        };

        const buildMatrixDataMap = () => { elementToGradePeMap.clear(); for (const pe of peMap.values()) for (const code of pe.associatedComponentCodes) { if (!elementToGradePeMap.has(code)) elementToGradePeMap.set(code, new Map()); const gradeMap = elementToGradePeMap.get(code); if (!gradeMap.has(pe.gradeLabel)) gradeMap.set(pe.gradeLabel, new Set()); gradeMap.get(pe.gradeLabel).add(pe.id); } };
        
        // --- 4. UI RENDERING & NAVIGATION ---
        const populatePeTable = () => { 
            // --- LAZY LOADING: RENDER EMPTY DETAILS ROWS INITIALLY ---
            peTableBody.innerHTML = [...peMap.values()].map(pe => `
                <tr class="pe-main-row" data-pe-id="${pe.id}" data-grade="${pe.gradeLabel}">
                    <td><input type="checkbox" class="pe-bundle-checkbox" data-pe-id="${pe.id}" ${peBundle.has(pe.id) ? 'checked' : ''}></td>
                    <td><span class="pe-id copyable" title="${pe.description.replace(/"/g, '&quot;')}">${pe.id}</span></td>
                    <td><span class="copyable" title="${pe.description.replace(/"/g, '&quot;')}">${pe.description}</span></td>
                    <td><span class="copyable">${pe.gradeLabel}</span></td>
                    <td><span class="copyable">${pe.topicTitle}</span></td>
                </tr>
                <tr class="pe-details-row" data-pe-id="${pe.id}">
                    <td colspan="5"></td>
                </tr>`
            ).join(''); 
        };
        const processAndLinkPeText = (text, peId) => { 
            const pe = peMap.get(peId); 
            
            // 1. Handle Array (new) vs String (old) input
            if (!text) return '';
            const lines = Array.isArray(text) ? text : text.split('\n');

            if (!pe) return lines.join('<br>'); // Fallback
            
            return lines.map((line, index) => { 
                const cleanLine = line.trim();
                if (!cleanLine) return ''; 
                
                let processedLine = line;
                let codeDisplay = ''; // New variable to hold the code HTML
                
                // 2. Attempt to link text to 3D element codes
                const code = findBestMatchingSpecificElement(line, pe.gradeLabel); 
                
                if (code) { 
                    const el = specificElementMap.get(code); 
                    if (el) {
                        processedLine = `<span class="clickable-element-link" title="${el.text.replace(/"/g, '&quot;')}" data-pe-id="${peId}" data-component-code="${el.parentCode}" data-specific-code="${code}">${line}</span>`; 
                        codeDisplay = `<strong style="font-family: monospace; color: #888;  font-size: 0.9em;">(${code})</strong> `;
                    }
                } 
                
                // 3. Smart Bullet Detection
                const hasExistingBullet = cleanLine.startsWith('‚Ä¢') || cleanLine.startsWith('*') || cleanLine.startsWith('-');
                const isHeader = cleanLine.endsWith(':');
                const isSpecificItem = !!code; // It matched a progression/element
                
                // Logic: It's a bullet if it already has one, OR if it's a specific element, OR if it's item 2+ in a list, UNLESS it looks like a header.
                let shouldBeBullet = hasExistingBullet || ((isSpecificItem || (lines.length > 1 && index > 0)) && !isHeader);

                let className = 'pe-details-paragraph';
                let finalHtml = `${codeDisplay}${processedLine}`;
                
                if (shouldBeBullet) {
                    className += ' is-bullet';
                    // If the bullet character is missing from the text (because of the JSON cleanup), add it visually here.
                    if (!hasExistingBullet) {
                        finalHtml = `‚Ä¢ ${finalHtml}`; 
                    }
                }
                
                return `<p class="${className}">${finalHtml}</p>`; 
            }).join(''); 
        };
		const createPeDetailsHtml = (pe, inBundle = false) => {
            // Helper to link codes
            const linkPeCodes = (text, currentPe) => {
                if (!text) return 'N/A';
                text = text.replace(/\(([A-Z0-9-]+)\)/g, (match, id) => {
                    const p = peMap.get(id);
                    if (p && id !== currentPe.id) return `<span class="pe-nav-link" data-pe-id="${id}" title="${`PE: ${id}\n${p.description}`.replace(/"/g, '&quot;')}">${match}</span>`;
                    return match;
                });
                return text.replace(/\b(?:[K\d]|MS|HS)(?:-\d)?\.([A-Z]{2,4}\d?(?:\.[A-Z])?)\b/g, (match, code) => {
                    const el = elementMap.get(code);
                    if (el) return `<span class="clickable-element-link" data-pe-id="${currentPe.id}" data-component-code="${code}" title="${`Dimension Element: ${el.name}`.replace(/"/g, '&quot;')}">${match}</span>`;
                    return match;
                });
            };

            // Helper to create columns with specific color classes
            const createCol = (dim, title) => {
                const items = pe.details[dim] || [];
                if (!items.length) return '';

                const regularItems = [];
                const connectionItems = [];
                let inConnectionSection = false;
                for (const item of items) {
                    if (item.id.startsWith('Connections to')) {
                        inConnectionSection = true;
                    }
                    if (inConnectionSection) {
                        connectionItems.push(item);
                    } else {
                        regularItems.push(item);
                    }
                }

                const regularItemsHtml = regularItems.map(item => {
                    const code = nameToCodeMap.get(item.id.replace(' (secondary)', '').trim());
                    const el = code ? elementMap.get(code) : null;
                    return `<li>
                        <span class="clickable-element-link" ${code ? `data-component-code="${code}" data-pe-id="${pe.id}"` : ''} ${el ? `title="${el.name.replace(/"/g, '&quot;')}"` : ''}>
                            <strong class="copyable">${item.id}</strong>
                        </span>
                        <div class="copyable">${processAndLinkPeText(item.text, pe.id)}</div>
                    </li>`;
                }).join('');

                let connectionItemsHtml = '';
                if (connectionItems.length > 0) {
                    connectionItemsHtml += `<div class="pe-details-col-connections-wrapper">`;
                    connectionItems.forEach(item => {
                        const textContent = Array.isArray(item.text) ? item.text.join('') : (item.text || '');
                        if (textContent.trim() === '') {
                            connectionItemsHtml += `<strong class="connection-header">${item.id}</strong>`;
                        } else {
                            connectionItemsHtml += `<div class="connection-item-block">
                                <strong class="connection-subheader">${item.id}</strong>
                                <div class="connection-text">${processAndLinkPeText(item.text, pe.id)}</div>
                            </div>`;
                        }
                    });
                    connectionItemsHtml += `</div>`;
                }

                const colClass = `pe-col-${dim}`;
                return `<div class="pe-details-column ${colClass}">
                    <h4>${title}</h4>
                    <ul>${regularItemsHtml}</ul>
                    ${connectionItemsHtml}
                </div>`;
            };

            const createConns = (conns, currentPe) => {
                if (!conns) return '';
                const filterStr = text => {
                    if (!text) return 'N/A';
                    const relevant = text.split(';').map(s => s.trim()).filter(Boolean).filter(e => e.includes(`(${currentPe.id})`));
                    return relevant.length ? linkPeCodes(relevant.join('; '), currentPe) : 'N/A';
                };
                const filterArr = items => items ? items.filter(i => i.text && i.text.includes(`(${currentPe.id})`)) : [];
                const ela = filterArr(conns.commonCoreStateStandards?.elaLiteracy).map(i => `<li class="copyable"><strong>${i.id}:</strong> ${linkPeCodes(i.text, currentPe)}</li>`).join('');
                const math = filterArr(conns.commonCoreStateStandards?.mathematics).map(i => `<li class="copyable"><strong>${i.id}:</strong> ${linkPeCodes(i.text, currentPe)}</li>`).join('');
                return `<div class="pe-details-connections">
                    <h3>Connections</h3>
                    <div class="pe-connections-grid">
                        <div class="pe-connections-section"><h4>Connections to other DCIs in this grade-level</h4><p class="copyable">${filterStr(conns.connectionsToOtherDcisInGradeLevel)}</p></div>
                        <div class="pe-connections-section"><h4>Articulation of DCIs across grade levels</h4><p class="copyable">${filterStr(conns.articulationOfDcisAcrossGradeLevels)}</p></div>
                        <div class="pe-connections-section"><h4>Connections to Common Core (ELA)</h4><ul>${ela || '<li>N/A</li>'}</ul></div>
                        <div class="pe-connections-section"><h4>Connections to Common Core (Math)</h4><ul>${math || '<li>N/A</li>'}</ul></div>
                    </div>
                </div>`;
            };

            const savedDesc = savedAnalyses[pe.id]?.description || pe.description;
            
            const clarification = pe.details.clarificationStatement ? `<div class="pe-details-info-box clarification"><h4>Clarification Statement</h4><p class="copyable">${pe.details.clarificationStatement}</p></div>` : '';
            const boundary = pe.details.assessmentBoundary ? `<div class="pe-details-info-box boundary"><h4>Assessment Boundary</h4><p class="copyable">${pe.details.assessmentBoundary}</p></div>` : '';
            
            const esBtn = (pe.details.evidenceStatements && pe.details.evidenceStatements.length) ? `<button class="filter-btn view-evidence-btn" data-pe-id="${pe.id}">View Evidence Statements</button>` : '';
            const analyzeBtn = inBundle ? '' : `<div class="ai-controls"><button class="filter-btn active analyze-pe-desc-btn" data-pe-id="${pe.id}">Analyze with Full Context</button><button class="filter-btn reset-btn reset-analysis-btn">Reset</button></div>`;

            // MODIFIED LAYOUT STRUCTURE: Removed pe-description-header (ID, Description, Buttons)
            return `<div class="pe-details-wrapper">
                
                <div style="margin-top:0;">${clarification}${boundary}</div>
                <div class="pe-details-container" style="margin-top:1rem;">
                    ${createCol('sep', 'Science & Engineering Practices')}
                    ${createCol('dci', 'Disciplinary Core Ideas')}
                    ${createCol('ccc', 'Crosscutting Concepts')}
                </div>
                <div class="pe-details-actions">
                    ${esBtn}
                </div>
                ${createConns(pe.connections, pe)}
            </div>`;
        };
const populate3dTable = () => { threedTableBody.innerHTML = window.allNgss3dElements.map(dim => { let html = `<tr class="dimension-header header-row" data-dimension-code="${dim.code}"><td colspan="5">${dim.dimension}</td></tr>`; const items = dim.elements || dim.core_ideas?.flatMap(c => c.components) || []; const progHtml = p => ['primary', 'elementary', 'middle', 'high'].map(k => `<td>${(p[k] || []).map(i => `<div class="item" data-code="${i.code}" title="${i.text.replace(/"/g, '&quot;')}\n\n(Click to see related PEs)"><strong>${i.code}</strong> ${i.text}</div>`).join('')}</td>`).join(''); if (dim.elements) html += dim.elements.map(el => `<tr class="data-row" data-dimension-code="${dim.code}" data-component-code="${el.name.split(':')[0].trim()}"><td class="element-header">${el.name}</td>${progHtml(el.progressions)}</tr>`).join(''); else if (dim.core_ideas) html += dim.core_ideas.map(core => `<tr class="dci-major-header header-row" data-dimension-code="${dim.code}" data-component-code="${core.name.split(':')[0].trim()}"><td colspan="5">${core.name}</td></tr>` + core.components.map(comp => `<tr class="data-row" data-dimension-code="${dim.code}" data-component-code="${comp.name.split(':')[0].trim()}"><td class="dci-minor-header">${comp.name}</td>${progHtml(comp.progressions)}</tr>`).join('')).join(''); return html; }).join(''); };
        const renderTopicFilters = grade => { const cont = document.getElementById('topic-filters-container'), group = document.getElementById('topic-filters'); const topics = grade === 'all' ? allTopics : gradeToTopicsMap[grade]; if (!topics || !topics.length) { cont.style.display = 'none'; group.innerHTML = ''; return; } const active = new Set([...document.querySelectorAll('#topic-filters .filter-btn.active')].map(b => b.dataset.filter)); let hasActive = active.size > 0 && !active.has('all'); let html = `<button class="filter-btn ${!hasActive ? 'active' : ''}" data-filter="all">All Topics</button>`; html += topics.map(t => `<button class="filter-btn ${active.has(t) ? 'active' : ''}" data-filter="${t}">${t}</button>`).join(''); group.innerHTML = html; cont.style.display = 'block'; };
        const updateNavControls = () => navigationControls.style.display = navigationHistory.length > 0 ? 'flex' : 'none';
        const pushNavState = (isLinkNav = false) => { const cont = document.querySelector('.explorer-view.is-visible .table-container'); const state = { view: currentView, scrollTop: cont ? cont.scrollTop : 0, searchTerm: searchInput.value, activePeFilter, isLinkNavigation: isLinkNav }; if (currentView === 'pe') { state.activeGrade = gradeFilters.querySelector('.active')?.dataset.filter; state.expandedPe = peTableBody.querySelector('.pe-main-row.expanded')?.dataset.peId; state.activeElementFilters = new Set(activeElementFilters); state.activeBundleFilter = activeBundleFilter; } else if (['3d', 'matrix'].includes(currentView)) { state.activeDimension = dimensionFilters.querySelector('.active')?.dataset.filter; state.activeSubFilters = [...subDimensionFilters.querySelectorAll('.active')].map(b => b.dataset.filter); state.activeDciMinorFilters = [...dciMinorFilters.querySelectorAll('.active')].map(b => b.dataset.filter); if (currentView === '3d') state.isolatedColumn = isolatedColumn; } if (currentView === 'matrix') state.matrixRowElements = new Set(matrixRowElements); navigationHistory.push(state); updateNavControls(); };
        const goBack = () => { 
            if (!navigationHistory.length) return; 
            const s = navigationHistory.pop(); 
            activePeFilter = s.activePeFilter; 
            searchInput.value = s.searchTerm; 
            if (s.view === 'pe') { document.querySelectorAll('#grade-filters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === s.activeGrade)); renderTopicFilters(s.activeGrade); activeElementFilters = s.activeElementFilters || new Set(); renderActiveElementFilters(); activeBundleFilter = s.activeBundleFilter; renderBundleFilters(); } else if (['3d', 'matrix'].includes(s.view)) { document.querySelectorAll('#dimension-filters .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === s.activeDimension)); renderSubFilters(s.activeDimension); if (s.activeSubFilters) document.querySelectorAll('#sub-dimension-filters .filter-btn').forEach(b => b.classList.toggle('active', s.activeSubFilters.includes(b.dataset.filter))); if (s.activeDimension && s.activeDimension.startsWith('DCI') && s.activeSubFilters.length > 0) { renderDciMinorFilters(s.activeSubFilters[0]); if (s.activeDciMinorFilters) document.querySelectorAll('#dci-minor-filters .filter-btn').forEach(b => b.classList.toggle('active', s.activeDciMinorFilters.includes(b.dataset.filter))); } if (s.view === '3d') s.isolatedColumn = isolatedColumn; } if (s.view === 'matrix') matrixRowElements = s.matrixRowElements || new Set(); switchView(s.view, null, false); 
            setTimeout(() => { 
                const cont = document.querySelector('.explorer-view.is-visible .table-container'); 
                if (cont) cont.scrollTop = s.scrollTop; 
                if (s.view === 'pe' && s.expandedPe) { 
                    const row = peTableBody.querySelector(`.pe-main-row[data-pe-id="${s.expandedPe}"]`); 
                    if (row) { 
                        // --- LAZY LOAD CONTENT ON BACK NAVIGATION ---
                        const detailsRow = row.nextElementSibling;
                        const detailsCell = detailsRow.querySelector('td');
                        if (!detailsCell.hasChildNodes()) {
                            const pe = peMap.get(s.expandedPe);
                            if (pe) detailsCell.innerHTML = createPeDetailsHtml(pe);
                        }
                        row.classList.add('expanded'); 
                        row.nextElementSibling.classList.add('is-visible'); 
                    } 
                } 
            }, 50); 
            updateNavControls(); updateUrlFromState(); 
        };
        const navigateToPe = id => { 
            pushNavState(true); 
            currentView = 'pe'; 
            navPeExplorer.classList.add('active'); 
            navThreedExplorer.classList.remove('active'); 
            navMatrixView.classList.remove('active'); 
            peExplorerView.style.display = 'flex'; 
            threedExplorerView.style.display = 'none'; 
            matrixView.style.display = 'none'; 
            bundleView.style.display = 'none'; 
            peFiltersAll.style.display = 'block'; 
            threedFiltersAll.style.display = 'none'; 
            searchInput.value = ''; 
            gradeFilters.querySelector('.active')?.classList.remove('active'); 
            gradeFilters.querySelector('[data-filter="all"]').classList.add('active'); 
            renderTopicFilters('all'); 
            activeElementFilters.clear(); 
            renderActiveElementFilters(); 
            activeBundleFilter = null; 
            renderBundleFilters(); 
            applyFilters(); 
            setTimeout(() => { 
                const row = peTableBody.querySelector(`.pe-main-row[data-pe-id="${id}"]`); 
                if (row) { 
                    peTableBody.querySelectorAll('.expanded, .is-visible').forEach(r => r.classList.remove('expanded', 'is-visible')); 
                    
                    // --- LAZY LOAD CONTENT FOR INTERNAL NAV ---
                    const detailsRow = row.nextElementSibling;
                    const detailsCell = detailsRow.querySelector('td');
                    if (!detailsCell.hasChildNodes()) {
                        const pe = peMap.get(id);
                        if (pe) detailsCell.innerHTML = createPeDetailsHtml(pe);
                    }
                    
                    row.classList.add('expanded'); 
                    row.nextElementSibling.classList.add('is-visible'); 
                    
                    scrollToPeRow(row); // Use standardized scroll to top
                    
                    row.classList.add('scroll-target'); 
                    setTimeout(() => row.classList.remove('scroll-target'), 1500); 
                } 
                updateUrlFromState(); 
            }, 100); 
        };
        
        // --- 5. VIEW & FILTER LOGIC ---
        const switchView = (name, target = null, push = false) => { if (push && (currentView !== name || !navigationHistory[navigationHistory.length - 1]?.isLinkNavigation)) pushNavState(target !== null); currentView = name; navPeExplorer.classList.toggle('active', name === 'pe'); peExplorerView.style.display = name === 'pe' ? 'flex' : 'none'; navThreedExplorer.classList.toggle('active', name === '3d'); threedExplorerView.style.display = name === '3d' ? 'flex' : 'none'; navMatrixView.classList.toggle('active', name === 'matrix'); matrixView.style.display = name === 'matrix' ? 'flex' : 'none'; if (name !== 'bundle') bundleView.style.display = 'none'; sidebarFiltersContainer.style.display = 'block'; resultsCountSpan.style.display = 'block'; peFiltersAll.style.display = name === 'pe' ? 'block' : 'none'; threedFiltersAll.style.display = ['3d', 'matrix'].includes(name) ? 'block' : 'none'; if (name === 'matrix') renderMatrix(); else if (name === 'pe') syncCheckboxesWithBundle(); if (activePeFilter) { const pe = peMap.get(activePeFilter); activePeFilterTag.querySelector('span').textContent = `Highlighting for PE: ${pe ? pe.id : '...'}`; activePeFilterTag.style.display = 'flex'; activePeFilterTag.dataset.peId = activePeFilter; activePeFilterTag.style.cursor = 'pointer'; activePeFilterTag.title = `Click to go to ${activePeFilter} in PE Explorer`; } else { activePeFilterTag.style.display = 'none'; activePeFilterTag.removeAttribute('data-pe-id'); activePeFilterTag.style.cursor = 'default'; activePeFilterTag.removeAttribute('title'); } if (!target && !push && !isNavigatingHistory) { searchInput.value = ''; if (name === 'pe') { gradeFilters.querySelector('.active')?.classList.remove('active'); gradeFilters.querySelector('[data-filter="all"]')?.classList.add('active'); } else if (['3d', 'matrix'].includes(name)) dimensionFilters.querySelector('.active')?.classList.remove('active'); } if (name === '3d' && push) { dimensionFilters.querySelector('.active')?.classList.remove('active'); subDimensionFilters.innerHTML = ''; subDimensionFiltersContainer.style.display = 'none'; dciMinorFilters.innerHTML = ''; dciMinorFiltersContainer.style.display = 'none'; isolatedColumn = null; searchInput.value = ''; } applyFilters(); updateUrlFromState(); if (name === '3d' && target) { let el; if (target.specific) el = threedTableBody.querySelector(`.item[data-code="${target.specific}"]`); else if (target.component) el = threedTableBody.querySelector(`tr[data-component-code="${target.component}"]`); if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (target.specific) { el.classList.add('scroll-target'); setTimeout(() => el.classList.remove('scroll-target'), 1500); } } } };
        const resetApp = () => { 
            isNavigatingHistory = true; 
            searchInput.value = ''; 
            navigationHistory = []; 
            
            // --- FIX: Clear Bundle State ---
            peBundle.clear();
            syncCheckboxesWithBundle();
            updateBundleControls();
            // -------------------------------

            activePeFilter = null; 
            isolatedColumn = null; 
            activeElementFilters.clear(); 
            activeBundleFilter = null; 
            peTableBody.querySelectorAll('.expanded, .is-visible').forEach(r => r.classList.remove('expanded', 'is-visible')); 
            matrixRowElements.clear(); 
            window.allNgss3dElements.forEach(d => (d.elements || d.core_ideas?.flatMap(c => c.components) || []).forEach(i => { const c = i.name.split(':')[0].trim(); if (c) matrixRowElements.add(c); })); 
            gradeFilters.querySelector('.active')?.classList.remove('active'); 
            gradeFilters.querySelector('[data-filter="all"]')?.classList.add('active'); 
            renderTopicFilters('all'); 
            renderActiveElementFilters(); 
            renderBundleFilters(); 
            dimensionFilters.querySelector('.active')?.classList.remove('active'); 
            subDimensionFiltersContainer.style.display = 'none'; 
            dciMinorFiltersContainer.style.display = 'none'; 
            subDimensionFilters.innerHTML = ''; 
            dciMinorFilters.innerHTML = ''; 
            updateNavControls(); 
            clearPeFilter(); 
            switchView('pe', null, false); 
            const cont = peExplorerView.querySelector('.table-container'); 
            if (cont) cont.scrollTop = 0; 
            history.replaceState(null, '', window.location.pathname); 
            isNavigatingHistory = false; 
        };
        const applySearchHighlight = (container, term) => {
            // 1. Cleanup: Remove existing highlights before applying new ones
            container.querySelectorAll('span.search-highlight').forEach(span => {
                const parent = span.parentNode;
                parent.replaceChild(document.createTextNode(span.textContent), span);
                parent.normalize(); // Merge adjacent text nodes
            });

            if (!term) return;

            // 2. Escape regex characters to prevent errors with terms like "E=mc^2"
            const safeTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${safeTerm})`, 'gi');
            
            // 3. Walk through all text nodes
            const walker = document.createTreeWalker(
                container, 
                NodeFilter.SHOW_TEXT, 
                {
                    acceptNode: (node) => {
                        // Skip empty text or text inside existing highlights
                        if (!node.textContent.trim()) return NodeFilter.FILTER_REJECT;
                        if (node.parentNode.classList.contains('search-highlight')) return NodeFilter.FILTER_REJECT;
                        return NodeFilter.FILTER_ACCEPT;
                    }
                }, 
                false
            );

            const nodesToHighlight = [];
            while (walker.nextNode()) {
                if (regex.test(walker.currentNode.textContent)) {
                    nodesToHighlight.push(walker.currentNode);
                }
            }

            // 4. Apply Highlight
            nodesToHighlight.forEach(node => {
                const fragment = document.createDocumentFragment();
                // Split by the regex (capturing group keeps the separator/match)
                const parts = node.textContent.split(regex);
                
                parts.forEach(part => {
                    if (part.toLowerCase() === term.toLowerCase()) {
                        const span = document.createElement('span');
                        span.className = 'search-highlight';
                        span.textContent = part;
                        fragment.appendChild(span);
                    } else {
                        fragment.appendChild(document.createTextNode(part));
                    }
                });
                
                node.parentNode.replaceChild(fragment, node);
            });
        };
		const applyFilters = () => { if (currentView === 'pe') filterPeTable(); else if (currentView === '3d') update3dView(); else if (currentView === 'matrix') filterMatrixTable(); const body = document.querySelector('.explorer-view.is-visible table tbody'); if (body) applySearchHighlight(body, searchInput.value.trim()); };
        const filterPeTable = () => { const term = searchInput.value.trim().toLowerCase(); const grade = gradeFilters.querySelector('.active')?.dataset.filter || 'all'; const topics = new Set([...document.querySelectorAll('#topic-filters .filter-btn.active')].map(b => b.dataset.filter)); const showAllTopics = topics.has('all') || topics.size === 0; const bundleIds = activeBundleFilter ? new Set(savedBundles[activeBundleFilter]) : null; let count = 0; peTableBody.querySelectorAll('.pe-main-row').forEach(row => { const pe = peMap.get(row.dataset.peId); const hasElems = activeElementFilters.size === 0 || [...activeElementFilters].every(code => pe.associatedComponentCodes.has(code)); const inBundle = !bundleIds || bundleIds.has(pe.id); const isVis = (!term || row.textContent.toLowerCase().includes(term)) && (grade === 'all' || row.dataset.grade === grade) && (showAllTopics || topics.has(pe.topicTitle)) && hasElems && inBundle; row.style.display = isVis ? '' : 'none'; const details = row.nextElementSibling; if (!isVis && details?.classList.contains('is-visible')) { details.classList.remove('is-visible'); row.classList.remove('expanded'); } if (isVis) count++; }); updateSelectAllCheckboxState(); resultsCountSpan.textContent = `${count} PEs found.`; };
        const clearPeFilter = () => { activePeFilter = null; activePeFilterTag.style.display = 'none'; applyFilters(); updateUrlFromState(); };
        const applyColumnIsolation = () => { const table = document.getElementById('threed-explorer-table'); table.className = ''; document.querySelectorAll('.col-toggle-btn.active').forEach(b => b.classList.remove('active')); if (isolatedColumn) { table.classList.add('col-isolated', `isolate-col-${isolatedColumn}`); table.querySelector(`.col-toggle-btn[data-col="${isolatedColumn}"]`)?.classList.add('active'); } };
        const update3dView = () => { applyColumnIsolation(); const term = searchInput.value.trim().toLowerCase(); const dim = dimensionFilters.querySelector('.active')?.dataset.filter; let compCodes, specCodes; threedTableBody.querySelectorAll('.pe-highlight-row, .pe-highlight-specific').forEach(el => el.classList.remove('pe-highlight-row', 'pe-highlight-specific')); if (activePeFilter) { const pe = peMap.get(activePeFilter); if (pe) { compCodes = pe.associatedComponentCodes; specCodes = pe.associatedSpecificCodes; } } let count = 0; threedTableBody.querySelectorAll('.data-row').forEach(row => { let isVis = true; const code = row.dataset.componentCode; if (dim) { if (row.dataset.dimensionCode !== dim) isVis = false; else if (dim.startsWith('DCI')) { const major = document.querySelector('#sub-dimension-filters .active')?.dataset.filter; const minors = new Set([...dciMinorFilters.querySelectorAll('.active')].map(b => b.dataset.filter)); if (minors.size > 0) { if (![...minors].some(m => code.startsWith(m))) isVis = false; } else if (major && !code.startsWith(major)) isVis = false; } else { const subs = new Set([...subDimensionFilters.querySelectorAll('.active')].map(b => b.dataset.filter)); if (subs.size > 0 && !subs.has(code)) isVis = false; } } if (isVis && term && !row.textContent.toLowerCase().includes(term)) isVis = false; if (compCodes) { if (compCodes.has(row.dataset.componentCode)) { row.classList.add('pe-highlight-row'); row.querySelectorAll('.item').forEach(item => { if (specCodes && specCodes.has(item.dataset.code)) item.classList.add('pe-highlight-specific'); }); } else if (!term && !dim) isVis = false; } row.style.display = isVis ? '' : 'none'; if (isVis) count++; }); threedTableBody.querySelectorAll('.header-row').forEach(h => { let next = h.nextElementSibling, hasVis = false; while (next && !next.classList.contains('header-row')) { if (next.style.display !== 'none') { hasVis = true; break; } next = next.nextElementSibling; } h.style.display = hasVis ? '' : 'none'; }); resultsCountSpan.textContent = `${count} elements found.`; };
        const renderDciMinorFilters = major => { const dimCode = dimensionFilters.querySelector('.active')?.dataset.filter; const dciData = window.allNgss3dElements.find(d => d.code === dimCode); if (!dciData) { dciMinorFiltersContainer.style.display = 'none'; return; } const core = dciData.core_ideas.find(c => c.name.startsWith(major)); if (!core) { dciMinorFiltersContainer.style.display = 'none'; return; } dciMinorFilters.innerHTML = core.components.map(c => `<button class="filter-btn" data-filter="${c.name.split(':')[0].trim()}">${c.name}</button>`).join(''); dciMinorFiltersContainer.style.display = core.components.length ? 'block' : 'none'; };
        const renderSubFilters = dimCode => { const dimData = window.allNgss3dElements.find(d => d.code === dimCode); const label = subDimensionFiltersContainer.querySelector('.filter-group-label'); dciMinorFiltersContainer.style.display = 'none'; if (!dimData) { subDimensionFiltersContainer.style.display = 'none'; return; } let hasItems = false; if (dimData.code.startsWith('DCI')) { label.textContent = 'Filter by Core Idea:'; subDimensionFilters.innerHTML = dimData.core_ideas.map(c => `<button class="filter-btn" data-filter="${c.name.split(':')[0].trim()}">${c.name}</button>`).join(''); hasItems = dimData.core_ideas.length > 0; } else { label.textContent = 'Filter by Element:'; const items = dimData.elements || []; subDimensionFilters.innerHTML = items.map(i => `<button class="filter-btn" data-filter="${i.name.split(':')[0].trim()}">${i.name.split(':').slice(-1)[0].trim()}</button>`).join(''); hasItems = items.length > 0; } subDimensionFiltersContainer.style.display = hasItems ? 'block' : 'none'; clearSubFiltersBtn.style.display = hasItems ? 'block' : 'none'; };

        // --- 6. BUNDLE & ADVANCED FILTERS ---
        const updateBundleControls = () => { const count = peBundle.size; bundleCountSpan.textContent = `${count} PE${count !== 1 ? 's' : ''} selected`; bundleControls.style.display = count > 0 ? 'flex' : 'none'; localStorage.setItem('ngssPeBundle', JSON.stringify([...peBundle])); };
        const updateSelectAllCheckboxState = () => { const vis = [...peTableBody.querySelectorAll('.pe-main-row:not([style*="display: none"]) .pe-bundle-checkbox')]; if (!vis.length) { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; return; } const checked = vis.filter(cb => cb.checked).length; selectAllCheckbox.checked = checked === vis.length; selectAllCheckbox.indeterminate = checked > 0 && checked < vis.length; };
        const syncCheckboxesWithBundle = () => { peTableBody.querySelectorAll('.pe-bundle-checkbox').forEach(cb => { cb.checked = peBundle.has(cb.dataset.peId); }); updateSelectAllCheckboxState(); };
        const renderBundleSummary = () => { const counts = {}; peBundle.forEach(id => { const pe = peMap.get(id); if (!pe) return; pe.associatedComponentCodes.forEach(code => { const el = elementMap.get(code); if (!el) return; const dim = el.dimensionCode; if (!counts[dim]) counts[dim] = new Map(); if (!counts[dim].has(code)) counts[dim].set(code, { name: el.name, count: 0 }); counts[dim].get(code).count++; }); }); const order = window.allNgss3dElements.map(d => d.code); const dims = Object.keys(counts).filter(d => counts[d].size > 0).sort((a, b) => order.indexOf(a) - order.indexOf(b)); const listHtml = map => `<ul>${[...map.entries()].sort((a, b) => b[1].count - a[1].count).map(([_, { name, count }]) => `<li class="copyable"><strong>(${count})</strong> ${name}</li>`).join('')}</ul>`; const colHtml = code => { const data = window.allNgss3dElements.find(d => d.code === code); return `<div class="bundle-summary-col"><h4>${data ? data.dimension : code}</h4>${listHtml(counts[code])}</div>`; }; const dciHtml = codes => { if (!codes.length) return ''; return `<div class="bundle-summary-col dci-group"><h4>Disciplinary Core Ideas</h4>${codes.map(code => { const data = window.allNgss3dElements.find(d => d.code === code); return `<div class="dci-sub-group"><h5 class="dci-sub-header">${data ? data.dimension.replace('Disciplinary Core Ideas - ', '') : code}</h5>${listHtml(counts[code])}</div>`; }).join('')}</div>`; }; const mainCodes = ['SEP', 'CCC']; const dciCodes = dims.filter(d => d.startsWith('DCI')); const connCodes = dims.filter(d => ['CNS', 'C-ETAS'].includes(d)); let mainGrid = dims.filter(d => mainCodes.includes(d)).map(colHtml).join(''); mainGrid += dciHtml(dciCodes); const connGrid = connCodes.map(colHtml).join(''); return `<div class="bundle-summary"><h3>Bundle 3D Element Summary</h3><div class="bundle-summary-grid">${mainGrid}</div>${connGrid ? `<div class="bundle-summary-connections-grid">${connGrid}</div>` : ''}</div>`; };
        const renderBundleView = () => { if (!peBundle.size) return; currentView = 'bundle'; peExplorerView.style.display = 'none'; threedExplorerView.style.display = 'none'; bundleView.style.display = 'flex'; let html = `<div class="bundle-header"><h2>Selected PEs (${peBundle.size})</h2><div class="bundle-header-actions"><button id="copy-bundle-btn" class="filter-btn">Copy</button><button id="print-bundle-btn" class="filter-btn">Print</button><button id="back-to-pe-list-btn" class="filter-btn">&larr; Back</button></div></div>`; html += renderBundleSummary(); peBundle.forEach(id => { const pe = peMap.get(id); if (pe) html += `<div class="pe-bundle-item"><h3>${pe.id}: ${pe.description}</h3><div>${createPeDetailsHtml(pe, true)}</div></div>`; }); bundleView.innerHTML = html; document.getElementById('back-to-pe-list-btn').addEventListener('click', () => { bundleView.style.display = 'none'; switchView('pe'); }); document.getElementById('print-bundle-btn').addEventListener('click', () => window.print()); document.getElementById('copy-bundle-btn').addEventListener('click', copyBundleToClipboard); updateUrlFromState(); };
        const copyBundleToClipboard = () => { let text = `NGSS PE Bundle (${peBundle.size} PEs)\n==============================\n\n`; const summary = document.querySelector('.bundle-summary'); if (summary) text += summary.innerText + '\n\n------------------------------\n\n'; peBundle.forEach(id => { const pe = peMap.get(id); if (pe) { text += `${pe.id}: ${pe.description}\n`; ['sep', 'dci', 'ccc'].forEach(dim => { if (pe.details[dim]?.length) { text += `  ${dim.toUpperCase()}:\n`; // FIX: Handle Array or String for Clipboard
pe.details[dim].forEach(item => { 
    const txt = Array.isArray(item.text) ? item.text.join(' ') : item.text.replace(/\n/g, ' ');
    text += `    - ${item.id}: ${txt.trim()}\n`; 
}); } }); text += '\n'; } }); navigator.clipboard.writeText(text).then(() => alert('Bundle details copied!')); };
        const renderActiveElementFilters = () => { activeElementFiltersDiv.innerHTML = [...activeElementFilters].map(code => { const el = elementMap.get(code); const name = el ? el.name.split(':')[1]?.trim() || el.name : code; return `<span class="element-filter-tag">${name} <button data-code="${code}" title="Remove filter">&times;</button></span>`; }).join(''); };
        const saveBundlesToStorage = () => localStorage.setItem('ngssSavedBundles', JSON.stringify(savedBundles));
        const loadBundlesFromStorage = () => savedBundles = JSON.parse(localStorage.getItem('ngssSavedBundles') || '{}');
        const renderBundleManager = () => { document.getElementById('bundle-manager-list').innerHTML = Object.keys(savedBundles).sort().map(name => `<li><div><span class="bundle-name">${name}</span> (${savedBundles[name].length} PEs)</div><div class="actions"><button class="filter-btn load-bundle-btn" data-name="${name}">Load</button><button class="filter-btn delete-bundle-btn" data-name="${name}">Delete</button></div></li>`).join('') || '<li>No saved bundles.</li>'; };
        const renderBundleFilters = () => { let html = `<button class="filter-btn ${!activeBundleFilter ? 'active' : ''}" data-name="all">All PEs</button>`; html += Object.keys(savedBundles).sort().map(name => `<button class="filter-btn ${activeBundleFilter === name ? 'active' : ''}" data-name="${name}">${name}</button>`).join(''); bundleFilters.innerHTML = html; };
        
        // --- 7. EVIDENCE STATEMENTS, MATRIX, FACETS & AI ---
        const saveAnalysis = (peId, part, data) => { if (!savedAnalyses[peId]) savedAnalyses[peId] = {}; savedAnalyses[peId][part] = data; saveAnalysisToDB(peId, part, data); };
        const resetAnalysis = (peId, part, element) => { if (savedAnalyses[peId]?.[part]) { delete savedAnalyses[peId][part]; if (Object.keys(savedAnalyses[peId]).length === 0) delete savedAnalyses[peId]; deleteAnalysisFromDB(peId, part); } const pe = peMap.get(peId); if (part === 'description') element.innerHTML = pe.description; else if (part === 'evidenceStatements') element.innerHTML = formatEvidenceStatements(pe.details.evidenceStatements); };
        const formatEvidenceStatements = stmts => { if (!stmts || !stmts.length) return '<div>No evidence statements available.</div>'; const patterns = [{ r: /^([ivx]+)\.\s*(.*)$/i, t: 'nested', c: 'es-nested-item' }, { r: /^(\d+)\.\s*(.*)$/, t: 'deeply-nested', c: 'es-deeply-nested-item' }, { r: /^([a-z])\s+(.*)$/i, t: 'item', c: 'es-item' }, { r: /^(\d+)\s+(.*)$/, t: 'heading', c: 'es-heading-entry' }]; return stmts.map(s => { const t = s.trim(); if (!t) return ''; for (const { r, t: type, c } of patterns) { const m = t.match(r); if (m) { let marker = m[1]; if (type === 'nested' || type === 'deeply-nested') marker += '.'; if (type === 'heading') return `<div class="${c} es-entry copyable"><span class="es-marker">${marker}</span><h4 class="es-heading-text es-text">${m[2]}</h4></div>`; return `<div class="${c} es-entry copyable"><span class="es-marker">${marker}</span><p class="es-text">${m[2]}</p></div>`; } } return `<div class="es-entry es-item copyable" style="padding-left:3rem;"><p class="es-text">${t}</p></div>`; }).join(''); };
        const showEvidenceStatements = id => { const pe = peMap.get(id); if (!pe || !pe.details.evidenceStatements) return; evidenceStatementsModalTitle.textContent = `Evidence Statements for ${pe.id}`; const saved = savedAnalyses[id]?.evidenceStatements; evidenceStatementsModalBody.innerHTML = saved || formatEvidenceStatements(pe.details.evidenceStatements); evidenceStatementsModal.dataset.peId = id; evidenceStatementsModalBody.dataset.peId = id; evidenceStatementsModal.classList.add('is-visible'); };
        const initializeGenAI = () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (apiKey) { try { genAI = new GoogleGenerativeAI(apiKey); apiKeyInput.value = apiKey; } catch (e) { console.error("Error initializing GoogleGenerativeAI:", e); alert("There was an error initializing the AI. Please check your API key."); genAI = null; } } else { genAI = null; } };
        const animationManager = new Map(); const startAnalysisAnimation = el => { if (animationManager.has(el)) return; const colors = ['#0072bc', '#f26522', '#0b9444']; const origHtml = el.innerHTML; const wrap = n => { if (n.nodeType === 3) { const f = document.createDocumentFragment(); for (let char of n.textContent) { if (char.trim()) { const s = document.createElement('span'); s.className = 'analyzing-char'; s.textContent = char; f.appendChild(s); } else f.appendChild(document.createTextNode(char)); } n.parentNode.replaceChild(f, n); } else if (n.nodeType === 1) [...n.childNodes].forEach(wrap); }; wrap(el); const chars = el.querySelectorAll('.analyzing-char'); if (!chars.length) return; const id = setInterval(() => chars.forEach(c => { c.style.color = colors[Math.floor(Math.random() * 3)]; c.style.transition = 'color 0.15s ease-in-out'; }), 150); animationManager.set(el, { intervalId: id, originalHtml: origHtml }); };
        const stopAnalysisAnimation = el => { const data = animationManager.get(el); if (data) { clearInterval(data.intervalId); animationManager.delete(el); return data.originalHtml; } return null; };
        
        const getFullPeContextAsText = (p) => {
            let context = `## Performance Expectation: ${p.id}\n${p.description}\n\n`;
            if (p.details.clarificationStatement) context += `### Clarification Statement\n${p.details.clarificationStatement}\n\n`;
            if (p.details.assessmentBoundary) context += `### Assessment Boundary\n${p.details.assessmentBoundary}\n\n`;
            ['sep', 'dci', 'ccc'].forEach(key => {
                if (p.details[key] && p.details[key].length > 0) {
                    context += `### ${key.toUpperCase()}s\n`;
                   // FIX: Handle Array or String for AI context
					p.details[key].forEach(item => {
						const txt = Array.isArray(item.text) ? item.text.join(' ') : item.text.replace(/\n/g, ' ');
						context += `- **${item.id}:** ${txt}\n`;
					});
                    context += '\n';
                }
            });
            if (p.details.evidenceStatements && p.details.evidenceStatements.length > 0) {
                context += `### Evidence Statements (Raw)\n${p.details.evidenceStatements.join('\n')}\n`;
            }
            return context;
        };
        
        const runAiAnalysis = async (peId, partToAnalyze, targetElement) => {
            if (!genAI) { alert("Gemini API Key is not set. Please add it in Settings."); settingsModal.classList.add('is-visible'); return false; }
            startAnalysisAnimation(targetElement);
            const pe = peMap.get(peId);
            if (!pe) { const originalHtml = stopAnalysisAnimation(targetElement); targetElement.innerHTML = originalHtml; targetElement.innerHTML += `<p style="color:red;">Error: PE data not found.</p>`; return false; }
            const fullContext = getFullPeContextAsText(pe);
            let contentToModify;
            if (partToAnalyze === 'description') contentToModify = pe.description;
            else if (partToAnalyze === 'evidenceStatements') contentToModify = formatEvidenceStatements(pe.details.evidenceStatements);
            else return false;

            const finalPrompt = `
## Persona
You are an expert instructional designer specializing in the deconstruction of Next Generation Science Standards (NGSS). You have a deep understanding of the three dimensions: Science and Engineering Practices (SEPs), Disciplinary Core Ideas (DCIs), and Crosscutting Concepts (CCCs).
## Context
You will be provided with the full details of a Performance Expectation (PE) to inform your analysis. You will also be given a specific HTML snippet to modify. Your analysis should be based on these official definitions:
- **SEP (Science and Engineering Practices):** The actions students perform. These are verbs like "developing a model," "analyzing data," or "constructing an explanation." Tag these with \`<span class="sep">\`.
- **DCI (Disciplinary Core Ideas):** The core scientific knowledge or content. These are the key concepts and nouns like "atomic structure," "natural selection," or "energy transfer." Tag these with \`<span class="dci">\`.
- **CCC (Crosscutting Concepts):** The thematic lenses that connect different scientific domains. These are overarching themes like "Patterns," "Cause and Effect," or "Structure and Function." Tag these with \`<span class="ccc">\`.
**Full PE Context for Analysis:**
${fullContext}
## Task
Your task is to meticulously analyze the following "CONTENT TO MODIFY." Identify all phrases corresponding to the three dimensions (SEP, DCI, CCC) and wrap them in the appropriate \`<span>\` tag. You will then return the entire HTML block with your modifications embedded.
## Format
Your output must be **only** the modified HTML snippet.
## Constraints
- **DO NOT** include any explanations, introductions, or markdown code fences (like \`\`\`html\`) in your response.
- **DO NOT** wrap block-level elements (like \`<div>\`, \`<p>\`, \`<h4>\`) inside your \`<span>\` tags. The spans must only go inside these elements.
- **BE PRECISE:** Wrap only the specific phrase that corresponds to a dimension. A single sentence can and often will contain multiple dimensions.
- **MAINTAIN ALL ORIGINAL HTML STRUCTURE:** Your output must be valid HTML that preserves all original tags and classes from the input.
---
**CONTENT TO MODIFY:**
${contentToModify}`;
            try {
                const model = genAI.getGenerativeModel({ model: selectedAiModel });
                const result = await model.generateContent(finalPrompt);
                const response = await result.response;
                const htmlOutput = response.text();
                stopAnalysisAnimation(targetElement);
                targetElement.innerHTML = htmlOutput;
                saveAnalysis(peId, partToAnalyze, targetElement.innerHTML);
                return true;
            } catch (error) {
                const originalHtml = stopAnalysisAnimation(targetElement);
                if (originalHtml) targetElement.innerHTML = originalHtml;
                console.error('Gemini API error:', error);
                targetElement.innerHTML += `<p style="color:red; margin-top: 1rem;"><b>API Error:</b> ${error.message}. Check your API key and browser console for details.</p>`;
                return false;
            }
        };

        const generateFacetsForElement = async (pe, elementCode, analyzedEsHtml) => {
            const element = elementMap.get(elementCode);
            if (!element) throw new Error(`Element data for ${elementCode} not found.`);
            const fullContext = getFullPeContextAsText(pe);

            const finalPrompt = `
## Persona
You are an expert in curriculum design and cognitive task analysis, specializing in the NGSS. Your task is to deconstruct a Performance Expectation (PE) into its fundamental, discrete, and observable student skills and knowledge components, which we call 'facets'.
## Facet Definition
A facet should reflect a specific, granular expectation of what a student should be able to know or do. It must be a discrete skill or piece of knowledge derived *only from the evidence statements provided*. When aggregated, the facets for a given standard should fully represent that standard.
## Target Element for this Task
You must generate facets **ONLY** for the following 3D Element:
- **Code:** ${elementCode}
- **Dimension:** ${element.dimensionName}
- **Element Text:** ${element.name}
## Context
Below is the full context for a single NGSS Performance Expectation (PE) and its Evidence Statements. The Evidence Statements are the primary source from which you will derive the facets.
**Full PE Context:**
${fullContext}
**Analyzed Evidence Statements (Primary Source for Decomposition):**
\`\`\`html
${analyzedEsHtml}
\`\`\`
## Task
Your task is to meticulously analyze the "Analyzed Evidence Statements" and identify all granular facets a student must master that are directly related to the **"Target Element for this Task"** specified above.
- Derive facets ONLY from the text of the Evidence Statements.
- DO NOT invent facets or pull information from other elements. Your focus must remain exclusively on the target element.
- Each facet must be a complete, standalone statement of a skill or concept.
## Output Format
Your output **MUST** be a valid JSON object. Do not include any text, explanations, or markdown fences before or after the JSON.
The JSON object must contain:
1.  \`dimensionName\`: A string with the full name of the dimension (e.g., "Planning and Carrying Out Investigations").
2.  \`elementText\`: A string with the full official text of the element (e.g., "Conduct an investigation and/or evaluate and/or revise the experimental design...").
3.  \`facets\`: An array of strings. Each string is a single, decomposed facet related ONLY to the target element.
## Example Output:
\`\`\`json
{
  "dimensionName": "Structure and Function",
  "elementText": "All living things are made up of cells, which is the smallest unit that can be said to be alive. An organism may consist of one single cell (unicellular) or many different numbers and types of cells (multicellular).",
  "facets": [
    "Identify that all living things are made of cells.",
    "Identify that the cell is the smallest unit that can be considered alive.",
    "Provide evidence for the presence or absence of cells in living and nonliving things.",
    "Distinguish between unicellular and multicellular organisms."
  ]
}
\`\`\``;
            const model = genAI.getGenerativeModel({ model: selectedAiModel });
            const result = await model.generateContent(finalPrompt);
            const response = await result.response;
            const jsonText = response.text().replace(/^```json\n?/, '').replace(/\n?```$/, '');
            return JSON.parse(jsonText);
        };
        
        const runFacetDecomposition = async (peId, forceRefresh = false) => {
            const deconstructBtn = document.getElementById('deconstruct-facets-btn');
            const refreshBtn = document.getElementById('refresh-facets-btn');

            if (!forceRefresh && savedAnalyses[peId]?.facetDecomposition) {
                try {
                    const cachedData = JSON.parse(savedAnalyses[peId].facetDecomposition);
                    renderFacetTables(cachedData, peId);
                    facetDecompositionModal.classList.add('is-visible');
                    return;
                } catch (e) { console.warn("Could not parse cached facet data, regenerating.", e); }
            }
            if (forceRefresh) {
                if (savedAnalyses[peId]?.facetDecomposition) {
                    delete savedAnalyses[peId].facetDecomposition;
                    deleteAnalysisFromDB(peId, 'facetDecomposition');
                }
            }

            if (!genAI) { alert("Gemini API Key is not set. Please add it in Settings."); settingsModal.classList.add('is-visible'); return; }

            const esBody = evidenceStatementsModalBody;
            const needsAnalysis = !esBody.querySelector('span.sep, span.dci, span.ccc');
            let analyzedEsHtml = esBody.innerHTML;

            if (needsAnalysis) {
                const success = await runAiAnalysis(peId, 'evidenceStatements', esBody);
                if (!success) { return; }
                analyzedEsHtml = esBody.innerHTML;
            }

            const pe = peMap.get(peId);
            const elementCodes = [...pe.associatedComponentCodes];
            const finalFacetData = {};

            deconstructBtn.disabled = true;
            refreshBtn.disabled = true;

            for (let i = 0; i < elementCodes.length; i++) {
                const elementCode = elementCodes[i];
                const progressText = `Deconstructing ${i + 1} of ${elementCodes.length}...`;
                deconstructBtn.textContent = progressText;
                refreshBtn.textContent = progressText;

                try {
                    const singleElementFacetData = await generateFacetsForElement(pe, elementCode, analyzedEsHtml);
                    finalFacetData[elementCode] = singleElementFacetData;
                } catch (error) {
                    console.error(`Failed to generate facets for ${elementCode}:`, error);
                    alert(`An error occurred while processing element ${elementCode}. Check the console for details.`);
                    break; // Stop on failure
                }
            }

            if (Object.keys(finalFacetData).length === elementCodes.length) {
                saveAnalysis(peId, 'facetDecomposition', JSON.stringify(finalFacetData));
                renderFacetTables(finalFacetData, peId);
                facetDecompositionModal.classList.add('is-visible');
            }

            deconstructBtn.textContent = 'Deconstruct into 3D Facets';
            deconstructBtn.disabled = false;
            refreshBtn.textContent = 'Refresh with AI';
            refreshBtn.disabled = false;
        };

        const renderFacetTables = (data, peId) => {
            const container = document.getElementById('facet-tables-container');
            document.getElementById('facet-modal-title').textContent = `3D Facet Decomposition for ${peId}`;
            facetDecompositionModal.dataset.peId = peId;
            container.innerHTML = '';
            
            for (const elementCode in data) {
                const item = data[elementCode];
                let tableHtml = `<table class="facet-table"><thead><tr><th>
                    <div class="facet-element-id">${elementCode}</div>
                    <div class="facet-dimension-name">${item.dimensionName || '...'}</div>
                    <div class="facet-element-text">${item.elementText || '...'}</div>
                </th></tr></thead><tbody>`;
                item.facets.forEach((facet, index) => {
                    tableHtml += `<tr><td><div class="facet-item-row"><span class="facet-num">${index + 1}.</span><span class="facet-text">${facet}</span></div></td></tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML += tableHtml;
            }
        };

        const renderMatrix = () => { if (!matrixRowElements.size) { matrixTableContainer.style.display = 'none'; matrixPlaceholder.style.display = 'flex'; return; } matrixTableContainer.style.display = 'block'; matrixPlaceholder.style.display = 'none'; let head = '<tr><th>3D Element</th>'; sortedGradeLabels.forEach(g => { head += `<th>${g}</th>`; }); matrixTableHead.innerHTML = head + '</tr>'; let body = ''; [...matrixRowElements].sort((a, b) => (elementMap.get(a)?.name || '').localeCompare(elementMap.get(b)?.name || '')).forEach(code => { const el = elementMap.get(code); if (!el) return; body += `<tr data-dimension-code="${el.dimensionCode}" data-component-code="${el.code}"><td class="copyable">${el.name}</td>`; const gradeMap = elementToGradePeMap.get(code); sortedGradeLabels.forEach(g => { if (gradeMap?.has(g)) { const ids = [...gradeMap.get(g)].sort(); body += `<td>${ids.map(id => { const p = peMap.get(id); return `<span class="pe-matrix-link copyable" data-pe-id="${id}" title="${p ? `PE: ${id}\n${p.description}`.replace(/"/g, '&quot;') : `View ${id}`}">${id}</span>`; }).join('')}</td>`; } else body += '<td></td>'; }); body += '</tr>'; }); matrixTableBody.innerHTML = body; applyFilters(); };
        const filterMatrixTable = () => { const term = searchInput.value.trim().toLowerCase(); const dim = dimensionFilters.querySelector('.active')?.dataset.filter; let count = 0; matrixTableBody.querySelectorAll('tr').forEach(row => { let isVis = true; const code = row.dataset.componentCode; if (dim) { if (row.dataset.dimensionCode !== dim) isVis = false; else if (dim.startsWith('DCI')) { const major = document.querySelector('#sub-dimension-filters .active')?.dataset.filter; const minors = new Set([...dciMinorFilters.querySelectorAll('.active')].map(b => b.dataset.filter)); if (minors.size > 0) { if (![...minors].some(m => code.startsWith(m))) isVis = false; } else if (major && !code.startsWith(major)) isVis = false; } else { const subs = new Set([...subDimensionFilters.querySelectorAll('.active')].map(b => b.dataset.filter)); if (subs.size > 0 && !subs.has(code)) isVis = false; } } if (isVis && term && !row.textContent.toLowerCase().includes(term)) isVis = false; row.style.display = isVis ? '' : 'none'; if (isVis) count++; }); resultsCountSpan.textContent = `${count} elements found.`; };

        // --- 8. EVENT LISTENERS & UI/UX ---
        const makeModalDraggable = (modal) => {
            const content = modal.querySelector('.modal-content');
            const header = modal.querySelector('.modal-header');
            if (!content || !header) return;
            let active = false, initialX, initialY, xOffset = 0, yOffset = 0;
            const observer = new MutationObserver(() => { if (modal.classList.contains('is-visible') && !modal.wasVisible) { content.style.transform = 'translate(0, 0)'; xOffset = 0; yOffset = 0; } modal.wasVisible = modal.classList.contains('is-visible'); });
            observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
            const dragStart = (e) => { if (e.target.closest('button')) return; initialX = (e.type === 'touchstart' ? e.touches[0].clientX : e.clientX) - xOffset; initialY = (e.type === 'touchstart' ? e.touches[0].clientY : e.clientY) - yOffset; active = true; content.style.transition = 'none'; header.style.cursor = 'grabbing'; document.body.style.userSelect = 'none'; };
            const dragEnd = () => { if (!active) return; active = false; content.style.transition = ''; header.style.cursor = 'move'; document.body.style.userSelect = ''; };
            const drag = (e) => { if (active) { if (e.cancelable) e.preventDefault(); const currentX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX) - initialX; const currentY = (e.type === 'touchmove' ? e.touches[0].clientY : e.clientY) - initialY; xOffset = currentX; yOffset = currentY; content.style.transform = `translate(${currentX}px, ${currentY}px)`; } };
            header.addEventListener('mousedown', dragStart);
            header.addEventListener('touchstart', dragStart, { passive: true });
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
        };
        
        const showHandlesForSpan = (span) => {
            if (window.innerWidth < 768) return;
            hideHandles();
            const container = span.closest('.ai-editable-content');
            if (!container) return;
            const rects = span.getClientRects();
            if (rects.length === 0) return;
            const containerRect = container.getBoundingClientRect();
            const firstRect = rects[0], lastRect = rects[rects.length - 1];
            const startTop = firstRect.top - containerRect.top + (firstRect.height / 2) + container.scrollTop;
            const startLeft = firstRect.left - containerRect.left + container.scrollLeft;
            const endTop = lastRect.top - containerRect.top + (lastRect.height / 2) + container.scrollTop;
            const endLeft = lastRect.right - containerRect.left + container.scrollLeft;
            container.appendChild(handleStart); container.appendChild(handleEnd);
            handleStart.style.top = `${startTop}px`; handleStart.style.left = `${startLeft}px`; handleStart.style.display = 'block';
            handleEnd.style.top = `${endTop}px`; handleEnd.style.left = `${endLeft}px`; handleEnd.style.display = 'block';
        };
        const hideHandles = () => { handleStart.style.display = 'none'; handleEnd.style.display = 'none'; document.querySelectorAll('.is-active-target').forEach(el => el.classList.remove('is-active-target')); };
        const showToolbar = (target) => { const rect = target instanceof Element ? target.getBoundingClientRect() : target; aiEditToolbar.classList.add('is-visible'); if (window.innerWidth >= 768) { const scrollY = window.scrollY, scrollX = window.scrollX; aiEditToolbar.style.position = 'absolute'; aiEditToolbar.style.top = `${rect.top + scrollY - aiEditToolbar.offsetHeight - 8}px`; aiEditToolbar.style.left = `${rect.left + scrollX + rect.width / 2 - aiEditToolbar.offsetWidth / 2}px`; } updateToolbarState(); };
        const hideToolbar = () => { aiEditToolbar.classList.remove('is-visible'); aiEditToolbar.style.position = ''; if (activeEditableTarget instanceof Element) activeEditableTarget.classList.remove('is-active-target'); activeEditableTarget = null; activeResizeSpan = null; };
        const updateToolbarState = () => { aiEditToolbar.querySelectorAll('button').forEach(b => b.classList.remove('active')); if (activeEditableTarget instanceof Element) { const span = activeEditableTarget; const btn = aiEditToolbar.querySelector(`button[data-value="${span.className.trim()}"]`); if(btn) btn.classList.add('active'); } };
        const performToolbarAction = (action, value) => { if (!activeEditableTarget) return; let targetSpan, isRange = activeEditableTarget instanceof Range; if (isRange) { try { const newSpan = document.createElement('span'); activeEditableTarget.surroundContents(newSpan); targetSpan = newSpan; } catch (e) { alert("Could not apply change. Selections cannot cross different text blocks."); console.error("Could not wrap selection:", e); window.getSelection().removeAllRanges(); hideToolbar(); return; } } else { targetSpan = activeEditableTarget; } if (action === 'set-class') { const wasActive = !isRange && targetSpan.className === value; if (wasActive) { if (targetSpan.parentElement) targetSpan.replaceWith(...targetSpan.childNodes); } else { targetSpan.className = value; } } else if (action === 'unwrap') { if (targetSpan.parentElement) targetSpan.replaceWith(...targetSpan.childNodes); } const editableContent = targetSpan.closest('.ai-editable-content'); if (editableContent) { editableContent.normalize(); saveAnalysis(editableContent.dataset.peId, editableContent.dataset.part, editableContent.innerHTML); } window.getSelection().removeAllRanges(); hideToolbar(); hideHandles(); };
        const handlePointerMove = (e) => { if (!isResizing) return; e.preventDefault(); const x = e.touches ? e.touches[0].clientX : e.clientX, y = e.touches ? e.touches[0].clientY : e.clientY; const selection = window.getSelection(); const range = document.caretRangeFromPoint ? document.caretRangeFromPoint(x, y) : null; if (!range) return; const cursorNode = range.startContainer, cursorOffset = range.startOffset; const editableContent = activeResizeSpan.closest('.ai-editable-content'); if (!editableContent || !editableContent.contains(cursorNode)) return; try { selection.extend(cursorNode, cursorOffset); } catch (err) { console.warn("Cannot extend selection.", err); } };
        const handlePointerUp = (e) => { if (!isResizing) return; isResizing = false; document.body.style.userSelect = ''; document.removeEventListener('mousemove', handlePointerMove); document.removeEventListener('touchmove', handlePointerMove); document.removeEventListener('mouseup', handlePointerUp); document.removeEventListener('touchend', handlePointerUp); const selection = window.getSelection(); if (!selection || selection.isCollapsed) { window.getSelection()?.removeAllRanges(); hideToolbar(); hideHandles(); return; } const finalRange = selection.getRangeAt(0); const originalSpan = activeResizeSpan; const editableContent = originalSpan.closest('.ai-editable-content'); const classList = originalSpan.className; originalSpan.replaceWith(...originalSpan.childNodes); try { const newSpan = document.createElement('span'); newSpan.className = classList; finalRange.surroundContents(newSpan); editableContent.normalize(); saveAnalysis(editableContent.dataset.peId, editableContent.dataset.part, editableContent.innerHTML); } catch (err) { console.error("Resize/Highlight failed. This is expected for multi-block selections.", err); alert("Could not apply change. Highlights cannot span across multiple paragraphs or list items."); } window.getSelection()?.removeAllRanges(); hideToolbar(); hideHandles(); };
        const handlePointerDownOnHandle = (e, handleName) => { e.preventDefault(); e.stopPropagation(); if (!activeResizeSpan) return; const spanToResize = activeResizeSpan; isResizing = true; activeHandle = handleName; document.body.style.userSelect = 'none'; aiEditToolbar.classList.remove('is-visible'); const selection = window.getSelection(); selection.removeAllRanges(); const range = document.createRange(); range.selectNodeContents(spanToResize); if (handleName === 'end') { selection.collapse(range.startContainer, range.startOffset); } else { selection.collapse(range.endContainer, range.endOffset); } document.addEventListener('mousemove', handlePointerMove); document.addEventListener('touchmove', handlePointerMove, { passive: false }); document.addEventListener('mouseup', handlePointerUp); document.addEventListener('touchend', handlePointerUp); };

        handleStart.addEventListener('mousedown', e => handlePointerDownOnHandle(e, 'start'));
        handleStart.addEventListener('touchstart', e => handlePointerDownOnHandle(e, 'start'), { passive: false });
        handleEnd.addEventListener('mousedown', e => handlePointerDownOnHandle(e, 'end'));
        handleEnd.addEventListener('touchstart', e => handlePointerDownOnHandle(e, 'end'), { passive: false });
        
        const setupCoreEventListeners = () => {
            resetAppBtn.addEventListener('click', resetApp);
            navPeExplorer.addEventListener('click', () => switchView('pe'));
            navThreedExplorer.addEventListener('click', () => switchView('3d'));
            navMatrixView.addEventListener('click', () => switchView('matrix'));
            backBtn.addEventListener('click', goBack);
            searchInput.addEventListener('input', () => { applyFilters(); updateUrlFromState(); });
            dimensionFilters.addEventListener('click', e => { if (e.target.matches('.filter-btn')) { const wasActive = e.target.classList.contains('active'); dimensionFilters.querySelector('.active')?.classList.remove('active'); subDimensionFilters.innerHTML = ''; subDimensionFiltersContainer.style.display = 'none'; clearSubFiltersBtn.style.display = 'none'; dciMinorFiltersContainer.style.display = 'none'; if (!wasActive) { e.target.classList.add('active'); renderSubFilters(e.target.dataset.filter); } applyFilters(); updateUrlFromState(); } });
            subDimensionFilters.addEventListener('click', e => { if (e.target.matches('.filter-btn')) { const isDci = dimensionFilters.querySelector('.active')?.dataset.filter.startsWith('DCI'); if(isDci) { const wasActive = e.target.classList.contains('active'); subDimensionFilters.querySelectorAll('.active').forEach(b => b.classList.remove('active')); dciMinorFiltersContainer.style.display = 'none'; if (!wasActive) { e.target.classList.add('active'); renderDciMinorFilters(e.target.dataset.filter); } } else { e.target.classList.toggle('active'); } applyFilters(); updateUrlFromState(); } });
            dciMinorFilters.addEventListener('click', e => { if(e.target.matches('.filter-btn')) { e.target.classList.toggle('active'); applyFilters(); updateUrlFromState(); } });
            clearSubFiltersBtn.addEventListener('click', () => { subDimensionFilters.querySelectorAll('.active').forEach(b => b.classList.remove('active')); dciMinorFiltersContainer.style.display = 'none'; applyFilters(); updateUrlFromState(); });
            gradeFilters.addEventListener('click', e => { if (e.target.matches('.filter-btn')) { gradeFilters.querySelector('.active')?.classList.remove('active'); e.target.classList.add('active'); document.getElementById('topic-filters').innerHTML = ''; renderTopicFilters(e.target.dataset.filter); applyFilters(); updateUrlFromState(); } });
            document.getElementById('topic-filters-container').addEventListener('click', e => { const btn = e.target.closest('.filter-btn'); if (!btn) return; const group = document.getElementById('topic-filters'); if (btn.dataset.filter === 'all') { group.querySelectorAll('.active').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } else { group.querySelector('[data-filter="all"]')?.classList.remove('active'); btn.classList.toggle('active'); } if (!group.querySelector('.active')) group.querySelector('[data-filter="all"]')?.classList.add('active'); applyFilters(); updateUrlFromState(); });
            activePeFilterTag.addEventListener('click', e => { if (e.target.closest('#clear-pe-filter-btn')) clearPeFilter(); else { const id = e.currentTarget.dataset.peId; if (id) navigateToPe(id); } });

            const handle3dLinkClick = (e) => {
                const link = e.target.closest('.clickable-element-link');
                const evidenceBtn = e.target.closest('.view-evidence-btn');
                const analyzeBtn = e.target.closest('.analyze-pe-desc-btn');
                const resetBtn = e.target.closest('.reset-analysis-btn');
                if (evidenceBtn) { e.stopPropagation(); showEvidenceStatements(evidenceBtn.dataset.peId); return; }
                if (analyzeBtn) { e.stopPropagation(); const peId = analyzeBtn.dataset.peId; const targetDiv = analyzeBtn.closest('.pe-details-wrapper').querySelector('.pe-description-text'); runAiAnalysis(peId, 'description', targetDiv); return; }
                if (resetBtn) { e.stopPropagation(); const wrapper = resetBtn.closest('.pe-details-wrapper, .modal-footer'); const content = wrapper.parentElement.querySelector('.ai-editable-content'); if (content) { resetAnalysis(content.dataset.peId, content.dataset.part, content); } return; }
                if (link) { const peId = e.target.closest('[data-pe-id]').dataset.peId; const compCode = link?.dataset.componentCode; const specCode = link?.dataset.specificCode; activePeFilter = link?.closest('.pe-details-connections') ? null : peId; switchView('3d', { component: compCode, specific: specCode }, true); }
            };
            
			document.body.addEventListener('click', e => {
                const isToolbar = e.target.closest('#ai-edit-toolbar');
                
                // FIX: Hide toolbar if we click anywhere (including inside text) and there is no text selected
                const selection = window.getSelection();
                if (!isToolbar && (selection.isCollapsed || selection.rangeCount === 0)) {
                    hideToolbar(); 
                    hideHandles(); 
                }

                const span = e.target.closest('.ai-editable-content span');
                if(span && !isToolbar) {
                    document.querySelectorAll('.is-active-target').forEach(el => el.classList.remove('is-active-target'));
                    span.classList.add('is-active-target');
                    activeEditableTarget = span; activeResizeSpan = span;
                    showToolbar(span); showHandlesForSpan(span);
                }
            });

            document.body.addEventListener('mouseup', e => {
                if (isResizing || e.target.closest('#ai-edit-toolbar')) return;
                 setTimeout(() => {
                    const selection = window.getSelection();
                    if (!selection || selection.isCollapsed || selection.toString().trim().length === 0) return;
                    const range = selection.getRangeAt(0);
                    const commonAncestor = range.commonAncestorContainer;
                    const containerEl = commonAncestor.nodeType === 3 ? commonAncestor.parentElement : commonAncestor;
                    if (containerEl && containerEl.closest('.ai-editable-content')) {
                        activeEditableTarget = range; activeResizeSpan = null;
                        showToolbar(range.getBoundingClientRect()); hideHandles();
                    }
                 }, 10);
            });
            aiEditToolbar.addEventListener('click', e => { const btn = e.target.closest('button'); if (btn?.dataset.action) performToolbarAction(btn.dataset.action, btn.dataset.value); });

            peTableBody.addEventListener('click', e => {
                const link = e.target.closest('.pe-nav-link');
                if (link) { e.stopPropagation(); navigateToPe(link.dataset.peId); return; }
                const cb = e.target.closest('.pe-bundle-checkbox');
                if (cb) { if (cb.checked) peBundle.add(cb.dataset.peId); else peBundle.delete(cb.dataset.peId); updateBundleControls(); updateSelectAllCheckboxState(); return; }
                handle3dLinkClick(e);
                 const row = e.target.closest('.pe-main-row');
                if (row && !e.target.closest('.clickable-element-link, .view-evidence-btn, .analyze-pe-desc-btn, .reset-analysis-btn')) {
                    const wasExp = row.classList.contains('expanded');
                    const detailsRow = row.nextElementSibling;
                    const peId = row.dataset.peId;
                    
                    // Close other rows
                    peTableBody.querySelectorAll('.expanded, .is-visible').forEach(r => r.classList.remove('expanded', 'is-visible'));
                    
                    if (!wasExp) {
                        // --- LAZY LOAD CONTENT ON CLICK ---
                        const detailsCell = detailsRow.querySelector('td');
                        if (!detailsCell.hasChildNodes()) {
                            const pe = peMap.get(peId);
                            if (pe) detailsCell.innerHTML = createPeDetailsHtml(pe);
                        }
                        
                        row.classList.add('expanded');
                        detailsRow.classList.add('is-visible');
                        
                        // *** NEW LINE: Re-apply highlight to the newly opened details ***
                        applySearchHighlight(detailsRow, searchInput.value.trim());

                        scrollToPeRow(row); 
                    }
                    updateUrlFromState();
                }
            });
            bundleView.addEventListener('click', handle3dLinkClick);
            threedTableBody.addEventListener('click', e => { const item = e.target.closest('.item'); if(item) { const code = item.dataset.code; const el = specificElementMap.get(code); if(!el) return; document.getElementById('related-pe-modal-title').textContent = `PEs related to ${code}`; const ids = [...el.relatedPes].sort(); relatedPeList.innerHTML = ids.length ? ids.map(id => { const p = peMap.get(id); return `<li class="clickable-pe-link" data-pe-id="${id}" title="${p.description.replace(/"/g, '&quot;')}"><strong>${id}</strong>: ${p.description}</li>`; }).join('') : '<li>No PEs found.</li>'; relatedPeModal.classList.add('is-visible'); } });
            
            // --- UPDATED RELATED PE MODAL NAVIGATION ---
            relatedPeModal.addEventListener('click', e => { 
                const li = e.target.closest('.clickable-pe-link'); 
                if (li) { 
                    relatedPeModal.classList.remove('is-visible'); 
                    navigateToPe(li.dataset.peId); // This now handles Lazy Load + Scroll
                } else if (e.target === relatedPeModal || e.target.closest('.modal-close-btn')) {
                    relatedPeModal.classList.remove('is-visible'); 
                }
            });

            settingsBtn.addEventListener('click', () => settingsModal.classList.add('is-visible'));
            settingsModal.addEventListener('click', e => { if (e.target === settingsModal || e.target.closest('.modal-close-btn')) settingsModal.classList.remove('is-visible'); });
            saveSettingsBtn.addEventListener('click', () => { const key = apiKeyInput.value.trim(); if(key){ localStorage.setItem('geminiApiKey', key); initializeGenAI(); } else { localStorage.removeItem('geminiApiKey'); genAI = null; } selectedAiModel = aiModelSelect.value; localStorage.setItem('aiModel', selectedAiModel); alert('Settings saved.'); settingsModal.classList.remove('is-visible'); updateAiFeatureVisibility(); });
            clearAiCacheBtn.addEventListener('click', async () => { if (confirm("Delete all cached AI results?")) try { await clearAllAnalyses(); alert("AI cache cleared. Refresh may be needed."); } catch (e) { alert("Error clearing AI cache."); } });
            clearDataCacheBtn.addEventListener('click', async () => { if (confirm("Delete cached app data? Next load may be slow.")) try { await clearDataCache(); alert("Data cache cleared. Please refresh."); } catch (e) { alert("Error clearing data cache."); } });
            
            document.getElementById('analyze-es-btn').addEventListener('click', e => runAiAnalysis(e.target.closest('.modal-overlay').dataset.peId, 'evidenceStatements', evidenceStatementsModalBody));
            document.getElementById('deconstruct-facets-btn').addEventListener('click', e => runFacetDecomposition(e.target.closest('.modal-overlay').dataset.peId));
            document.getElementById('copy-es-html-btn').addEventListener('click', () => navigator.clipboard.writeText(evidenceStatementsModalBody.innerHTML).then(() => alert('HTML copied.')));
            evidenceStatementsModal.addEventListener('click', e => { if (e.target.matches('.modal-close-btn, .modal-overlay')) evidenceStatementsModal.classList.remove('is-visible'); if (e.target.closest('.reset-analysis-btn')) { resetAnalysis(evidenceStatementsModal.dataset.peId, evidenceStatementsModalBody.dataset.part, evidenceStatementsModalBody); }});
            
            facetDecompositionModal.addEventListener('click', e => {
                if (e.target.matches('.modal-close-btn, #close-facets-btn, .modal-overlay')) { facetDecompositionModal.classList.remove('is-visible'); }
                if (e.target.matches('#refresh-facets-btn')) { const peId = e.currentTarget.dataset.peId; if(peId && confirm("This will use the AI to regenerate the facet decomposition, overwriting the current version. Continue?")) { runFacetDecomposition(peId, true); } }
                if (e.target.matches('#copy-facets-btn')) {
                    const container = document.getElementById('facet-tables-container');
                    let text = document.getElementById('facet-modal-title').textContent + '\n\n';
                    container.querySelectorAll('.facet-table').forEach(table => { const id = table.querySelector('.facet-element-id').textContent, dim = table.querySelector('.facet-dimension-name').textContent, elText = table.querySelector('.facet-element-text').textContent; text += `--- ${id}: ${dim} ---\n${elText}\n\n`; table.querySelectorAll('.facet-text').forEach(facet => { text += `- ${facet.textContent.trim()}\n`; }); text += '\n'; });
                    navigator.clipboard.writeText(text).then(() => alert('Facets copied as text.'));
                }
            });

            document.getElementById('sidebar-toggle').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('is-visible'); document.getElementById('page-overlay').classList.toggle('is-visible'); });
            document.getElementById('page-overlay').addEventListener('click', () => { document.getElementById('sidebar').classList.remove('is-visible'); document.getElementById('page-overlay').classList.remove('is-visible'); });
            document.getElementById('threed-explorer-table').querySelectorAll('.col-toggle-btn').forEach(t => t.addEventListener('click', () => { isolatedColumn = t.classList.contains('active') ? null : t.dataset.col; applyColumnIsolation(); updateUrlFromState(); }));
            document.body.addEventListener('contextmenu', e => { const t = e.target.closest('.item, .copyable, .statement'); if (t) { e.preventDefault(); navigator.clipboard.writeText(t.innerText.trim()); t.classList.add('copied'); setTimeout(() => t.classList.remove('copied'), 1500); } });
            viewBundleBtn.addEventListener('click', renderBundleView); clearBundleBtn.addEventListener('click', () => { peBundle.clear(); peTableBody.querySelectorAll('.pe-bundle-checkbox:checked').forEach(cb => cb.checked = false); updateBundleControls(); updateSelectAllCheckboxState(); });
            selectAllCheckbox.addEventListener('click', e => { const c = e.target.checked; peTableBody.querySelectorAll('.pe-main-row:not([style*="display: none"]) .pe-bundle-checkbox').forEach(cb => { cb.checked = c; if (c) peBundle.add(cb.dataset.peId); else peBundle.delete(cb.dataset.peId); }); updateBundleControls(); });
            addElementFilterBtn.addEventListener('click', () => { let html = ''; window.allNgss3dElements.forEach(d => { html += `<div><h4>${d.dimension}</h4>`; const items = d.elements || d.core_ideas?.flatMap(c => c.components) || []; html += items.map(i => `<div class="element-choice" data-code="${i.name.split(':')[0].trim()}">${i.name}</div>`).join(''); html += `</div>`; }); document.getElementById('element-filter-choices').innerHTML = html; elementFilterModal.classList.add('is-visible'); });
            elementFilterModal.addEventListener('click', e => { const choice = e.target.closest('.element-choice'); if (choice) { activeElementFilters.add(choice.dataset.code); renderActiveElementFilters(); applyFilters(); elementFilterModal.classList.remove('is-visible'); updateUrlFromState(); } else if (e.target === elementFilterModal || e.target.closest('.modal-close-btn')) elementFilterModal.classList.remove('is-visible'); });
            activeElementFiltersDiv.addEventListener('click', e => { const btn = e.target.closest('button'); if(btn) { activeElementFilters.delete(btn.dataset.code); renderActiveElementFilters(); applyFilters(); updateUrlFromState(); }});
            document.getElementById('manage-bundles-btn').addEventListener('click', () => { renderBundleManager(); bundleManagerModal.classList.add('is-visible'); });
            bundleManagerModal.addEventListener('click', e => { if (e.target === bundleManagerModal || e.target.closest('.modal-close-btn')) bundleManagerModal.classList.remove('is-visible'); const load = e.target.closest('.load-bundle-btn'); const del = e.target.closest('.delete-bundle-btn'); if (load) { peBundle = new Set(savedBundles[load.dataset.name]); populatePeTable(); updateBundleControls(); updateSelectAllCheckboxState(); bundleManagerModal.classList.remove('is-visible'); } else if (del) { const name = del.dataset.name; if (confirm(`Delete bundle "${name}"?`)) { delete savedBundles[name]; saveBundlesToStorage(); renderBundleManager(); if (activeBundleFilter === name) activeBundleFilter = null; renderBundleFilters(); applyFilters(); updateUrlFromState(); } } });
            saveBundleBtn.addEventListener('click', () => { document.getElementById('bundle-name-input').value = ''; saveBundleModal.classList.add('is-visible'); });
            saveBundleModal.addEventListener('click', e => { if (e.target === saveBundleModal || e.target.closest('.modal-close-btn')) saveBundleModal.classList.remove('is-visible'); });
            document.getElementById('confirm-save-bundle-btn').addEventListener('click', () => { const name = document.getElementById('bundle-name-input').value.trim(); if (!name) return; if (savedBundles[name] && !confirm(`Overwrite bundle "${name}"?`)) return; savedBundles[name] = [...peBundle]; saveBundlesToStorage(); saveBundleModal.classList.remove('is-visible'); renderBundleFilters(); });
            document.getElementById('cancel-save-bundle-btn').addEventListener('click', () => saveBundleModal.classList.remove('is-visible'));
            bundleFilters.addEventListener('click', e => { const btn = e.target.closest('.filter-btn'); if (btn) { activeBundleFilter = btn.dataset.name === 'all' ? null : btn.dataset.name; renderBundleFilters(); applyFilters(); updateUrlFromState(); } });
            matrixTableBody.addEventListener('click', e => { const link = e.target.closest('.pe-matrix-link'); if(link) navigateToPe(link.dataset.peId); });
            document.getElementById('select-matrix-rows-btn').addEventListener('click', () => { let html = ''; window.allNgss3dElements.forEach(d => { html += `<div><h4>${d.dimension}</h4>`; const items = d.elements || d.core_ideas?.flatMap(c => c.components) || []; items.forEach(i => { const code = i.name.split(':')[0].trim(); html += `<label><input type="checkbox" data-code="${code}" ${matrixRowElements.has(code) ? 'checked' : ''}> ${i.name}</label>`; }); html += `</div>`; }); document.getElementById('matrix-row-choices').innerHTML = html; matrixRowSelectModal.classList.add('is-visible'); });
            document.getElementById('update-matrix-btn').addEventListener('click', () => { matrixRowElements.clear(); document.querySelectorAll('#matrix-row-choices input:checked').forEach(cb => matrixRowElements.add(cb.dataset.code)); matrixRowSelectModal.classList.remove('is-visible'); renderMatrix(); updateUrlFromState(); });
            matrixRowSelectModal.addEventListener('click', e => { if (e.target === matrixRowSelectModal || e.target.closest('.modal-close-btn')) matrixRowSelectModal.classList.remove('is-visible'); });
            window.addEventListener('popstate', applyStateFromUrl);
        };

        // --- 9. INITIALIZATION ---
        const initializeApp = async () => {
            await openDb();
            savedAnalyses = await loadAnalysesFromDB();
            selectedAiModel = localStorage.getItem('aiModel') || 'gemini-2.5-pro';
            aiModelSelect.value = selectedAiModel;
            initializeGenAI(); 
            updateAiFeatureVisibility();
            try { peBundle = new Set(JSON.parse(localStorage.getItem('ngssPeBundle')) || []); } catch (e) { peBundle = new Set(); }
            loadBundlesFromStorage();
            await loadAndProcessData();
            buildMatrixDataMap();
            window.allNgss3dElements.forEach(d => (d.elements || d.core_ideas?.flatMap(c => c.components) || []).forEach(i => { const c = i.name.split(':')[0].trim(); if (c) matrixRowElements.add(c); }));
            populatePeTable(); 
            populate3dTable();
            gradeFilters.innerHTML = '<button class="filter-btn active" data-filter="all">All</button>' + sortedGradeLabels.map(g => `<button class="filter-btn" data-filter="${g}">${g}</button>`).join('');
            dimensionFilters.innerHTML = window.allNgss3dElements.filter(d => d.short_name).map(d => `<button class="filter-btn" data-filter="${d.code}">${d.short_name}</button>`).join('');
            setupCoreEventListeners(); 
            makeModalDraggable(document.getElementById('evidence-statements-modal'));
            makeModalDraggable(document.getElementById('facet-decomposition-modal'));
            updateBundleControls(); 
            applyStateFromUrl();
        };
		
		// --- 10. SHEPHERD.JS GUIDED TOUR IMPLEMENTATION ---
    const startTourBtn = document.getElementById('start-tour-btn');

    const initTour = async () => {
        // 1. FORCE RESET APPLICATION STATE
        document.getElementById('reset-app-btn').click();
        
        // Wait for the reset to finish rendering the DOM
        await new Promise(r => setTimeout(r, 500));

        const hasApiKey = !!localStorage.getItem('geminiApiKey');
        
        // --- HELPER FUNCTIONS ---
        
        // Robustly wait for an element to appear in the DOM
        const waitFor = (selector) => {
            return new Promise(resolve => {
                const el = document.querySelector(selector);
                if (el) return resolve(el);
                
                const observer = new MutationObserver(() => {
                    const el = document.querySelector(selector);
                    if (el) {
                        observer.disconnect();
                        resolve(el);
                    }
                });
                observer.observe(document.body, { childList: true, subtree: true });
                setTimeout(() => { observer.disconnect(); resolve(null); }, 5000); 
            });
        };

        const closeAllModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('is-visible'));
        };

        const ensurePeView = () => {
            if(currentView !== 'pe') switchView('pe');
        };

        const tour = new Shepherd.Tour({
            useModalOverlay: true,
            exitOnEsc: true,
            keyboardNavigation: false,
            defaultStepOptions: {
                cancelIcon: { enabled: true },
                classes: 'shepherd-theme-custom',
                scrollTo: { behavior: 'smooth', block: 'center' },
                buttons: [
                    { action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' },
                    { action() { return this.next(); }, text: 'Next' }
                ]
            }
        });

        // --- GLOBAL ESC HANDLER ---
        const escHandler = (e) => { if (e.key === 'Escape') tour.cancel(); };
        document.addEventListener('keydown', escHandler);
        const cleanup = () => {
            document.removeEventListener('keydown', escHandler);
            document.getElementById('reset-app-btn').click();
        };
        tour.on('complete', cleanup);
        tour.on('cancel', cleanup);

        // --- TOUR STEPS ---

        // 1. Intro
        tour.addStep({
            id: 'intro',
            title: 'Welcome',
            text: 'This guided tour will walk you through the NGSS Explorer. We have reset your view to ensure a smooth start.',
            buttons: [{ action() { return this.next(); }, text: 'Start' }]
        });

        // 2. Filters
        tour.addStep({
            id: 'filters',
            title: 'Filtering',
            text: 'The sidebar allows you to filter standards by Grade, Topic, or Dimension. If you have saved bundles, they appear as filters, too.',
            attachTo: { element: '#sidebar', on: 'right' }
        });

        // 3. Search
        tour.addStep({
            id: 'search',
            title: 'Global Search',
            text: 'Use this bar to search for specific keywords across the current view.',
            attachTo: { element: '#search-input', on: 'bottom' }
        });

        // 4. Expand Row
        tour.addStep({
            id: 'expand-row',
            title: 'Expand Details',
            text: 'Click on the <strong>first row</strong> to see the full standard details.',
            attachTo: { element: '.pe-main-row', on: 'bottom' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    ensurePeView();
                    document.querySelectorAll('.pe-main-row.expanded').forEach(r => r.click());
                    setTimeout(resolve, 300);
                });
            },
            when: {
                show: function() {
                    const row = document.querySelector('.pe-main-row');
                    const handler = (e) => {
                        setTimeout(() => tour.next(), 600);
                        row.removeEventListener('click', handler);
                    };
                    if(row) row.addEventListener('click', handler);
                }
            }
        });

        // 5. Details Explanation
        tour.addStep({
            id: 'details-expl',
            title: 'Standard Details',
            text: 'Here you see the 3D breakdown. Colored text (SEP, DCI, CCC) is interactive!',
            attachTo: { element: '.pe-details-wrapper', on: 'top' },
            beforeShowPromise: () => waitFor('.pe-details-wrapper')
        });

        // 6. Copy Tip
        tour.addStep({
            id: 'copy-tip',
            title: 'Pro Tip: Copying',
            text: 'Right-click on almost any text to copy. For example, right click any of this  <strong>3D elements</strong> (SEP, DCI, or CCC) text to instantly copy them to your clipboard.',
            attachTo: { element: '.pe-details-column li', on: 'right' },
            beforeShowPromise: () => waitFor('.pe-details-column li')
        });

        // 7. Bundle 1st Item
        tour.addStep({
            id: 'bundle-1',
            title: 'Start a Bundle',
            text: 'Check this box to select the first standard.',
            attachTo: { element: '.pe-main-row:nth-of-type(1) .pe-bundle-checkbox', on: 'right' },
            popperOptions: { modifiers: [{ name: 'offset', options: { offset: [0, 20] } }] },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            when: {
                show: function() {
                    const cb = document.querySelector('.pe-main-row:nth-of-type(1) .pe-bundle-checkbox');
                    const handler = () => setTimeout(() => tour.next(), 200);
                    if(cb) cb.addEventListener('change', handler, { once: true });
                }
            }
        });

        // 8. Bundle 2nd Item
        tour.addStep({
            id: 'bundle-2',
            title: 'Add Another',
            text: 'Select a <strong>second checkbox</strong> to build a group.',
            attachTo: { element: '.pe-main-row:nth-of-type(3) .pe-bundle-checkbox', on: 'right' },
            popperOptions: { modifiers: [{ name: 'offset', options: { offset: [0, 20] } }] },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    const rows = document.querySelectorAll('.pe-main-row');
                    if (rows.length >= 2) {
                        const secondRow = rows[1]; 
                        secondRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    setTimeout(resolve, 600);
                });
            },
            when: {
                show: function() {
                    const cbs = document.querySelectorAll('.pe-bundle-checkbox');
                    const handler = () => setTimeout(() => tour.next(), 200);
                    cbs.forEach(cb => cb.addEventListener('change', handler, { once: true }));
                }
            }
        });

        // 9. Bundle Controls
        tour.addStep({
            id: 'bundle-controls',
            title: 'Bundle Toolbar',
            text: 'The toolbar appears when items are selected. You can view bundle details, save a bundle for quick filtering, or clear the selection. Bundle details can be printed or easily copied with a button',
            attachTo: { element: '#bundle-controls', on: 'bottom' }
        });

        // 10. Switch to 3D
        tour.addStep({
            id: 'go-3d',
            title: '3D Explorer',
            text: 'Click the tab to switch to the 3D Element view.',
            attachTo: { element: '#nav-threed-explorer', on: 'bottom' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            when: {
                show: function() {
                    const btn = document.getElementById('nav-threed-explorer');
                    const handler = () => setTimeout(() => tour.next(), 300);
                    btn.addEventListener('click', handler, { once: true });
                }
            }
        });
		
		// --- NEW STEP HERE ---
        tour.addStep({
            id: 'explain-3d-filters',
            title: '3D Filters',
            text: 'Before exploring the list, use these filters to narrow down elements by Dimension (SEP, DCI, CCC) or specific sub-categories.',
            attachTo: { element: '#threed-filters-all', on: 'right' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }, { action() { return this.next(); }, text: 'Next' }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    // Ensure the view is actually switched before showing this bubble
                    if(currentView !== '3d') switchView('3d');
                    setTimeout(resolve, 300);
                });
            }
        });
        // ---------------------

        // 11. Click 3D Item
        tour.addStep({
            id: 'click-3d',
            title: 'Interactive Elements',
            text: 'Click on any element code to see where it is used in a PE, or if it is used at all.',
            attachTo: { element: '#threed-explorer-table .item', on: 'top' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    closeAllModals();
                    document.getElementById('threed-explorer-table').scrollIntoView();
                    setTimeout(resolve, 300);
                });
            },
            when: {
                show: function() {
                    const items = document.querySelectorAll('#threed-explorer-table .item');
                    const handler = () => setTimeout(() => tour.next(), 500);
                    items.forEach(i => i.addEventListener('click', handler, { once: true }));
                }
            }
        });

        // 12. Modal View (CONSOLIDATED STEP)
        tour.addStep({
            id: 'modal-view',
            title: 'Usage Modal',
            text: 'This modal lists every PE that uses the element you clicked.<br><br>‚Ä¢ Links take you back to the PE details.<br>‚Ä¢ Click <strong>Next</strong> to close this modal.',
            attachTo: { element: '#related-pe-modal .modal-content', on: 'right' },
            buttons: [{ 
                text: 'Next', 
                action() { 
                    closeAllModals(); 
                    return this.next(); 
                } 
            }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    const modal = document.getElementById('related-pe-modal');
                    // If user navigated back, we need to re-open the modal
                    if (!modal.classList.contains('is-visible')) {
                        const item = document.querySelector('#threed-explorer-table .item');
                        if(item) item.click();
                    }
                    setTimeout(resolve, 300);
                });
            }
        });

        // 13. Matrix View Nav
        tour.addStep({
            id: 'go-matrix',
            title: 'Matrix View',
            text: 'Click here to access the custom Matrix builder.',
            attachTo: { element: '#nav-matrix-view', on: 'bottom' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            advanceOn: { selector: '#nav-matrix-view', event: 'click' }
        });

        // 14. Matrix Explanation
        tour.addStep({
            id: 'explain-matrix',
            title: 'Custom Heatmaps',
            text: 'Use the <strong>Select/Refine Rows</strong> button to choose specific elements and visualize their progression.<br><br><em>Note: Layouts are still being optimized for Middle & High School.</em>',
            attachTo: { element: '#select-matrix-rows-btn', on: 'bottom' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }, { action() { return this.next(); }, text: 'Next' }],
            beforeShowPromise: () => waitFor('#select-matrix-rows-btn')
        });
		
        // 16. Prepare for Evidence
        tour.addStep({
            id: 'prep-evidence',
            title: 'Evidence Statements',
            text: 'Let\'s view the official Evidence Statements. Heading back to the main list...',
            buttons: [{ action() { return this.next(); }, text: 'Go' }],
            beforeShowPromise: function() {
                return new Promise(resolve => {
                    ensurePeView();
                    document.getElementById('reset-app-btn').click();
                    setTimeout(async () => {
                        const row = document.querySelector('.pe-main-row');
                        if(row) {
                            row.click();
                            await waitFor('.view-evidence-btn');
                            row.scrollIntoView({block: 'center', behavior: 'smooth'});
                        }
                        resolve();
                    }, 500);
                });
            }
        });

        // 16. Click Evidence Button
        tour.addStep({
            id: 'click-evidence',
            title: 'View Evidence',
            text: 'Click the **View Evidence Statements** button.',
            attachTo: { element: '.view-evidence-btn', on: 'top' },
            buttons: [{ action() { return this.back(); }, classes: 'shepherd-button-secondary', text: 'Back' }],
            advanceOn: { selector: '.view-evidence-btn', event: 'click' },
            beforeShowPromise: function() {
                closeAllModals();
                return Promise.resolve();
            }
        });

        // 18. Explain Evidence
        tour.addStep({
            id: 'explain-evidence',
            title: 'Official Data',
            text: 'These are the official evidence statements from NGSS. Right click to copy any text on this screen, as well.',
            attachTo: { element: '#evidence-statements-modal .modal-body', on: 'right' },
            beforeShowPromise: function() {
                return new Promise(resolve => {
                     const modal = document.getElementById('evidence-statements-modal');
                     if (!modal.classList.contains('is-visible')) {
                         document.querySelector('.view-evidence-btn').click();
                     }
                     setTimeout(resolve, 300);
                });
            }
        });

        // 19. Conditional AI
        if (hasApiKey) {
            tour.addStep({
                id: 'ai-features',
                title: 'AI Features',
                text: 'Use <strong>Deconstruct</strong> to break this down into learning facets, or <strong>Analyze</strong> for context.',
                attachTo: { element: '.modal-footer .ai-controls', on: 'top' },
                buttons: [{ 
                    text: 'Finish', 
                    action() { closeAllModals(); tour.complete(); } 
                }]
            });
        } else {
            tour.addStep({
                id: 'no-ai',
                title: 'Enable AI',
                text: 'To unlock Deconstruction and Analysis, add a free API Key in <strong>Settings</strong>.',
                attachTo: { element: '.ai-controls', on: 'top' },
                buttons: [{ 
                    text: 'Finish', 
                    action() { closeAllModals(); tour.complete(); } 
                }]
            });
        }

        tour.start();
    };

    startTourBtn.addEventListener('click', initTour);

        initializeApp();
    });
    </script>
</body>
</html>
