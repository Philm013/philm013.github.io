<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SnapMeet</title>
    
    <!-- PWA MANIFEST LINK -->
    <link rel="manifest" href="manifest.json">
    
    <!-- THEME COLORS FOR MOBILE -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- IOS ICON SUPPORT -->
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="src/style.css"/>
</head>
<body class="">

    <!-- AUDIO ELEMENTS -->
    <audio id="sound-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a"></audio>
    <audio id="sound-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

    <!-- HEADER -->
    <div class="header-left glass">
        <button onclick="app.toggleTheme()" class="text-yellow-500 mr-3"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
        <button onclick="app.toggleChatList()" class="text-blue-500 mr-3"><i class="fa-solid fa-comments"></i></button>
        <div class="flex flex-col leading-none">
            <span class="font-black text-xs tracking-wide">SNAP<span class="text-blue-500">MEET</span></span>
            <span id="conn-status" class="text-[9px] opacity-60 font-bold mt-1 tracking-widest uppercase">OFFLINE</span>
        </div>
        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_red] ml-3"></div>
    </div>

    <div class="header-right">
        <button onclick="app.toggleQR()" class="icon-btn glass"><i class="fa-solid fa-qrcode"></i></button>
    </div>

    <!-- MAP VIEW -->
    <div id="view-map">
        <div id="map"></div>
        <div class="search-bar glass">
            <input type="text" id="search-input" placeholder="Search location..." class="flex-1 bg-transparent px-4 outline-none text-base">
            <button onclick="app.searchLocation()" class="w-10 h-10 bg-blue-600 rounded-full text-white shadow-lg"><i class="fa-solid fa-search"></i></button>
        </div>
        <button onclick="app.togglePoiPanel()" class="poi-toggle-btn glass"><i class="fa-solid fa-list"></i></button>

        <div id="poi-panel" class="poi-panel glass hidden">
            <div class="poi-panel-header">
                <h3>Points of Interest</h3>
                <button onclick="app.togglePoiPanel()" class="close-btn"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="poi-panel-tabs">
                <button class="poi-tab-btn active" data-tab="pois">POIs</button>
                <button class="poi-tab-btn" data-tab="rally">Rally</button>
                <button class="poi-tab-btn" data-tab="search">Search</button>
            </div>
            <div id="poi-list" class="poi-panel-content">
                <div id="pois-content" class="tab-content active"></div>
                <div id="rally-content" class="tab-content"></div>
                <div id="search-content" class="tab-content"></div>
            </div>
        </div>


        
        <!-- OPS STACK (Controls) -->
        <div class="ops-stack">
            <button onclick="app.locateMe()" class="ops-btn glass text-blue-500" title="Locate Me"><i class="fa-solid fa-location-crosshairs"></i></button>
            <button onclick="app.toggleSatellite()" class="ops-btn glass text-green-400" title="Satellite Mode"><i class="fa-solid fa-layer-group"></i></button>
            <button onclick="app.toggleWaypointMode()" id="btn-poi" class="ops-btn glass text-yellow-500" title="Add POI"><i class="fa-solid fa-map-pin"></i></button>
            <button onclick="app.sendSonar()" class="ops-btn glass text-red-500" title="Sonar Ping"><i class="fa-solid fa-bullseye"></i></button>
            <button id="btn-focus" onclick="app.forceFocus()" class="hidden ops-btn bg-blue-600 text-white shadow-lg shadow-blue-500/50" title="Force Group Focus"><i class="fa-solid fa-magnet"></i></button>
        </div>

        <div id="host-hint" class="absolute top-24 left-1/2 -translate-x-1/2 z-[10] glass px-4 py-2 rounded-full text-xs font-bold opacity-0 pointer-events-none transition-opacity">Host: Double-Tap to Flag</div>

        <div id="call-container" class="hidden absolute inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center">
            <video id="remote-video" class="w-full h-full object-cover" autoplay></video>
            <video id="local-video" class="absolute w-32 h-48 bottom-4 right-4 border-2 border-white rounded-lg object-cover" autoplay muted></video>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-4">
                <button id="mute-btn" class="call-btn bg-gray-500"><i class="fa-solid fa-microphone-slash"></i></button>
                <button id="end-call-btn" class="call-btn bg-red-500"><i class="fa-solid fa-phone-slash"></i></button>
                <button id="switch-camera-btn" class="call-btn bg-gray-500"><i class="fa-solid fa-camera-rotate"></i></button>
            </div>
        </div>

        <div id="chat-list-panel" class="chat-list-panel glass hidden">
            <div class="chat-list-header">
                <h3>Chats</h3>
                <button onclick="app.toggleChatList()" class="close-btn"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="chat-list" class="chat-list-content"></div>
        </div>
    </div>

    <!-- CHAT VIEW -->
    <div id="view-chat">
        <div id="chat-header" class="absolute top-0 left-0 right-0 z-30 p-4 glass hidden"></div>
        <div id="chat-scroll" class="no-scrollbar">
            <div id="msg-list" class="flex flex-col gap-4"></div>
        </div>
        <div id="mention-suggestions" class="absolute bottom-[170px] left-4 right-4 z-40 glass rounded-xl p-2 hidden"></div>
        <div class="absolute bottom-[110px] left-4 right-4 z-30 glass p-2 rounded-3xl flex gap-2">
            <input type="text" id="msg-input" placeholder="Message... (@ to mention)" autocomplete="off" class="flex-1 bg-transparent px-4 outline-none text-base">
            <button onclick="app.sendMessage(event)" class="w-10 h-10 bg-blue-600 rounded-full text-white shadow-lg"><i class="fa-solid fa-arrow-up"></i></button>
        </div>
    </div>

    <!-- ROSTER VIEW -->
    <div id="view-roster">
        <div id="roster-list" class="flex flex-col gap-2 p-4"></div>
    </div>

    <!-- BOARDS VIEW -->
    <div id="view-boards" class="hidden absolute inset-0 z-30 bg-black/90 flex flex-col items-center justify-center p-6">
        <h2 class="text-3xl font-bold text-white mb-6">Planning Boards</h2>
        <div class="glass p-6 rounded-2xl w-full max-w-xs text-center mb-6">
            <h3 class="text-xl font-bold mb-4">Create New Board</h3>
            <div class="bg-white/10 p-2 rounded-xl mb-4">
                <input type="text" id="new-board-name-input" class="w-full bg-transparent text-white p-2 text-center font-bold text-lg outline-none" placeholder="Board Name">
            </div>
            <button onclick="app.createNewBoard()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold text-lg">CREATE BOARD</button>
        </div>

        <div class="glass p-6 rounded-2xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold mb-4">Load Existing Board</h3>
            <div id="boards-list" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <!-- NAV DOCK -->
    <nav class="nav-dock glass">
        <button onclick="app.switchTab('map')" id="btn-map" class="nav-btn active"><i class="fa-solid fa-map-location-dot"></i></button>
        <div class="w-px h-8 bg-gray-500/30 my-auto mx-1"></div>
        <button onclick="app.switchTab('chat')" id="btn-chat" class="nav-btn relative">
            <i class="fa-solid fa-comments"></i>
            <div id="unread-dot" class="absolute top-4 right-4 w-2.5 h-2.5 bg-red-500 rounded-full hidden border-2 border-white"></div>
        </button>
        <div class="w-px h-8 bg-gray-500/30 my-auto mx-1"></div>
        <button onclick="app.switchTab('roster')" id="btn-roster" class="nav-btn"><i class="fa-solid fa-users"></i></button>
        <div class="w-px h-8 bg-gray-500/30 my-auto mx-1"></div>
        <button onclick="app.switchTab('boards')" id="btn-boards" class="nav-btn"><i class="fa-solid fa-clipboard-list"></i></button>
        <div class="w-px h-8 bg-gray-500/30 my-auto mx-1"></div>
        <button onclick="app.burn()" class="nav-btn text-red-500"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- WAYPOINT NAME MODAL -->
    <div id="modal-waypoint-name" class="fixed inset-0 z-[100] bg-black/80 hidden flex flex-col items-center justify-center p-6" onclick="if(event.target === this) this.classList.add('hidden');">
        <div class="glass p-6 rounded-2xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold mb-4">Name your POI</h3>
            <div class="bg-white/10 p-2 rounded-xl mb-4">
                <input type="text" id="waypoint-name-input" class="w-full bg-transparent text-white p-2 text-center font-bold text-lg outline-none" placeholder="E.g., The Man">
            </div>
            <button id="waypoint-save-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg">SAVE</button>
        </div>
    </div>

    <!-- ACTION SHEET -->
    <div id="modal-actions" class="fixed inset-0 z-[60] bg-black/60 hidden" onclick="app.hideActions()">
        <div id="action-sheet" class="action-sheet glass">
            <div class="w-12 h-1.5 bg-gray-500 rounded-full mx-auto mb-4"></div>
            <div id="action-content" class="text-center"></div>
            <div id="action-buttons" class="flex flex-col gap-2 mt-4"></div>
        </div>
    </div>

    <!-- GROUP CHAT MODAL -->
    <div id="modal-group-chat" class="fixed inset-0 z-[100] bg-black/80 hidden flex flex-col items-center justify-center p-6" onclick="if(event.target === this) this.classList.add('hidden');">
        <div class="glass p-6 rounded-2xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold mb-4">Create Group Chat</h3>
            <div class="bg-white/10 p-2 rounded-xl mb-4">
                <input type="text" id="group-name-input" class="w-full bg-transparent text-white p-2 text-center font-bold text-lg outline-none" placeholder="Group Name">
            </div>
            <div id="group-chat-participants" class="text-left mb-4"></div>
            <button onclick="app.createGroupChat()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-lg">CREATE</button>
        </div>
    </div>

    <!-- ICON PICKER MODAL -->
    <div id="modal-icon-picker" class="fixed inset-0 z-[100] bg-black/80 hidden flex flex-col items-center justify-center p-6" onclick="if(event.target === this) this.classList.add('hidden');">
        <div class="glass p-6 rounded-2xl w-full max-w-xs text-center">
            <h3 class="text-xl font-bold mb-4">Choose an Icon</h3>
            <div id="icon-grid" class="grid grid-cols-4 gap-4 mb-4"></div>
            <button onclick="document.getElementById('modal-icon-picker').classList.add('hidden')" class="w-full bg-gray-500 text-white py-3 rounded-xl font-bold text-lg">CANCEL</button>
        </div>
    </div>

    <!-- ONBOARDING -->
    <div id="modal-onboarding" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-6 transition-opacity duration-500">
        <div class="w-24 h-24 bg-gradient-to-tr from-gray-800 to-gray-900 rounded-3xl flex items-center justify-center shadow-2xl border border-white/10 mb-8">
            <i class="fa-solid fa-users text-5xl text-white"></i>
        </div>
        <h1 class="text-4xl font-black text-white mb-2">SNAP<span class="text-blue-500">MEET</span></h1>
        <p class="text-gray-500 text-xs uppercase font-bold tracking-[0.2em] mb-10">Social Exploration</p>
        <div class="bg-white/10 p-2 rounded-2xl mb-4 w-full max-w-xs">
            <input type="text" id="username-input" class="w-full bg-transparent text-white p-4 text-center font-bold text-xl outline-none" placeholder="CODENAME">
        </div>
        <button onclick="app.startSession()" class="w-full max-w-xs bg-white text-black py-4 rounded-2xl font-black text-lg active:scale-95 transition-transform">ENTER</button>
    </div>

    <!-- QR -->
    <div id="modal-qr" class="fixed inset-0 z-[90] hidden bg-black/95 flex flex-col items-center justify-center p-6 gap-4" onclick="app.toggleQR()">
        <div class="bg-white p-8 rounded-[32px] text-center" onclick="event.stopPropagation()">
            <div id="qrcode" class="flex justify-center p-2 mb-4"></div>
            <p class="text-black font-bold">Scan to Join</p>
        </div>
        <button onclick="app.copyLink(event)" class="bg-white text-black px-6 py-3 rounded-full font-bold text-lg">Copy Link</button>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 glass px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-all pointer-events-none translate-y-4 z-[200]">Notification</div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="src/state.js"></script>
    <script src="src/ui.js"></script>
    <script src="src/map.js"></script>
    <script src="src/network.js"></script>
    <script src="src/app.js"></script>
<script src="src/app.js"></script>

    <!-- SERVICE WORKER REGISTRATION -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('SW Registered!', reg.scope))
                    .catch((err) => console.log('SW Failed:', err));
            });
        }
    </script>
</body>
</body>
</html>