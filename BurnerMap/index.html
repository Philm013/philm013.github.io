<!-- 
  BURNERMAP v3.2: Robust Permission Handling & Manual Fallback
  Single File Implementation
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BurnerMap v3.2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root { --app-height: 100dvh; }
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; height: var(--app-height); width: 100vw; overflow: hidden; overscroll-behavior: none; }
        
        /* Layout */
        #app { height: 100%; width: 100%; position: relative; }
        .view-section { position: absolute; inset: 0; height: 100%; width: 100%; transition: opacity 0.3s ease; }
        .view-active { z-index: 20; opacity: 1; pointer-events: auto; }
        .view-hidden { z-index: 0; opacity: 0; pointer-events: none; }

        /* Map */
        #map { height: 100%; width: 100%; background: #0f172a; }
        
        /* Safe Areas */
        .pt-safe { padding-top: max(env(safe-area-inset-top), 20px); }
        .pb-safe { padding-bottom: max(env(safe-area-inset-bottom), 20px); }

        /* UI Elements */
        .glass-header { background: linear-gradient(to bottom, rgba(15,23,42,0.9) 0%, rgba(15,23,42,0) 100%); }
        .glass-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Markers */
        .custom-marker { border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; }
        .pulse-dot::before { content: ''; position: absolute; width: 100%; height: 100%; background: inherit; border-radius: 50%; z-index: -1; animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2.2); opacity: 0; } }
        
        /* Avatar Selection */
        .avatar-option.selected { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.2); transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="app">
        
        <!-- === TOP HEADER === -->
        <header class="absolute top-0 left-0 right-0 z-50 pt-safe px-4 pb-6 glass-header pointer-events-none flex justify-between items-start">
            <!-- Status -->
            <div class="pointer-events-auto flex flex-col gap-2 mt-1">
                <div class="bg-slate-900/80 backdrop-blur px-3 py-1.5 rounded-full border border-white/10 flex items-center gap-2 shadow-lg w-max">
                    <div id="heartbeat-icon" class="text-[10px] text-slate-500"><i class="fa-solid fa-signal"></i></div>
                    <span id="connection-status" class="text-[10px] font-bold tracking-wider text-slate-300 uppercase">OFFLINE</span>
                </div>
                <!-- Manual Mode Indicator -->
                <div id="manual-mode-badge" class="hidden bg-amber-900/80 backdrop-blur px-3 py-1.5 rounded-full border border-amber-500/30 flex items-center gap-2 shadow-lg w-max">
                    <i class="fa-solid fa-hand-pointer text-amber-400 text-[10px]"></i>
                    <span class="text-[10px] font-bold text-amber-100 uppercase">Manual Loc</span>
                </div>
            </div>

            <!-- Actions -->
            <div class="pointer-events-auto flex gap-3 mt-1">
                <button id="btn-settings" onclick="app.toggleSettings()" class="hidden bg-slate-800 hover:bg-slate-700 text-white w-10 h-10 rounded-full shadow-lg border border-white/10 flex items-center justify-center transition-all active:scale-95">
                    <i class="fa-solid fa-gear"></i>
                </button>
                <button onclick="app.copyLink()" class="bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95">
                    <i class="fa-solid fa-link"></i>
                </button>
            </div>
        </header>

        <!-- === MAP VIEW === -->
        <div id="view-map" class="view-section view-active">
            <div id="map"></div>
        </div>

        <!-- === CHAT VIEW === -->
        <div id="view-chat" class="view-section view-hidden bg-slate-900 flex flex-col">
            <div class="pt-safe pb-4 px-4 bg-slate-900 border-b border-white/5 shrink-0 min-h-[100px] flex items-end">
                <div>
                    <h2 class="text-xl font-bold text-white">Live Chat</h2>
                    <p class="text-xs text-slate-400 uppercase tracking-wide">Encrypted P2P Mesh</p>
                </div>
            </div>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
                <div class="text-center mt-4 opacity-30">
                    <i class="fa-solid fa-comments text-4xl mb-2"></i>
                    <p class="text-xs">Chat History Started</p>
                </div>
            </div>
            <div class="p-3 bg-slate-800 border-t border-white/5 shrink-0 pb-[100px]">
                <form onsubmit="app.sendMessage(event)" class="flex gap-2">
                    <input type="text" id="msg-input" placeholder="Type message..." autocomplete="off" class="flex-1 bg-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <button type="submit" class="bg-blue-600 text-white px-4 rounded-xl font-bold active:scale-95 transition-transform"><i class="fa-solid fa-paper-plane"></i></button>
                </form>
            </div>
        </div>

        <!-- === BOTTOM NAV === -->
        <div class="absolute bottom-6 left-0 right-0 z-50 flex justify-center pb-safe pointer-events-none">
            <nav class="glass-nav pointer-events-auto rounded-2xl p-1.5 flex gap-1 shadow-2xl w-[90%] max-w-sm">
                <button onclick="app.switchTab('map')" id="btn-map" class="flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all">
                    <i class="fa-solid fa-map-location-dot text-lg mb-0.5 block"></i><span class="text-[10px] font-bold uppercase">Map</span>
                </button>
                <button onclick="app.switchTab('chat')" id="btn-chat" class="flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all relative">
                    <i class="fa-solid fa-comments text-lg mb-0.5 block"></i>
                    <span id="unread-badge" class="absolute top-2 right-8 w-3 h-3 bg-red-500 rounded-full hidden border border-slate-900"></span>
                    <span class="text-[10px] font-bold uppercase">Chat</span>
                </button>
                <button onclick="app.burn()" class="flex-1 py-3 rounded-xl text-center text-red-400 hover:text-red-300 hover:bg-red-500/10 transition-all">
                    <i class="fa-solid fa-fire text-lg mb-0.5 block"></i><span class="text-[10px] font-bold uppercase">Burn</span>
                </button>
            </nav>
        </div>

        <!-- === ONBOARDING MODAL === -->
        <div id="modal-onboarding" class="absolute inset-0 z-[60] bg-slate-900 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
            <div class="w-full max-w-sm text-center">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-map text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-1">BurnerMap v3.2</h1>
                <p class="text-xs text-slate-400 mb-6">Secure â€¢ Ephemeral â€¢ Real-time</p>
                
                <!-- HTTPS Warning -->
                <div id="https-warning" class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-xl text-left">
                    <p class="text-[10px] text-red-300 leading-relaxed">
                        <i class="fa-solid fa-lock-open mr-1"></i> 
                        <b>Insecure Connection:</b> Browsers block GPS on "http" or "file". Please use "https" or "localhost".
                    </p>
                </div>

                <div class="mb-4">
                    <div class="grid grid-cols-5 gap-3" id="avatar-grid"></div>
                </div>

                <input type="text" id="username-input" class="w-full bg-slate-800 text-white px-4 py-3 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center font-bold border border-white/5" placeholder="Enter Alias">

                <!-- Action Button -->
                <button id="btn-start" onclick="app.requestLocationAndStart()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3.5 rounded-xl font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-location-crosshairs"></i> Enable GPS & Start
                </button>
                
                <button onclick="app.startManualMode()" class="mt-4 text-xs text-slate-500 hover:text-white underline">
                    GPS Broken? Use Manual Mode
                </button>
            </div>
        </div>

        <!-- === MANUAL MODE MODAL === -->
        <div id="modal-manual" class="hidden absolute inset-0 z-[70] bg-slate-900/90 flex items-center justify-center p-6 text-center">
            <div class="bg-slate-800 p-6 rounded-2xl border border-white/10 max-w-xs w-full">
                <i class="fa-solid fa-hand-pointer text-4xl text-amber-500 mb-4"></i>
                <h2 class="text-lg font-bold text-white mb-2">Tap Your Location</h2>
                <p class="text-xs text-slate-400 mb-4">Since GPS is disabled, tap the map where you are right now.</p>
                <button onclick="document.getElementById('modal-manual').classList.add('hidden')" class="bg-amber-600 text-white px-6 py-2 rounded-xl font-bold w-full">Okay</button>
            </div>
        </div>

        <!-- === SETTINGS MODAL === -->
        <div id="modal-settings" class="hidden absolute inset-0 z-[70] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-slate-800 w-full max-w-sm rounded-t-2xl sm:rounded-2xl border border-white/10 p-6 shadow-2xl pb-safe">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white">Host Controls</h2>
                    <button onclick="app.toggleSettings()" class="text-slate-400 p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <button onclick="app.resetRallyPoint()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-sm">
                    <i class="fa-solid fa-flag-checkered mr-2"></i> Clear Rally Point
                </button>
            </div>
        </div>

        <!-- === TOAST === -->
        <div id="toast" class="absolute top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-xl border border-white/10 z-[90] flex items-center gap-2 text-xs transition-opacity duration-300 opacity-0 pointer-events-none w-max max-w-[80%]">
            <i class="fa-solid fa-info-circle text-blue-400"></i><span id="toast-msg">Notification</span>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        const app = {
            peer: null, conn: null, connections: [], 
            myId: null, hostId: null, isHost: false,
            username: 'Anon', avatar: 'fa-user', color: '#3b82f6',
            map: null, markers: {}, rallyMarker: null, myLocation: null,
            manualMode: false, activeTab: 'map',
            avatars: ['fa-user-astronaut', 'fa-ghost', 'fa-robot', 'fa-dragon', 'fa-cat', 'fa-dog', 'fa-frog', 'fa-spider', 'fa-crow', 'fa-mask'],

            init: function() {
                const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                window.addEventListener('resize', setVh);
                setVh();

                // Check Secure Context
                if (!window.isSecureContext && window.location.hostname !== 'localhost') {
                    document.getElementById('https-warning').classList.remove('hidden');
                }

                this.renderAvatars();
                this.initMap();
                
                // Check persistence
                const saved = JSON.parse(localStorage.getItem('burner_state'));
                const urlParams = new URLSearchParams(window.location.search);
                this.hostId = urlParams.get('join');
                
                if (saved && (!this.hostId || this.hostId === saved.hostId)) {
                    this.username = saved.username;
                    this.avatar = saved.avatar;
                    this.color = saved.color;
                    this.hostId = saved.hostId;
                    this.myId = saved.myId;
                    document.getElementById('username-input').value = this.username;
                    this.selectAvatar(this.avatar);
                    document.getElementById('btn-start').innerHTML = `<i class="fa-solid fa-rotate-left"></i> Rejoin Session`;
                }

                this.isHost = !this.hostId;
                if(this.isHost) document.getElementById('btn-settings').classList.remove('hidden');
            },

            renderAvatars: function() {
                const grid = document.getElementById('avatar-grid');
                grid.innerHTML = this.avatars.map(icon => `
                    <div onclick="app.selectAvatar('${icon}')" class="avatar-option w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center cursor-pointer border border-white/10 transition-all text-slate-400 hover:text-white">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                `).join('');
                this.selectAvatar(this.avatar);
            },

            selectAvatar: function(icon) {
                this.avatar = icon;
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected', 'text-white'));
                const selected = document.querySelector(`.avatar-option i.fa-solid.${icon}`).parentNode;
                selected.classList.add('selected', 'text-white');
            },

            initMap: function() {
                this.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20,0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(this.map);
                
                this.map.on('click', (e) => {
                    if (this.manualMode) {
                        this.updateMyLocation(e.latlng.lat, e.latlng.lng);
                        this.showToast("Location Updated");
                    }
                });

                this.map.on('dblclick', (e) => {
                    if(this.isHost && !this.manualMode) {
                        this.setRallyPoint(e.latlng.lat, e.latlng.lng);
                        this.send({ type: 'rally', lat: e.latlng.lat, lng: e.latlng.lng });
                    }
                });
            },

            requestLocationAndStart: function() {
                const input = document.getElementById('username-input');
                if(!input.value.trim()) return input.classList.add('border-red-500');
                this.username = input.value.trim();

                // Explicitly request location NOW
                if (!navigator.geolocation) {
                    alert("GPS not supported. Switching to manual mode.");
                    this.startManualMode();
                    return;
                }

                const btn = document.getElementById('btn-start');
                btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Locating...`;

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        // Success!
                        this.finishOnboarding();
                        this.startTracking(true); // Start watcher
                    },
                    (err) => {
                        // Error
                        console.warn(err);
                        if(err.code === 1) alert("Location Denied. Please enable permissions or use Manual Mode.");
                        else if (err.code === 2) alert("GPS Signal Unavailable. Try Manual Mode.");
                        else alert("GPS Timeout. Try Manual Mode.");
                        
                        btn.innerHTML = `<i class="fa-solid fa-location-crosshairs"></i> Try Again`;
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            },

            startManualMode: function() {
                const input = document.getElementById('username-input');
                if(!input.value.trim()) return input.classList.add('border-red-500');
                this.username = input.value.trim();
                
                this.manualMode = true;
                document.getElementById('manual-mode-badge').classList.remove('hidden');
                this.finishOnboarding();
                document.getElementById('modal-manual').classList.remove('hidden');
            },

            finishOnboarding: function() {
                document.getElementById('modal-onboarding').style.opacity = '0';
                setTimeout(() => document.getElementById('modal-onboarding').style.display = 'none', 300);
                this.initPeer();
                this.saveState();
            },

            startTracking: function(watch) {
                if(watch) {
                    navigator.geolocation.watchPosition(
                        (pos) => this.updateMyLocation(pos.coords.latitude, pos.coords.longitude),
                        (err) => console.warn(err),
                        { enableHighAccuracy: true }
                    );
                }
            },

            updateMyLocation: function(lat, lng) {
                this.myLocation = { lat, lng };
                this.updateMarker(this.myId, lat, lng, 'You', this.avatar, this.color, true);
                if (!this.mapCentered) { 
                    this.map.setView([lat, lng], 16); 
                    this.mapCentered = true; 
                }
                this.send({ type: 'location', lat, lng });
            },

            saveState: function() {
                localStorage.setItem('burner_state', JSON.stringify({
                    username: this.username, avatar: this.avatar, color: this.color, hostId: this.hostId, myId: this.myId
                }));
            },

            // --- PEER JS & NETWORKING (Same as v3.1) ---
            initPeer: function() {
                this.updateStatus('connecting', 'INIT...');
                this.peer = new Peer(null, { debug: 0 }); 
                this.peer.on('open', (id) => {
                    this.myId = id;
                    this.saveState(); 
                    if (this.isHost) {
                        this.updateStatus('online', 'HOSTING');
                        this.peer.on('connection', (conn) => this.handleHostConnection(conn));
                        this.startHeartbeat();
                    } else {
                        this.connectToHost();
                    }
                });
                this.peer.on('error', (err) => {
                    this.updateStatus('error', 'NET ERR');
                    setTimeout(() => this.initPeer(), 3000);
                });
            },

            connectToHost: function() {
                if(!this.hostId) return;
                this.conn = this.peer.connect(this.hostId, { metadata: { username: this.username, avatar: this.avatar, color: this.color }});
                this.conn.on('open', () => {
                    this.updateStatus('online', 'CONNECTED');
                    this.showToast('Connected!');
                    if(this.myLocation) this.send({ type: 'location', lat: this.myLocation.lat, lng: this.myLocation.lng });
                });
                this.conn.on('data', (data) => this.handleData(data));
                this.conn.on('close', () => {
                    this.updateStatus('error', 'LOST HOST');
                    setTimeout(() => this.connectToHost(), 2000);
                });
            },

            handleHostConnection: function(conn) {
                this.connections.push(conn);
                conn.on('open', () => {
                    this.showToast(`${conn.metadata.username} joined`);
                    conn.send({ type: 'sync', rally: this.rallyMarker ? this.rallyMarker.getLatLng() : null });
                });
                conn.on('data', (data) => {
                    if(!data.from) data.from = conn.peer;
                    if(!data.username) data.username = conn.metadata.username;
                    if(!data.avatar) data.avatar = conn.metadata.avatar;
                    if(!data.color) data.color = conn.metadata.color;
                    if(data.type === 'pong') return; 
                    this.handleData(data);
                    this.broadcast(data, conn.peer);
                });
                conn.on('close', () => {
                    this.connections = this.connections.filter(c => c.peer !== conn.peer);
                    this.removeMarker(conn.peer);
                    this.showToast(`${conn.metadata.username} left`);
                });
            },

            broadcast: function(data, excludeId) {
                this.connections.forEach(c => { if(c.peer !== excludeId && c.open) c.send(data); });
            },

            handleData: function(data) {
                if(data.type === 'ping') {
                    if(this.conn) this.conn.send({ type: 'pong' });
                    return;
                }
                if(data.type === 'location') this.updateMarker(data.from, data.lat, data.lng, data.username, data.avatar, data.color);
                else if(data.type === 'chat') {
                    this.addMessage(data.username, data.msg, data.avatar, false);
                    if(this.activeTab !== 'chat') {
                        document.getElementById('unread-badge').classList.remove('hidden');
                        this.showToast(`Msg: ${data.username}`);
                    }
                }
                else if(data.type === 'rally') {
                    this.setRallyPoint(data.lat, data.lng);
                    this.showToast("Rally Point Updated");
                }
                else if(data.type === 'sync') {
                    if(data.rally) this.setRallyPoint(data.rally.lat, data.rally.lng);
                }
            },

            send: function(data) {
                data.from = this.myId; data.username = this.username; data.avatar = this.avatar; data.color = this.color;
                if(this.isHost) {
                    if(data.type !== 'ping') this.handleData(data);
                    this.broadcast(data);
                } else if(this.conn && this.conn.open) {
                    this.conn.send(data);
                    if(data.type === 'chat') this.addMessage('You', data.msg, this.avatar, true);
                }
            },

            startHeartbeat: function() {
                setInterval(() => {
                    this.broadcast({ type: 'ping' });
                }, 3000);
            },

            updateMarker: function(id, lat, lng, label, avatar, color, isSelf) {
                if(this.markers[id]) this.markers[id].setLatLng([lat, lng]);
                else {
                    const html = `<div class="${isSelf ? 'custom-marker pulse-dot' : 'custom-marker'}" style="background:${isSelf?'#10b981':color}; width:36px; height:36px;"><i class="fa-solid ${avatar}"></i></div>`;
                    const icon = L.divIcon({ className: 'bg-transparent', html: html });
                    const marker = L.marker([lat, lng], { icon: icon, zIndexOffset: isSelf?1000:500 }).addTo(this.map);
                    marker.bindPopup(label, { closeButton: false, offset: [0,-15] });
                    this.markers[id] = marker;
                }
            },

            setRallyPoint: function(lat, lng) {
                if(this.rallyMarker) this.map.removeLayer(this.rallyMarker);
                const icon = L.divIcon({ className: 'bg-transparent', html: '<div style="font-size:30px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.5));">ðŸš©</div>' });
                this.rallyMarker = L.marker([lat, lng], { icon: icon }).addTo(this.map);
            },

            resetRallyPoint: function() {
                if(this.rallyMarker) this.map.removeLayer(this.rallyMarker);
                this.rallyMarker = null;
                this.send({ type: 'sync', rally: null });
                this.toggleSettings();
            },

            sendMessage: function(e) {
                e.preventDefault();
                const input = document.getElementById('msg-input');
                const msg = input.value.trim();
                if(!msg) return;
                this.send({ type: 'chat', msg: msg });
                input.value = '';
                input.focus();
            },

            addMessage: function(username, msg, avatar, isSelf) {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `flex gap-2 ${isSelf ? 'flex-row-reverse' : 'flex-row'} mb-3`;
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs text-slate-300 border border-white/10 shrink-0"><i class="fa-solid ${avatar}"></i></div>
                    <div class="flex flex-col ${isSelf ? 'items-end' : 'items-start'} max-w-[80%]">
                        <span class="text-[10px] text-slate-500 mb-0.5 px-1">${username}</span>
                        <div class="${isSelf ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'} px-3 py-2 rounded-2xl ${isSelf?'rounded-tr-none':'rounded-tl-none'} text-sm shadow-sm break-words">${msg.replace(/</g, "&lt;")}</div>
                    </div>
                `;
                container.appendChild(div);
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            },

            switchTab: function(tab) {
                this.activeTab = tab;
                const mapBtn = document.getElementById('btn-map');
                const chatBtn = document.getElementById('btn-chat');
                const mapView = document.getElementById('view-map');
                const chatView = document.getElementById('view-chat');

                if(tab === 'map') {
                    mapBtn.className = "flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all";
                    chatBtn.className = "flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all relative";
                    mapView.classList.remove('view-hidden'); mapView.classList.add('view-active');
                    chatView.classList.remove('view-active'); chatView.classList.add('view-hidden');
                    setTimeout(() => this.map.invalidateSize(), 300);
                } else {
                    chatBtn.className = "flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all relative";
                    mapBtn.className = "flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all";
                    chatView.classList.remove('view-hidden'); chatView.classList.add('view-active');
                    mapView.classList.remove('view-active'); mapView.classList.add('view-hidden');
                    document.getElementById('unread-badge').classList.add('hidden');
                }
            },

            toggleSettings: function() { document.getElementById('modal-settings').classList.toggle('hidden'); },
            
            updateStatus: function(type, text) {
                document.getElementById('connection-status').innerText = text;
                const icon = document.getElementById('heartbeat-icon');
                if(type === 'online') icon.className = 'text-[10px] text-emerald-400 animate-pulse';
                else icon.className = 'text-[10px] text-red-500';
            },

            copyLink: function() {
                const url = `${window.location.origin}${window.location.pathname}?join=${this.isHost?this.myId:this.hostId}`;
                if(navigator.share) navigator.share({title:'BurnerMap', url: url}).catch(()=>{});
                else navigator.clipboard.writeText(url).then(() => this.showToast('Copied!'));
            },

            showToast: function(msg) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.style.opacity = '1';
                setTimeout(() => toast.style.opacity = '0', 3000);
            },

            burn: function() {
                if(confirm("BURN SESSION?")) {
                    localStorage.removeItem('burner_state');
                    window.location.href = window.location.pathname;
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>