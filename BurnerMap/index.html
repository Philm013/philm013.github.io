<!-- 
  BURNERMAP v3.0: Persistence, Avatars, Heartbeat & Host Controls
  Single File Implementation
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BurnerMap v3</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root { --app-height: 100dvh; }
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; height: var(--app-height); width: 100vw; overflow: hidden; overscroll-behavior: none; }
        
        /* Layout & Layers */
        #app { height: 100%; width: 100%; display: flex; flex-direction: column; position: relative; }
        #map { height: 100%; width: 100%; z-index: 0; background: #0f172a; }
        
        /* UI Components */
        .glass { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-panel { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Map Markers */
        .leaflet-control-attribution { display: none; }
        .custom-marker {
            border: 2px solid white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;
        }
        .rally-point { text-shadow: 0 2px 4px black; font-size: 24px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }

        /* Animations */
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2.2); opacity: 0; } }
        .pulse-dot::before { content: ''; position: absolute; width: 100%; height: 100%; background: inherit; border-radius: 50%; z-index: -1; animation: pulse-ring 2s infinite; }
        .toast-active { transform: translate(-50%, 20px) !important; }
        
        /* Avatar Grid */
        .avatar-option.selected { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.2); transform: scale(1.1); }
    </style>
</head>
<body>

    <div id="app">
        <!-- TOP HEADER -->
        <header class="absolute top-0 left-0 right-0 z-30 pt-safe px-4 pointer-events-none flex justify-between items-start">
            <div class="pointer-events-auto mt-2 flex flex-col gap-2">
                <!-- Connection Badge -->
                <div class="bg-slate-900/90 backdrop-blur-md px-3 py-1.5 rounded-full border border-white/10 flex items-center gap-2 shadow-lg w-max">
                    <div id="heartbeat-icon" class="text-[10px] text-slate-500"><i class="fa-solid fa-signal"></i></div>
                    <span id="connection-status" class="text-[10px] font-bold tracking-wider text-slate-300 uppercase">OFFLINE</span>
                </div>
                <!-- Timer Badge (Hidden by default) -->
                <div id="timer-badge" class="hidden bg-slate-900/90 backdrop-blur-md px-3 py-1.5 rounded-full border border-red-500/30 flex items-center gap-2 shadow-lg w-max">
                    <i class="fa-solid fa-hourglass-half text-red-400 text-xs"></i>
                    <span id="session-timer" class="text-[10px] font-mono font-bold text-red-100">00:00</span>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 mt-2">
                 <!-- Share Button -->
                <button onclick="app.copyLink()" class="pointer-events-auto bg-blue-600 hover:bg-blue-500 text-white w-10 h-10 rounded-full shadow-lg transition-all active:scale-95 flex items-center justify-center">
                    <i class="fa-solid fa-link"></i>
                </button>
                <!-- Host Settings Button (Only visible to Host) -->
                <button id="btn-settings" onclick="app.toggleSettings()" class="hidden pointer-events-auto bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-full shadow-lg transition-all active:scale-95 flex items-center justify-center border border-white/10">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="flex-1 relative w-full h-full overflow-hidden">
            <!-- Map View -->
            <div id="view-map" class="absolute inset-0 w-full h-full transition-opacity duration-300 z-0">
                <div id="map"></div>
                <!-- Rally Point Hint -->
                <div id="rally-hint" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/60 text-white px-4 py-2 rounded-lg text-xs pointer-events-none opacity-0 transition-opacity">
                    Double-tap map to set Rally Point
                </div>
            </div>

            <!-- Chat View -->
            <div id="view-chat" class="absolute inset-0 w-full h-full bg-slate-900 flex flex-col opacity-0 pointer-events-none transition-opacity duration-300 z-10">
                <div class="pt-safe px-4 pb-3 bg-slate-900 border-b border-white/5 shadow-md z-20 flex justify-between items-end">
                    <div>
                        <h2 class="text-lg font-bold text-white leading-none">Live Comms</h2>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-wide">Encrypted P2P Mesh</p>
                    </div>
                    <button onclick="app.switchTab('map')" class="text-slate-400 hover:text-white p-2"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar"></div>
                <div class="p-3 bg-slate-800 border-t border-white/5 pb-[calc(env(safe-area-inset-bottom)+80px)]">
                    <form onsubmit="app.sendMessage(event)" class="flex gap-2">
                        <input type="text" id="msg-input" placeholder="Type message..." autocomplete="off" class="flex-1 bg-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <button type="submit" class="bg-blue-600 text-white px-4 rounded-xl font-bold"><i class="fa-solid fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </main>

        <!-- BOTTOM NAV -->
        <div class="absolute bottom-6 left-0 right-0 z-40 flex justify-center pb-safe pointer-events-none">
            <nav class="glass pointer-events-auto rounded-2xl p-1.5 flex gap-1 shadow-2xl w-[90%] max-w-sm backdrop-blur-xl">
                <button onclick="app.switchTab('map')" id="btn-map" class="flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all">
                    <i class="fa-solid fa-map-location-dot text-lg mb-0.5 block"></i><span class="text-[10px] font-bold uppercase">Map</span>
                </button>
                <button onclick="app.switchTab('chat')" id="btn-chat" class="flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all relative">
                    <i class="fa-solid fa-comments text-lg mb-0.5 block"></i>
                    <span id="unread-badge" class="absolute top-2 right-8 w-3 h-3 bg-red-500 rounded-full hidden border border-slate-900"></span>
                    <span class="text-[10px] font-bold uppercase">Chat</span>
                </button>
                <button onclick="app.burn()" class="flex-1 py-3 rounded-xl text-center text-red-400 hover:text-red-300 hover:bg-red-500/10 transition-all">
                    <i class="fa-solid fa-fire text-lg mb-0.5 block"></i><span class="text-[10px] font-bold uppercase">Burn</span>
                </button>
            </nav>
        </div>

        <!-- ONBOARDING MODAL -->
        <div id="modal-onboarding" class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center p-6 transition-opacity duration-300 overflow-y-auto">
            <div class="w-full max-w-sm text-center my-auto">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-satellite-dish text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white mb-1">BurnerMap v3</h1>
                <p class="text-xs text-slate-400 mb-6">Persistent â€¢ Encrypted â€¢ Ephemeral</p>
                
                <!-- Avatar Selection -->
                <div class="mb-6">
                    <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Choose Avatar</label>
                    <div class="grid grid-cols-5 gap-3" id="avatar-grid">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <div class="bg-slate-800/50 border border-white/5 p-1 rounded-2xl mb-4">
                    <input type="text" id="username-input" class="w-full bg-slate-800 text-white px-4 py-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-center font-bold" placeholder="Enter Alias">
                </div>

                <button onclick="app.startSession()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-900/40 transition-all active:scale-95">
                    <span id="btn-start-text">Start Session</span>
                </button>
                
                <div id="rejoin-hint" class="hidden mt-4 text-xs text-emerald-400">
                    <i class="fa-solid fa-rotate-left mr-1"></i> Previous session found
                </div>
            </div>
        </div>

        <!-- HOST SETTINGS MODAL -->
        <div id="modal-settings" class="hidden absolute inset-0 z-[60] bg-slate-900/90 backdrop-blur-sm flex items-end sm:items-center justify-center transition-opacity">
            <div class="bg-slate-800 w-full max-w-sm rounded-t-2xl sm:rounded-2xl border border-white/10 p-6 shadow-2xl animate-slide-up">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-white">Session Controls</h2>
                    <button onclick="app.toggleSettings()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Auto-Destruct Timer</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="app.setExpiry(30)" class="expiry-btn bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs font-bold transition-all">30m</button>
                            <button onclick="app.setExpiry(60)" class="expiry-btn bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs font-bold transition-all">1h</button>
                            <button onclick="app.setExpiry(240)" class="expiry-btn bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-xs font-bold transition-all">4h</button>
                        </div>
                    </div>
                    
                    <div class="pt-4 border-t border-white/5">
                        <button onclick="app.resetRallyPoint()" class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-sm mb-2">
                            <i class="fa-solid fa-flag-checkered mr-2"></i> Clear Rally Point
                        </button>
                        <p class="text-[10px] text-slate-500 text-center">Double-tap map to set a new point.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- EXPIRED OVERLAY -->
        <div id="modal-expired" class="hidden absolute inset-0 z-[70] bg-red-900/90 backdrop-blur-md flex items-center justify-center p-6 text-center">
            <div>
                <i class="fa-solid fa-skull-crossbones text-6xl text-red-400 mb-4 animate-pulse"></i>
                <h1 class="text-3xl font-bold text-white mb-2">SESSION BURNED</h1>
                <p class="text-red-200 mb-6">The host timer has expired.</p>
                <button onclick="app.burn()" class="bg-white text-red-900 px-6 py-3 rounded-xl font-bold">Start New</button>
            </div>
        </div>

        <!-- TOAST -->
        <div id="toast" class="absolute top-0 left-1/2 bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl border border-white/10 z-[80] flex items-center gap-3 text-xs font-medium transition-transform duration-500 w-max max-w-[90%] -translate-y-full -translate-x-1/2">
            <i class="fa-solid fa-circle-info text-blue-400"></i><span id="toast-msg">Notification</span>
        </div>
    </div>

    <!-- LIBS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        const app = {
            // State
            peer: null,
            conn: null,
            connections: [], // Host only
            myId: null,
            hostId: null,
            isHost: false,
            
            // User Data
            username: 'Anon',
            avatar: 'fa-user-astronaut',
            color: '#3b82f6',
            
            // Map Data
            map: null,
            markers: {},
            rallyMarker: null,
            myLocation: null,
            
            // Logic
            heartbeatInterval: null,
            expiryTime: null,
            lastPing: Date.now(),
            activeTab: 'map',

            // Icons list
            avatars: ['fa-user-astronaut', 'fa-ghost', 'fa-robot', 'fa-dragon', 'fa-cat', 'fa-dog', 'fa-frog', 'fa-crow', 'fa-spider', 'fa-otter'],

            init: function() {
                this.fixViewport();
                this.renderAvatars();
                
                // 1. Check LocalStorage for previous session
                const savedState = JSON.parse(localStorage.getItem('burner_state'));
                const urlParams = new URLSearchParams(window.location.search);
                const joinParam = urlParams.get('join');

                // If we have saved state and it matches the URL (or no URL), restore it
                if (savedState) {
                    // If URL param exists and is DIFFERENT from saved host, we must ignore saved state (new join)
                    if (joinParam && joinParam !== savedState.hostId) {
                        // New session
                        this.hostId = joinParam;
                    } else {
                        // Restore session
                        this.username = savedState.username;
                        this.avatar = savedState.avatar;
                        this.color = savedState.color;
                        this.hostId = savedState.hostId;
                        this.myId = savedState.myId; // Try to reuse ID
                        
                        document.getElementById('username-input').value = this.username;
                        this.selectAvatar(this.avatar);
                        document.getElementById('rejoin-hint').classList.remove('hidden');
                        document.getElementById('btn-start-text').innerText = "Rejoin Session";
                    }
                } else {
                    this.hostId = joinParam;
                }

                this.isHost = !this.hostId;
                if (this.isHost) document.getElementById('btn-settings').classList.remove('hidden');

                this.initMap();
            },

            fixViewport: function() {
                const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
                window.addEventListener('resize', setVh);
                setVh();
            },

            renderAvatars: function() {
                const grid = document.getElementById('avatar-grid');
                grid.innerHTML = this.avatars.map(icon => `
                    <div onclick="app.selectAvatar('${icon}')" class="avatar-option w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center cursor-pointer border border-white/10 transition-all text-slate-400 hover:text-white">
                        <i class="fa-solid ${icon}"></i>
                    </div>
                `).join('');
                // Select default
                this.selectAvatar(this.avatar);
            },

            selectAvatar: function(icon) {
                this.avatar = icon;
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected', 'text-white'));
                const selected = document.querySelector(`.avatar-option i.fa-solid.${icon}`).parentNode;
                selected.classList.add('selected', 'text-white');
            },

            initMap: function() {
                this.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(this.map);
                
                // Double tap to set Rally Point (Host only)
                this.map.on('dblclick', (e) => {
                    if(this.isHost) {
                        this.setRallyPoint(e.latlng.lat, e.latlng.lng);
                        this.send({ type: 'rally', lat: e.latlng.lat, lng: e.latlng.lng });
                    }
                });
            },

            startSession: function() {
                const input = document.getElementById('username-input');
                if(!input.value.trim()) return input.classList.add('ring-2', 'ring-red-500');
                
                this.username = input.value.trim();
                
                // Hide Modal
                document.getElementById('modal-onboarding').style.opacity = '0';
                setTimeout(() => document.getElementById('modal-onboarding').style.display = 'none', 300);

                this.initPeer();
                this.startLocation();
                
                // Save State
                this.saveState();
            },

            saveState: function() {
                localStorage.setItem('burner_state', JSON.stringify({
                    username: this.username,
                    avatar: this.avatar,
                    color: this.color,
                    hostId: this.hostId,
                    myId: this.myId // We save this, but PeerJS might not give it back
                }));
            },

            initPeer: function() {
                this.updateStatus('connecting', 'Connecting...');
                
                // Try to reuse ID if we have one, otherwise generate new
                // Note: PeerJS cloud often won't let you reuse an ID immediately after refresh.
                // We will just let PeerJS assign a new one if we are a client, but try to reuse if Host.
                // Actually, for stability, let's just generate new ID always on refresh for now, 
                // but since we stored 'hostId' in localStorage, clients will find the Host again.
                
                this.peer = new Peer(null, { debug: 0 });

                this.peer.on('open', (id) => {
                    this.myId = id;
                    console.log("My ID:", id);
                    this.saveState(); // Update with actual ID

                    if (this.isHost) {
                        this.updateStatus('online', 'HOSTING');
                        this.showToast('Session Active. Waiting for peers.');
                        this.peer.on('connection', (conn) => this.handleHostConnection(conn));
                        this.startHeartbeat(); // Host drives the heartbeat
                    } else {
                        this.connectToHost();
                    }
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    this.updateStatus('error', 'NET ERROR');
                    this.showToast('Connection failed. Retrying...');
                    setTimeout(() => this.initPeer(), 3000);
                });
            },

            connectToHost: function() {
                if (!this.hostId) return;
                this.conn = this.peer.connect(this.hostId, {
                    metadata: { username: this.username, avatar: this.avatar, color: this.color }
                });

                this.conn.on('open', () => {
                    this.updateStatus('online', 'CONNECTED');
                    this.showToast('Joined Session');
                    // Send immediate location
                    if (this.myLocation) this.send({ type: 'location', lat: this.myLocation.lat, lng: this.myLocation.lng });
                });

                this.conn.on('data', (data) => this.handleData(data));
                
                this.conn.on('close', () => {
                    this.updateStatus('error', 'DISCONNECTED');
                    this.showToast('Host lost. Reconnecting...');
                    setTimeout(() => this.connectToHost(), 2000); // Auto-reconnect
                });
            },

            handleHostConnection: function(conn) {
                this.connections.push(conn);
                conn.on('open', () => {
                    this.showToast(`${conn.metadata.username} joined`);
                    
                    // Sync State to new user
                    conn.send({ 
                        type: 'sync', 
                        expiry: this.expiryTime,
                        rally: this.rallyMarker ? this.rallyMarker.getLatLng() : null
                    });
                });

                conn.on('data', (data) => {
                    // Inject Sender Metadata
                    if (!data.from) data.from = conn.peer;
                    if (!data.username) data.username = conn.metadata.username;
                    if (!data.avatar) data.avatar = conn.metadata.avatar;
                    if (!data.color) data.color = conn.metadata.color;

                    // Heartbeat Response
                    if (data.type === 'pong') {
                        // We could track latency here
                        return;
                    }

                    this.handleData(data);
                    this.broadcast(data, conn.peer);
                });

                conn.on('close', () => {
                    this.connections = this.connections.filter(c => c.peer !== conn.peer);
                    this.removeMarker(conn.peer);
                    this.showToast(`${conn.metadata.username} left`);
                });
            },

            broadcast: function(data, excludeId) {
                this.connections.forEach(c => {
                    if (c.peer !== excludeId && c.open) c.send(data);
                });
            },

            // CORE DATA HANDLER
            handleData: function(data) {
                if (data.type === 'ping') {
                    this.lastPing = Date.now();
                    this.updateSignalStrength(true);
                    // Reply Pong
                    if(this.conn) this.conn.send({ type: 'pong' });
                    // Also sync timer
                    if(data.expiry) this.checkExpiry(data.expiry);
                    return;
                }

                if (data.type === 'location') {
                    this.updateMarker(data.from, data.lat, data.lng, data.username, data.avatar, data.color);
                } else if (data.type === 'chat') {
                    this.addMessageToUI(data.username, data.msg, data.avatar, false);
                    if (this.activeTab !== 'chat') {
                        document.getElementById('unread-badge').classList.remove('hidden');
                        this.showToast(`Msg: ${data.username}`);
                    }
                } else if (data.type === 'rally') {
                    this.setRallyPoint(data.lat, data.lng);
                    this.showToast('Rally Point Updated!');
                } else if (data.type === 'sync') {
                    if(data.expiry) this.checkExpiry(data.expiry);
                    if(data.rally) this.setRallyPoint(data.rally.lat, data.rally.lng);
                }
            },

            send: function(data) {
                data.from = this.myId;
                data.username = this.username;
                data.avatar = this.avatar;
                data.color = this.color;

                if (this.isHost) {
                    if(data.type !== 'ping') this.handleData(data); // Don't process own pings
                    this.broadcast(data);
                } else if (this.conn && this.conn.open) {
                    this.conn.send(data);
                    if (data.type === 'chat') this.addMessageToUI('You', data.msg, this.avatar, true);
                }
            },

            // --- HEARTBEAT & TIMER ---
            startHeartbeat: function() {
                if (this.heartbeatInterval) clearInterval(this.heartbeatInterval);
                this.heartbeatInterval = setInterval(() => {
                    // Send Ping
                    this.broadcast({ type: 'ping', expiry: this.expiryTime });
                    
                    // Check Expiry locally
                    if (this.expiryTime && Date.now() > this.expiryTime) {
                        this.triggerExpiry();
                    }
                }, 3000);
            },

            updateSignalStrength: function(isOnline) {
                const icon = document.getElementById('heartbeat-icon');
                if (isOnline) {
                    icon.className = 'text-[10px] text-emerald-400 animate-pulse';
                    this.updateStatus('online', 'LIVE');
                } else {
                    icon.className = 'text-[10px] text-red-500';
                }
            },

            setExpiry: function(minutes) {
                this.expiryTime = Date.now() + (minutes * 60 * 1000);
                this.checkExpiry(this.expiryTime);
                this.send({ type: 'sync', expiry: this.expiryTime }); // Broadcast new time
                this.toggleSettings();
                this.showToast(`Timer set for ${minutes}m`);
            },

            checkExpiry: function(timestamp) {
                this.expiryTime = timestamp;
                const badge = document.getElementById('timer-badge');
                const label = document.getElementById('session-timer');
                
                badge.classList.remove('hidden');
                
                // Update countdown UI loop
                if (this.timerLoop) clearInterval(this.timerLoop);
                this.timerLoop = setInterval(() => {
                    const diff = this.expiryTime - Date.now();
                    if (diff <= 0) {
                        this.triggerExpiry();
                        clearInterval(this.timerLoop);
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        label.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                    }
                }, 1000);
            },

            triggerExpiry: function() {
                document.getElementById('modal-expired').classList.remove('hidden');
                // Stop everything
                if (this.peer) this.peer.destroy();
                localStorage.removeItem('burner_state');
            },

            // --- MAP LOGIC ---
            startLocation: function() {
                if (!navigator.geolocation) return;
                navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        this.myLocation = { lat: latitude, lng: longitude };
                        this.updateMarker(this.myId, latitude, longitude, 'You', this.avatar, this.color, true);
                        if (!this.mapCentered) {
                            this.map.setView([latitude, longitude], 16);
                            this.mapCentered = true;
                        }
                        this.send({ type: 'location', lat: latitude, lng: longitude });
                    },
                    (err) => console.warn(err),
                    { enableHighAccuracy: true }
                );
            },

            updateMarker: function(id, lat, lng, label, avatar, color, isSelf = false) {
                if (this.markers[id]) {
                    this.markers[id].setLatLng([lat, lng]);
                } else {
                    const className = isSelf ? 'custom-marker pulse-dot' : 'custom-marker';
                    const iconHtml = `<div class="${className}" style="background-color: ${isSelf ? '#10b981' : color}; width: 36px; height: 36px; border-color: ${isSelf ? '#fff' : '#e2e8f0'};"><i class="fa-solid ${avatar}"></i></div>`;
                    
                    const icon = L.divIcon({ className: 'bg-transparent', html: iconHtml });
                    const marker = L.marker([lat, lng], { icon: icon, zIndexOffset: isSelf ? 1000 : 500 }).addTo(this.map);
                    marker.bindPopup(`<div class="text-slate-900 font-bold flex items-center gap-2"><i class="fa-solid ${avatar}"></i> ${label}</div>`, { closeButton: false, offset: [0, -15] });
                    this.markers[id] = marker;
                }
            },

            setRallyPoint: function(lat, lng) {
                if (this.rallyMarker) this.map.removeLayer(this.rallyMarker);
                const icon = L.divIcon({ className: 'bg-transparent', html: '<div class="rally-point">ðŸš©</div>', iconSize: [30, 30] });
                this.rallyMarker = L.marker([lat, lng], { icon: icon }).addTo(this.map);
                this.rallyMarker.bindPopup("<b>Rally Point</b>").openPopup();
            },

            removeMarker: function(id) {
                if (this.markers[id]) {
                    this.map.removeLayer(this.markers[id]);
                    delete this.markers[id];
                }
            },

            // --- CHAT & UI ---
            sendMessage: function(e) {
                e.preventDefault();
                const input = document.getElementById('msg-input');
                const msg = input.value.trim();
                if (!msg) return;
                this.send({ type: 'chat', msg: msg });
                input.value = '';
                input.focus();
            },

            addMessageToUI: function(username, msg, avatar, isSelf) {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                div.className = `flex gap-2 ${isSelf ? 'flex-row-reverse' : 'flex-row'} mb-3 animate-fade-in`;
                
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs text-slate-300 border border-white/10 shrink-0">
                        <i class="fa-solid ${avatar}"></i>
                    </div>
                    <div class="flex flex-col ${isSelf ? 'items-end' : 'items-start'} max-w-[75%]">
                        <span class="text-[10px] text-slate-500 mb-0.5 px-1">${username}</span>
                        <div class="${isSelf ? 'bg-blue-600 text-white' : 'bg-slate-700 text-slate-200'} px-3 py-2 rounded-2xl ${isSelf ? 'rounded-tr-none' : 'rounded-tl-none'} text-sm shadow-sm break-words">
                            ${msg.replace(/</g, "&lt;")}
                        </div>
                    </div>
                `;
                container.appendChild(div);
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            },

            switchTab: function(tab) {
                this.activeTab = tab;
                const mapBtn = document.getElementById('btn-map');
                const chatBtn = document.getElementById('btn-chat');
                const mapView = document.getElementById('view-map');
                const chatView = document.getElementById('view-chat');

                if (tab === 'map') {
                    mapBtn.className = "flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all";
                    chatBtn.className = "flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all relative";
                    mapView.style.opacity = '1'; chatView.style.opacity = '0'; chatView.style.pointerEvents = 'none';
                    setTimeout(() => this.map.invalidateSize(), 300);
                } else {
                    chatBtn.className = "flex-1 py-3 rounded-xl text-center bg-slate-700 text-white shadow-inner transition-all relative";
                    mapBtn.className = "flex-1 py-3 rounded-xl text-center text-slate-400 hover:text-white transition-all";
                    chatView.style.opacity = '1'; chatView.style.pointerEvents = 'auto'; mapView.style.opacity = '0';
                    document.getElementById('unread-badge').classList.add('hidden');
                }
            },

            toggleSettings: function() {
                const modal = document.getElementById('modal-settings');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    modal.style.opacity = '0';
                    setTimeout(() => modal.style.opacity = '1', 10);
                } else {
                    modal.style.opacity = '0';
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            },

            updateStatus: function(type, text) {
                document.getElementById('connection-status').innerText = text;
                const icon = document.getElementById('heartbeat-icon');
                if(type !== 'online') icon.className = 'text-[10px] text-red-500';
            },

            copyLink: function() {
                if (!this.myId) return;
                const url = `${window.location.origin}${window.location.pathname}?join=${this.isHost ? this.myId : this.hostId}`;
                if (navigator.share) navigator.share({ title: 'Join BurnerMap', url: url }).catch(()=>{});
                else navigator.clipboard.writeText(url).then(() => this.showToast('Link Copied'));
            },

            showToast: function(msg) {
                const toast = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.add('toast-active');
                setTimeout(() => toast.classList.remove('toast-active'), 3000);
            },

            burn: function() {
                if(confirm("BURN SESSION?\nThis will disconnect you and wipe local data.")) {
                    localStorage.removeItem('burner_state');
                    window.location.href = window.location.pathname;
                }
            },
            
            resetRallyPoint: function() {
                if(this.rallyMarker) this.map.removeLayer(this.rallyMarker);
                this.rallyMarker = null;
                this.send({ type: 'sync', rally: null });
                this.toggleSettings();
                this.showToast('Rally Point Cleared');
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>